# 認証トークンのフロー図とユーザー権限設計

## 作成日
2025年12月21日

## 目的
現在の認証システムとユーザー権限が混在しているため、設計を明確化し、統一された仕様を確立する。

---

## 1. ユーザーロール（Role）定義

### 3つのユーザータイプ

| Role | 説明 | 認証方法 | アクセス先 |
|------|------|----------|------------|
| **citizen** | 一般市民ユーザー | Firebase Authentication | フロントエンド（3000番） |
| **politician** | 議員・政治家 | バックエンドJWT認証 | 管理画面（3001番） |
| **admin** | 運営管理者 | バックエンドJWT認証 | 管理画面（3001番） |

---

## 2. 認証トークンフロー図

### 2.1 一般市民（citizen）の認証フロー

```
┌─────────────────────────────────────────────────────────────┐
│ 1. ユーザー登録・ログイン（Firebase Authentication）           │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ フロントエンド（3000番）                                        │
│ ・Firebase SDK（firebase/auth）を使用                         │
│ ・メール/パスワードでユーザー登録                              │
│ ・メール認証リンクをクリック                                   │
│ ・ログイン成功 → Firebase ID Token取得                        │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. バックエンドへのリクエスト                                   │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ POST /api/auth/register-firebase                            │
│ Header: Authorization: Bearer <Firebase ID Token>          │
│ Body: { name, email, phone, prefecture, city }             │
│                                                             │
│ または                                                       │
│                                                             │
│ POST /api/auth/login-firebase                               │
│ Header: Authorization: Bearer <Firebase ID Token>          │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. バックエンド処理（4000番）                                  │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ ・Firebase Admin SDKでID Tokenを検証                         │
│ ・email_verifiedがtrueか確認                                │
│ ・MySQLのusersテーブルでユーザーを確認/作成                    │
│ ・role = 'citizen', status = 'pending'                      │
│ ・バックエンドのJWT Token発行                                 │
│   payload: { sub: userId, role: 'citizen', email }         │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. レスポンス                                                 │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ Set-Cookie: auth_token=<JWT Token>                         │
│ Response: { token, user: { id, email, name, role } }       │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 5. 以降のAPIリクエスト                                         │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ Cookie: auth_token=<JWT Token>（自動送信）                   │
│ または                                                       │
│ Header: Authorization: Bearer <JWT Token>                  │
└─────────────────────────────────────────────────────────────┘
```

---

### 2.2 議員（politician）の認証フロー

```
┌─────────────────────────────────────────────────────────────┐
│ 1. ユーザー登録                                                │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 管理画面（3001番）                                             │
│ /politician/signup                                          │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ POST /api/auth/politician/signup                            │
│ Body: {                                                     │
│   email: string,                                            │
│   password: string,                                         │
│   name: string,                                             │
│   regionId?: string,                                        │
│   partyId?: string                                          │
│ }                                                           │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. バックエンド処理                                            │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ ・パスワードをbcryptでハッシュ化                               │
│ ・usersテーブルに保存                                         │
│   role = 'politician', status = 'active'                   │
│ ・politiciansテーブルに議員情報を保存                          │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. ログイン                                                   │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 管理画面（3001番）                                             │
│ /politician/login                                           │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ POST /api/auth/politician/login                             │
│ Body: { email, password }                                   │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. バックエンド処理                                            │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ ・メールアドレスでユーザーを検索                                │
│ ・パスワードを検証（bcrypt.compare）                           │
│ ・role = 'politician'であることを確認                         │
│ ・JWT Token発行                                              │
│   payload: { sub: userId, role: 'politician' }             │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 5. レスポンス                                                 │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ Set-Cookie: auth_token=<JWT Token>                         │
│ Response: { token }                                         │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 6. 以降のAPIリクエスト                                         │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ Cookie: auth_token=<JWT Token>（自動送信）                   │
│ バックエンドでJWT検証 → role='politician'を確認               │
└─────────────────────────────────────────────────────────────┘
```

---

### 2.3 管理者（admin）の認証フロー

```
┌─────────────────────────────────────────────────────────────┐
│ 1. ユーザー登録                                                │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 管理画面（3001番）                                             │
│ /admin/signup                                               │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ POST /api/auth/admin/signup                                 │
│ Body: { email, password }                                   │
│                                                             │
│ 【制限】email は @keygo.jp ドメインのみ許可                   │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 2. バックエンド処理                                            │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ ・ドメインチェック（@keygo.jp）                                │
│ ・パスワードをbcryptでハッシュ化                               │
│ ・usersテーブルに保存                                         │
│   role = 'admin', status = 'active'                        │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 3. ログイン                                                   │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 管理画面（3001番）                                             │
│ /admin/login                                                │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ POST /api/auth/admin/login                                  │
│ Body: { email, password }                                   │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 4. バックエンド処理                                            │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ ・メールアドレスでユーザーを検索                                │
│ ・パスワードを検証（bcrypt.compare）                           │
│ ・role = 'admin'であることを確認                              │
│ ・JWT Token発行                                              │
│   payload: { sub: userId, role: 'admin' }                  │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 5. レスポンス                                                 │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ Set-Cookie: auth_token=<JWT Token>                         │
│ Response: { token }                                         │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ 6. 以降のAPIリクエスト                                         │
└─────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────┐
│ Cookie: auth_token=<JWT Token>（自動送信）                   │
│ バックエンドでJWT検証 → role='admin'を確認                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. ユーザー権限ごとの画面遷移図

### 3.1 一般市民（citizen）- フロントエンド（3000番）

```
┌──────────────────────────────────────────────────────────────┐
│                    トップページ（/）                            │
│                     ・未認証でも閲覧可能                        │
│                     ・タイムライン表示                          │
└──────────────────────────────────────────────────────────────┘
                            ↓
              ┌─────────────┴─────────────┐
              ↓                           ↓
┌──────────────────────────┐  ┌──────────────────────────┐
│  ログイン（/login）        │  │  会員登録（/register）     │
│  ・Firebase Auth         │  │  ・Firebase Auth         │
│  ・メール/パスワード      │  │  ・メール認証必須          │
└──────────────────────────┘  └──────────────────────────┘
              ↓                           ↓
              └─────────────┬─────────────┘
                            ↓
┌──────────────────────────────────────────────────────────────┐
│                     ログイン後の画面                            │
└──────────────────────────────────────────────────────────────┘
                            ↓
        ┌───────────────────┼───────────────────┐
        ↓                   ↓                   ↓
┌────────────────┐  ┌────────────────┐  ┌────────────────┐
│ タイムライン（/） │  │プロフィール      │  │通知（/notifications）│
│ ・投稿一覧表示   │  │（/profile）      │  │・通知一覧表示    │
│ ・いいね・コメント│  │・ユーザー情報表示 │  │                │
└────────────────┘  └────────────────┘  └────────────────┘
        ↓                   ↓                   ↓
┌────────────────┐  ┌────────────────┐  ┌────────────────┐
│議員詳細         │  │KYC認証           │  │アンケート       │
│（/politicians/:id）│ │（/kyc）         │  │（/surveys）     │
│・議員情報表示    │  │・本人確認手続き   │  │・市民の意見収集  │
│・活動報告閲覧    │  │・status変更      │  │                │
└────────────────┘  └────────────────┘  └────────────────┘
```

**アクセス制限:**
- 未認証: トップページ、ログイン、会員登録
- 認証済み（role=citizen）: 全ページアクセス可能
- KYC完了後（status=verified）: ウォレット、投票機能など

---

### 3.2 議員（politician）- 管理画面（3001番）

```
┌──────────────────────────────────────────────────────────────┐
│              議員ログイン（/politician/login）                    │
│              ・バックエンドJWT認証                               │
└──────────────────────────────────────────────────────────────┘
                            ↓
┌──────────────────────────────────────────────────────────────┐
│                  ダッシュボード（/dashboard）                    │
│                  ・最近の投稿一覧                                │
│                  ・ユーザー情報表示                              │
│                  ・新規投稿ボタン                                │
└──────────────────────────────────────────────────────────────┘
                            ↓
        ┌───────────────────┼───────────────────┐
        ↓                   ↓                   ↓
┌────────────────┐  ┌────────────────┐  ┌────────────────┐
│新規投稿作成      │  │投稿一覧         │  │コメント管理      │
│（/posts/create） │  │（/posts）       │  │（/comments）    │
│・タイトル入力    │  │・自分の投稿一覧  │  │・コメント一覧    │
│・内容入力       │  │・編集・削除      │  │・返信機能       │
│・画像アップロード │  │                │  │                │
│・動画アップロード │  │                │  │                │
└────────────────┘  └────────────────┘  └────────────────┘
        ↓                   ↓                   ↓
┌────────────────┐  ┌────────────────┐  ┌────────────────┐
│フォロワー分析    │  │エンゲージメント  │  │資金情報管理      │
│（/analytics）   │  │（/engagement）  │  │（/funding）     │
│・フォロワー統計  │  │・いいね数       │  │・収支報告       │
│・地域別分布     │  │・コメント数      │  │                │
└────────────────┘  └────────────────┘  └────────────────┘
```

**アクセス制限:**
- 認証済み（role=politician）のみアクセス可能
- 自分の投稿のみ編集・削除可能

---

### 3.3 管理者（admin）- 管理画面（3001番）

```
┌──────────────────────────────────────────────────────────────┐
│              管理者ログイン（/admin/login）                      │
│              ・@keygo.jp ドメイン限定                           │
│              ・バックエンドJWT認証                               │
└──────────────────────────────────────────────────────────────┘
                            ↓
┌──────────────────────────────────────────────────────────────┐
│                  ダッシュボード（/dashboard）                    │
│                  ・システム全体の統計                            │
│                  ・最近の活動                                   │
└──────────────────────────────────────────────────────────────┘
                            ↓
        ┌───────────────────┼───────────────────┐
        ↓                   ↓                   ↓
┌────────────────┐  ┌────────────────┐  ┌────────────────┐
│ユーザー管理      │  │投稿管理（全体）   │  │コメント管理（全体）│
│（/users）       │  │（/posts）       │  │（/comments）    │
│・全ユーザー一覧  │  │・全投稿一覧      │  │・全コメント一覧  │
│・ステータス変更  │  │・削除・編集      │  │・削除           │
│・権限変更       │  │・承認・非承認    │  │・モデレーション  │
└────────────────┘  └────────────────┘  └────────────────┘
        ↓                   ↓                   ↓
┌────────────────┐  ┌────────────────┐  ┌────────────────┐
│通報管理         │  │アンケート管理    │  │システム設定      │
│（/reports）     │  │（/surveys）     │  │（/settings）    │
│・通報一覧       │  │・アンケート作成  │  │・NGワード設定   │
│・対応履歴       │  │・結果確認       │  │・セキュリティ設定│
└────────────────┘  └────────────────┘  └────────────────┘
```

**アクセス制限:**
- 認証済み（role=admin）のみアクセス可能
- 全ユーザー・投稿・コメントにアクセス可能
- システム全体の設定変更権限

---

## 4. APIエンドポイントとRole制限

### 4.1 認証不要（Public）

| エンドポイント | メソッド | 説明 |
|--------------|---------|------|
| `/api/posts` | GET | 投稿一覧取得 |
| `/api/posts/:id` | GET | 投稿詳細取得 |
| `/api/politicians` | GET | 議員一覧取得 |
| `/api/politicians/:id` | GET | 議員詳細取得 |

### 4.2 一般市民（citizen）のみ

| エンドポイント | メソッド | 説明 |
|--------------|---------|------|
| `/api/auth/register-firebase` | POST | Firebase新規登録 |
| `/api/auth/login-firebase` | POST | Firebaseログイン |
| `/api/kyc/submit` | POST | KYC申請 |
| `/api/wallet/transactions` | GET | ウォレット取引履歴 |
| `/api/surveys/:id/responses` | POST | アンケート回答 |

### 4.3 議員（politician）のみ

| エンドポイント | メソッド | 説明 |
|--------------|---------|------|
| `/api/auth/politician/signup` | POST | 議員登録 |
| `/api/auth/politician/login` | POST | 議員ログイン |
| `/api/posts` | POST | 投稿作成 |
| `/api/posts/:id` | PUT | 自分の投稿編集 |
| `/api/posts/:id` | DELETE | 自分の投稿削除 |
| `/api/analytics/my/*` | GET | 自分の分析データ |

### 4.4 管理者（admin）のみ

| エンドポイント | メソッド | 説明 |
|--------------|---------|------|
| `/api/auth/admin/signup` | POST | 管理者登録 |
| `/api/auth/admin/login` | POST | 管理者ログイン |
| `/api/admin/users` | GET | 全ユーザー一覧 |
| `/api/admin/users/:id` | PATCH | ユーザー情報変更 |
| `/api/admin/posts/*` | ALL | 全投稿管理 |
| `/api/admin/comments/*` | ALL | 全コメント管理 |
| `/api/admin/reports/*` | ALL | 通報管理 |

### 4.5 認証済み（全Role共通）

| エンドポイント | メソッド | 説明 |
|--------------|---------|------|
| `/api/auth/me` | GET | 現在のユーザー情報取得 |
| `/api/posts/:id/comments` | POST | コメント投稿 |
| `/api/posts/:id/votes` | POST | 投票 |
| `/api/follows/:userId` | POST | フォロー |
| `/api/follows/:userId` | DELETE | フォロー解除 |

---

## 5. トークン保存方法

### フロントエンド（3000番）- citizen
- **Firebase ID Token**: ブラウザのメモリ（Firebase SDKが管理）
- **バックエンドJWT**: HttpOnly Cookie `auth_token`
- **有効期限**: 7日間

### 管理画面（3001番）- politician/admin
- **バックエンドJWT**: HttpOnly Cookie `auth_token`
- **有効期限**: 7日間

### セキュリティ設定
```javascript
res.cookie('auth_token', token, {
  httpOnly: true,                        // XSS対策
  secure: process.env.NODE_ENV === 'production',  // HTTPS必須（本番環境）
  sameSite: 'lax',                       // CSRF対策
  maxAge: 7 * 24 * 60 * 60 * 1000,       // 7日間
});
```

---

## 6. 現在の問題点と提案

### 問題点

1. **フロントエンド（3000番）に管理者ログインページが存在**
   - `frontend/app/admin/login/page.tsx`
   - `frontend/app/admin/signup/page.tsx`
   - `frontend/app/admin/politicians/login/page.tsx`
   - `frontend/app/admin/politicians/signup/page.tsx`

2. **役割が混在している**
   - 一般市民用のフロントエンドに管理者・議員のログインページがある
   - URLが `/admin/...` となっており、混乱を招く

3. **認証フローの不統一**
   - 一般市民: Firebase Authentication
   - 議員・管理者: バックエンドJWT認証
   - しかし、両方とも最終的にバックエンドJWTを使用

### 提案する修正

#### オプション A: 完全分離（推奨）

```
frontend（3000番）
  ├─ /                    # 一般市民用トップ
  ├─ /login               # 一般市民ログイン（Firebase）
  ├─ /register            # 一般市民登録（Firebase）
  └─ /profile             # 一般市民プロフィール

admin-frontend（3001番）
  ├─ /                    # ダッシュボード（要認証）
  ├─ /politician/login    # 議員ログイン
  ├─ /politician/signup   # 議員登録
  ├─ /admin/login         # 管理者ログイン
  ├─ /admin/signup        # 管理者登録
  └─ /posts/create        # 投稿作成（議員・管理者共通）
```

**メリット:**
- 役割が明確
- セキュリティ設定を分離できる
- 混乱が少ない

**実装作業:**
- `frontend/app/admin/*` を削除
- 管理画面へのリンクを整理

#### オプション B: 統合

すべての認証をFirebase Authenticationに統一し、Custom Claimsでroleを管理

**メリット:**
- 認証フローが統一される
- Firebase側でrole管理

**デメリット:**
- 大規模な改修が必要
- 議員・管理者の登録フローが複雑化

---

## 7. 推奨する実装順序

1. **frontend/app/admin/* の削除または移動**
   - 管理者・議員のログインページをadmin-frontendに移動
   - または削除して、admin-frontendのページを使用

2. **ルーティングの整理**
   - 一般市民: `/`, `/login`, `/register`, `/profile` など
   - 議員・管理者: `/dashboard`, `/posts/create` など

3. **認証ガードの実装**
   - フロントエンドでroleに基づくページアクセス制御
   - バックエンドでAPIエンドポイントのrole制御

4. **ドキュメントの更新**
   - 各roleのアクセス可能なページ・エンドポイントを明確化

---

## 8. 確認事項

以下の点についてご確認・ご承認をお願いします：

1. **ユーザーロールの定義は適切ですか？**
   - citizen / politician / admin の3つのロール

2. **認証フローは承認できますか？**
   - 一般市民: Firebase Authentication → バックエンドJWT
   - 議員・管理者: バックエンドJWT認証のみ

3. **画面遷移図は適切ですか？**
   - frontend（3000番）: 一般市民専用
   - admin-frontend（3001番）: 議員・管理者専用

4. **提案する修正（オプションA: 完全分離）を採用しますか？**
   - YES: `frontend/app/admin/*` を削除し、完全分離
   - NO: 別の方法を提案してください

5. **その他の変更や追加の要望はありますか？**

---

この設計ドキュメントをご確認いただき、承認後に実装を進めさせていただきます。
