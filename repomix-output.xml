This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
admin-frontend/
  app/
    admin/
      login/
        page.tsx
      signup/
        page.tsx
    comments/
      page.tsx
    components/
      Sidebar.tsx
    dashboard/
      page.tsx
    engagement/
      page.tsx
    politician/
      login/
        page.tsx
      signup/
        page.tsx
    users/
      page.tsx
    favicon.ico
    globals.css
    layout.tsx
    page.tsx
  public/
    file.svg
    globe.svg
    next.svg
    vercel.svg
    window.svg
  .gitignore
  eslint.config.mjs
  next.config.ts
  package.json
  postcss.config.mjs
  README.md
  tsconfig.json
backend/
  __tests__/
    auth.e2e.ts
    notifications.e2e.ts
    posts.e2e.ts
  data/
    members.csv
    mockData.js
  modules/
    reactions/
      reactions.entity.ts
  scripts/
    seed-ng-words.ts
  src/
    auth/
      dto/
        login.dto.ts
        register-user.dto.ts
      auth.controller.ts
      auth.module.ts
      auth.service.ts
      dev-login.controller.ts
      dev-seed.controller.ts
      dev.module.ts
      jwt.strategy.ts
    common/
      decorators/
        public.decorator.ts
        roles.decorator.ts
      filters/
        http-exception.filter.ts
      guards/
        jwt-auth.guard.ts
        roles.guard.ts
      interceptors/
        response.interceptor.ts
      middleware/
        rate-limit.middleware.ts
    config/
      database.config.ts
      firebase.config.ts
    entities/
      activity-fund.entity.ts
      activity-log.entity.ts
      audit-log.entity.ts
      comment-like.entity.ts
      comment-mention.entity.ts
      comment-reaction.entity.ts
      comment.entity.ts
      follow.entity.ts
      funding-record.entity.ts
      funding.entity.ts
      media.entity.ts
      member.entity.ts
      ng-word.entity.ts
      notification.entity.ts
      party.entity.ts
      policy.entity.ts
      politician-profile.entity.ts
      politician.entity.ts
      post.entity.ts
      reaction.entity.ts
      region.entity.ts
      report.entity.ts
      scheduled-post.entity.ts
      survey-response.entity.ts
      survey.entity.ts
      user.entity.ts
      vote.entity.ts
      wallet-transaction.entity.ts
    enums/
      activity-log-type.enum.ts
      age-group.enum.ts
      currency.enum.ts
      kyc-status.enum.ts
      media-category.enum.ts
      media-type.enum.ts
      notification-type.enum.ts
      post-type.enum.ts
      reaction-type.enum.ts
      user-role.enum.ts
      vote-choice.enum.ts
      wallet-transaction-type.enum.ts
    guards/
      role.guard.ts
      roles.decorator.ts
      roles.guard.ts
    health/
      health.controller.ts
      health.module.ts
      health.service.ts
    lib/
      swagger-fallback.ts
    middleware/
      rate-limit.middleware.ts
    modules/
      activity-funds/
        dto/
          create-activity-fund.dto.ts
          update-activity-fund.dto.ts
        activity-funds.controller.ts
        activity-funds.module.ts
        activity-funds.service.ts
      activity-logs/
        dto/
          create-activity-log.dto.ts
          update-activity-log.dto.ts
        activity-log.entity.ts
        activity-log.service.ts
        activity-logs.controller.ts
        activity-logs.module.ts
        activity-logs.service.ts
      admin/
        admin.bulk-posts.controller.ts
        admin.controller.ts
        admin.module.ts
        admin.politicians.controller.ts
        admin.posts.controller.ts
      admin-search/
        admin-search.controller.ts
        admin-search.module.ts
      analytics/
        analytics.controller.ts
        analytics.module.ts
        analytics.service.ts
      audit/
        audit.module.ts
        audit.service.ts
      auth/
        dto/
          login.dto.ts
          register.dto.ts
        guards/
          admin.guard.ts
          firebase-auth.guard.ts
          jwt-auth.guard.ts
        strategies/
          firebase.strategy.ts
          jwt.strategy.ts
        auth.controller.ts
        auth.module.ts
        auth.service.ts
        dev-seed.controller.ts
        firebase.provider.ts
        jwt-auth.guard.ts
        jwt.strategy.ts
        register.controller.ts
        register.dto.ts
        register.module.ts
        register.service.ts
      comment-likes/
        comment-likes.controller.ts
        comment-likes.module.ts
        comment-likes.service.ts
      comments/
        dto/
          create-comment.dto.ts
          create-reply.dto.ts
          react.dto.ts
        comment.entity.ts
        comments.controller.ts
        comments.module.ts
        comments.service.ts
      external-feeds/
        external-feeds.controller.ts
        external-feeds.module.ts
        external-feeds.service.ts
        twitter-rate-limiter.service.ts
      follows/
        follow.entity.ts
        follows.controller.ts
        follows.module.ts
        follows.service.ts
      funding/
        funding.controller.ts
        funding.module.ts
        funding.service.ts
      health/
        health.controller.ts
        health.module.ts
      mail/
        mail.module.ts
        mail.service.ts
      media/
        media-asset.entity.ts
        media.controller.ts
        media.module.ts
        media.service.ts
      members/
        dto/
          create-member.dto.ts
          update-member.dto.ts
        members.controller.ts
        members.module.ts
        members.service.ts
      moderation/
        moderation.module.ts
        ng-words.controller.ts
        ng-words.service.ts
      news-ingest/
        news-ingest.controller.ts
        news-ingest.module.ts
        news-ingest.service.ts
      notifications/
        notifications.controller.ts
        notifications.module.ts
        notifications.service.ts
      policies/
        policies.controller.ts
        policies.module.ts
        policies.service.ts
      politicians/
        dto/
          search-politicians.dto.ts
          update-politician.dto.ts
        politician-profile.controller.ts
        politicians.controller.ts
        politicians.module.ts
        politicians.service.ts
      posts/
        dto/
          create-post.dto.ts
          query-posts.dto.ts
          update-post.dto.ts
        post.entity.ts
        posts.controller.ts
        posts.module.ts
        posts.service.ts
      reactions/
        dto/
          react.dto.ts
        reaction.entity.ts
        reactions.controller.ts
        reactions.module.ts
        reactions.service.ts
      recommendations/
        recommendations.controller.ts
        recommendations.module.ts
        recommendations.service.ts
      reports/
        dto/
          create-report.dto.ts
          mod-action.dto.ts
        admin-reports.controller.ts
        report.entity.ts
        reports.controller.ts
        reports.module.ts
        reports.service.ts
      scheduled-posts/
        scheduled-posts.controller.ts
        scheduled-posts.module.ts
        scheduled-posts.service.ts
      search/
        follows.controller.ts
        search.controller.ts
        search.module.ts
        search.service.ts
      surveys/
        dto/
          create-response.dto.ts
        surveys.controller.ts
        surveys.module.ts
        surveys.service.ts
      users/
        dto/
          create-user.dto.ts
          update-user.dto.ts
          user.dto.ts
        user.entity.ts
        users.controller.ts
        users.module.ts
        users.service.ts
      votes/
        dto/
          create-vote.dto.ts
        vote.entity.ts
        votes.controller.ts
        votes.module.ts
        votes.service.ts
      wallet/
        wallet.controller.ts
        wallet.module.ts
        wallet.service.ts
    news-ingest/
      news-ingest.controller.ts
      news-ingest.module.ts
      news-ingest.service.ts
      news-source.interface.ts
      rss-news.source.ts
    scripts/
      e2e-smoke.sh
      reset-password.ts
      seed.ts
      typeorm.config.ts
    type/
      global.d.ts
    app.controller.spec.ts
    app.controller.ts
    app.module.ts
    app.service.ts
    main.ts
  .gitignore
  .prettierrc
  eslint.config.mjs
  jest.config.ts
  nest-cli.json
  package.json
  README.md
  server.js
  tsconfig.build.json
  tsconfig.json
  update_user.sql
docker/
  mysql/
    init/
      01-init.sql
frontend/
  app/
    about/
      page.tsx
    admin/
      approval/
        page.tsx
      bulk-posts/
        page.tsx
      dashboard/
        page.md
        page.tsx
      funding/
        page.tsx
      login/
        page.tsx
      ng-words/
        page.tsx
      notifications/
        send/
          page.tsx
      policies/
        page.tsx
      politicians/
        import/
          page.tsx
        login/
          page.tsx
        new/
          page.tsx
        signup/
          page.tsx
      posts/
        [id]/
          edit/
            page.tsx
        new/
          page.tsx
      reports/
        page.tsx
      scheduled-posts/
        page.tsx
      search/
        page.tsx
      signup/
        page.tsx
      users/
        page.tsx
      page.tsx
    contact/
      page.tsx
    dashboard/
      page.tsx
    feed/
      page.tsx
    forgot-password/
      page.tsx
    globals/
      globals.css
    help/
      page.tsx
    kyc/
      page.tsx
    legal/
      privacy/
        page.md
      terms/
        page.md
    login/
      page.tsx
    members/
      [id]/
        page.tsx
    notifications/
      page.tsx
    politicians/
      [id]/
        page.tsx
    posts/
      [id]/
        comment-with-media.tsx
        page.tsx
    privacy/
      page.tsx
    profile/
      page.tsx
    register/
      page.tsx
      types.ts
    search/
      page.tsx
    surveys/
      page.tsx
    terms/
      page.tsx
    timeline/
      page.tsx
    verify/
      page.tsx
    wallet/
      page.tsx
    favicon.ico
    globals.css
    layout.tsx
    page.tsx
  components/
    auth/
      AuthGuard.tsx
      LoginForm.tsx
      RegisterForm.tsx
    common/
      Button.tsx
      Input.tsx
    layout/
      Footer.tsx
      Header.tsx
      MainLayout.tsx
      Sidebar.tsx
    timeline/
      PostForm.tsx
      PostItem.tsx
      PostList.tsx
    ActivityFundsChart.tsx
    AdminReportsClient.tsx
    AppShell.tsx
    AuthActions.tsx
    CommentLikeButton.tsx
    CommentsSection.tsx
    FeedClient.tsx
    FollowButton.tsx
    FollowingPanel.tsx
    Footer.tsx
    FundingChart.tsx
    Header.tsx
    Hero.tsx
    LeftSidebar.tsx
    MembersGrid.tsx
    PledgeCard.tsx
    PostCard.tsx
    PostCategoryBadge.tsx
    PostComposer.tsx
    PostComposerSWR.tsx
    PostCreateForm.tsx
    PostItem.tsx
    PostsList.tsx
    ReactionButtons.tsx
    RecommendedUsersPanel.tsx
    ReportButton.tsx
    ReportModal.tsx
    RightSidebar.tsx
    RightSidebarFilters.tsx
    SearchFilterBar.tsx
    SearchSidebar.tsx
    SegmentsPanel.tsx
    Sidebar.tsx
    Stats.tsx
    SupportOpposeChart.tsx
    Timeline.tsx
    ToastProvider.tsx
    VoteButton.tsx
    VoteButtons.tsx
  contexts/
    AuthContext.tsx
  lib/
    hooks/
      useComments.ts
      usePosts.ts
    age.ts
    api-extended.ts
    api-follows.ts
    api-media.ts
    api-recommendations.ts
    api.analytics-snippet.ts
    api.follows-snippet.ts
    api.notifications-admin-snippet.ts
    api.notifications-snippet.ts
    api.posts-edit-snippet.ts
    api.posts-manage-snippet.ts
    api.reports.ts
    api.ts
    auth.ts
    firebase.ts
    geoJP.ts
    japanLocation.ts
    navData.ts
    utils.ts
  nextjs-platform-clean/
    .next/
      dev/
        types/
          routes.d.ts
          validator.ts
  public/
    geo/
      jp-pref-cities.json
    file.svg
    globe.svg
    next.svg
    vercel.svg
    window.svg
  types/
    data.ts
  utils/
    fakeApi.ts
  .gitignore
  env.example
  eslint.config.mjs
  jsconfig.json
  next.config.js
  next.config.ts
  package.json
  postcss.config.js
  postcss.config.mjs
  README.md
  tailwind.config.js
  testData.js
  tsconfig.json
test/
  app.e2e-spac.ts
.env.example
.gitignore
docker-compose.yml
FIREBASE_SETUP.md
generateData.js
README.md
setup-env.js
SETUP.md
start-dev.bat
start-dev.sh
プロジェクト名：市民参加型 透明性データプラットフォーム（仮称） MVP開発.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="プロジェクト名：市民参加型 透明性データプラットフォーム（仮称） MVP開発.md">
### **プロジェクト名：市民参加型 透明性データプラットフォーム（仮称） MVP開発**

### **1\. プロジェクトの概要と目的（募集文で伏せていた情報）**

本プロジェクトは、**地方議会議員**の活動情報、公約、および**政務活動費（公金）の使途**を市民が公平に確認・評価できるデータ駆動型WebプラットフォームのMVP（最小実行可能製品）を構築することを目的としています。

* **社会的意義：** 政治と市民のエンゲージメントを向上させ、情報の透明性を高める**社会貢献性の高い取り組み**です。  
* **求められる品質：** 扱うデータが公的な性質を持つため、**データの整合性、正確性、およびセキュリティの堅牢性**が極めて重要です。

### **2\. MVPで実装する具体的な機能**

募集文で提示した各機能について、具体的な要件を定義します。

#### **A. 登録メンバー（議員）チャンネル機能**

* **プロフィール表示：** 議員の氏名、写真、所属、経歴、公約一覧を表示。  
* **活動資金（公金）の可視化：** 運営者側でCSVインポートした政務活動費の支出データを、**カテゴリ別**（例：広報費、人件費、事務所費）に集計し、**Chart.js / Recharts**を用いた円グラフまたは棒グラフで直感的に可視化。  
* **賛否評価機能：**  
  * ログインユーザーのみが**1アカウントにつき1回**、各活動や公約に対し「賛成」または「反対」の評価を表明可能。  
  * リアルタイムで集計結果（賛成数・反対数・割合）を表示。

#### **B. メインタイムライン・情報自動収集機能**

* **活動ログのフィード：** すべての登録メンバーの最新の活動ログを時系列で表示。  
* **外部フィード連携：** 以下の情報をNode.jsの非同期処理により**自動収集・更新**し、タイムラインに反映させます。  
  * **X (旧Twitter) API**  
  * **議員の公式ブログやウェブサイトのRSS**  
  * **地方自治体議会公式サイトのRSS**  
* **技術要件：** 外部APIやフィードの障害に備え、**再送・リトライ機構**を備えた堅牢な自動収集システムの設計が必須です。

#### **C. バックエンド・データ管理**

* **API基盤：** RESTful APIの設計・構築（Node.js/Express、または**NestJS**）。  
* **DB設計：** メンバー、公約、活動ログ、ユーザー、投票データについて、**正規化と拡張性**を意識したMySQLスキーマ設計。  
* **運営者向け管理画面（CMS）：** 議員情報のCRUD操作（登録・更新・削除）、活動資金データのCSVインポート機能。

### **3\. 求められる設計思想（開発者に期待すること）**

* **拡張性の確保：** MVP完成後、機能拡張（コメント機能、地域別フィルターなど）が容易に行えるよう、**モジュール構造と保守性の高いコード**を最優先してください。（UZUME008様の場合、特にNestJS構成を歓迎します）  
* **セキュリティと信頼性：** ユーザー認証はFirebase Authenticationを採用。データ整合性を保つためのトランザクション処理、およびSQLインジェクション対策などの基本的なセキュリティ対策を徹底してください。

---
</file>

<file path="admin-frontend/app/admin/login/page.tsx">
'use client';
import React, { useState } from 'react';

export default function AdminLoginPage() {
  const [email, setEmail] = useState(''), [password, setPassword] = useState(''), [msg, setMsg] = useState('');
  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setMsg('');
    const res = await fetch('http://localhost:4000/api/auth/admin/login', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }), credentials: 'include'
    });
    if(res.ok) window.location.href = '/dashboard';
    else { const err = await res.json().catch(()=>({})); setMsg(err.message || 'ログインできません'); }
  }
  return (
    <form className="max-w-md mx-auto space-y-4" onSubmit={onSubmit}>
      <h1 className="text-xl font-bold mb-3">運営ログイン</h1>
      <input className="border w-full p-2" placeholder="メール" value={email} onChange={e=>setEmail(e.target.value)} />
      <input className="border w-full p-2" type="password" placeholder="パスワード" value={password} onChange={e=>setPassword(e.target.value)} />
      <button className="bg-blue-700 text-white px-4 py-2 w-full" type="submit">ログイン</button>
      {msg && <div className="text-red-600">{msg}</div>}
      <div className="pt-2"><a href="/admin/signup" className="text-blue-500 underline text-sm">新規登録はこちら</a></div>
    </form>
  );
}
</file>

<file path="admin-frontend/app/admin/signup/page.tsx">
'use client';
import React, { useState } from 'react';

export default function AdminSignupPage() {
  const [email, setEmail] = useState(''), [password, setPassword] = useState(''), [msg, setMsg] = useState('');
  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setMsg('');
    const res = await fetch('http://localhost:4000/api/auth/admin/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    setMsg(res.ok ? '新規登録成功！ログインしてください。' : (await res.json().catch(()=>({}))).message || '新規登録失敗');
  }
  return (
    <form className="max-w-md mx-auto space-y-4" onSubmit={onSubmit}>
      <h1 className="text-xl font-bold mb-3">運営 新規登録</h1>
      <input className="border w-full p-2" placeholder="メール" value={email} onChange={e=>setEmail(e.target.value)} />
      <input className="border w-full p-2" type="password" placeholder="パスワード" value={password} onChange={e=>setPassword(e.target.value)} />
      <button className="bg-blue-700 text-white px-4 py-2 w-full" type="submit">登録</button>
      <div className="p-2 text-green-700">{msg}</div>
      <div className="pt-2"><a href="/admin/login" className="text-blue-500 underline text-sm">管理者ログインはこちら</a></div>
    </form>
  );
}
</file>

<file path="admin-frontend/app/components/Sidebar.tsx">
'use client';
import Link from 'next/link';
import { useEffect, useState } from 'react';

export default function Sidebar() {
  const [user, setUser] = useState<{ role?: string } | null>(null);

  useEffect(() => {
    fetch('http://localhost:4000/api/auth/me', { credentials:'include' })
      .then(res => res.ok ? res.json() : null)
      .then(data => setUser(data))
      .catch(() => setUser(null));
  }, []);

  return (
    <aside className="w-64 bg-gray-800 text-white p-4 space-y-4 flex flex-col">
      <h2 className="text-xl font-bold mb-2">管理メニュー</h2>
      <nav className="space-y-2 flex-1">
        <Link href="/dashboard" className="block hover:bg-gray-700 rounded p-2">ダッシュボード</Link>
        <Link href="/post/new" className="block hover:bg-gray-700 rounded p-2">新規投稿</Link>
        <Link href="/comments" className="block hover:bg-gray-700 rounded p-2">コメント返信</Link>
        <Link href="/engagement" className="block hover:bg-gray-700 rounded p-2">投稿分析</Link>
        {/* 運営(admin)のみがユーザー管理を表示 */}
        {user?.role === 'admin' && (
          <Link href="/users" className="block hover:bg-gray-700 rounded p-2">ユーザー管理</Link>
        )}
      </nav>
      <div className="mt-auto">
        <Link href="/politician/login" className="underline text-sm mr-2">議員ログイン</Link>
        <Link href="/admin/login" className="underline text-sm">運営ログイン</Link>
      </div>
    </aside>
  );
}
</file>

<file path="admin-frontend/app/dashboard/page.tsx">
import React from 'react';

export default function DashboardPage() {
  // ここで user.role を取得し、ナビゲーション等を動的に分岐してもOK
  return (
    <div>
      <h1 className="text-2xl font-bold mb-4">ダッシュボード</h1>
      <div>ここに議員・運営それぞれの概要や通知などをまとめます。</div>
    </div>
  );
}
</file>

<file path="admin-frontend/app/engagement/page.tsx">
'use client';
import React, { useEffect, useState } from 'react';

type PostAnalytics = { id: string; title: string; likes: number; comments: number; disagrees: number; authorId: string };
type User = { id: string; role: string; isPaidMember: boolean; allowedEngagement: boolean; };

export default function EngagementPage() {
  const [posts, setPosts] = useState<PostAnalytics[]>([]);
  const [user, setUser] = useState<User|null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetch('http://localhost:4000/api/auth/me', {credentials:'include'})
      .then(res=>res.json())
      .then(data=>setUser(data));
    fetch('http://localhost:4000/api/admin/posts/analytics', {credentials:'include'})
      .then(res=>res.json())
      .then(data=>{ setPosts(data); setLoading(false); });
  }, []);

  // 閲覧許可条件
  const canSee = user?.role === 'admin' || user?.allowedEngagement || user?.isPaidMember;

  let filteredPosts = posts;
  if(user?.role === 'politician') {
    filteredPosts = posts.filter(x => x.authorId === user.id);
  }

  return (
    <div>
      <h1 className="text-2xl font-extrabold text-black mb-4">投稿のエンゲージメント分析</h1>
      {!canSee && (
        <div className="bg-yellow-100 border-yellow-400 border p-4 mb-5 text-black font-bold rounded">
          この機能を閲覧するには有料会員登録が必要です。(運営または許可議員のみご利用可能)
        </div>
      )}
      {loading ? (<div>読込中...</div>)
        : canSee && (<table className="w-full border">
        <thead><tr><th>タイトル</th><th>いいね</th><th>コメント</th><th>反対票</th></tr></thead>
        <tbody>
          {filteredPosts.map(x=>(
            <tr key={x.id}>
              <td>{x.title}</td>
              <td className="text-center">{x.likes}</td>
              <td className="text-center">{x.comments}</td>
              <td className="text-center">{x.disagrees}</td>
            </tr>
          ))}
        </tbody>
      </table>)}
    </div>
  );
}
</file>

<file path="admin-frontend/app/politician/login/page.tsx">
'use client';
import React, { useState } from 'react';

export default function PoliticianLoginPage() {
  const [email, setEmail] = useState(''), [password, setPassword] = useState(''), [msg, setMsg] = useState('');
  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setMsg('');
    const res = await fetch('http://localhost:4000/api/auth/politician/login', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }), credentials: 'include'
    });
    if(res.ok) window.location.href = '/dashboard';
    else { const err = await res.json().catch(()=>({})); setMsg(err.message || 'ログインできません'); }
  }
  return (
    <form className="max-w-md mx-auto space-y-4" onSubmit={onSubmit}>
      <h1 className="text-xl font-bold mb-3">議員ログイン</h1>
      <input className="border w-full p-2" placeholder="メール" value={email} onChange={e=>setEmail(e.target.value)} />
      <input className="border w-full p-2" type="password" placeholder="パスワード" value={password} onChange={e=>setPassword(e.target.value)} />
      <button className="bg-blue-700 text-white px-4 py-2 w-full" type="submit">ログイン</button>
      {msg && <div className="text-red-600">{msg}</div>}
      <div className="pt-2"><a href="/politician/signup" className="text-blue-500 underline text-sm">新規登録はこちら</a></div>
    </form>
  );
}
</file>

<file path="admin-frontend/app/politician/signup/page.tsx">
'use client';
import React, { useState } from 'react';

export default function PoliticianSignupPage() {
  const [form, setForm] = useState({ email: '', password: '', name: '', regionId: '', partyId: '' });
  const [msg, setMsg] = useState('');
  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setMsg('');
    const res = await fetch('http://localhost:4000/api/auth/politician/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(form),
    });
    if(res.ok) {
      setMsg('新規登録成功！ログインしてください。');
      setForm({ email: '', password: '', name: '', regionId: '', partyId: '' });
    } else {
      const err = await res.json().catch(()=> ({}));
      setMsg(err.message || '新規登録失敗');
    }
  }
  return (
    <div className="max-w-md mx-auto">
      <h1 className="text-xl font-bold mb-2">議員 新規登録</h1>
      <form onSubmit={onSubmit} className="space-y-3">
        <input className="border p-2 w-full" placeholder="メール" value={form.email}
          onChange={e=>setForm(f=>({ ...f, email: e.target.value }))} required />
        <input className="border p-2 w-full" type="password" placeholder="パスワード" value={form.password}
          onChange={e=>setForm(f=>({ ...f, password: e.target.value }))} required />
        <input className="border p-2 w-full" placeholder="氏名" value={form.name}
          onChange={e=>setForm(f=>({ ...f, name: e.target.value }))} required />
        <input className="border p-2 w-full" placeholder="地域ID" value={form.regionId}
          onChange={e=>setForm(f=>({ ...f, regionId: e.target.value }))} />
        <input className="border p-2 w-full" placeholder="政党ID" value={form.partyId}
          onChange={e=>setForm(f=>({ ...f, partyId: e.target.value }))} />
        <button className="bg-blue-700 text-white px-4 py-2 w-full" type="submit">登録</button>
        <div className="text-green-700 p-2">{msg}</div>
        <div className="text-right pt-2"><a href="/politician/login" className="text-blue-500 underline text-sm">ログインはこちら</a></div>
      </form>
    </div>
  );
}
</file>

<file path="admin-frontend/app/users/page.tsx">
'use client';
import React, { useEffect, useState } from 'react';

type User = {
  id: string;
  name: string | null;
  email: string;
  role: string;
  status: 'pending' | 'approved' | 'rejected';
};

export default function UserManagePage() {
  const [users, setUsers] = useState<User[]>([]);
  const [msg, setMsg] = useState('');

  useEffect(() => {
    fetch('http://localhost:4000/api/admin/users', { credentials: 'include' })
      .then(res => res.json())
      .then(setUsers);
  }, []);

  function approve(id: string) {
    fetch(`http://localhost:4000/api/admin/users/${id}/approve`, { method: 'POST', credentials: 'include' })
      .then(res => res.json())
      .then(res => setMsg(res?.ok ? '承認しました' : '失敗'))
      .then(() => setUsers(us => us.map(u => u.id === id ? { ...u, status: 'approved' } : u)));
  }
  function reject(id: string) {
    fetch(`http://localhost:4000/api/admin/users/${id}/reject`, { method: 'POST', credentials: 'include' })
      .then(res => res.json())
      .then(res => setMsg(res?.ok ? '却下しました' : '失敗'))
      .then(() => setUsers(us => us.map(u => u.id === id ? { ...u, status: 'rejected' } : u)));
  }

  return (
    <div>
      <h1 className="text-xl font-bold mb-4">ユーザー管理</h1>
      {msg && <div className="text-green-700 p-2">{msg}</div>}
      <table className="w-full border">
        <thead>
          <tr>
            <th>ID</th><th>氏名</th><th>メール</th><th>種類</th><th>状態</th><th>操作</th>
          </tr>
        </thead>
        <tbody>
          {users.map(u => (
            <tr key={u.id}>
              <td>{u.id}</td>
              <td>{u.name ?? '-'}</td>
              <td>{u.email}</td>
              <td>{u.role}</td>
              <td>{u.status}</td>
              <td>
                {u.status === 'pending' && (
                  <>
                    <button className="bg-blue-600 text-white px-2 py-1 mr-2" onClick={() => approve(u.id)}>承認</button>
                    <button className="bg-red-500 text-white px-2 py-1" onClick={() => reject(u.id)}>却下</button>
                  </>
                )}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
</file>

<file path="admin-frontend/app/globals.css">
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}
</file>

<file path="admin-frontend/app/layout.tsx">
import './globals.css';
import Sidebar from './components/Sidebar';

export const metadata = { title: '議員・運営管理画面' };

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="ja">
      <body>
        <div className="flex min-h-screen">
          <Sidebar />
          <main className="flex-1 bg-gray-50 p-8">{children}</main>
        </div>
      </body>
    </html>
  );
}
</file>

<file path="admin-frontend/public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="admin-frontend/public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="admin-frontend/public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="admin-frontend/public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="admin-frontend/public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="admin-frontend/.gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="admin-frontend/eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="admin-frontend/next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
</file>

<file path="admin-frontend/package.json">
{
  "name": "admin-frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "next": "16.0.10",
    "react": "19.2.1",
    "react-dom": "19.2.1"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.0.10",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}
</file>

<file path="admin-frontend/postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="admin-frontend/README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="admin-frontend/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="backend/__tests__/auth.e2e.ts">
import { Test } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import request from 'supertest';
import { AppModule } from '../src/app.module';

describe('Auth E2E', () => {
  let app: INestApplication;

  beforeAll(async () => {
    const moduleRef = await Test.createTestingModule({ imports: [AppModule] }).compile();
    app = moduleRef.createNestApplication();
    await app.init();
  });

  afterAll(async () => {
    await app.close();
  });

  it('/dev/login/admin returns token', async () => {
    const res = await request(app.getHttpServer()).post('/dev/login/admin').send({});
    expect(res.status).toBe(201);
    expect(res.body.accessToken).toBeDefined();
  });

  it('/auth/me with token returns 200', async () => {
    const login = await request(app.getHttpServer()).post('/dev/login/admin').send({});
    const token = login.body.accessToken;
    const res = await request(app.getHttpServer()).get('/auth/me').set('Authorization', `Bearer ${token}`);
    expect(res.status).toBe(200);
  });
});
</file>

<file path="backend/__tests__/notifications.e2e.ts">
import { Test } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import request from 'supertest';
import { AppModule } from '../src/app.module';

describe('Notifications E2E', () => {
  let app: INestApplication;
  let token: string;

  beforeAll(async () => {
    const moduleRef = await Test.createTestingModule({ imports: [AppModule] }).compile();
    app = moduleRef.createNestApplication();
    await app.init();

    const login = await request(app.getHttpServer()).post('/dev/login/admin').send({});
    token = login.body.accessToken;
  });

  afterAll(async () => {
    await app.close();
  });

  it('Send notification to admin and read it', async () => {
    // dev-admin の userId は /auth/me から取得
    const me = await request(app.getHttpServer()).get('/auth/me').set('Authorization', `Bearer ${token}`);
    expect(me.status).toBe(200);
    const userId = me.body.id || me.body.sub || me.body.userId;

    const send = await request(app.getHttpServer())
      .post('/notifications/send')
      .set('Authorization', `Bearer ${token}`)
      .send({ userId, type: 'info', title: 'Test Notification' });
    expect(send.status).toBe(201);
    const nid = send.body.id;

    const list = await request(app.getHttpServer()).get('/notifications').set('Authorization', `Bearer ${token}`);
    expect(list.status).toBe(200);
    expect(Array.isArray(list.body)).toBe(true);

    const read = await request(app.getHttpServer())
      .patch(`/notifications/${nid}/read`)
      .set('Authorization', `Bearer ${token}`)
      .send({});
    expect(read.status).toBe(200);
    expect(read.body.readAt).toBeDefined();
  });
});
</file>

<file path="backend/__tests__/posts.e2e.ts">
import { Test } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import request from 'supertest';
import { AppModule } from '../src/app.module';

describe('Posts E2E', () => {
  let app: INestApplication;
  let token: string;

  beforeAll(async () => {
    const moduleRef = await Test.createTestingModule({ imports: [AppModule] }).compile();
    app = moduleRef.createNestApplication();
    await app.init();

    const login = await request(app.getHttpServer()).post('/dev/login/admin').send({});
    token = login.body.accessToken;
  });

  afterAll(async () => {
    await app.close();
  });

  it('Create -> Update -> SoftDelete -> Restore', async () => {
    const create = await request(app.getHttpServer())
      .post('/posts')
      .set('Authorization', `Bearer ${token}`)
      .send({ body: 'hello world', postCategory: 'activity', visibility: 'public' });
    expect(create.status).toBe(201);
    const id = create.body.id;

    const update = await request(app.getHttpServer())
      .patch(`/posts/${id}`)
      .set('Authorization', `Bearer ${token}`)
      .send({ title: 'updated title' });
    expect(update.status).toBe(200);

    const del = await request(app.getHttpServer())
      .patch(`/posts/${id}/delete`)
      .set('Authorization', `Bearer ${token}`)
      .send({});
    expect(del.status).toBe(200);
    expect(del.body.deletedAt).toBeDefined();

    const restore = await request(app.getHttpServer())
      .patch(`/posts/${id}/restore`)
      .set('Authorization', `Bearer ${token}`)
      .send({});
    expect(restore.status).toBe(200);
    expect(restore.body.deletedAt).toBeNull();
  });
});
</file>

<file path="backend/data/members.csv">
name,affiliation,position,district,party,twitterHandle,website,email
逢沢 一郎,自民,衆議院議員,岡山1,,https://x.com/ichiroaisawa,https://www.aisawa.net/,
青柳 仁士,維新,衆議院議員,大阪14,,https://x.com/aoyagi_h,https://aoyagi-h.com/,
青柳 陽一郎,立憲,衆議院議員,神奈川6,,https://x.com/aoyagy,https://aoyagy.net/profile,
青山 大人,立憲,衆議院議員,茨城6,,https://x.com/aoyamayamato,https://cdp-japan.jp/member/3019,
赤澤 亮正,自民,衆議院議員,鳥取2,,見つかりませんでした,https://www.ryosei-akazawa.com/book/,
赤羽 一嘉,公明,衆議院議員,兵庫2,,https://x.com/AKBhyogo2ku,https://www.akaba-now.com/%E3%83%97%E3%83%AD%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB/,
あかま 二郎,自民,衆議院議員,神奈川14,,https://x.com/jiroakama0327,https://www.akama.jp/,
赤嶺 政賢,共産,衆議院議員,沖縄1,,https://x.com/akamineseiken,https://akamine-seiken.jp/about/,
阿久津 幸彦,立憲,衆議院議員,東京11,,https://x.com/akutsu0626,https://y-akutsu.jp/profile/,
浅野 哲,国民,衆議院議員,茨城5,,https://x.com/Asano__Satoshi,https://asanosatoshi.com/,
東 克哉,立憲,衆議院議員,（比）中国,,見つかりませんでした,https://cdp-japan.jp/member/5629,
東 国幹,自民,衆議院議員,北海道6,,https://x.com/azuma0217,https://www.jimin.jp/member/202132.html,
東 徹,維新,衆議院議員,大阪3,,https://twitter.com/toru_azuma/,https://www.azuma-toru.com/profile,
安住 淳,立憲,衆議院議員,宮城4,,見つかりませんでした,https://azumi-jun.jp/profile/,
麻生 太郎,自民,衆議院議員,福岡8,,https://x.com/aso_tarou,http://aso-taro.jp/profile/index.html,
阿部 圭史,維新,衆議院議員,（比）近畿,,https://x.com/abe_keishi,https://www.abekeishi.com/,
阿部 司,維新,衆議院議員,（比）東京,,https://x.com/abe2kasa,https://www.abetsukasa.jp/,
あべ 俊子,自民,衆議院議員,（比）九州,,https://x.com/abetoshiko,https://www.abetoshiko.com/,
阿部 知子,立憲,衆議院議員,神奈川12,,https://x.com/abe_tomoko,https://www.abetomoko.jp/profile,
阿部 弘樹,改革,衆議院議員,（比）九州,,https://x.com/HirokiAbe1961,https://hirokiabe.jp/,
阿部 祐美子,立憲,衆議院議員,（比）東京,,https://x.com/abe_shinagawa,https://abeyumiko.com/profile,
荒井 優,立憲,衆議院議員,北海道3,,見つかりませんでした,https://cdp-japan.jp/member/4085,
新垣 邦男,立憲,衆議院議員,沖縄2,,見つかりませんでした,https://www.shugiin.go.jp/internet/itdb_giinprof.nsf/html/profile/025.html,
有田 芳生,立憲,衆議院議員,（比）東京,,https://x.com/aritayoshifu,http://arita-yoshifu.com/,
安藤じゅん子,立憲,衆議院議員,千葉6,,https://x.com/andojunko,https://andojunko.net/profile/,
安藤 たかお,自民,衆議院議員,（比）東京,,https://x.com/AndoTakao1959,https://andotakao.jp/profile/,
五十嵐 えり,立憲,衆議院議員,東京30,,https://x.com/Igarashi_Eri,https://igarashi-eri.com/profile/,
五十嵐 清,自民,衆議院議員,（比）北関東,,見つかりませんでした,https://kiyoshi-igarashi.com/profile_/,
池下 卓,維新,衆議院議員,大阪10,,https://x.com/iketaku_0410,https://www.iketaku.jp/profile,
池田 真紀,立憲,衆議院議員,北海道5,,https://x.com/ikemakihonki,https://ikemaki.jp/profile.html,
池畑 浩太朗,維新,衆議院議員,（比）近畿,,https://x.com/vgz20ydbf5ouj4c,https://ikehata-koutarou.jp/about/profile/,
井坂 信彦,立憲,衆議院議員,兵庫1,,https://x.com/isakanobuhiko,https://isaka-nobuhiko.jp/profile.html,
石井 智恵,国民,衆議院議員,（比）四国,,https://x.com/tomoekakuda,https://ishiitomoe.com/,
石川 香織,立憲,衆議院議員,北海道11,,https://x.com/IshikawaKaori11,https://ishikawa-kaori.net/,
石田 真敏,自民,衆議院議員,（比）近畿,,https://x.com/ishidamasatoshi,https://ishida-masatoshi.net/profile/,
石破 茂,自民,衆議院議員,鳥取1,,https://x.com/shigeruishiba,https://www.ishiba.com/profile-2/,
石橋 林太郎,自民,衆議院議員,（比）中国,,https://x.com/1484_Rintaro,https://ishibashirintaro.com/profile.html,
石原 宏高,自民,衆議院議員,東京3,,https://x.com/ishiharahirotak,https://www.ishihara-hirotaka.com/profile/,
泉 健太,立憲,衆議院議員,京都3,,https://x.com/izmkenta,https://izumi-kenta.net/,
市來 伴子,立憲,衆議院議員,（比）北関東,,https://x.com/ichiki_tomoko,https://ichiki-tomoko.org/,
市村 浩一郎,維新,衆議院議員,（比）近畿,,https://x.com/ichimura_staff,https://www.javjav.com/,
井出 庸生,自民,衆議院議員,（比）北陸信越,,見つかりませんでした,https://www.jimin.jp/member/140847.html,
伊藤 俊輔,立憲,衆議院議員,東京23,,https://x.com/shun76450,https://i-shunsuke.com/profile.html,
伊藤 忠彦,自民,衆議院議員,（比）東海,,https://x.com/tadahiko_itoh,https://tadahiko-itoh.com/office,
伊藤 達也,自民,衆議院議員,（比）東京,,https://x.com/tatsuyaito0501,https://www.tatsuyaito.com/profile,
伊東 信久,維新,衆議院議員,大阪19,,https://x.com/nobuhisaito11,https://n-ito.jp/profile/,
伊東 良孝,自民,衆議院議員,（比）北海道,,https://x.com/yoshitaka2017,https://ito-yoshitaka.com/pages/profile,
稲田 朋美,自民,衆議院議員,福井1,,https://x.com/dento_to_souzo,https://www.inada-tomomi.com/profile/,
稲富 修二,立憲,衆議院議員,福岡2,,https://x.com/inatomishuji,https://inatomi.jp/about/,
井野 俊郎,自民,衆議院議員,群馬2,,https://x.com/olhtphmoe6pxi7i,https://www.inooffice.jp/profile/,
井上 信治,自民,衆議院議員,東京25,,見つかりませんでした,https://www.inoue-s.jp/profile.html,
井上 貴博,自民,衆議院議員,福岡1,,見つかりませんでした,https://inouetakahiro.jp/,
井上 英孝,維新,衆議院議員,大阪1,,https://x.com/hidetaka_i,https://www.hidetaka-inoue.com/profile,
猪口 幸子,維新,衆議院議員,（比）東京,,見つかりませんでした,https://inokuchi-sachiko.com/profile/,
井林 辰憲,自民,衆議院議員,静岡2,,https://x.com/T_Ibayashi,https://t-ibayashi.com/profile/,
今井 雅人,立憲,衆議院議員,岐阜4,,https://x.com/imai_masato,https://www.imaimasato.jp/,
今枝 宗一郎,自民,衆議院議員,愛知14,,https://x.com/imaeda_soichiro,https://www.imaeda-sou.com/profile/,
岩田 和親,自民,衆議院議員,（比）九州,,https://x.com/Kazuchika_Iwata,https://www.iwata-kazuchika.com/,
岩谷 良平,維新,衆議院議員,大阪13,,https://x.com/iwatani_ryohei,https://r-iwatani.com/profile/,
岩屋 毅,自民,衆議院議員,大分3,,https://x.com/i/grok/share/JwScZNNoH8NrNPRVseBDj4y2d,https://www.jimin.jp/member/100390.html,
上田 英俊,自民,衆議院議員,富山2,,見つかりませんでした,https://ueda-eishun.com/,
上野 賢一郎,自民,衆議院議員,滋賀2,,https://x.com/Ueno_Kenichiro,https://www.uenokenichiro.jp/profile,
上村 英明,れ新,衆議院議員,（比）東海,,https://x.com/un18urakawa,https://reiwa-shinsengumi.com/member/hideakiuemura/,
浮島 智子,公明,衆議院議員,（比）近畿,,https://x.com/Tomo_Ukishima,https://www.t-ukishima.net/profile/profile.html,
臼木 秀剛,国民,衆議院議員,（比）北海道,,見つかりませんでした,https://new-kokumin.jp/member/usuki-hidetake,
梅谷 守,立憲,衆議院議員,新潟5,,https://x.com/umetani_m,https://www.umetani.net/,
梅村 聡,維新,衆議院議員,大阪5,,https://x.com/umemura_ishin,https://www.umemurasatoshi.com/profile/,
浦野 靖人,維新,衆議院議員,大阪15,,https://x.com/uranoyasuto,https://uranoyasuto.net/profile,
うるま 譲司,維新,衆議院議員,大阪8,,https://x.com/urumageorge,https://uruma.osaka.jp/,
江田 憲司,立憲,衆議院議員,神奈川8,,https://x.com/edaoffice,http://www.eda-k.net/,
枝野 幸男,立憲,衆議院議員,埼玉5,,https://x.com/edanoyukio0531,https://www.edano.gr.jp/,
江渡 聡徳,自民,衆議院議員,（比）東北,,https://x.com/eto_akinori,http://www.eto-akinori.jp/,
江藤 拓,自民,衆議院議員,宮崎2,,https://x.com/etoh_taku,https://eto-taku.jp/profile/,
英利アルフィヤ,自民,衆議院議員,（比）南関東,,https://x.com/eri_arfiya,https://www.jimin.jp/member/203681.html,
遠藤 敬,維新,衆議院議員,大阪18,,見つかりませんでした,https://endo-takashi.jp/%E3%83%97%E3%83%AD%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB/,
遠藤 利明,自民,衆議院議員,山形1,,https://x.com/team_toshiaki,https://e-toshiaki.jp/profile-2/,
大石 あきこ,れ新,衆議院議員,（比）近畿,,https://x.com/oishiakiko,https://www.oishiakiko.net/profille/,
大岡 敏孝,自民,衆議院議員,（比）近畿,,https://x.com/OookaToshitaka,https://oooka.com/profile/,
大河原まさこ,立憲,衆議院議員,東京21,,https://x.com/Waku2_ookawara,https://ookawaramasako.com/profile,
大串 博志,立憲,衆議院議員,佐賀2,,https://x.com/OogushiHiroshi,https://oogushi.com/%E3%83%97%E3%83%AD%E3%83%95%E3%82%A3%E3%83%BC%E3%83%AB,
大串 正樹,自民,衆議院議員,（比）近畿,,https://x.com/Ogushi_Masaki,https://m-ogushi.com/,
逢坂 誠二,立憲,衆議院議員,北海道8,,https://x.com/seiji_ohsaka,https://ohsaka.jp/,
大島 敦,立憲,衆議院議員,埼玉6,,https://x.com/rokuko_again,https://oshimaatsushi.com/profile,
大空 幸星,自民,衆議院議員,（比）東京,,見つかりませんでした,https://www.jimin.jp/member/209123.html,
おおたけりえ,立憲,衆議院議員,（比）東海,,https://x.com/rie20070422,https://www.ootakerie.jp/prof.html,
大塚 小百合,立憲,衆議院議員,神奈川20,,https://x.com/sayuriohorai,https://sayurio.com/profile/,
おおつき紅葉,立憲,衆議院議員,北海道4,,https://x.com/kurehaotsuki,https://kurehaotsuki.jp/,
大西 健介,立憲,衆議院議員,愛知13,,https://x.com/oniken0024,https://www.oniken-web.jp/,
大西 洋平,自民,衆議院議員,東京16,,https://x.com/0024youhei,https://youhei.me/profile/,
大野 敬太郎,自民,衆議院議員,香川3,,https://x.com/keitaro_ohno,https://keitaro-ohno.com/,
大森 江里子,公明,衆議院議員,（比）東京,,https://x.com/eriko_omori,https://www.komei.or.jp/member/detail/13026090,
岡島 一正,立憲,衆議院議員,（比）南関東,,https://x.com/kazu_okajima,https://okajima-k.com/,
岡田 克也,立憲,衆議院議員,三重3,,https://x.com/okada_katsuya,https://www.katsuya.net/,
岡田 悟,立憲,衆議院議員,（比）近畿,,https://x.com/occupy012123,https://cdp-japan.jp/member/5670,
岡田 華子,立憲,衆議院議員,青森3,,https://x.com/Okada_Hanako,https://hanako-okada.com/profile-page/,
緒方 林太郎,有志,衆議院議員,福岡9,,見つかりませんでした,https://www.rinta.jp/profile/,
岡野 純子,国民,衆議院議員,（比）南関東,,https://x.com/junko_okano,https://okanojunko.jp/profile.html,
岡本 あき子,立憲,衆議院議員,宮城1,,https://x.com/a_okamotooffice,https://okamotoakiko.net/,
岡本 三成,公明,衆議院議員,東京29,,https://x.com/okamoto3nari,https://www.m-okamoto.jp/profile/,
岡本 充功,立憲,衆議院議員,愛知9,,https://x.com/mitsunori_ok,http://mitsunori.net/profile/,
小川 淳也,立憲,衆議院議員,香川1,,https://x.com/junyaog,https://www.junbo.org/profile/profile.html,
奥下 剛光,維新,衆議院議員,大阪7,,見つかりませんでした,https://www.shugiin.go.jp/internet/itdb_giinprof.nsf/html/profile/104.html,
奥野 総一郎,立憲,衆議院議員,千葉9,,https://x.com/sokuno2,https://s-okuno.jp/,
小熊 慎司,立憲,衆議院議員,福島3,,https://x.com/oguma_shinji,https://oguma-s.com/profile/,
尾崎 正直,自民,衆議院議員,高知2,,https://x.com/ozaki_masanao,https://www.jimin.jp/member/202157.html,
小沢 一郎,立憲,衆議院議員,岩手3,,https://x.com/ozawa_jimusho,https://www.ozawa-ichiro.jp/,
小竹 凱,国民,衆議院議員,（比）北陸信越,,見つかりませんでした,https://new-kokumin.jp/member/odake-kai,
落合 貴之,立憲,衆議院議員,東京6,,https://x.com/ochiaitakayuki,https://www.ochiaitakayuki.com/profile,
尾辻 かな子,立憲,衆議院議員,（比）近畿,,https://x.com/otsujikanako,https://otsuji.club/profile/index.html,
鬼木 誠,自民,衆議院議員,（比）九州,,https://x.com/onikidon,https://onikimakoto.com/profile/,
小野寺 五典,自民,衆議院議員,宮城5,,https://x.com/itsunori510,https://www.itsunori.com/,
小渕 優子,自民,衆議院議員,群馬5,,見つかりませんでした,https://www.obuchiyuko.com/profile/index.php,
</file>

<file path="backend/data/mockData.js">
// backend/data/mockData.js

const { v4: uuidv4 } = require('uuid');

// ----------------------------------------------------
// ユーティリティ関数
// ----------------------------------------------------

// ランダムな日付を生成 (最近のデータとして調整)
const getRandomDate = (start, end) => {
    return new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
};

// ----------------------------------------------------
// 1. 基本データ定義 (ユーザーと議員)
// ----------------------------------------------------

const mockUsers = [
    {
        id: 'user-123',
        email: 'user@example.com',
        displayName: '市民 太郎',
        district: '世田谷区',
        role: 'user',
        password: 'password123', // ログインモック用にパスワードを追加 (実際はハッシュ化)
    },
];

const mockMembers = [
    {
        id: 'member-001',
        name: '佐藤 一郎',
        photoUrl: 'https://picsum.photos/seed/member001/100/100',
        affiliation: '未来創造会',
        district: '世田谷区',
        party: '無所属',
        position: '環境福祉委員会 委員長',
        biography: '地域に根ざした活動をモットーに、教育環境の改善と高齢者福祉の充実に尽力しています。過去10年間、一貫して住民目線の政治を実現してきました。',
        website: 'https://satou-ichiro.jp',
        twitterHandle: 'satou_ichiro',
    },
    {
        id: 'member-002',
        name: '田中 花子',
        photoUrl: 'https://picsum.photos/seed/member002/100/100',
        affiliation: '改革ネット',
        district: '渋谷区',
        party: '市民党',
        position: '議会運営委員会 副委員長',
        biography: 'ITを活用した行政の効率化を推進し、若者が住みやすいまちづくりを目指します。デジタルデバイド解消にも積極的に取り組んでいます。',
        website: 'https://tanaka-hanako.net',
        twitterHandle: 'tanaka_hanako',
    },
    {
        id: 'member-003',
        name: '山田 健太',
        photoUrl: 'https://picsum.photos/seed/member003/100/100',
        affiliation: '緑の会',
        district: '新宿区',
        party: '日本緑の党',
        position: '一般議員',
        biography: '公園の緑化や再生可能エネルギーの導入を訴え、持続可能な地域社会の実現を目指します。',
        website: 'https://yamada-kenta.org',
        twitterHandle: 'yamada_kenta',
    },
];

// ----------------------------------------------------
// 2. 公約と活動記録のデータ生成
// ----------------------------------------------------

// 全公約のリスト
const allPledges = mockMembers.flatMap(member => [
    {
        id: uuidv4(),
        memberId: member.id,
        title: '小学校の給食費完全無償化',
        description: '子育て世帯の負担軽減のため、市立小学校の給食費を議会任期中に完全に無償化します。',
        status: 'in_progress',
        supportCount: 1500,
        opposeCount: 300,
    },
    {
        id: uuidv4(),
        memberId: member.id,
        title: '駅前の再開発計画見直し',
        description: '住民説明会を再度実施し、地域住民の意見を反映した形での駅前再開発計画を提案します。',
        status: 'pending',
        supportCount: 800,
        opposeCount: 1200,
    },
    {
        id: uuidv4(),
        memberId: member.id,
        title: '地域ネコの不妊去勢手術助成強化',
        description: '地域ネコの保護活動支援として、不妊去勢手術への助成金を大幅に増やし、年間処理数を倍増させます。',
        status: 'completed',
        supportCount: 2500,
        opposeCount: 50,
    },
]);

// 全活動記録のリスト
const allActivityLogs = mockMembers.flatMap(member => [
    {
        id: uuidv4(),
        memberId: member.id,
        title: '【活動報告】高齢者施設を視察',
        content: '〇〇地域にある高齢者施設を訪問し、現場の職員や入居者の方々から直接お話を伺いました。特に人手不足の問題が深刻であることを認識しました。',
        createdAt: getRandomDate(new Date(2025, 0, 1), new Date(2025, 3, 30)).toISOString(),
        commentCount: 45,
    },
    {
        id: uuidv4(),
        memberId: member.id,
        title: '【議会質問】災害時の情報伝達について',
        content: '本日の定例議会にて、地震などの大規模災害発生時における外国人居住者への多言語情報伝達の課題について質問を行いました。改善策を当局に求めました。',
        createdAt: getRandomDate(new Date(2025, 4, 1), new Date(2025, 7, 30)).toISOString(),
        commentCount: 22,
    },
    {
        id: uuidv4(),
        memberId: member.id,
        title: '地域イベントに参加しました',
        content: '今週末に開催された〇〇まつりに参加し、多くの住民の方々と交流させていただきました。皆さんの笑顔が私の活動の原動力です。',
        createdAt: getRandomDate(new Date(2025, 8, 1), new Date(2025, 10, 30)).toISOString(),
        commentCount: 10,
    },
]);

// ----------------------------------------------------
// 3. 最終的なデータセットを組み立て (議員の詳細情報として公約と活動記録を紐づける)
// ----------------------------------------------------

const members = mockMembers.map(member => {
    // 💡 詳細ページに必要な情報: その議員に紐づく公約と活動記録をフィルタリング
    const memberPledges = allPledges.filter(p => p.memberId === member.id);
    const memberActivityLogs = allActivityLogs.filter(a => a.memberId === member.id);

    return {
        ...member,
        // 💡 一覧表示に必要なカウント情報
        pledgesCount: memberPledges.length,
        activityLogsCount: memberActivityLogs.length,
        // 💡 詳細ページに必要な情報 (エラー2の解決)
        pledges: memberPledges, 
        activityLogs: memberActivityLogs,
    };
});

// ----------------------------------------------------
// 4. エクスポート
// ----------------------------------------------------

module.exports = {
    users: mockUsers,
    members,
    pledges: allPledges,
    activityLogs: allActivityLogs.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()),
};
</file>

<file path="backend/modules/reactions/reactions.entity.ts">
import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, Unique } from 'typeorm';

@Entity('reactions')
// 1ユーザー1対象で1レコードにする（typeは切り替えで更新）
@Unique(['userId', 'targetType', 'targetId'])
export class Reaction {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  userId: number;

  @Column()
  targetType: string; // post | comment | pledge | activity_log

  @Column()
  targetId: number;

  @Column()
  type: string; // like | agree | disagree

  @CreateDateColumn()
  createdAt: Date;
}
</file>

<file path="backend/scripts/seed-ng-words.ts">
import { DataSource } from 'typeorm';
import { NgWord } from '../src/entities/ng-word.entity';
import 'dotenv/config';

async function run() {
  const ds = new DataSource({
    type: 'better-sqlite3',
    database: process.env.DB_FILE || 'dev.sqlite',
    entities: [NgWord],
    synchronize: false,
  });
  await ds.initialize();
  const repo = ds.getRepository(NgWord);
  const list = ['死ね', '殺す', '詐欺', '違法']; // 例
  for (const w of list) {
    const exist = await repo.findOne({ where: { word: w } });
    if (!exist) {
      await repo.save(repo.create({ word: w }));
      console.log('Added NG word:', w);
    }
  }
  await ds.destroy();
}
run().catch(e => { console.error(e); process.exit(1); });
</file>

<file path="backend/src/common/decorators/public.decorator.ts">
import { SetMetadata } from '@nestjs/common';
export const IS_PUBLIC_KEY = 'isPublic';
export const Public = () => SetMetadata(IS_PUBLIC_KEY, true);
</file>

<file path="backend/src/common/middleware/rate-limit.middleware.ts">
import { Injectable, NestMiddleware, HttpException, HttpStatus } from '@nestjs/common';

interface Bucket {
  count: number;
  expiresAt: number;
}

@Injectable()
export class RateLimitMiddleware implements NestMiddleware {
  private buckets = new Map<string, Bucket>();

  use(req: any, _res: any, next: () => void) {
    const windowMs = Number(process.env.RATE_LIMIT_WINDOW_MS || 60000);
    const max = Number(process.env.RATE_LIMIT_MAX || 120);
    const key = req.ip || 'unknown';
    const now = Date.now();
    const bucket = this.buckets.get(key);

    if (!bucket || bucket.expiresAt < now) {
      this.buckets.set(key, { count: 1, expiresAt: now + windowMs });
      return next();
    }

    if (bucket.count >= max) {
      throw new HttpException('Rate limit exceeded', HttpStatus.TOO_MANY_REQUESTS);
    }

    bucket.count++;
    return next();
  }
}
</file>

<file path="backend/src/entities/comment-mention.entity.ts">
import { Column, CreateDateColumn, Entity, Index, ManyToOne, PrimaryGeneratedColumn } from 'typeorm';
import { Comment } from './comment.entity';

@Entity('comment_mentions')
@Index(['commentId', 'mentionedUserId'], { unique: true })
export class CommentMention {
  @PrimaryGeneratedColumn()
  id: number;

  @Index()
  @Column()
  commentId: number;

  @ManyToOne(() => Comment, (c) => c.mentions, { onDelete: 'CASCADE' })
  comment: Comment;

  @Index()
  @Column()
  mentionedUserId: number;

  // User 参照は暫定的に外します
  // @ManyToOne(() => User, { onDelete: 'CASCADE' })
  // mentionedUser: User;

  @CreateDateColumn()
  createdAt: Date;
}
</file>

<file path="backend/src/entities/funding.entity.ts">
import { Column, CreateDateColumn, Entity, Index, PrimaryGeneratedColumn, UpdateDateColumn } from 'typeorm';

@Entity('fundings')
export class Funding {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  @Index()
  @Column({ type: 'varchar', length: 64 })
  politicianId!: string;

  @Index()
  @Column({ type: 'varchar', length: 64 })
  actorUserId!: string;

  @Column({ type: 'int' })
  amount!: number;

  @Column({ type: 'varchar', length: 256, nullable: true })
  note!: string | null;

  @CreateDateColumn()
  createdAt!: Date;

  @UpdateDateColumn()
  updatedAt!: Date;
}
</file>

<file path="backend/src/entities/party.entity.ts">
import { Column, CreateDateColumn, Entity, PrimaryGeneratedColumn, UpdateDateColumn } from 'typeorm';

@Entity('parties')
export class Party {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  name: string;

  @Column({ length: 16 })
  abbreviation: string;

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
</file>

<file path="backend/src/entities/politician.entity.ts">
import { Column, CreateDateColumn, Entity, Index, PrimaryGeneratedColumn, UpdateDateColumn } from 'typeorm';

@Entity('politicians')
export class Politician {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  @Index()
  @Column({ type: 'varchar', length: 128 })
  name!: string;

  @Index()
  @Column({ type: 'varchar', length: 128, nullable: true })
  nickname!: string | null;

  @Index()
  @Column({ type: 'varchar', length: 64, nullable: true })
  regionId!: string | null;

  @Index()
  @Column({ type: 'varchar', length: 64, nullable: true })
  partyId!: string | null;

  @CreateDateColumn()
  createdAt!: Date;

  @UpdateDateColumn()
  updatedAt!: Date;
}
</file>

<file path="backend/src/entities/reaction.entity.ts">
import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, Index } from 'typeorm';

@Entity('reactions')
@Index(['targetId', 'userId'], { unique: true })
export class Reaction {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  targetId: string;

  @Column()
  userId: string;

  @Column({ type: 'varchar' })
  type: 'like' | 'agree' | 'disagree';

  @CreateDateColumn()
  createdAt: Date;
}
</file>

<file path="backend/src/entities/region.entity.ts">
import { Column, CreateDateColumn, Entity, PrimaryGeneratedColumn, UpdateDateColumn } from 'typeorm';

@Entity('regions')
export class Region {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  name: string;

  @Column()
  prefectureCode: string;

  @Column()
  cityCode: string;

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
</file>

<file path="backend/src/entities/survey-response.entity.ts">
import { Column, CreateDateColumn, Entity, Index, ManyToOne, PrimaryGeneratedColumn, Unique } from 'typeorm';
import { Survey } from './survey.entity';
import { User } from './user.entity';

@Entity('survey_responses')
@Unique('UQ_survey_respondent', ['surveyId', 'respondentUserId'])
export class SurveyResponse {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Index()
  @Column()
  surveyId: string;

  @ManyToOne(() => Survey, { onDelete: 'CASCADE' })
  survey: Survey;

  @Index()
  @Column()
  respondentUserId: string;

  @ManyToOne(() => User, { onDelete: 'CASCADE' })
  respondent: User;

  @Column({ type: 'json' })
  answers: Record<string, any>;

  @CreateDateColumn()
  createdAt: Date;
}
</file>

<file path="backend/src/entities/survey.entity.ts">
import { Column, CreateDateColumn, Entity, PrimaryGeneratedColumn, UpdateDateColumn } from 'typeorm';

@Entity('surveys')
export class Survey {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ length: 256 })
  title: string;

  @Column({ type: 'text', nullable: true })
  description: string | null;

  @Column({ type: 'json' })
  questions: Array<{ id: string; type: 'single' | 'multi' | 'text'; text: string; options?: string[] }>;

  // 配信対象の条件（簡易JSON）
  @Column({ type: 'json', nullable: true })
  targetCriteria: { regionIds?: string[]; ageGroups?: string[]; partyIds?: string[] } | null;

  @Column({ type: 'timestamptz', nullable: true })
  startAt: Date | null;

  @Column({ type: 'timestamptz', nullable: true })
  endAt: Date | null;

  @CreateDateColumn()
  createdAt: Date;

  @UpdateDateColumn()
  updatedAt: Date;
}
</file>

<file path="backend/src/entities/wallet-transaction.entity.ts">
import { Column, CreateDateColumn, Entity, Index, ManyToOne, PrimaryGeneratedColumn } from 'typeorm';
import { User } from './user.entity';
import { WalletTransactionType } from '../enums/wallet-transaction-type.enum';
import { Currency } from '../enums/currency.enum';

@Entity('wallet_transactions')
export class WalletTransaction {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Index()
  @Column()
  userId: string;

  @ManyToOne(() => User, { onDelete: 'CASCADE' })
  user: User;

  @Column({ type: 'enum', enum: WalletTransactionType })
  type: WalletTransactionType;

  @Column({ type: 'int' })
  amount: number; // JPY

  @Column({ type: 'enum', enum: Currency, default: Currency.JPY })
  currency: Currency;

  @Column({ type: 'text', nullable: true })
  memo: string | null;

  @CreateDateColumn()
  createdAt: Date;
}
</file>

<file path="backend/src/enums/age-group.enum.ts">
export enum AgeGroup {
  TEEN = 'teen',
  TWENTIES = 'twenties',
  THIRTIES = 'thirties',
  FORTIES = 'forties',
  FIFTIES = 'fifties',
  SIXTIES_PLUS = 'sixties_plus',
}
</file>

<file path="backend/src/enums/currency.enum.ts">
export enum Currency {
  JPY = 'JPY',
}
</file>

<file path="backend/src/enums/media-category.enum.ts">
export enum MediaCategory {
  POST = 'post',
  COMMENT = 'comment',
  KYC = 'kyc',
}
</file>

<file path="backend/src/enums/media-type.enum.ts">
export enum MediaType {
  IMAGE = 'image',
  VIDEO = 'video',
  DOCUMENT = 'document',
}
</file>

<file path="backend/src/enums/notification-type.enum.ts">
export enum NotificationType {
  SURVEY = 'survey',
  MENTION = 'mention',
  SYSTEM = 'system',
}
</file>

<file path="backend/src/enums/post-type.enum.ts">
export enum PostType {
  ACTIVITY = 'activity',
  PLEDGE = 'pledge',
  QUESTION = 'question',
  NEWS = 'news',
}
</file>

<file path="backend/src/enums/reaction-type.enum.ts">
export enum ReactionType {
  LIKE = 'like',
  AGREE = 'agree',
  DISAGREE = 'disagree',
}
</file>

<file path="backend/src/enums/vote-choice.enum.ts">
export enum VoteChoice {
  AGREE = 'agree',
  DISAGREE = 'disagree',
}
</file>

<file path="backend/src/enums/wallet-transaction-type.enum.ts">
export enum WalletTransactionType {
  REWARD = 'reward',
  ADJUSTMENT = 'adjustment',
}
</file>

<file path="backend/src/guards/role.guard.ts">
import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common';

@Injectable()
export class RoleGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const req = context.switchToHttp().getRequest();
    if (!req.user) {
      req.user = { id: 1, role: 'member' };
    }
    return true;
  }
}
</file>

<file path="backend/src/health/health.controller.ts">
import { Controller, Get } from '@nestjs/common';
import { HealthService } from './health.service';
import { Public } from '../common/decorators/public.decorator';

@Controller('health')
export class HealthController {
  constructor(private readonly health: HealthService) {}

  @Public()
  @Get()
  app() {
    return this.health.app();
  }

  @Public()
  @Get('db')
  async db() {
    return this.health.db();
  }
}
</file>

<file path="backend/src/health/health.module.ts">
import { Module } from '@nestjs/common';
import { HealthController } from './health.controller';
import { HealthService } from './health.service';

@Module({
  controllers: [HealthController],
  providers: [HealthService],
})
export class HealthModule {}
</file>

<file path="backend/src/health/health.service.ts">
import { Injectable } from '@nestjs/common';
import { DataSource } from 'typeorm';

@Injectable()
export class HealthService {
  constructor(private readonly dataSource: DataSource) {}

  app() {
    return {
      status: 'ok',
      timestamp: new Date().toISOString(),
      env: process.env.NODE_ENV || 'development',
    };
  }

  async db() {
    try {
      await this.dataSource.query('SELECT 1');
      return {
        status: 'ok',
        database: (this.dataSource.options as any).database,
        type: this.dataSource.options.type,
        timestamp: new Date().toISOString(),
      };
    } catch (e: any) {
      return {
        status: 'error',
        error: e?.message || String(e),
        timestamp: new Date().toISOString(),
      };
    }
  }
}
</file>

<file path="backend/src/modules/activity-funds/activity-funds.service.ts">
// backend/src/modules/activity-funds/activity-funds.service.ts

import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { ActivityFund } from '../../entities/activity-fund.entity';
import { CreateActivityFundDto } from './dto/create-activity-fund.dto';
import { UpdateActivityFundDto } from './dto/update-activity-fund.dto'; 

@Injectable()
export class ActivityFundsService {
  constructor(
    @InjectRepository(ActivityFund)
    private activityFundRepository: Repository<ActivityFund>,
  ) {}

  // 🚨 修正: 戻り値の型を Promise<ActivityFund> と明示
  async create(createActivityFundDto: CreateActivityFundDto): Promise<ActivityFund> {
    const activityFund = this.activityFundRepository.create(createActivityFundDto as any); 
    
    // 🚨 最終修正: 二重アサーションで型を強制上書き
    return this.activityFundRepository.save(activityFund) as unknown as ActivityFund; 
  }

  async findAll(): Promise<ActivityFund[]> {
    return this.activityFundRepository.find({ 
      relations: ['member'],
      order: { fiscalYear: 'DESC', expenseDate: 'DESC' }, 
    });
  }

  async findOne(id: string): Promise<ActivityFund> {
    const fund = await this.activityFundRepository.findOne({ where: { id }, relations: ['member'] });
    if (!fund) {
      throw new NotFoundException(`ActivityFund with ID "${id}" not found`);
    }
    return fund;
  }
  
  async update(id: string, updateActivityFundDto: UpdateActivityFundDto): Promise<ActivityFund> {
    const fund = await this.findOne(id);
    this.activityFundRepository.merge(fund, updateActivityFundDto);
    return this.activityFundRepository.save(fund);
  }

  async remove(id: string): Promise<{ deleted: true; id: string }> {
    const result = await this.activityFundRepository.delete(id);
    if (result.affected === 0) {
      throw new NotFoundException(`ActivityFund with ID "${id}" not found`);
    }
    return { deleted: true, id };
  }
  
  async importFromCsv(csvData: any[], memberId: string): Promise<{ importedCount: number }> {
    console.log(`Importing funds for member ${memberId}. CSV rows: ${csvData.length}`);
    return { importedCount: 0 }; 
  }

  async getStats(): Promise<any> {
    return { totalFunds: await this.activityFundRepository.count(), totalAmount: 0 };
  }

  async getCategorySummary(memberId: string, fiscalYear?: number): Promise<any> {
    return { memberId, fiscalYear, summary: [] };
  }
  
  async findByMember(memberId: string, fiscalYear?: number): Promise<ActivityFund[]> {
    const where: any = { memberId };
    if (fiscalYear) {
      where.fiscalYear = fiscalYear;
    }
    return this.activityFundRepository.find({ 
      where, 
      relations: ['member'],
      order: { fiscalYear: 'DESC', expenseDate: 'DESC' },
    });
  }
}
</file>

<file path="backend/src/modules/admin-search/admin-search.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { AdminSearchController } from './admin-search.controller';
import { Post } from '../posts/post.entity';
import { Notification } from '../../entities/notification.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Post, Notification])],
  controllers: [AdminSearchController],
})
export class AdminSearchModule {}
</file>

<file path="backend/src/modules/audit/audit.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { AuditLog } from '../../entities/audit-log.entity';
import { AuditService } from './audit.service';

@Module({
  imports: [TypeOrmModule.forFeature([AuditLog])],
  providers: [AuditService],
  exports: [AuditService],
})
export class AuditModule {}
</file>

<file path="backend/src/modules/audit/audit.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { AuditLog } from '../../entities/audit-log.entity';

@Injectable()
export class AuditService {
  constructor(@InjectRepository(AuditLog) private readonly logs: Repository<AuditLog>) {}

  async record(input: {
    actorUserId?: string | null;
    action: string;
    targetType?: string | null;
    targetId?: string | null;
    meta?: Record<string, any> | null;
  }) {
    const log = this.logs.create({
      actorUserId: input.actorUserId ?? null,
      action: input.action,
      targetType: input.targetType ?? null,
      targetId: input.targetId ?? null,
      meta: input.meta ?? null,
    });
    return this.logs.save(log);
  }
}
</file>

<file path="backend/src/modules/auth/dto/register.dto.ts">
import { IsEmail, IsIn, IsInt, IsOptional, IsString, Min } from 'class-validator';

export class RegisterDto {
  @IsEmail()
  email: string;

  @IsString()
  password: string;

  // role は通常 'user' 固定（政治家は管理側で昇格）
  @IsOptional()
  @IsIn(['user'])
  role?: 'user';

  // KYC
  @IsString()
  name: string;

  @IsInt()
  @Min(18)
  age: number;

  @IsString()
  addressPref: string;

  @IsString()
  addressCity: string;

  @IsOptional()
  @IsString()
  phone?: string;

  @IsOptional()
  @IsString()
  governmentIdUrl?: string;
}
</file>

<file path="backend/src/modules/auth/guards/admin.guard.ts">
import { Injectable, CanActivate, ExecutionContext, ForbiddenException } from '@nestjs/common';
import { Observable } from 'rxjs';

@Injectable()
export class AdminGuard implements CanActivate {
  canActivate(
    context: ExecutionContext,
  ): boolean | Promise<boolean> | Observable<boolean> {
    const request = context.switchToHttp().getRequest();
    const user = request.user;

    if (!user) {
      throw new ForbiddenException('User not authenticated');
    }

    if (user.role !== 'admin') {
      throw new ForbiddenException('Admin access required');
    }

    return true;
  }
}
</file>

<file path="backend/src/modules/auth/guards/firebase-auth.guard.ts">
import { Injectable, ExecutionContext } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class FirebaseAuthGuard extends AuthGuard('firebase') {
  canActivate(context: ExecutionContext) {
    return super.canActivate(context);
  }
}
</file>

<file path="backend/src/modules/auth/dev-seed.controller.ts">
import { Body, Controller, Post } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import * as bcrypt from 'bcryptjs';
import { User } from 'src/entities/user.entity';

@Controller('auth/dev-seed')
export class DevSeedController {
  constructor(@InjectRepository(User) private readonly userRepo: Repository<User>) {}

  @Post('user')
  async seedUser(
    @Body()
    body: {
      email: string;
      password: string;
      name?: string;
      nickname?: string | null;
      phoneNumber?: string | null;
      ageGroup?: string | null;
    },
  ) {
    const exists = await this.userRepo.findOne({ where: { email: body.email } });
    if (exists) {
      return { ok: true, id: exists.id };
    }

    const user = this.userRepo.create({
      email: body.email,
      passwordHash: await bcrypt.hash(body.password, 10),
      name: body.name || null,
      nickname: body.nickname ?? null,
      phoneNumber: body.phoneNumber ?? null,
      ageGroup: body.ageGroup ?? null,
      role: 'citizen',
      status: 'active',
      emailVerified: false,
      phoneVerified: false,
    } as any);

    const saved = await this.userRepo.save(user); // save は単体 User を返す前提
    const id = (saved as any)?.id; // 厳密型付けを避け、never を回避
    return { ok: true, id };
  }
}
</file>

<file path="backend/src/modules/auth/firebase.provider.ts">
import { ConfigService } from '@nestjs/config';
import { Provider } from '@nestjs/common';
import * as admin from 'firebase-admin';

export const FIREBASE_ADMIN = 'FIREBASE_ADMIN';

export const FirebaseAdminProvider: Provider = {
  provide: FIREBASE_ADMIN,
  inject: [ConfigService],
  useFactory: (config: ConfigService) => {
    const projectId = config.get<string>('FIREBASE_PROJECT_ID');
    const clientEmail = config.get<string>('FIREBASE_CLIENT_EMAIL');
    const privateKey = config.get<string>('FIREBASE_PRIVATE_KEY');

    // まだ値が無い場合はダミー初期化（本番用キーを後で設定）
    if (!projectId || !clientEmail || !privateKey) {
      return admin.initializeApp();
    }

    return admin.initializeApp({
      credential: admin.credential.cert({
        projectId,
        clientEmail,
        privateKey: privateKey.replace(/\\n/g, '\n'),
      }),
    });
  },
};
</file>

<file path="backend/src/modules/auth/jwt-auth.guard.ts">
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {}
</file>

<file path="backend/src/modules/auth/register.controller.ts">
import { Body, Controller, Post, UploadedFiles, UseInterceptors } from '@nestjs/common';
import { RegisterService } from './register.service';
import { RegisterDto } from './register.dto';
import { FileFieldsInterceptor } from '@nestjs/platform-express';

@Controller('auth')
export class RegisterController {
  constructor(private readonly registerService: RegisterService) {}

  @Post('register')
  @UseInterceptors(
    FileFieldsInterceptor([
      { name: 'license', maxCount: 1 },
      { name: 'mynumber', maxCount: 1 },
    ])
  )
  async register(
    @Body() dto: RegisterDto,
    @UploadedFiles()
    files: {
      license?: Express.Multer.File[];
      mynumber?: Express.Multer.File[];
    },
  ) {
    const licenseFile = files.license?.[0];
    const mynumberFile = files.mynumber?.[0];

    const user = await this.registerService.register({
      email: dto.email,
      name: dto.name,
      password: dto.password,
      phone: dto.phone,
      addressPrefecture: dto.addressPrefecture,
      addressCity: dto.addressCity,
      licensePath: licenseFile ? licenseFile.originalname : undefined, // 実運用は保存先のパス/URL
      mynumberPath: mynumberFile ? mynumberFile.originalname : undefined,
    });

    return { user, message: 'Registered successfully' };
  }
}
</file>

<file path="backend/src/modules/auth/register.dto.ts">
import { IsEmail, IsString, MinLength, IsOptional, Matches } from 'class-validator';

export class RegisterDto {
  @IsEmail()
  email: string;

  @IsString()
  @MinLength(8)
  password: string;

  @IsString()
  name: string;

  @IsOptional()
  @Matches(/^[0-9+\-\s]{7,15}$/)
  phone?: string;

  @IsOptional()
  @IsString()
  addressPrefecture?: string;

  @IsOptional()
  @IsString()
  addressCity?: string;

  // ファイルは Multer 経由で受け取るためDTOには含めない（license, mynumber）
}
</file>

<file path="backend/src/modules/auth/register.module.ts">
import { Module } from '@nestjs/common';
import { RegisterController } from './register.controller';
import { RegisterService } from './register.service';

@Module({
  controllers: [RegisterController],
  providers: [RegisterService],
})
export class RegisterModule {}
</file>

<file path="backend/src/modules/auth/register.service.ts">
import { Injectable, BadRequestException } from '@nestjs/common';

type RegisterInput = {
  email: string;
  name: string;
  password: string;
  phone?: string;
  addressPrefecture?: string;
  addressCity?: string;
  licensePath?: string;
  mynumberPath?: string;
};

@Injectable()
export class RegisterService {
  private memoryUsers: Array<RegisterInput & { id: number }> = [];
  private seq = 1;

  async register(input: RegisterInput) {
    if (this.memoryUsers.some((u) => u.email === input.email)) {
      throw new BadRequestException('Email already registered');
    }
    // TODO: bcrypt でハッシュ化（今は省略）
    const user = { id: this.seq++, ...input };
    this.memoryUsers.push(user);
    return user;
  }
}
</file>

<file path="backend/src/modules/comment-likes/comment-likes.controller.ts">
import { Controller, Post, Delete, Param, UseGuards, Request, Get } from '@nestjs/common';
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';
import { CommentLikesService } from './comment-likes.service';

@Controller('comments')
@UseGuards(JwtAuthGuard)
export class CommentLikesController {
  constructor(private readonly svc: CommentLikesService) {}

  @Post(':id/like')
  async like(@Param('id') id: string, @Request() req: any) {
    const l = await this.svc.like(id, req.user.sub);
    return { liked: true, likeId: l.id };
  }

  @Delete(':id/like')
  async unlike(@Param('id') id: string, @Request() req: any) {
    return this.svc.unlike(id, req.user.sub);
  }

  @Get(':id/likes-count')
  async count(@Param('id') id: string) {
    const count = await this.svc.count(id);
    return { count };
  }

  @Get(':id/is-liked')
  async isLiked(@Param('id') id: string, @Request() req: any) {
    const liked = await this.svc.isLiked(id, req.user.sub);
    return { liked };
  }
}
</file>

<file path="backend/src/modules/comment-likes/comment-likes.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { CommentLike } from '../../entities/comment-like.entity';
import { CommentLikesService } from './comment-likes.service';
import { CommentLikesController } from './comment-likes.controller';
import { Comment } from '../comments/comment.entity';

@Module({
  imports: [TypeOrmModule.forFeature([CommentLike, Comment])],
  providers: [CommentLikesService],
  controllers: [CommentLikesController],
  exports: [CommentLikesService],
})
export class CommentLikesModule {}
</file>

<file path="backend/src/modules/comment-likes/comment-likes.service.ts">
import { Injectable, BadRequestException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { CommentLike } from '../../entities/comment-like.entity';
import { Comment } from '../comments/comment.entity';

@Injectable()
export class CommentLikesService {
  constructor(
    @InjectRepository(CommentLike) private readonly likeRepo: Repository<CommentLike>,
    @InjectRepository(Comment) private readonly commentRepo: Repository<Comment>,
  ) {}

  async like(commentId: string, userId: string) {
    const c = await this.commentRepo.findOne({ where: { id: commentId } });
    if (!c) throw new BadRequestException('comment not found');
    const exist = await this.likeRepo.findOne({ where: { commentId, userId } });
    if (exist) return exist;
    const l = this.likeRepo.create({ commentId, userId });
    return this.likeRepo.save(l);
  }

  async unlike(commentId: string, userId: string) {
    const exist = await this.likeRepo.findOne({ where: { commentId, userId } });
    if (!exist) return { deleted: false };
    await this.likeRepo.remove(exist);
    return { deleted: true };
  }

  async count(commentId: string) {
    return this.likeRepo.count({ where: { commentId } });
  }

  async isLiked(commentId: string, userId: string) {
    const exist = await this.likeRepo.findOne({ where: { commentId, userId } });
    return !!exist;
  }
}
</file>

<file path="backend/src/modules/comments/dto/react.dto.ts">
import { IsIn, IsString } from 'class-validator';

export class ReactDto {
  @IsString()
  @IsIn(['agree'])
  type: 'agree';
}
</file>

<file path="backend/src/modules/external-feeds/twitter-rate-limiter.service.ts">
// backend/src/modules/external-feeds/twitter-rate-limiter.service.ts

import { Injectable, Logger, Inject } from '@nestjs/common';
import { CACHE_MANAGER } from '@nestjs/cache-manager';
import type { Cache } from 'cache-manager';

@Injectable()
export class TwitterRateLimiterService {
  private readonly logger = new Logger(TwitterRateLimiterService.name);

  constructor(@Inject(CACHE_MANAGER) private cacheManager: Cache) {}

  async checkRateLimit(): Promise<void> {
    // 修正: undefinedの可能性を考慮
    const remaining = await this.cacheManager.get<number>('twitter:rate:remaining');
    const resetTime = await this.cacheManager.get<number>('twitter:rate:reset');

    // remainingがnullやundefinedでなく、5以下の場合に警告
    if (remaining !== null && remaining !== undefined && remaining <= 5) {
      // resetTimeがnullやundefinedでなく、数値であることを確認
      if (resetTime !== null && resetTime !== undefined) {
        const waitTime = resetTime - Date.now() / 1000;
        if (waitTime > 0) {
          this.logger.warn(`Twitter APIのレート制限に近づいています。${Math.ceil(waitTime)}秒待機します。`);
          await new Promise(resolve => setTimeout(resolve, waitTime * 1000));
        }
      }
    }
  }
}
</file>

<file path="backend/src/modules/funding/funding.controller.ts">
import { Controller, Get, Param, Query, Post, Body, UseGuards, Request } from '@nestjs/common';
import { FundingService } from './funding.service';
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';
import { InjectRepository } from '@nestjs/typeorm';
import { User } from '../../entities/user.entity';
import { Repository } from 'typeorm';

@Controller('funding')
@UseGuards(JwtAuthGuard)
export class FundingController {
  constructor(
    private readonly svc: FundingService,
    @InjectRepository(User) private readonly userRepo: Repository<User>,
  ) {}

  @Get('politicians/:id/records')
  async list(@Param('id') id: string, @Query('from') from?: string, @Query('to') to?: string) {
    return this.svc.list(id, from, to);
  }

  @Get('politicians/:id/summary')
  async summary(@Param('id') id: string, @Query('from') from?: string, @Query('to') to?: string) {
    return this.svc.summary(id, from, to);
  }

  @Post('politicians/:id/records')
  async create(
    @Param('id') id: string,
    @Body() body: { amount: number; category?: string; description?: string; date?: string },
    @Request() req: any,
  ) {
    const actor = await this.userRepo.findOne({ where: { id: req.user.sub } });
    return this.svc.create(id, actor!, body);
  }
}
</file>

<file path="backend/src/modules/funding/funding.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { FundingRecord } from '../../entities/funding-record.entity';
import { FundingService } from './funding.service';
import { FundingController } from './funding.controller';
import { User } from '../../entities/user.entity';

@Module({
  imports: [TypeOrmModule.forFeature([FundingRecord, User])],
  providers: [FundingService],
  controllers: [FundingController],
  exports: [FundingService],
})
export class FundingModule {}
</file>

<file path="backend/src/modules/health/health.controller.ts">
import { Controller, Get } from '@nestjs/common';

@Controller('health')
export class HealthController {
  @Get()
  ping() {
    return { ok: true, timestamp: new Date().toISOString() };
  }
}
</file>

<file path="backend/src/modules/health/health.module.ts">
import { Module } from '@nestjs/common';
import { HealthController } from './health.controller';

@Module({
  controllers: [HealthController],
})
export class HealthModule {}
</file>

<file path="backend/src/modules/mail/mail.module.ts">
import { Module } from '@nestjs/common';
import { MailService } from './mail.service';

@Module({
  providers: [MailService],
  exports: [MailService],
})
export class MailModule {}
</file>

<file path="backend/src/modules/mail/mail.service.ts">
import * as nodemailer from 'nodemailer';
import { Injectable } from '@nestjs/common';

@Injectable()
export class MailService {
  private transporter = nodemailer.createTransport({
    // 開発用: SMTPが無くても送信内容を確認できるJSONトランスポート
    jsonTransport: true,
  });

  async send(opts: { to: string; subject: string; text?: string; html?: string }) {
    const info = await this.transporter.sendMail({
      from: 'no-reply@example.com',
      to: opts.to,
      subject: opts.subject,
      text: opts.text,
      html: opts.html,
    });
    return {
      messageId: (info as any).messageId ?? 'dev',
      envelope: (info as any).envelope,
      accepted: (info as any).accepted,
      rejected: (info as any).rejected,
    };
  }
}
</file>

<file path="backend/src/modules/media/media-asset.entity.ts">
import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn } from 'typeorm';

@Entity('media_assets')
export class MediaAsset {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  url: string;

  @Column()
  type: string;

  @CreateDateColumn()
  createdAt: Date;
}
</file>

<file path="backend/src/modules/moderation/moderation.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { NgWord } from '../../entities/ng-word.entity';
import { NgWordsService } from './ng-words.service';
import { NgWordsController } from './ng-words.controller';

@Module({
  imports: [TypeOrmModule.forFeature([NgWord])],
  providers: [NgWordsService],
  controllers: [NgWordsController],
  exports: [NgWordsService],
})
export class ModerationModule {}
</file>

<file path="backend/src/modules/news-ingest/news-ingest.controller.ts">
import { Controller, Get } from '@nestjs/common';

@Controller('news-ingest')
export class NewsIngestController {
  @Get('health')
  health() {
    return { ok: true };
  }
}
</file>

<file path="backend/src/modules/policies/policies.controller.ts">
import { Controller, Get, Param, Post, Body, UseGuards, Request, Patch } from '@nestjs/common';
import { PoliciesService } from './policies.service';
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { User } from '../../entities/user.entity';

@Controller('policies')
@UseGuards(JwtAuthGuard)
export class PoliciesController {
  constructor(
    private readonly svc: PoliciesService,
    @InjectRepository(User) private readonly userRepo: Repository<User>,
  ) {}

  @Get('politician/:id')
  async list(@Param('id') politicianId: string) {
    return this.svc.list(politicianId);
  }

  @Post('politician/:id')
  async create(
    @Param('id') politicianId: string,
    @Body() body: { title: string; description?: string; category?: string; status?: string },
    @Request() req: any,
  ) {
    const actor = await this.userRepo.findOne({ where: { id: req.user.sub } });
    if (!actor || (actor.role !== 'admin' && actor.id !== politicianId)) {
      throw new (require('@nestjs/common').ForbiddenException)('not allowed');
    }
    return this.svc.create(politicianId, body);
  }

  @Patch(':id')
  async update(
    @Param('id') id: string,
    @Body() patch: any,
    @Request() req: any,
  ) {
    const actor = await this.userRepo.findOne({ where: { id: req.user.sub } });
    if (!actor) throw new (require('@nestjs/common').ForbiddenException)('not allowed');
    return this.svc.update(id, actor, patch);
  }
}
</file>

<file path="backend/src/modules/policies/policies.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Policy } from '../../entities/policy.entity';
import { PoliciesService } from './policies.service';
import { PoliciesController } from './policies.controller';
import { User } from '../../entities/user.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Policy, User])],
  providers: [PoliciesService],
  controllers: [PoliciesController],
  exports: [PoliciesService],
})
export class PoliciesModule {}
</file>

<file path="backend/src/modules/politicians/dto/search-politicians.dto.ts">
import { IsOptional, IsString } from 'class-validator';

export class SearchPoliticiansDto {
  @IsOptional()
  @IsString()
  region?: string; // regionId もしくは名前での検索を想定（本実装で確定）

  @IsOptional()
  @IsString()
  party?: string; // partyId もしくは名前

  @IsOptional()
  @IsString()
  q?: string; // キーワード（名前/プロフィール）
}
</file>

<file path="backend/src/modules/politicians/dto/update-politician.dto.ts">
import { IsInt, IsOptional, IsString, MaxLength, Min } from 'class-validator';

export class UpdatePoliticianDto {
  @IsOptional()
  @IsString()
  bio?: string;

  @IsOptional()
  @IsString()
  partyId?: string;

  @IsOptional()
  @IsInt()
  @Min(18)
  age?: number;

  // pledges は簡易JSON配列として受け取り想定（型安全のためAPI契約で厳密化を推奨）
  @IsOptional()
  pledges?: Array<{ title: string; description?: string }>;

  @IsOptional()
  @IsString()
  @MaxLength(2048)
  fundingReportUrl?: string;
}
</file>

<file path="backend/src/modules/posts/dto/query-posts.dto.ts">
import { IsEnum, IsOptional, IsString } from 'class-validator';
import { PostType } from '../../../enums/post-type.enum';

export class QueryPostsDto {
  @IsOptional()
  @IsEnum(PostType)
  type?: PostType;

  @IsOptional()
  @IsString()
  region?: string;

  @IsOptional()
  @IsString()
  q?: string;

  @IsOptional()
  @IsString()
  cursor?: string;

  @IsOptional()
  @IsString()
  limit?: string;
}
</file>

<file path="backend/src/modules/reactions/dto/react.dto.ts">
import { IsString, IsNumber } from 'class-validator';

export class ReactDto {
  @IsString()
  targetType: string;

  @IsNumber()
  targetId: number;

  @IsString()
  type: string;
}
</file>

<file path="backend/src/modules/reactions/reaction.entity.ts">
import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, Unique } from 'typeorm';

@Entity('reactions')
@Unique(['userId', 'targetType', 'targetId', 'type'])
export class Reaction {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  userId: number;

  @Column()
  targetType: string; // post | comment | pledge | activity_log

  @Column()
  targetId: number;

  @Column()
  type: string; // like | agree | disagree

  @CreateDateColumn()
  createdAt: Date;
}
</file>

<file path="backend/src/modules/reports/dto/mod-action.dto.ts">
import { IsString, IsIn } from 'class-validator';

export class ModActionDto {
  @IsString()
  reportId: string;

  @IsString()
  @IsIn(['accept', 'reject'])
  action: 'accept' | 'reject';
}
</file>

<file path="backend/src/modules/scheduled-posts/scheduled-posts.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ScheduledPost } from '../../entities/scheduled-post.entity';
import { ScheduledPostsService } from './scheduled-posts.service';
import { ScheduledPostsController } from './scheduled-posts.controller';
import { User } from '../../entities/user.entity';
import { Post } from '../posts/post.entity';
import { ModerationModule } from '../moderation/moderation.module';

@Module({
  imports: [TypeOrmModule.forFeature([ScheduledPost, User, Post]), ModerationModule],
  providers: [ScheduledPostsService],
  controllers: [ScheduledPostsController],
  exports: [ScheduledPostsService],
})
export class ScheduledPostsModule {}
</file>

<file path="backend/src/modules/surveys/dto/create-response.dto.ts">
import { IsObject } from 'class-validator';

export class CreateSurveyResponseDto {
  @IsObject()
  answers: Record<string, any>;
}
</file>

<file path="backend/src/modules/surveys/surveys.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { SurveysService } from './surveys.service';
import { SurveysController } from './surveys.controller';
import { Survey } from '../../entities/survey.entity';
import { SurveyResponse } from '../../entities/survey-response.entity';
import { User } from '../../entities/user.entity';
import { WalletTransaction } from '../../entities/wallet-transaction.entity';
import { NotificationsModule } from '../notifications/notifications.module';

@Module({
  imports: [TypeOrmModule.forFeature([Survey, SurveyResponse, User, WalletTransaction]), NotificationsModule],
  controllers: [SurveysController],
  providers: [SurveysService],
  exports: [SurveysService],
})
export class SurveysModule {}
</file>

<file path="backend/src/modules/users/dto/user.dto.ts">
import { IsEmail, IsOptional, IsString, IsIn, IsInt, Min } from 'class-validator';

export class UpdateUserDto {
  @IsOptional() @IsEmail() email?: string;
  @IsOptional() @IsString() password?: string;

  @IsOptional()
  @IsIn(['user', 'politician', 'admin'])
  role?: 'user' | 'politician' | 'admin';

  @IsOptional() @IsString() name?: string;
  @IsOptional() @IsInt() @Min(18) age?: number;
  @IsOptional() @IsString() addressPref?: string;
  @IsOptional() @IsString() addressCity?: string;
  @IsOptional() @IsString() phone?: string;
  @IsOptional() @IsString() governmentIdUrl?: string;
}
</file>

<file path="backend/src/modules/users/user.entity.ts">
// backend/src/modules/users/user.entity.ts (全体コード)

import { Entity, PrimaryGeneratedColumn, Column, OneToMany } from 'typeorm';
import { Post } from '../posts/post.entity'; // Post エンティティのインポートを仮定

// 役割（Role）の定義をエンティティの前に配置します
export enum UserRole {
  CITIZEN = 'citizen',
  POLITICIAN = 'politician',
  ADMIN = 'admin',
}

@Entity('users')
export class User {
  @PrimaryGeneratedColumn()
  id: number;

  @Column()
  email: string; // 既存のフィールド（例として追加）

  @Column()
  name: string; // 既存のフィールド（例として追加）
  
  // ... その他の既存のフィールド ...

  // 👇 ここから追加/変更 👇
  @Column({
    type: 'enum',
    enum: UserRole,
    default: UserRole.CITIZEN, // デフォルトは一般市民
  })
  role: UserRole; // 👈 役割を保持するフィールド
  // 👆 ここまで追加/変更 👆

  @OneToMany(() => Post, post => post.author)
  posts: Post[];
}
</file>

<file path="backend/src/modules/wallet/wallet.controller.ts">
import { Controller, Get, Req, UseGuards } from '@nestjs/common';
import { WalletService } from './wallet.service';
import { AuthGuard } from '@nestjs/passport';

@Controller('wallet')
@UseGuards(AuthGuard('jwt'))
export class WalletController {
  constructor(private readonly wallet: WalletService) {}

  @Get('transactions')
  async transactions(@Req() req: any) {
    const userId = req.user?.sub ?? req.user?.id;
    return this.wallet.list(userId);
  }
}
</file>

<file path="backend/src/modules/wallet/wallet.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { WalletTransaction } from '../../entities/wallet-transaction.entity';
import { WalletService } from './wallet.service';
import { WalletController } from './wallet.controller';

@Module({
  imports: [TypeOrmModule.forFeature([WalletTransaction])],
  controllers: [WalletController],
  providers: [WalletService],
  exports: [WalletService],
})
export class WalletModule {}
</file>

<file path="backend/src/modules/wallet/wallet.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { WalletTransaction } from '../../entities/wallet-transaction.entity';

@Injectable()
export class WalletService {
  constructor(@InjectRepository(WalletTransaction) private readonly wallet: Repository<WalletTransaction>) {}

  async list(userId: string) {
    return this.wallet.find({ where: { userId }, order: { createdAt: 'DESC' } });
  }
}
</file>

<file path="backend/src/news-ingest/news-ingest.controller.ts">
import { Controller, Post } from '@nestjs/common';
import { NewsIngestService } from './news-ingest.service';

@Controller('news-ingest')
export class NewsIngestController {
  constructor(private readonly svc: NewsIngestService) {}

  // 管理用の手動取り込み（簡易）
  @Post('pull')
  async pull() {
    await this.svc.pullAndCreate();
    return { ok: true };
  }
}
</file>

<file path="backend/src/news-ingest/news-source.interface.ts">
export type NewsItem = {
  title: string;
  link: string;
  content?: string;
  publishedAt?: Date | null;
  source?: string;
};

export interface NewsSource {
  fetch(): Promise<NewsItem[]>;
}
</file>

<file path="backend/src/news-ingest/rss-news.source.ts">
import { NewsItem, NewsSource } from './news-source.interface';

export class RssNewsSource implements NewsSource {
  constructor(private readonly feedUrls: string[], private readonly sourceName = 'RSS') {}

  async fetch(): Promise<NewsItem[]> {
    // 簡易実装：各フィードURLをfetchし、非常に簡易なXMLパース（本番は rss-parser を推奨）
    const items: NewsItem[] = [];
    for (const url of this.feedUrls) {
      try {
        const res = await fetch(url);
        if (!res.ok) continue;
        const xml = await res.text();

        // 超簡易パース（<item><title>... を抜く）。正確なRSS対応は rss-parser を利用してください。
        const itemRegex = /<item[\s\S]*?<\/item>/g;
        const titleRegex = /<title>([\s\S]*?)<\/title>/;
        const linkRegex = /<link>([\s\S]*?)<\/link>/;
        const pubDateRegex = /<pubDate>([\s\S]*?)<\/pubDate>/;

        const matches = xml.match(itemRegex) || [];
        for (const m of matches) {
          const title = (m.match(titleRegex)?.[1] || '').trim();
          const link = (m.match(linkRegex)?.[1] || '').trim();
          const pubDateStr = (m.match(pubDateRegex)?.[1] || '').trim();
          const publishedAt = pubDateStr ? new Date(pubDateStr) : null;

          if (title && link) {
            items.push({ title, link, publishedAt, source: this.sourceName });
          }
        }
      } catch {
        // フィード取得失敗はスキップ
        continue;
      }
    }
    return items;
  }
}
</file>

<file path="backend/src/scripts/e2e-smoke.sh">
#!/usr/bin/env bash
set -euo pipefail

API=${API:-http://localhost:3001}

echo "Login citizen1..."
C1=$(curl -sS -X POST "$API/auth/login" -H "Content-Type: application/json" -d '{"id":"citizen1@example.com","password":"Passw0rd!"}')
C1_TOKEN=$(echo "$C1" | jq -r .accessToken)

echo "Login citizen2..."
C2=$(curl -sS -X POST "$API/auth/login" -H "Content-Type: application/json" -d '{"id":"citizen2@example.com","password":"Passw0rd!"}')
C2_TOKEN=$(echo "$C2" | jq -r .accessToken)

echo "Login politician..."
P=$(curl -sS -X POST "$API/auth/login" -H "Content-Type: application/json" -d '{"id":"politician@example.com","password":"Passw0rd!"}')
P_TOKEN=$(echo "$P" | jq -r .accessToken)

echo "List posts..."
POSTS=$(curl -sS "$API/posts")
POST_ID=$(echo "$POSTS" | jq -r '.[0].id')
echo "Using post: $POST_ID"

echo "Vote agree by citizen2..."
curl -sS -X POST "$API/posts/$POST_ID/votes" -H "Authorization: Bearer $C2_TOKEN" -H "Content-Type: application/json" -d '{"choice":"agree"}' > /dev/null || true
echo "Try duplicate vote (should fail)..."
curl -sS -w "\nHTTP:%{http_code}\n" -o /dev/null -X POST "$API/posts/$POST_ID/votes" -H "Authorization: Bearer $C2_TOKEN" -H "Content-Type: application/json" -d '{"choice":"agree"}'

echo "Comment by citizen2..."
curl -sS -X POST "$API/posts/$POST_ID/comments" -H "Authorization: Bearer $C2_TOKEN" -H "Content-Type: application/json" -d '{"content":"素晴らしい取り組みです！"}' > /dev/null

echo "Surveys available for citizen1..."
curl -sS -H "Authorization: Bearer $C1_TOKEN" "$API/surveys/available"

echo "Submit survey response (citizen1 -> pending reward)..."
SID=$(curl -sS -H "Authorization: Bearer $C1_TOKEN" "$API/surveys/available" | jq -r '.[0].id')
curl -sS -X POST "$API/surveys/$SID/responses" -H "Authorization: Bearer $C1_TOKEN" -H "Content-Type: application/json" -d '{"answers":{"q1":"はい"}}'

echo "Submit survey response (citizen2 -> granted reward)..."
curl -sS -X POST "$API/surveys/$SID/responses" -H "Authorization: Bearer $C2_TOKEN" -H "Content-Type: application/json" -d '{"answers":{"q1":"はい"}}' || true
echo "Wallet citizen2..."
curl -sS -H "Authorization: Bearer $C2_TOKEN" "$API/wallet/transactions"

echo "Politician dashboard summary..."
curl -sS -H "Authorization: Bearer $P_TOKEN" "$API/analytics/my/posts" | jq '.[] | {title, votes: .votes, comments}'

echo "News ingest trigger..."
curl -sS -X POST "$API/news-ingest/pull" || true
echo "List news posts..."
curl -sS "$API/posts?type=news" | jq '.[0:3]'
echo "Done."
</file>

<file path="backend/src/scripts/reset-password.ts">
import 'dotenv/config';
import { NestFactory } from '@nestjs/core';
import { AppModule } from '../app.module';
import { getRepositoryToken } from '@nestjs/typeorm';
import { INestApplicationContext } from '@nestjs/common';
import { Repository } from 'typeorm';
import * as bcrypt from 'bcryptjs';
import { User } from '../entities/user.entity';

async function bootstrap() {
  const email = process.argv[2];
  const newPass = process.argv[3];

  if (!email || !newPass) {
    console.error('Usage: ts-node src/scripts/reset-password.ts <email> <newPassword>');
    process.exit(1);
  }

  const app: INestApplicationContext = await NestFactory.createApplicationContext(AppModule, {
    logger: ['error', 'warn'],
  });

  try {
    const userRepo = app.get<Repository<User>>(getRepositoryToken(User));
    const user = await userRepo.findOne({ where: { email } });
    if (!user) {
      console.error(`User not found: ${email}`);
      process.exit(1);
    }

    const salt = await bcrypt.genSalt(10);
    const hash = await bcrypt.hash(newPass, salt);

    // プロジェクトのユーザーエンティティに合わせて両対応
    if ('passwordHash' in user) {
      (user as any).passwordHash = hash;
    } else {
      (user as any).password = hash;
    }

    await userRepo.save(user);
    console.log(`Password updated for ${email}`);
  } catch (e) {
    console.error(e);
    process.exit(1);
  } finally {
    await app.close();
  }
}

bootstrap();
</file>

<file path="backend/src/scripts/typeorm.config.ts">
import 'reflect-metadata';
import { DataSource } from 'typeorm';
import * as dotenv from 'dotenv';

dotenv.config({ path: process.env.DOTENV_CONFIG_PATH || '.env' });

export default new DataSource({
  type: 'mysql',
  host: process.env.DB_HOST,
  port: parseInt(process.env.DB_PORT || '3306', 10),
  username: process.env.DB_USER,
  password: process.env.DB_PASS,
  database: process.env.DB_NAME,
  // src 実行時/ts-node 用と、build 後の js 双方に対応
  entities: [
    __dirname + '/../**/*.entity.{ts,js}',
  ],
  migrations: [
    __dirname + '/../migrations/*.{ts,js}',
  ],
  synchronize: false,
  logging: false,
});
</file>

<file path="backend/src/type/global.d.ts">
/// <reference types="node" />
/// <reference types="express" />
/// <reference types="multer" />
</file>

<file path="backend/src/app.controller.spec.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { AppController } from './app.controller';
import { AppService } from './app.service';

describe('AppController', () => {
  let appController: AppController;

  beforeEach(async () => {
    const app: TestingModule = await Test.createTestingModule({
      controllers: [AppController],
      providers: [AppService],
    }).compile();

    appController = app.get<AppController>(AppController);
  });

  describe('root', () => {
    it('should return "Hello World!"', () => {
      expect(appController.getHello()).toBe('Hello World!');
    });
  });
});
</file>

<file path="backend/src/app.controller.ts">
import { Controller, Get } from '@nestjs/common';
import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  getHello(): string {
    return this.appService.getHello();
  }
}
</file>

<file path="backend/src/app.service.ts">
import { Injectable } from '@nestjs/common';

@Injectable()
export class AppService {
  getHello(): string {
    return 'Hello World!';
  }
}
</file>

<file path="backend/.gitignore">
# compiled output
/dist
/node_modules
/build

# Logs
logs
*.log
npm-debug.log*
pnpm-debug.log*
yarn-debug.log*
yarn-error.log*
lerna-debug.log*

# OS
.DS_Store

# Tests
/coverage
/.nyc_output

# IDEs and editors
/.idea
.project
.classpath
.c9/
*.launch
.settings/
*.sublime-workspace

# IDE - VSCode
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json

# dotenv environment variable files
.env
.env.development.local
.env.test.local
.env.production.local
.env.local

# temp directory
.temp
.tmp

# Runtime data
pids
*.pid
*.seed
*.pid.lock

# Diagnostic reports (https://nodejs.org/api/report.html)
report.[0-9]*.[0-9]*.[0-9]*.[0-9]*.json
</file>

<file path="backend/.prettierrc">
{
  "singleQuote": true,
  "trailingComma": "all"
}
</file>

<file path="backend/eslint.config.mjs">
// @ts-check
import eslint from '@eslint/js';
import eslintPluginPrettierRecommended from 'eslint-plugin-prettier/recommended';
import globals from 'globals';
import tseslint from 'typescript-eslint';

export default tseslint.config(
  {
    ignores: ['eslint.config.mjs'],
  },
  eslint.configs.recommended,
  ...tseslint.configs.recommendedTypeChecked,
  eslintPluginPrettierRecommended,
  {
    languageOptions: {
      globals: {
        ...globals.node,
        ...globals.jest,
      },
      sourceType: 'commonjs',
      parserOptions: {
        projectService: true,
        tsconfigRootDir: import.meta.dirname,
      },
    },
  },
  {
    rules: {
      '@typescript-eslint/no-explicit-any': 'off',
      '@typescript-eslint/no-floating-promises': 'warn',
      '@typescript-eslint/no-unsafe-argument': 'warn',
      "prettier/prettier": ["error", { endOfLine: "auto" }],
    },
  },
);
</file>

<file path="backend/jest.config.ts">
import type { Config } from 'jest';

const config: Config = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  testMatch: ['**/__tests__/**/*.ts'],
  moduleFileExtensions: ['ts', 'js', 'json'],
  transform: {
    '^.+\\.ts$': ['ts-jest', { tsconfig: 'tsconfig.json' }],
  },
};

export default config;
</file>

<file path="backend/README.md">
<p align="center">
  <a href="http://nestjs.com/" target="blank"><img src="https://nestjs.com/img/logo-small.svg" width="120" alt="Nest Logo" /></a>
</p>

[circleci-image]: https://img.shields.io/circleci/build/github/nestjs/nest/master?token=abc123def456
[circleci-url]: https://circleci.com/gh/nestjs/nest

  <p align="center">A progressive <a href="http://nodejs.org" target="_blank">Node.js</a> framework for building efficient and scalable server-side applications.</p>
    <p align="center">
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/v/@nestjs/core.svg" alt="NPM Version" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/l/@nestjs/core.svg" alt="Package License" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/dm/@nestjs/common.svg" alt="NPM Downloads" /></a>
<a href="https://circleci.com/gh/nestjs/nest" target="_blank"><img src="https://img.shields.io/circleci/build/github/nestjs/nest/master" alt="CircleCI" /></a>
<a href="https://discord.gg/G7Qnnhy" target="_blank"><img src="https://img.shields.io/badge/discord-online-brightgreen.svg" alt="Discord"/></a>
<a href="https://opencollective.com/nest#backer" target="_blank"><img src="https://opencollective.com/nest/backers/badge.svg" alt="Backers on Open Collective" /></a>
<a href="https://opencollective.com/nest#sponsor" target="_blank"><img src="https://opencollective.com/nest/sponsors/badge.svg" alt="Sponsors on Open Collective" /></a>
  <a href="https://paypal.me/kamilmysliwiec" target="_blank"><img src="https://img.shields.io/badge/Donate-PayPal-ff3f59.svg" alt="Donate us"/></a>
    <a href="https://opencollective.com/nest#sponsor"  target="_blank"><img src="https://img.shields.io/badge/Support%20us-Open%20Collective-41B883.svg" alt="Support us"></a>
  <a href="https://twitter.com/nestframework" target="_blank"><img src="https://img.shields.io/twitter/follow/nestframework.svg?style=social&label=Follow" alt="Follow us on Twitter"></a>
</p>
  <!--[![Backers on Open Collective](https://opencollective.com/nest/backers/badge.svg)](https://opencollective.com/nest#backer)
  [![Sponsors on Open Collective](https://opencollective.com/nest/sponsors/badge.svg)](https://opencollective.com/nest#sponsor)-->

## Description

[Nest](https://github.com/nestjs/nest) framework TypeScript starter repository.

## Project setup

```bash
$ npm install
```

## Compile and run the project

```bash
# development
$ npm run start

# watch mode
$ npm run start:dev

# production mode
$ npm run start:prod
```

## Run tests

```bash
# unit tests
$ npm run test

# e2e tests
$ npm run test:e2e

# test coverage
$ npm run test:cov
```

## Deployment

When you're ready to deploy your NestJS application to production, there are some key steps you can take to ensure it runs as efficiently as possible. Check out the [deployment documentation](https://docs.nestjs.com/deployment) for more information.

If you are looking for a cloud-based platform to deploy your NestJS application, check out [Mau](https://mau.nestjs.com), our official platform for deploying NestJS applications on AWS. Mau makes deployment straightforward and fast, requiring just a few simple steps:

```bash
$ npm install -g @nestjs/mau
$ mau deploy
```

With Mau, you can deploy your application in just a few clicks, allowing you to focus on building features rather than managing infrastructure.

## Resources

Check out a few resources that may come in handy when working with NestJS:

- Visit the [NestJS Documentation](https://docs.nestjs.com) to learn more about the framework.
- For questions and support, please visit our [Discord channel](https://discord.gg/G7Qnnhy).
- To dive deeper and get more hands-on experience, check out our official video [courses](https://courses.nestjs.com/).
- Deploy your application to AWS with the help of [NestJS Mau](https://mau.nestjs.com) in just a few clicks.
- Visualize your application graph and interact with the NestJS application in real-time using [NestJS Devtools](https://devtools.nestjs.com).
- Need help with your project (part-time to full-time)? Check out our official [enterprise support](https://enterprise.nestjs.com).
- To stay in the loop and get updates, follow us on [X](https://x.com/nestframework) and [LinkedIn](https://linkedin.com/company/nestjs).
- Looking for a job, or have a job to offer? Check out our official [Jobs board](https://jobs.nestjs.com).

## Support

Nest is an MIT-licensed open source project. It can grow thanks to the sponsors and support by the amazing backers. If you'd like to join them, please [read more here](https://docs.nestjs.com/support).

## Stay in touch

- Author - [Kamil Myśliwiec](https://twitter.com/kammysliwiec)
- Website - [https://nestjs.com](https://nestjs.com/)
- Twitter - [@nestframework](https://twitter.com/nestframework)

## License

Nest is [MIT licensed](https://github.com/nestjs/nest/blob/master/LICENSE).
</file>

<file path="backend/server.js">
// backend/server.js (最終修正版 - 活動記録エラー修正済み)

const express = require('express');
const cors = require('cors'); 
const bodyParser = require('body-parser');
const mockData = require('./data/mockData'); 

const app = express();
const port = 8000;

// ------------------------------------------------------------------
// 1. ミドルウェア設定
// ------------------------------------------------------------------
app.use(cors({
  origin: 'http://localhost:3000' // フロントエンドからのアクセスを許可
}));

app.use(bodyParser.json());

// ------------------------------------------------------------------
// 2. ユーザー認証のモックエンドポイント
// ------------------------------------------------------------------
app.post('/api/register', (req, res) => {
  const { name, email, password, district } = req.body;
  
  if (mockData.users.some(user => user.email === email)) {
    return res.status(400).send({ message: 'そのメールアドレスはすでに使用されています。' });
  }

  const newUser = {
    id: `user-${mockData.users.length + 1}`,
    name,
    email,
    district,
    password 
  };

  mockData.users.push(newUser);

  res.status(201).send({ 
    token: `mock-token-${newUser.id}`,
    user: { id: newUser.id, name: newUser.name, email: newUser.email, district: newUser.district }
  });
});

app.post('/api/login', (req, res) => {
  const { email, password } = req.body;
  const user = mockData.users.find(u => u.email === email && u.password === password);

  if (user) {
    res.status(200).send({ 
      token: `mock-token-${user.id}`,
      user: { id: user.id, name: user.name, email: user.email, district: user.district }
    });
  } else {
    res.status(401).send({ message: 'メールアドレスまたはパスワードが正しくありません。' });
  }
});

app.get('/api/profile', (req, res) => {
    const authHeader = req.headers['authorization'];
    if (!authHeader || !authHeader.startsWith('Bearer mock-token-')) {
        return res.status(401).send({ message: '認証されていません。' });
    }
    res.status(200).send({
      id: "user-1",
      name: "テスト 太郎",
      email: "test@example.com",
      district: "渋谷区"
    });
});

// ------------------------------------------------------------------
// 3. 議員データのエンドポイント
// ------------------------------------------------------------------
app.get('/api/members', (req, res) => {
  res.json(mockData.members);
});

app.get('/api/members/:id', (req, res) => {
  const memberId = req.params.id;
  const member = mockData.members.find(m => m.id === memberId);

  if (member) {
    res.json(member);
  } else {
    res.status(404).send({ message: '議員が見つかりません。' });
  }
});

// ------------------------------------------------------------------
// 4. タイムライン（活動記録）のエンドポイント 💡 修正箇所
// ------------------------------------------------------------------
app.get('/api/activity-logs', (req, res) => {
  // エラー解消のための修正: 活動記録に紐づく議員情報を結合します
  const logsWithMemberDetail = mockData.activityLogs.map(log => {
    // memberIdを元に議員の詳細情報を検索
    const member = mockData.members.find(m => m.id === log.memberId);
    
    // フロントエンドの期待通り、memberというキーで議員情報をネストして返す
    return {
      ...log,
      member: member ? { 
        id: member.id,
        name: member.name,
        photoUrl: member.photoUrl 
      } : null, // 議員が見つからない場合を考慮
    };
  });

  // ソート済みの結合済みデータを返す
  res.json(logsWithMemberDetail);
});


// ------------------------------------------------------------------
// サーバー起動
// ------------------------------------------------------------------
app.listen(port, () => {
  console.log(`🚀 Mock API Server is running on http://localhost:${port}/api`);
});
</file>

<file path="backend/update_user.sql">
UPDATE users
SET passwordHash='$2b$10$IMs7GmtZqZvtXOzbkTw1oek.XPZjVrjW9gvS2VJPXou0op.m0A9xS',
    role='admin',
    status='active'
WHERE email='keigominowa56@gmail.com';

.headers on
.mode column
SELECT id, email, role, status FROM users WHERE email='keigominowa56@gmail.com';
</file>

<file path="docker/mysql/init/01-init.sql">
-- docker/mysql/init/01-init.sql の内容
-- データベースの文字セット設定
ALTER DATABASE transparency_platform CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
-- タイムゾーン設定
SET GLOBAL time_zone = '+09:00';
-- 権限の付与 
GRANT ALL PRIVILEGES ON transparency_platform.* TO 'transparency_user'@'%';
FLUSH PRIVILEGES;
</file>

<file path="frontend/app/about/page.tsx">
'use client';

import Header from '@/components/Header';
import Footer from '@/components/Footer';
import { motion } from 'framer-motion';
import { 
  Shield, 
  Users, 
  Eye, 
  Heart, 
  Target, 
  CheckCircle, 
  BarChart3, 
  Globe,
  MessageSquare,
  TrendingUp,
  Award,
  Lightbulb
} from 'lucide-react';

export default function AboutPage() {
  const features = [
    {
      icon: Users,
      title: '議員情報の透明性',
      description: '地方議会議員の基本情報、経歴、所属政党などを公開し、市民が議員を理解しやすくします。'
    },
    {
      icon: Target,
      title: '公約の追跡',
      description: '議員が掲げた公約の進捗状況を可視化し、実現度を市民が確認できるようにします。'
    },
    {
      icon: BarChart3,
      title: '政務活動費の可視化',
      description: '議員の政務活動費の使途をカテゴリ別に集計し、円グラフや棒グラフで分かりやすく表示します。'
    },
    {
      icon: MessageSquare,
      title: '市民参加の促進',
      description: '公約や活動に対する賛否投票機能により、市民の声を政治に反映させます。'
    },
    {
      icon: Globe,
      title: '外部情報の統合',
      description: 'Twitter、RSS、公式サイトなど複数のソースから議員の活動情報を自動収集します。'
    },
    {
      icon: TrendingUp,
      title: 'データ駆動型の政治',
      description: '客観的なデータに基づいて政治の透明性を向上させ、より良い民主主義を実現します。'
    }
  ];

  const values = [
    {
      icon: Shield,
      title: '透明性',
      description: '政治の透明性を最優先に考え、すべての情報を市民に開示します。'
    },
    {
      icon: Heart,
      title: '市民参加',
      description: '市民が政治に参加し、声を届けられる仕組みを提供します。'
    },
    {
      icon: Eye,
      title: '監視機能',
      description: '議員の活動を市民が監視し、責任ある政治を促進します。'
    },
    {
      icon: Award,
      title: '信頼性',
      description: '正確で信頼できる情報を提供し、データの整合性を保ちます。'
    }
  ];

  const stats = [
    { label: '登録議員数', value: '3名', description: '現在登録されている議員' },
    { label: '公開公約数', value: '4件', description: '追跡可能な公約' },
    { label: '活動ログ数', value: '3件', description: '記録された活動' },
    { label: '政務活動費', value: '¥2.8M', description: '可視化された支出' }
  ];

  return (
    <div className="min-h-screen bg-gray-50">
      <Header />
      
      <main>
        {/* Hero Section */}
        <section className="bg-gradient-to-r from-blue-600 to-blue-800 text-white py-20">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="text-center"
            >
              <h1 className="text-4xl md:text-5xl font-bold mb-6">
                このサイトについて
              </h1>
              <p className="text-xl md:text-2xl mb-8 max-w-3xl mx-auto">
                市民参加型 透明性データプラットフォームは、政治の透明性向上と市民参加の促進を目指す革新的なプラットフォームです。
              </p>
              <div className="flex flex-wrap justify-center gap-4">
                <div className="bg-white/20 backdrop-blur-sm rounded-lg px-6 py-3">
                  <span className="font-semibold">政治の透明性</span>
                </div>
                <div className="bg-white/20 backdrop-blur-sm rounded-lg px-6 py-3">
                  <span className="font-semibold">市民参加</span>
                </div>
                <div className="bg-white/20 backdrop-blur-sm rounded-lg px-6 py-3">
                  <span className="font-semibold">データ駆動</span>
                </div>
              </div>
            </motion.div>
          </div>
        </section>

        {/* Mission Section */}
        <section className="py-16 bg-white">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="text-center mb-12"
            >
              <h2 className="text-3xl font-bold text-gray-900 mb-4">私たちの使命</h2>
              <p className="text-lg text-gray-600 max-w-3xl mx-auto">
                地方議会議員の活動情報、公約、および政務活動費の使途を市民が公平に確認・評価できる環境を提供し、
                政治と市民のエンゲージメントを向上させることを目指しています。
              </p>
            </motion.div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
              {stats.map((stat, index) => (
                <motion.div
                  key={stat.label}
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: index * 0.1 }}
                  className="text-center"
                >
                  <div className="text-3xl font-bold text-blue-600 mb-2">{stat.value}</div>
                  <div className="text-lg font-semibold text-gray-900 mb-1">{stat.label}</div>
                  <div className="text-sm text-gray-600">{stat.description}</div>
                </motion.div>
              ))}
            </div>
          </div>
        </section>

        {/* Features Section */}
        <section className="py-16 bg-gray-50">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="text-center mb-12"
            >
              <h2 className="text-3xl font-bold text-gray-900 mb-4">主要機能</h2>
              <p className="text-lg text-gray-600">
                プラットフォームの核心となる機能をご紹介します
              </p>
            </motion.div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
              {features.map((feature, index) => {
                const Icon = feature.icon;
                return (
                  <motion.div
                    key={feature.title}
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: index * 0.1 }}
                    className="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow"
                  >
                    <div className="flex items-center mb-4">
                      <div className="bg-blue-100 p-3 rounded-lg">
                        <Icon className="w-6 h-6 text-blue-600" />
                      </div>
                      <h3 className="text-xl font-semibold text-gray-900 ml-4">
                        {feature.title}
                      </h3>
                    </div>
                    <p className="text-gray-600">
                      {feature.description}
                    </p>
                  </motion.div>
                );
              })}
            </div>
          </div>
        </section>

        {/* Values Section */}
        <section className="py-16 bg-white">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="text-center mb-12"
            >
              <h2 className="text-3xl font-bold text-gray-900 mb-4">私たちの価値観</h2>
              <p className="text-lg text-gray-600">
                プラットフォームの根底にある価値観と理念
              </p>
            </motion.div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              {values.map((value, index) => {
                const Icon = value.icon;
                return (
                  <motion.div
                    key={value.title}
                    initial={{ opacity: 0, x: index % 2 === 0 ? -20 : 20 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: index * 0.1 }}
                    className="flex items-start space-x-4"
                  >
                    <div className="bg-green-100 p-3 rounded-lg flex-shrink-0">
                      <Icon className="w-6 h-6 text-green-600" />
                    </div>
                    <div>
                      <h3 className="text-xl font-semibold text-gray-900 mb-2">
                        {value.title}
                      </h3>
                      <p className="text-gray-600">
                        {value.description}
                      </p>
                    </div>
                  </motion.div>
                );
              })}
            </div>
          </div>
        </section>

        {/* Technology Section */}
        <section className="py-16 bg-gray-50">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="text-center mb-12"
            >
              <h2 className="text-3xl font-bold text-gray-900 mb-4">技術的特徴</h2>
              <p className="text-lg text-gray-600">
                最新の技術を活用した堅牢で拡張性の高いプラットフォーム
              </p>
            </motion.div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              {[
                { name: 'NestJS', description: '堅牢なバックエンドAPI' },
                { name: 'Next.js', description: '高速なフロントエンド' },
                { name: 'TypeORM', description: '型安全なデータベース' },
                { name: 'Firebase', description: 'セキュアな認証システム' },
                { name: 'Recharts', description: '美しいデータ可視化' },
                { name: 'Tailwind CSS', description: 'モダンなUIデザイン' },
                { name: 'Framer Motion', description: '滑らかなアニメーション' },
                { name: 'Swagger', description: '包括的なAPI文書' }
              ].map((tech, index) => (
                <motion.div
                  key={tech.name}
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: index * 0.1 }}
                  className="bg-white rounded-lg shadow-lg p-4 text-center hover:shadow-xl transition-shadow"
                >
                  <h3 className="font-semibold text-gray-900 mb-2">{tech.name}</h3>
                  <p className="text-sm text-gray-600">{tech.description}</p>
                </motion.div>
              ))}
            </div>
          </div>
        </section>

        {/* Contact Section */}
        <section className="py-16 bg-blue-600 text-white">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="text-center"
            >
              <h2 className="text-3xl font-bold mb-4">お問い合わせ</h2>
              <p className="text-xl mb-8 max-w-2xl mx-auto">
                ご質問、ご提案、または技術的なお問い合わせがございましたら、お気軽にご連絡ください。
              </p>
              <div className="flex flex-col sm:flex-row gap-4 justify-center">
                <a
                  href="mailto:info@transparency-platform.jp"
                  className="bg-white text-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors"
                >
                  メールでお問い合わせ
                </a>
                <a
                  href="https://github.com/transparency-platform"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-800 transition-colors"
                >
                  GitHub で確認
                </a>
              </div>
            </motion.div>
          </div>
        </section>
      </main>

      <Footer />
    </div>
  );
}
</file>

<file path="frontend/app/admin/approval/page.tsx">
// frontend/app/admin/approval/page.tsx

"use client";

import React, { useState, useEffect, useCallback, useMemo } from 'react';
import axios from 'axios';
import dayjs from 'dayjs';
import Link from 'next/link';
import { ExternalLink, Check, X, Loader2, BarChart, Clock, Hash, Zap } from 'lucide-react';

// --- 型定義 (バックエンドのActivityLog Entityに基づく) ---
interface ActivityLog {
  id: string;
  memberId: string;
  source: 'twitter' | 'rss' | 'official' | 'manual';
  content: string;
  isPublic: boolean;
  publishedAt: string;
  metadata: {
    url?: string;
    isPolitical?: boolean;
    isNoise?: boolean;
    [key: string]: any;
  };
  member: {
    id: string;
    name: string;
    affiliation: string;
    position: string;
    twitterHandle?: string;
  };
}

interface Stats {
  total: number;
  approved: number;
  pending: number;
  approvalRate: number;
  politicalCount: number;
  noiseCount: number;
}

// --- APIクライアント (適切なAPI URLを設定) ---
const api = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:4000/api', 
});

// --- 主要コンポーネント ---

const ApprovalPage: React.FC = () => {
  const [logs, setLogs] = useState<ActivityLog[]>([]);
  const [stats, setStats] = useState<Stats | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  // フィルター状態
  const [filterStatus, setFilterStatus] = useState<'all' | 'pending' | 'approved'>('pending');
  const [filterSource, setFilterSource] = useState<'all' | 'twitter' | 'rss' | 'official' | 'manual'>('all');
  
  const fetchLogs = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      let endpoint = '';
      if (filterStatus === 'pending') {
        endpoint = '/activity-logs/pending';
      } else if (filterStatus === 'approved') {
        endpoint = '/activity-logs/all?includePrivate=true'; // isPublic=true のみをフロントでフィルター
      } else {
        endpoint = '/activity-logs/all?includePrivate=true';
      }
      
      // バックエンドがページネーションを返すことを想定
      const response = await api.get(endpoint, { params: { limit: 100 } });
      let fetchedLogs = response.data.data || response.data;

      // フロントエンドでのステータスフィルター
      if (filterStatus === 'approved') {
        fetchedLogs = fetchedLogs.filter((log: ActivityLog) => log.isPublic);
      }
      
      setLogs(fetchedLogs);
    } catch (e) {
      setError('ログの取得に失敗しました。バックエンドが起動しているか確認してください。');
      console.error(e);
    } finally {
      setLoading(false);
    }
  }, [filterStatus]);

  const fetchStats = async () => {
    try {
      const response = await api.get('/activity-logs/stats');
      setStats(response.data);
    } catch (e) {
      console.error('統計情報の取得に失敗しました。', e);
    }
  };

  useEffect(() => {
    fetchLogs();
    fetchStats();
  }, [fetchLogs, filterStatus]);
  
  // --- アクションハンドラー (Line 121-147) ---
  const handleApprove = async (logId: string) => {
    try {
      await api.patch(`/activity-logs/${logId}/approve`);
      // 承認後、リストから削除して再フェッチ
      setLogs(prev => prev.filter(log => log.id !== logId));
      fetchStats(); // 統計情報も更新
    } catch (e) {
      alert('承認処理に失敗しました。');
    }
  };

  const handleReject = async (logId: string) => {
    try {
      await api.patch(`/activity-logs/${logId}/reject`);
      // 非承認後、リストから削除して再フェッチ
      setLogs(prev => prev.filter(log => log.id !== logId));
      fetchStats(); // 統計情報も更新
    } catch (e) {
      alert('非承認処理に失敗しました。');
    }
  };
  
  const handleBatchApprove = async () => {
    const pendingLogs = filteredLogs.filter(log => !log.isPublic).map(log => log.id);
    if (pendingLogs.length === 0) return;
    
    try {
      await api.patch('/activity-logs/bulk/approve', { ids: pendingLogs });
      alert(`${pendingLogs.length}件を一括承認しました。`);
      fetchLogs();
      fetchStats();
    } catch (e) {
      alert('一括承認処理に失敗しました。');
    }
  };
  
  // --- フィルタリングと表示 (Line 184-232) ---
  const filteredLogs = useMemo(() => {
    return logs.filter(log => {
      // ソースフィルター
      if (filterSource !== 'all' && log.source !== filterSource) {
        return false;
      }
      // ステータスフィルターはfetchLogs内で処理済みだが、念のため。
      return true;
    });
  }, [logs, filterSource]);
  
  if (loading && !logs.length) {
    return (
      <div className="flex justify-center items-center h-64">
        <Loader2 className="w-8 h-8 animate-spin text-blue-500" />
      </div>
    );
  }

  if (error) {
    return <div className="text-red-500 p-4 bg-red-100 rounded">{error}</div>;
  }

  return (
    <div className="p-8 space-y-8 bg-gray-50 min-h-screen">
      <h1 className="text-3xl font-bold text-gray-800">活動ログ承認管理</h1>

      {/* 統計ダッシュボード (Line 152-182) */}
      {stats && (
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          <StatCard title="合計ログ数" value={stats.total} icon={<Hash className="w-6 h-6" />} />
          <StatCard title="承認済み" value={stats.approved} icon={<Check className="w-6 h-6 text-green-500" />} />
          <StatCard title="承認待ち" value={stats.pending} icon={<Clock className="w-6 h-6 text-yellow-500" />} />
          <StatCard title="承認率" value={`${stats.approvalRate}%`} icon={<BarChart className="w-6 h-6 text-blue-500" />} />
          <StatCard title="自動承認 (政治関連)" value={stats.politicalCount} icon={<Zap className="w-6 h-6 text-indigo-500" />} />
          <StatCard title="ノイズ判定数" value={stats.noiseCount} icon={<X className="w-6 h-6 text-red-500" />} />
        </div>
      )}

      {/* フィルターとアクション */}
      <div className="flex flex-wrap items-center justify-between p-4 bg-white rounded-lg shadow">
        <div className="flex space-x-4 mb-4 md:mb-0">
          <FilterButton 
            label="承認待ち" 
            isActive={filterStatus === 'pending'} 
            onClick={() => setFilterStatus('pending')} 
            count={stats?.pending || 0}
          />
          <FilterButton 
            label="承認済み" 
            isActive={filterStatus === 'approved'} 
            onClick={() => setFilterStatus('approved')} 
            count={stats?.approved || 0}
          />
          <FilterButton 
            label="すべて" 
            isActive={filterStatus === 'all'} 
            onClick={() => setFilterStatus('all')} 
            count={stats?.total || 0}
          />
        </div>

        <div className="flex space-x-4">
          <select 
            className="p-2 border rounded-md"
            value={filterSource}
            onChange={(e) => setFilterSource(e.target.value as any)}
          >
            <option value="all">ソース: すべて</option>
            <option value="twitter">ソース: Twitter</option>
            <option value="rss">ソース: RSS</option>
            <option value="official">ソース: 公式</option>
            <option value="manual">ソース: 手動</option>
          </select>
          
          <button
            onClick={handleBatchApprove}
            className="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow hover:bg-green-600 transition disabled:opacity-50"
            disabled={filteredLogs.filter(log => !log.isPublic).length === 0}
          >
            一括承認 ({filteredLogs.filter(log => !log.isPublic).length})
          </button>
        </div>
      </div>

      {/* ログ一覧 */}
      <div className="space-y-4">
        {filteredLogs.length === 0 && !loading && (
          <div className="p-6 text-center text-gray-500 bg-white rounded-lg shadow">
            表示するログはありません。
          </div>
        )}
        {filteredLogs.map(log => (
          <LogCard 
            key={log.id} 
            log={log} 
            onApprove={handleApprove} 
            onReject={handleReject} 
            canApprove={filterStatus === 'pending'}
          />
        ))}
      </div>
    </div>
  );
};

// --- サブコンポーネント ---

const StatCard: React.FC<{ title: string; value: string | number; icon: React.ReactNode }> = ({ title, value, icon }) => (
  <div className="p-4 bg-white rounded-lg shadow flex items-center space-x-4">
    <div className="text-blue-500">{icon}</div>
    <div>
      <p className="text-sm font-medium text-gray-500">{title}</p>
      <p className="text-2xl font-semibold text-gray-900">{value}</p>
    </div>
  </div>
);

const FilterButton: React.FC<{ label: string; isActive: boolean; onClick: () => void; count: number }> = ({ label, isActive, onClick, count }) => (
  <button
    className={`px-3 py-1.5 text-sm font-medium rounded-full transition ${
      isActive
        ? 'bg-blue-600 text-white shadow-md'
        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
    }`}
    onClick={onClick}
  >
    {label} ({count})
  </button>
);

const LogCard: React.FC<{ log: ActivityLog; onApprove: (id: string) => void; onReject: (id: string) => void; canApprove: boolean }> = ({ log, onApprove, onReject, canApprove }) => {
  const isPending = !log.isPublic;
  const isPolitical = log.metadata.isPolitical;
  const isNoise = log.metadata.isNoise;

  return (
    <div className={`p-5 rounded-xl shadow-lg transition duration-200 ${
      isPending ? 'bg-white border-l-4 border-yellow-500' : 
      log.isPublic ? 'bg-green-50 border-l-4 border-green-500' : 'bg-red-50 border-l-4 border-red-500'
    }`}>
      <div className="flex justify-between items-start">
        <div>
          <p className="text-lg font-semibold text-gray-800">
            {log.member.name} ({log.member.affiliation})
          </p>
          <p className="text-sm text-gray-500 mb-2">
            {log.member.position} | {dayjs(log.publishedAt).format('YYYY/MM/DD HH:mm')} | <span className="uppercase font-mono">{log.source}</span>
          </p>
        </div>
        <div className="flex items-center space-x-2 text-sm">
          {isPolitical && <span className="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded-full font-medium">政治関連 (自動承認)</span>}
          {isNoise && <span className="px-2 py-0.5 bg-red-100 text-red-700 rounded-full font-medium">ノイズ判定</span>}
          {log.metadata.url && (
            <Link href={log.metadata.url} target="_blank" className="text-blue-500 hover:text-blue-600 transition">
              <ExternalLink className="w-4 h-4" />
            </Link>
          )}
        </div>
      </div>

      <p className="mt-3 text-gray-700 whitespace-pre-wrap">{log.content}</p>
      
      {isPending && canApprove && (
        <div className="mt-4 pt-4 border-t border-gray-100 flex space-x-3">
          <button
            onClick={() => onApprove(log.id)}
            className="flex items-center px-3 py-1 bg-green-500 text-white text-sm font-medium rounded hover:bg-green-600 transition"
          >
            <Check className="w-4 h-4 mr-1" /> 承認
          </button>
          <button
            onClick={() => onReject(log.id)}
            className="flex items-center px-3 py-1 bg-red-500 text-white text-sm font-medium rounded hover:bg-red-600 transition"
          >
            <X className="w-4 h-4 mr-1" /> 非承認
          </button>
        </div>
      )}
    </div>
  );
};

export default ApprovalPage;
</file>

<file path="frontend/app/admin/bulk-posts/page.tsx">
'use client';
import { useState } from 'react';
import { bulkPostsJSON, bulkPostsCSV } from '../../../lib/api-extended';
import { useAuth } from '../../../contexts/AuthContext';

export default function AdminBulkPostsPage() {
  const { isAdmin } = useAuth();
  const [mode, setMode] = useState<'json' | 'csv'>('json');
  const [text, setText] = useState('');
  const [result, setResult] = useState<any>(null);
  const [err, setErr] = useState<string|null>(null);

  if (!isAdmin) return <div>管理者のみアクセス可能</div>;

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setErr(null); setResult(null);
    try {
      let res;
      if (mode === 'json') {
        const parsed = JSON.parse(text);
        if (!Array.isArray(parsed)) throw new Error('JSONは配列が必要です');
        res = await bulkPostsJSON(parsed);
      } else {
        res = await bulkPostsCSV(text);
      }
      setResult(res);
    } catch (e: any) {
      setErr(e.message || '失敗');
    }
  }

  return (
    <div className="space-y-4">
      <h1 className="text-lg font-semibold">一括投稿</h1>
      <div className="card space-y-3">
        <div className="flex gap-4 text-sm">
          <label className="flex items-center gap-1">
            <input type="radio" value="json" checked={mode === 'json'} onChange={() => setMode('json')} /> JSON
          </label>
          <label className="flex items-center gap-1">
            <input type="radio" value="csv" checked={mode === 'csv'} onChange={() => setMode('csv')} /> CSV
          </label>
        </div>
        <form onSubmit={onSubmit} className="space-y-2 text-sm">
          <textarea
            className="border rounded w-full px-2 py-1 min-h-[200px]"
            placeholder={mode === 'json' ? '[{"title":"...","body":"..."}]' : 'title,body,tags,authorId\n...'}
            value={text}
            onChange={(e) => setText(e.target.value)}
          />
          <button className="px-3 py-2 border rounded">送信</button>
        </form>
        {err && <div className="text-xs text-red-600">{err}</div>}
        {result && (
          <div className="text-xs space-y-1">
            <div>結果: {result.count}件</div>
            <ul className="max-h-48 overflow-auto space-y-1">
              {result.results.map((r: any, i: number) => (
                <li key={i} className={r.created ? 'text-green-600' : r.error ? 'text-red-600' : ''}>
                  #{r.index} {r.created ? `作成 (id=${r.id})` : r.error || 'スキップ'}
                </li>
              ))}
            </ul>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="frontend/app/admin/dashboard/page.md">
# Admin Dashboard

This page uses analytics endpoints `/analytics/posts/summary` and `/analytics/posts/timeseries` to render charts and summary tiles.
</file>

<file path="frontend/app/admin/dashboard/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { fetchPostsSummary, fetchPostsTimeseries } from '../../../lib/api.analytics-snippet';

export default function AdminDashboardPage() {
  const [summary, setSummary] = useState<{ total: number; policy: number; activity: number } | null>(null);
  const [series, setSeries] = useState<{ date: string; total: number; policy: number; activity: number }[]>([]);
  const [err, setErr] = useState<string | null>(null);
  const [days, setDays] = useState(30);

  useEffect(() => {
    (async () => {
      try {
        const s = await fetchPostsSummary();
        const t = await fetchPostsTimeseries(days);
        setSummary(s);
        setSeries(t);
      } catch (e: any) {
        setErr(e?.response?.data?.message || e.message || '取得に失敗しました');
      }
    })();
  }, [days]);

  return (
    <div className="p-4 space-y-6">
      <h1 className="text-lg font-semibold">ダッシュボード</h1>
      {err && <div className="text-sm text-red-700">{err}</div>}

      <div className="grid grid-cols-3 gap-3">
        <StatCard title="投稿総数" value={summary?.total ?? '-'} />
        <StatCard title="政策(Policy)" value={summary?.policy ?? '-'} />
        <StatCard title="活動(Activity)" value={summary?.activity ?? '-'} />
      </div>

      <div className="space-y-3">
        <div className="flex items-center gap-2">
          <h2 className="font-medium">日別推移</h2>
          <select className="border px-2 py-1 text-sm" value={days} onChange={(e) => setDays(Number(e.target.value))}>
            <option value={7}>7日</option>
            <option value={14}>14日</option>
            <option value={30}>30日</option>
            <option value={60}>60日</option>
          </select>
        </div>
        <SimpleChart data={series} />
      </div>
    </div>
  );
}

function StatCard({ title, value }: { title: string; value: number | string }) {
  return (
    <div className="border rounded p-3">
      <div className="text-xs text-slate-600">{title}</div>
      <div className="text-2xl font-semibold">{value}</div>
    </div>
  );
}

function SimpleChart({ data }: { data: { date: string; total: number; policy: number; activity: number }[] }) {
  // シンプルなSVGラインチャート（外部ライブラリ無し）
  const width = 800;
  const height = 220;
  const padding = 30;

  const totals = data.map((d) => d.total);
  const maxY = Math.max(1, ...totals);
  const stepX = data.length > 1 ? (width - padding * 2) / (data.length - 1) : 0;

  const toY = (v: number) => height - padding - (v / maxY) * (height - padding * 2);

  const pathFor = (key: 'total' | 'policy' | 'activity') => {
    return data
      .map((d, i) => {
        const x = padding + i * stepX;
        const y = toY(d[key]);
        return `${i === 0 ? 'M' : 'L'} ${x} ${y}`;
      })
      .join(' ');
  };

  return (
    <div className="overflow-x-auto border rounded">
      <svg width={width} height={height}>
        {/* 軸 */}
        <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#ccc" />
        <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="#ccc" />

        {/* 総数 */}
        <path d={pathFor('total')} stroke="#1e40af" fill="none" strokeWidth={2} />
        {/* policy */}
        <path d={pathFor('policy')} stroke="#059669" fill="none" strokeWidth={2} />
        {/* activity */}
        <path d={pathFor('activity')} stroke="#dc2626" fill="none" strokeWidth={2} />

        {/* 凡例 */}
        <Legend items={[{ c: '#1e40af', t: 'total' }, { c: '#059669', t: 'policy' }, { c: '#dc2626', t: 'activity' }]} />
      </svg>
    </div>
  );
}

function Legend({ items }: { items: { c: string; t: string }[] }) {
  return (
    <g>
      {items.map((it, i) => (
        <g key={it.t} transform={`translate(${20 + i * 100}, 10)`}>
          <rect width={12} height={12} fill={it.c} />
          <text x={18} y={11} fontSize={12} fill="#333">
            {it.t}
          </text>
        </g>
      ))}
    </g>
  );
}
</file>

<file path="frontend/app/admin/funding/page.tsx">
'use client';
import { useState } from 'react';
import useSWR from 'swr';
import { adminFetchUsers } from '../../../lib/api';
import { fetchFundingRecords, fetchFundingSummary, createFundingRecord } from '../../../lib/api-extended';
import { useAuth } from '../../../contexts/AuthContext';

export default function AdminFundingPage() {
  const { isAdmin } = useAuth();
  const { data: politicians } = useSWR(isAdmin ? ['adminUsersPoliticiansFunding'] : null, () => adminFetchUsers({ role: 'politician', page: 1, pageSize: 300 }));
  const [selectedPolitician, setSelectedPolitician] = useState('');
  const { data: records, mutate: mutateRecords } = useSWR(selectedPolitician ? ['fundingRecords', selectedPolitician] : null, () => fetchFundingRecords(selectedPolitician));
  const { data: summary, mutate: mutateSummary } = useSWR(selectedPolitician ? ['fundingSummary', selectedPolitician] : null, () => fetchFundingSummary(selectedPolitician));
  const [form, setForm] = useState({ amount: '', category: '', description: '', date: '' });
  const [msg, setMsg] = useState<string|null>(null);
  const [err, setErr] = useState<string|null>(null);

  if (!isAdmin) return <div>管理者のみアクセス可能です。</div>;

  async function onCreate(e: React.FormEvent) {
    e.preventDefault();
    setMsg(null); setErr(null);
    try {
      await createFundingRecord(selectedPolitician, {
        amount: Number(form.amount),
        category: form.category || undefined,
        description: form.description || undefined,
        date: form.date || undefined,
      });
      setForm({ amount: '', category: '', description: '', date: '' });
      mutateRecords(); mutateSummary();
      setMsg('資金記録を追加しました');
    } catch (e: any) {
      setErr(e?.response?.data?.message || e.message);
    }
  }

  return (
    <div className="space-y-4">
      <h1 className="text-lg font-semibold">政治資金管理</h1>
      <div className="card space-y-3">
        <select
          className="border rounded px-3 py-2 text-sm w-full"
          value={selectedPolitician}
          onChange={(e) => setSelectedPolitician(e.target.value)}
        >
          <option value="">政治家を選択</option>
          {politicians?.items?.map((p: any) => (
            <option key={p.id} value={p.id}>{p.name || p.email}</option>
          ))}
        </select>
        {selectedPolitician && (
          <form onSubmit={onCreate} className="space-y-2 text-sm">
            <input className="border rounded px-2 py-1 w-full" placeholder="金額 (円)" value={form.amount} onChange={(e) => setForm(f => ({ ...f, amount: e.target.value }))} />
            <input className="border rounded px-2 py-1 w-full" placeholder="カテゴリ" value={form.category} onChange={(e) => setForm(f => ({ ...f, category: e.target.value }))} />
            <input className="border rounded px-2 py-1 w-full" placeholder="日付 (YYYY-MM-DD 任意)" value={form.date} onChange={(e) => setForm(f => ({ ...f, date: e.target.value }))} />
            <textarea className="border rounded px-2 py-1 w-full min-h-[80px]" placeholder="説明 (任意)" value={form.description} onChange={(e) => setForm(f => ({ ...f, description: e.target.value }))} />
            {msg && <div className="text-xs text-green-600">{msg}</div>}
            {err && <div className="text-xs text-red-600">{err}</div>}
            <button className="px-3 py-2 border rounded text-sm">追加</button>
          </form>
        )}
      </div>
      {summary && (
        <div className="card space-y-2 text-xs">
          <div className="font-medium">サマリ: 合計 {summary.total} 円</div>
          <ul>
            {Object.entries(summary.byCategory).map(([cat, amt]) => (
              <li key={cat}>{cat}: {amt} 円</li>
            ))}
          </ul>
        </div>
      )}
      <div className="card space-y-2">
        <h2 className="font-medium text-sm">記録一覧</h2>
        {!records && selectedPolitician && <div className="text-xs">読み込み中...</div>}
        <ul className="space-y-1 text-xs">
          {records?.map((r: any) => (
            <li key={r.id} className="flex justify-between border rounded px-2 py-1">
              <span>{r.date} {r.category || 'その他'}</span>
              <span>{r.amount} 円</span>
            </li>
          ))}
        </ul>
      </div>
    </div>
  );
}
</file>

<file path="frontend/app/admin/login/page.tsx">
'use client';
import React, { useState } from 'react';

export default function AdminLoginPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    const res = await fetch('/api/auth/admin/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    if (res.ok) {
      location.href = '/admin/dashboard';
    } else {
      const err = await res.json().catch(() => ({}));
      alert(`ログイン失敗: ${err.message ?? res.statusText}`);
    }
  }

  return (
    <div className="p-6">
      <h1 className="text-xl font-bold">管理者 ログイン</h1>
      <form className="mt-4 space-y-2" onSubmit={onSubmit}>
        <input className="border p-2 w-64" placeholder="メール" value={email} onChange={(e) => setEmail(e.target.value)} />
        <input className="border p-2 w-64" type="password" placeholder="パスワード" value={password} onChange={(e) => setPassword(e.target.value)} />
        <button className="bg-blue-600 text-white px-4 py-2" type="submit">ログイン</button>
      </form>
    </div>
  );
}
</file>

<file path="frontend/app/admin/ng-words/page.tsx">
'use client';
import useSWR from 'swr';
import { listNgWords, addNgWord, removeNgWord } from '../../../lib/api-extended';
import { useState } from 'react';
import { useAuth } from '../../../contexts/AuthContext';

export default function AdminNgWordsPage() {
  const { isAdmin } = useAuth();
  const { data, mutate } = useSWR(isAdmin ? ['ngWords'] : null, listNgWords);
  const [word, setWord] = useState('');
  const [msg, setMsg] = useState<string|null>(null);
  const [err, setErr] = useState<string|null>(null);

  if (!isAdmin) return <div>管理者のみ</div>;

  async function onAdd(e: React.FormEvent) {
    e.preventDefault();
    setMsg(null); setErr(null);
    try {
      await addNgWord(word);
      setWord('');
      mutate();
      setMsg('追加しました');
    } catch (e: any) {
      setErr(e?.response?.data?.message || e.message);
    }
  }

  async function onRemove(id: string) {
    try {
      await removeNgWord(id);
      mutate();
    } catch (e: any) {
      setErr(e?.response?.data?.message || e.message);
    }
  }

  return (
    <div className="space-y-4">
      <h1 className="text-lg font-semibold">NGワード管理</h1>
      <div className="card space-y-2">
        <form onSubmit={onAdd} className="flex gap-2">
          <input className="border rounded px-2 py-1 text-sm flex-1" placeholder="ワード" value={word} onChange={(e) => setWord(e.target.value)} />
          <button className="border rounded px-3 py-1 text-sm">追加</button>
        </form>
        {msg && <div className="text-xs text-green-600">{msg}</div>}
        {err && <div className="text-xs text-red-600">{err}</div>}
        <ul className="space-y-1 text-xs">
          {data?.map((w: any) => (
            <li key={w.id} className="flex justify-between border rounded px-2 py-1">
              <span>{w.word}</span>
              <button className="text-red-600" onClick={() => onRemove(w.id)}>削除</button>
            </li>
          ))}
        </ul>
      </div>
    </div>
  );
}
</file>

<file path="frontend/app/admin/notifications/send/page.tsx">
'use client';

import { useState } from 'react';
import { sendNotification } from '../../../../lib/api.notifications-snippet';

export default function AdminSendNotificationPage() {
  const [userId, setUserId] = useState('');
  const [type, setType] = useState('info');
  const [title, setTitle] = useState('');
  const [text, setText] = useState('');
  const [linkUrl, setLinkUrl] = useState('');
  const [email, setEmail] = useState('');

  async function submit(e: React.FormEvent) {
    e.preventDefault();
    try {
      await sendNotification({ userId, type, title, text: text || undefined, linkUrl: linkUrl || undefined, email: email || undefined });
      alert('通知を送信しました（メール指定時は開発用jsonTransportで送信内容をログします）');
    } catch (e: any) {
      alert(e?.response?.data?.message || e.message || '送信に失敗しました');
    }
  }

  return (
    <div className="p-4 space-y-4 max-w-xl">
      <h1 className="text-lg font-semibold">通知送信（管理）</h1>
      <form onSubmit={submit} className="space-y-2 border rounded p-3">
        <input className="border px-2 py-1 w-full" placeholder="ユーザーID" value={userId} onChange={(e) => setUserId(e.target.value)} />
        <div className="flex gap-2">
          <select className="border px-2 py-1" value={type} onChange={(e) => setType(e.target.value)}>
            <option value="info">info</option>
            <option value="alert">alert</option>
          </select>
          <input className="border px-2 py-1 flex-1" placeholder="タイトル" value={title} onChange={(e) => setTitle(e.target.value)} />
        </div>
        <textarea className="border px-2 py-1 w-full" rows={5} placeholder="本文（任意）" value={text} onChange={(e) => setText(e.target.value)} />
        <input className="border px-2 py-1 w-full" placeholder="リンクURL（任意）" value={linkUrl} onChange={(e) => setLinkUrl(e.target.value)} />
        <input className="border px-2 py-1 w-full" placeholder="メール（任意・開発用送信）" value={email} onChange={(e) => setEmail(e.target.value)} />
        <button className="border px-3 py-2 rounded">送信</button>
      </form>
    </div>
  );
}
</file>

<file path="frontend/app/admin/policies/page.tsx">
'use client';
import { useState } from 'react';
import useSWR from 'swr';
import { adminFetchUsers } from '../../../lib/api';
import { fetchPolicies, createPolicy, updatePolicy } from '../../../lib/api-extended';
import { useAuth } from '../../../contexts/AuthContext';

export default function AdminPoliciesPage() {
  const { isAdmin } = useAuth();
  const { data: politicians } = useSWR(isAdmin ? ['adminUsersPoliticians'] : null, () => adminFetchUsers({ role: 'politician', page: 1, pageSize: 300 }));
  const [selectedPolitician, setSelectedPolitician] = useState('');
  const { data: policies, mutate } = useSWR(selectedPolitician ? ['policies', selectedPolitician] : null, () => fetchPolicies(selectedPolitician));
  const [form, setForm] = useState({ title: '', description: '', category: '', status: 'pending' });
  const [msg, setMsg] = useState<string|null>(null);
  const [err, setErr] = useState<string|null>(null);

  if (!isAdmin) return <div>管理者のみアクセス可能です。</div>;

  async function onCreate(e: React.FormEvent) {
    e.preventDefault();
    setMsg(null); setErr(null);
    try {
      await createPolicy(selectedPolitician, form);
      setForm({ title: '', description: '', category: '', status: 'pending' });
      mutate();
      setMsg('公約を追加しました');
    } catch (e: any) {
      setErr(e?.response?.data?.message || e.message);
    }
  }

  async function onStatus(id: string, status: string) {
    await updatePolicy(id, { status });
    mutate();
  }

  return (
    <div className="space-y-4">
      <h1 className="text-lg font-semibold">公約管理</h1>
      <div className="card space-y-3">
        <select
          className="border rounded px-3 py-2 text-sm w-full"
          value={selectedPolitician}
          onChange={(e) => setSelectedPolitician(e.target.value)}
        >
          <option value="">政治家を選択</option>
          {politicians?.items?.map((p: any) => (
            <option key={p.id} value={p.id}>{p.name || p.email}</option>
          ))}
        </select>

        {selectedPolitician && (
          <form onSubmit={onCreate} className="space-y-2 text-sm">
            <input className="border rounded px-2 py-1 w-full" placeholder="タイトル" value={form.title} onChange={(e) => setForm(f => ({ ...f, title: e.target.value }))} />
            <textarea className="border rounded px-2 py-1 w-full min-h-[120px]" placeholder="説明" value={form.description} onChange={(e) => setForm(f => ({ ...f, description: e.target.value }))} />
            <input className="border rounded px-2 py-1 w-full" placeholder="カテゴリ" value={form.category} onChange={(e) => setForm(f => ({ ...f, category: e.target.value }))} />
            <select className="border rounded px-2 py-1 w-full" value={form.status} onChange={(e) => setForm(f => ({ ...f, status: e.target.value }))}>
              <option value="pending">pending</option>
              <option value="in-progress">in-progress</option>
              <option value="achieved">achieved</option>
              <option value="abandoned">abandoned</option>
            </select>
            {msg && <div className="text-green-600 text-xs">{msg}</div>}
            {err && <div className="text-red-600 text-xs">{err}</div>}
            <button className="px-3 py-2 border rounded text-sm">追加</button>
          </form>
        )}
      </div>
      <div className="card space-y-2">
        <h2 className="font-medium text-sm">公約一覧</h2>
        {!policies && selectedPolitician && <div className="text-xs">読み込み中...</div>}
        {policies?.map((p: any) => (
          <div key={p.id} className="border rounded p-2 text-xs space-y-1">
            <div className="font-semibold">{p.title}</div>
            <div className="text-slate-600">{p.description || '(説明なし)'}</div>
            <div className="flex items-center gap-2">
              <span className="text-[10px]">status: {p.status}</span>
              <select
                className="border rounded px-1 py-0.5 text-[10px]"
                value={p.status}
                onChange={(e) => onStatus(p.id, e.target.value)}
              >
                <option value="pending">pending</option>
                <option value="in-progress">in-progress</option>
                <option value="achieved">achieved</option>
                <option value="abandoned">abandoned</option>
              </select>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="frontend/app/admin/politicians/import/page.tsx">
'use client';
import { useState } from 'react';
import { adminBulkPoliticiansCSV, adminBulkPoliticiansJSON, BulkResult } from '../../../../lib/api';

export default function AdminPoliticiansImportPage() {
  const [mode, setMode] = useState<'csv' | 'json'>('csv');
  const [text, setText] = useState('');
  const [result, setResult] = useState<BulkResult | null>(null);
  const [err, setErr] = useState<string | null>(null);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setErr(null); setResult(null);
    try {
      let res: BulkResult;
      if (mode === 'csv') {
        if (!text.trim()) throw new Error('CSVテキストを入力してください');
        res = await adminBulkPoliticiansCSV(text);
      } else {
        const json = JSON.parse(text);
        if (!Array.isArray(json)) throw new Error('JSONは配列で入力してください');
        res = await adminBulkPoliticiansJSON(json);
      }
      setResult(res);
    } catch (e: any) {
      setErr(e?.message || 'インポートに失敗しました');
    }
  }

  return (
    <div className="space-y-4">
      <h1 className="text-lg font-semibold">政治家インポート</h1>
      <div className="card space-y-3">
        <div className="flex items-center gap-3 text-sm">
          <label className="flex items-center gap-2">
            <input type="radio" name="mode" value="csv" checked={mode === 'csv'} onChange={() => setMode('csv')} />
            CSVでインポート
          </label>
          <a className="text-blue-600 underline" href="/admin/politician-import-template.csv" target="_blank" rel="noopener noreferrer">CSVテンプレート</a>
          <label className="flex items-center gap-2">
            <input type="radio" name="mode" value="json" checked={mode === 'json'} onChange={() => setMode('json')} />
            JSON配列でインポート
          </label>
        </div>
        <form onSubmit={onSubmit} className="space-y-2">
          <textarea
            className="w-full border rounded px-3 py-2 text-sm min-h-[220px]"
            placeholder={mode === 'csv' ? 'email,name,party,addressPref,addressCity,password\n...' : '[{ "email": "...", "name": "...", "party": "...", "addressPref": "...", "addressCity": "...", "password": "..." } ]'}
            value={text}
            onChange={(e) => setText(e.target.value)}
          />
          <button className="px-4 py-2 border rounded text-sm">インポート</button>
        </form>
        {err && <div className="text-sm text-red-600">{err}</div>}
        {result && (
          <div className="text-sm">
            <div className="font-medium mb-1">結果: {result.count}件</div>
            <ul className="space-y-1 max-h-64 overflow-auto">
              {result.results.map((r, i) => (
                <li key={i} className={r.created ? 'text-green-600' : r.error ? 'text-red-600' : ''}>
                  {r.email} - {r.created ? '作成' : r.error ? `失敗 (${r.error})` : '既存スキップ'} {r.id ? `(id: ${r.id})` : ''}
                </li>
              ))}
            </ul>
          </div>
        )}
      </div>
      <p className="text-xs text-slate-500">
        パスワード未指定の場合はランダム生成されます。作成後のパスワード共有は別途ご手配ください。
      </p>
    </div>
  );
}
</file>

<file path="frontend/app/admin/politicians/login/page.tsx">
'use client';
import React, { useState } from 'react';

export default function PoliticianLoginPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    const res = await fetch('/api/auth/politician/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    if (res.ok) {
      location.href = '/politician/dashboard';
    } else {
      const err = await res.json().catch(() => ({}));
      alert(`ログイン失敗: ${err.message ?? res.statusText}`);
    }
  }

  return (
    <div className="p-6">
      <h1 className="text-xl font-bold">議員 ログイン</h1>
      <form className="mt-4 space-y-2" onSubmit={onSubmit}>
        <input className="border p-2 w-64" placeholder="メール" value={email} onChange={(e) => setEmail(e.target.value)} />
        <input className="border p-2 w-64" type="password" placeholder="パスワード" value={password} onChange={(e) => setPassword(e.target.value)} />
        <button className="bg-blue-600 text-white px-4 py-2" type="submit">ログイン</button>
      </form>
    </div>
  );
}
</file>

<file path="frontend/app/admin/politicians/new/page.tsx">
'use client';
import { useState } from 'react';
import api, { unwrap } from '../../../../lib/api';
import { useAuth } from '../../../../contexts/AuthContext';

export default function AdminCreatePoliticianPage() {
  const { isAdmin } = useAuth();
  const [form, setForm] = useState({
    email: '',
    password: '',
    name: '',
    kana: '',
    party: '',
    constituency: '',
    termCount: '',
    xHandle: '',
    instagramHandle: '',
    facebookUrl: '',
    youtubeUrl: '',
    websiteUrl: '',
  });
  const [msg, setMsg] = useState<string|null>(null);
  const [err, setErr] = useState<string|null>(null);

  if (!isAdmin) return <div>管理者のみアクセス可能です。</div>;

  async function submit(e: React.FormEvent) {
    e.preventDefault();
    setMsg(null); setErr(null);
    try {
      const res = await api.post('/admin/politicians', {
        email: form.email,
        password: form.password || undefined,
        name: form.name || undefined,
        kana: form.kana || undefined,
        party: form.party || undefined,
        constituency: form.constituency || undefined,
        termCount: form.termCount ? Number(form.termCount) : undefined,
        xHandle: form.xHandle || undefined,
        instagramHandle: form.instagramHandle || undefined,
        facebookUrl: form.facebookUrl || undefined,
        youtubeUrl: form.youtubeUrl || undefined,
        websiteUrl: form.websiteUrl || undefined,
      });
      const data = unwrap(res);
      setMsg(`登録しました: id=${data.id}, email=${data.email}`);
      setForm({ ...form, email: '', password: '' });
    } catch (e: any) {
      setErr(e?.response?.data?.message || e.message);
    }
  }

  function i(name: keyof typeof form, value: string) {
    setForm(f => ({ ...f, [name]: value }));
  }

  return (
    <div className="space-y-4">
      <h1 className="text-lg font-semibold">議員登録（管理者専用）</h1>
      <form onSubmit={submit} className="space-y-2 text-sm">
        <input className="border rounded px-2 py-1 w-full" placeholder="メール" value={form.email} onChange={e => i('email', e.target.value)} />
        <input className="border rounded px-2 py-1 w-full" placeholder="初期パスワード（任意）" value={form.password} onChange={e => i('password', e.target.value)} />
        <input className="border rounded px-2 py-1 w-full" placeholder="氏名" value={form.name} onChange={e => i('name', e.target.value)} />
        <input className="border rounded px-2 py-1 w-full" placeholder="ふりがな" value={form.kana} onChange={e => i('kana', e.target.value)} />
        <input className="border rounded px-2 py-1 w-full" placeholder="党" value={form.party} onChange={e => i('party', e.target.value)} />
        <input className="border rounded px-2 py-1 w-full" placeholder="選挙区" value={form.constituency} onChange={e => i('constituency', e.target.value)} />
        <input className="border rounded px-2 py-1 w-full" placeholder="当選回数" value={form.termCount} onChange={e => i('termCount', e.target.value)} />
        <input className="border rounded px-2 py-1 w-full" placeholder="Xハンドル" value={form.xHandle} onChange={e => i('xHandle', e.target.value)} />
        <input className="border rounded px-2 py-1 w-full" placeholder="Instagram" value={form.instagramHandle} onChange={e => i('instagramHandle', e.target.value)} />
        <input className="border rounded px-2 py-1 w-full" placeholder="Facebook URL" value={form.facebookUrl} onChange={e => i('facebookUrl', e.target.value)} />
        <input className="border rounded px-2 py-1 w-full" placeholder="YouTube URL" value={form.youtubeUrl} onChange={e => i('youtubeUrl', e.target.value)} />
        <input className="border rounded px-2 py-1 w-full" placeholder="公式サイトURL" value={form.websiteUrl} onChange={e => i('websiteUrl', e.target.value)} />
        {msg && <div className="text-xs text-green-600">{msg}</div>}
        {err && <div className="text-xs text-red-600">{err}</div>}
        <button className="border rounded px-3 py-2">登録</button>
      </form>
    </div>
  );
}
</file>

<file path="frontend/app/admin/politicians/signup/page.tsx">
'use client';
import React, { useState } from 'react';

export default function PoliticianSignupPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [name, setName] = useState('');
  const [regionId, setRegionId] = useState('');
  const [partyId, setPartyId] = useState('');

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    const res = await fetch('/api/auth/politician/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password, name, regionId, partyId }),
    });
    if (res.ok) {
      alert('議員登録に成功しました。ログインしてください。');
      location.href = '/politician/login';
    } else {
      const err = await res.json().catch(() => ({}));
      alert(`失敗しました: ${err.message ?? res.statusText}`);
    }
  }

  return (
    <div className="p-6">
      <h1 className="text-xl font-bold">議員 新規登録</h1>
      <form className="mt-4 space-y-2" onSubmit={onSubmit}>
        <input className="border p-2 w-64" placeholder="メール" value={email} onChange={(e) => setEmail(e.target.value)} />
        <input className="border p-2 w-64" type="password" placeholder="パスワード" value={password} onChange={(e) => setPassword(e.target.value)} />
        <input className="border p-2 w-64" placeholder="氏名" value={name} onChange={(e) => setName(e.target.value)} />
        <input className="border p-2 w-64" placeholder="地域ID" value={regionId} onChange={(e) => setRegionId(e.target.value)} />
        <input className="border p-2 w-64" placeholder="政党ID" value={partyId} onChange={(e) => setPartyId(e.target.value)} />
        <button className="bg-green-600 text-white px-4 py-2" type="submit">登録</button>
      </form>
      <p className="mt-2"><a href="/politician/login" className="text-blue-600 underline">ログインはこちら</a></p>
    </div>
  );
}
</file>

<file path="frontend/app/admin/posts/[id]/edit/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { useAuth } from '../../../../contexts/AuthContext';
import { useRouter, useParams } from 'next/navigation';
import { fetchPostById, updatePost } from '../../../../lib/api.posts-edit-snippet';
import { softDeletePost, restorePost } from '../../../../lib/api.posts-manage-snippet';

export default function PostEditPage() {
  const { ready, isLoggedIn, user } = useAuth();
  const router = useRouter();
  const params = useParams();
  const id = params?.id as string;

  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  const [title, setTitle] = useState('');
  const [body, setBody] = useState('');
  const [postCategory, setPostCategory] = useState<'policy' | 'activity'>('activity');
  const [visibility, setVisibility] = useState<'public' | 'hidden'>('public');
  const [regionPref, setRegionPref] = useState('');
  const [regionCity, setRegionCity] = useState('');
  const [deletedAt, setDeletedAt] = useState<string | null>(null);

  useEffect(() => {
    if (!id) return;
    if (ready && isLoggedIn) {
      (async () => {
        setLoading(true);
        try {
          const p = await fetchPostById(id);
          setTitle(p.title || '');
          setBody(p.body);
          setPostCategory(p.postCategory);
          setVisibility(p.hidden ? 'hidden' : 'public');
          setRegionPref(p.regionPref || '');
          setRegionCity(p.regionCity || '');
          setDeletedAt((p as any).deletedAt || null);
        } catch (e: any) {
          setErr(e?.response?.data?.message || e.message || '読み込みに失敗しました');
        } finally {
          setLoading(false);
        }
      })();
    }
  }, [ready, isLoggedIn, id]);

  async function onSave(e: React.FormEvent) {
    e.preventDefault();
    setSaving(true);
    setErr(null);
    try {
      await updatePost(id, {
        title: title || undefined,
        body,
        postCategory,
        visibility,
        regionPref: regionPref || undefined,
        regionCity: regionCity || undefined,
      });
      alert('更新しました');
      router.push('/feed');
    } catch (e: any) {
      setErr(e?.response?.data?.message || e.message || '更新に失敗しました');
    } finally {
      setSaving(false);
    }
  }

  async function onDelete() {
    if (!confirm('この投稿を非表示(論理削除)にしますか？')) return;
    try {
      const p = await softDeletePost(id);
      setDeletedAt((p as any).deletedAt || new Date().toISOString());
      alert('論理削除しました');
    } catch (e: any) {
      alert(e?.response?.data?.message || e.message || '削除に失敗しました');
    }
  }

  async function onRestore() {
    try {
      const p = await restorePost(id);
      setDeletedAt((p as any).deletedAt || null);
      alert('復元しました');
    } catch (e: any) {
      alert(e?.response?.data?.message || e.message || '復元に失敗しました');
    }
  }

  if (!ready) return <div className="p-4 text-sm text-slate-500">読み込み中...</div>;
  if (!isLoggedIn) return <div className="p-4 text-sm text-slate-500">ログインしてください</div>;
  if (user?.role !== 'admin' && user?.role !== 'politician')
    return <div className="p-4 text-sm text-red-600">権限がありません</div>;

  if (loading) return <div className="p-4 text-sm">投稿読み込み中...</div>;
  if (err) return <div className="p-4 text-sm text-red-600">{err}</div>;

  return (
    <div className="p-4 space-y-4 max-w-2xl">
      <h1 className="text-lg font-semibold">投稿編集</h1>
      {deletedAt && (
        <div className="text-xs text-red-700 border border-red-300 p-2 rounded">
          この投稿は論理削除されています（deletedAt: {new Date(deletedAt).toLocaleString()}）
        </div>
      )}
      <form onSubmit={onSave} className="space-y-3 border rounded p-3">
        <div className="flex gap-2">
          <select className="border px-2 py-1" value={postCategory} onChange={(e) => setPostCategory(e.target.value as any)}>
            <option value="activity">活動報告</option>
            <option value="policy">政策</option>
          </select>
          <select className="border px-2 py-1" value={visibility} onChange={(e) => setVisibility(e.target.value as any)}>
            <option value="public">公開</option>
            <option value="hidden">非公開</option>
          </select>
        </div>

        <input className="border px-2 py-1 w-full" placeholder="タイトル（任意）" value={title} onChange={(e) => setTitle(e.target.value)} />
        <textarea className="border px-2 py-1 w-full" rows={8} value={body} onChange={(e) => setBody(e.target.value)} placeholder="本文" />
        <div className="flex gap-2">
          <input className="border px-2 py-1" placeholder="都道府県" value={regionPref} onChange={(e) => setRegionPref(e.target.value)} />
          <input className="border px-2 py-1" placeholder="市区町村" value={regionCity} onChange={(e) => setRegionCity(e.target.value)} />
        </div>

        <div className="flex items-center gap-2">
          <button className="border px-3 py-2 rounded disabled:opacity-50" disabled={saving}>
            {saving ? '保存中...' : '保存'}
          </button>
          {!deletedAt ? (
            <button type="button" className="border px-3 py-2 rounded text-red-700" onClick={onDelete}>
              論理削除
            </button>
          ) : (
            <button type="button" className="border px-3 py-2 rounded" onClick={onRestore}>
              復元
            </button>
          )}
        </div>
      </form>
    </div>
  );
}
</file>

<file path="frontend/app/admin/posts/new/page.tsx">
'use client';

import PostCreateForm from '../../../../components/PostCreateForm';
import { useAuth } from '../../../../contexts/AuthContext';

export default function AdminPostNewPage() {
  const { user, ready, isLoggedIn } = useAuth();

  if (!ready) return <div className="p-4 text-sm text-slate-500">読み込み中...</div>;
  if (!isLoggedIn) return <div className="p-4 text-sm text-slate-500">ログインしてください</div>;
  if (user?.role !== 'admin' && user?.role !== 'politician')
    return <div className="p-4 text-sm text-red-600">権限がありません（admin / politician 専用）</div>;

  return (
    <div className="p-4 space-y-4">
      <h1 className="text-lg font-semibold">新規投稿</h1>
      <PostCreateForm />
    </div>
  );
}
</file>

<file path="frontend/app/admin/reports/page.tsx">
'use client';
import useSWR from 'swr';
import { adminListReports, adminUpdateReportStatus, adminActionReport } from '../../../lib/api-extended';
import { useAuth } from '../../../contexts/AuthContext';
import { useState } from 'react';

export default function AdminReportsPage() {
  const { isAdmin } = useAuth();
  const [statusFilter, setStatusFilter] = useState('');
  const { data, mutate } = useSWR(isAdmin ? ['reports', statusFilter] : null, () => adminListReports({ status: statusFilter || undefined }));
  const [err, setErr] = useState<string|null>(null);

  if (!isAdmin) return <div>管理者のみアクセス可能</div>;

  async function changeStatus(id: string, status: string) {
    setErr(null);
    try {
      await adminUpdateReportStatus(id, status);
      mutate();
    } catch (e: any) {
      setErr(e?.response?.data?.message || e.message);
    }
  }

  async function action(id: string, action: string) {
    setErr(null);
    try {
      await adminActionReport(id, action as any);
      mutate();
    } catch (e: any) {
      setErr(e?.response?.data?.message || e.message);
    }
  }

  return (
    <div className="space-y-4">
      <h1 className="text-lg font-semibold">通報管理</h1>
      <div className="flex gap-2 text-sm">
        <select value={statusFilter} onChange={(e) => setStatusFilter(e.target.value)} className="border rounded px-2 py-1">
          <option value="">全ステータス</option>
          <option value="open">open</option>
          <option value="reviewing">reviewing</option>
          <option value="resolved">resolved</option>
          <option value="dismissed">dismissed</option>
          <option value="actioned">actioned</option>
        </select>
        <button className="border rounded px-2 py-1" onClick={() => mutate()}>更新</button>
      </div>
      {err && <div className="text-xs text-red-600">{err}</div>}
      <div className="card space-y-2 text-xs">
        {!data && <div>読み込み中...</div>}
        {data?.length === 0 && <div>通報なし</div>}
        {data?.map((r: any) => (
          <div key={r.id} className="border rounded p-2 space-y-1">
            <div className="font-semibold">{r.targetType} : {r.targetId}</div>
            <div>カテゴリ: {r.reasonCategory}</div>
            <div>本文: {r.reasonText || '(なし)'}</div>
            <div>status: {r.status}</div>
            <div className="flex gap-2 flex-wrap">
              {['open','reviewing','resolved','dismissed','actioned'].map(s => (
                <button key={s} className="border rounded px-2 py-1" onClick={() => changeStatus(r.id, s)}>{s}</button>
              ))}
              {r.targetType === 'user' && <button className="border rounded px-2 py-1" onClick={() => action(r.id,'ban-user')}>ban-user</button>}
              {r.targetType === 'post' && <button className="border rounded px-2 py-1" onClick={() => action(r.id,'hide-post')}>hide-post</button>}
              {r.targetType === 'comment' && <button className="border rounded px-2 py-1" onClick={() => action(r.id,'hide-comment')}>hide-comment</button>}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="frontend/app/admin/scheduled-posts/page.tsx">
'use client';
import useSWR from 'swr';
import { schedulePost, listScheduledPosts, cancelScheduledPost, adminFetchUsers } from '../../../lib/api-extended';
import { useAuth } from '../../../contexts/AuthContext';
import { useState } from 'react';

export default function AdminScheduledPostsPage() {
  const { isAdmin } = useAuth();
  const { data: scheduled, mutate } = useSWR(isAdmin ? ['scheduledPosts'] : null, () => listScheduledPosts());
  const { data: politicians } = useSWR(isAdmin ? ['adminPoliticiansForSchedule'] : null, () => adminFetchUsers({ role: 'politician', page: 1, pageSize: 300 }) as any);
  const [form, setForm] = useState({ authorId: '', title: '', body: '', tags: '', scheduledAt: '' });
  const [err, setErr] = useState<string|null>(null);
  const [msg, setMsg] = useState<string|null>(null);

  if (!isAdmin) return <div>管理者のみ</div>;

  async function onSchedule(e: React.FormEvent) {
    e.preventDefault();
    setErr(null); setMsg(null);
    try {
      await schedulePost({
        authorId: form.authorId || undefined,
        title: form.title || undefined,
        body: form.body,
        tags: form.tags ? form.tags.split(',').map(t => t.trim()).filter(Boolean) : undefined,
        scheduledAt: form.scheduledAt,
      });
      setForm({ authorId: '', title: '', body: '', tags: '', scheduledAt: '' });
      setMsg('予約しました');
      mutate();
    } catch (e: any) {
      setErr(e?.response?.data?.message || e.message);
    }
  }

  return (
    <div className="space-y-4">
      <h1 className="text-lg font-semibold">投稿予約</h1>
      <div className="card">
        <form onSubmit={onSchedule} className="space-y-2 text-sm">
          <select className="border rounded px-2 py-1 w-full" value={form.authorId} onChange={(e) => setForm(f => ({ ...f, authorId: e.target.value }))}>
            <option value="">運営名義</option>
            {politicians?.items?.map((p: any) => (
              <option key={p.id} value={p.id}>{p.name || p.email}</option>
            ))}
          </select>
            <input className="border rounded px-2 py-1 w-full" placeholder="タイトル（任意）" value={form.title} onChange={(e) => setForm(f => ({ ...f, title: e.target.value }))} />
          <textarea className="border rounded px-2 py-1 w-full min-h-[120px]" placeholder="本文" value={form.body} onChange={(e) => setForm(f => ({ ...f, body: e.target.value }))} />
          <input className="border rounded px-2 py-1 w-full" placeholder="タグ（カンマ区切り 任意）" value={form.tags} onChange={(e) => setForm(f => ({ ...f, tags: e.target.value }))} />
          <input className="border rounded px-2 py-1 w-full" type="datetime-local" value={form.scheduledAt} onChange={(e) => setForm(f => ({ ...f, scheduledAt: e.target.value }))} />
          {msg && <div className="text-xs text-green-600">{msg}</div>}
          {err && <div className="text-xs text-red-600">{err}</div>}
          <button className="px-3 py-2 border rounded text-sm">予約</button>
        </form>
      </div>
      <div className="card space-y-2 text-xs">
        <h2 className="font-medium text-sm">予約一覧</h2>
        {!scheduled && <div>読み込み中...</div>}
        {scheduled?.map((sp: any) => (
          <div key={sp.id} className="border rounded p-2 flex flex-col gap-1">
            <div>ID: {sp.id}</div>
            <div>authorId: {sp.authorId}</div>
            <div>status: {sp.status}</div>
            <div>scheduledAt: {sp.scheduledAt}</div>
            {sp.failureReason && <div className="text-red-600">失敗: {sp.failureReason}</div>}
            {sp.status === 'scheduled' && (
              <button className="border rounded px-2 py-1 w-fit" onClick={async () => {
                await cancelScheduledPost(sp.id);
                mutate();
              }}>キャンセル</button>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="frontend/app/admin/search/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import api, { unwrap } from '../../lib/api';

type PostItem = {
  id: string;
  title?: string;
  body: string;
  postCategory: 'policy' | 'activity';
  regionPref?: string;
  regionCity?: string;
  createdAt: string;
};

type NotificationItem = {
  id: string;
  title: string;
  type: string;
  body?: string;
  createdAt: string;
};

export default function AdminSearchPage() {
  const [q, setQ] = useState('');
  const [category, setCategory] = useState<'all' | 'policy' | 'activity'>('all');
  const [pref, setPref] = useState('');
  const [city, setCity] = useState('');

  const [posts, setPosts] = useState<PostItem[]>([]);
  const [notifications, setNotifications] = useState<NotificationItem[]>([]);
  const [loading, setLoading] = useState(false);

  async function search() {
    setLoading(true);
    try {
      const resPosts = await api.get('/admin/search/posts', {
        params: {
          q: q || undefined,
          category: category === 'all' ? undefined : category,
          pref: pref || undefined,
          city: city || undefined,
        },
      });
      const resN = await api.get('/admin/search/notifications', {
        params: { q: q || undefined },
      });
      setPosts(unwrap<PostItem[]>(resPosts));
      setNotifications(unwrap<NotificationItem[]>(resN));
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    // 初期ロード
    search();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  return (
    <div className="p-4 space-y-4">
      <h1 className="text-lg font-semibold">検索・フィルタ</h1>
      <div className="flex gap-2">
        <input className="border px-2 py-1 w-64" placeholder="キーワード" value={q} onChange={(e) => setQ(e.target.value)} />
        <select className="border px-2 py-1" value={category} onChange={(e) => setCategory(e.target.value as any)}>
          <option value="all">すべて</option>
          <option value="policy">政策</option>
          <option value="activity">活動</option>
        </select>
        <input className="border px-2 py-1" placeholder="都道府県" value={pref} onChange={(e) => setPref(e.target.value)} />
        <input className="border px-2 py-1" placeholder="市区町村" value={city} onChange={(e) => setCity(e.target.value)} />
        <button className="border px-3 py-1 rounded" onClick={search} disabled={loading}>
          {loading ? '検索中...' : '検索'}
        </button>
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <h2 className="font-medium">投稿</h2>
          <ul className="space-y-2">
            {posts.map((p) => (
              <li key={p.id} className="border rounded p-2 text-sm">
                <div className="font-medium">{p.title || '(無題)'}</div>
                <div className="text-xs text-slate-500">
                  {p.postCategory} / {p.regionPref || '-'} {p.regionCity || ''}
                </div>
                <div className="text-xs">{p.body.slice(0, 120)}...</div>
              </li>
            ))}
            {!loading && posts.length === 0 && <li className="text-xs text-slate-500">該当する投稿がありません</li>}
          </ul>
        </div>
        <div>
          <h2 className="font-medium">通知</h2>
          <ul className="space-y-2">
            {notifications.map((n) => (
              <li key={n.id} className="border rounded p-2 text-sm">
                <div className="font-medium">{n.title}</div>
                <div className="text-xs text-slate-500">{n.type}</div>
                <div className="text-xs">{(n.body || '').slice(0, 120)}...</div>
              </li>
            ))}
            {!loading && notifications.length === 0 && <li className="text-xs text-slate-500">該当する通知がありません</li>}
          </ul>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="frontend/app/admin/signup/page.tsx">
'use client';
import React, { useState } from 'react';

export default function AdminSignupPage() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    const res = await fetch('/api/auth/admin/signup', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    if (res.ok) {
      alert('管理者登録に成功しました。ログインしてください。');
      location.href = '/admin/login';
    } else {
      const err = await res.json().catch(() => ({}));
      alert(`失敗しました: ${err.message ?? res.statusText}`);
    }
  }

  return (
    <div className="p-6">
      <h1 className="text-xl font-bold">管理者 新規登録</h1>
      <form className="mt-4 space-y-2" onSubmit={onSubmit}>
        <input className="border p-2 w-64" placeholder="メール" value={email} onChange={(e) => setEmail(e.target.value)} />
        <input className="border p-2 w-64" type="password" placeholder="パスワード" value={password} onChange={(e) => setPassword(e.target.value)} />
        <button className="bg-blue-600 text-white px-4 py-2" type="submit">登録</button>
      </form>
      <p className="mt-2"><a href="/admin/login" className="text-blue-600 underline">ログインはこちら</a></p>
    </div>
  );
}
</file>

<file path="frontend/app/admin/users/page.tsx">
'use client';

import useSWR from 'swr';
import { useEffect, useState, useCallback } from 'react';
import {
  adminFetchUsers,
  adminUpdateUser,
  AdminUserSummary,
  AdminUsersResponse,
} from '../../../lib/api';
import { useAuth } from '../../../contexts/AuthContext';

const fetcher = async (key: string) => {
  // key 例: /admin/users?q=&role=&status=&page=1&perPage=20
  const url = new URL(key, window.location.origin);
  const params: any = {};
  url.searchParams.forEach((v, k) => {
    if (v) params[k] = v;
  });
  return adminFetchUsers(params);
};

export default function AdminUsersPage() {
  const { user, isLoggedIn, ready } = useAuth();
  const [q, setQ] = useState('');
  const [role, setRole] = useState('');
  const [status, setStatus] = useState('');
  const [page, setPage] = useState(1);
  const perPage = 20;

  const key = `/admin/users?q=${encodeURIComponent(q)}&role=${encodeURIComponent(
    role,
  )}&status=${encodeURIComponent(status)}&page=${page}&perPage=${perPage}`;

  const { data, error, isLoading, mutate } = useSWR<AdminUsersResponse>(ready && isLoggedIn ? key : null, fetcher);

  useEffect(() => {
    // 管理者以外は何も表示しない
  }, [user]);

  const onChangeField = useCallback(
    async (id: string, patch: Partial<{ role: string; status: string }>) => {
      try {
        await adminUpdateUser(id, patch);
        mutate();
      } catch (e: any) {
        alert('更新失敗: ' + (e?.response?.data?.message ?? e?.message ?? 'unknown'));
      }
    },
    [mutate],
  );

  if (!ready) return <div className="p-4 text-sm text-slate-500">読み込み中...</div>;
  if (!isLoggedIn) return <div className="p-4 text-sm text-slate-500">ログインしてください</div>;
  if (user?.role !== 'admin')
    return <div className="p-4 text-sm text-red-600">権限がありません（admin専用）</div>;

  return (
    <div className="space-y-4 p-4">
      <h1 className="text-lg font-semibold">ユーザー管理</h1>

      <form
        onSubmit={(e) => {
          e.preventDefault();
          setPage(1);
          mutate();
        }}
        className="flex flex-wrap gap-2 items-end"
      >
        <div className="flex flex-col">
          <label className="text-xs">検索</label>
            <input
              className="border px-2 py-1"
              value={q}
              onChange={(e) => setQ(e.target.value)}
              placeholder="メール/名前など"
            />
        </div>
        <div className="flex flex-col">
          <label className="text-xs">ロール</label>
          <select
            className="border px-2 py-1"
            value={role}
            onChange={(e) => {
              setRole(e.target.value);
              setPage(1);
            }}
          >
            <option value="">すべて</option>
            <option value="admin">admin</option>
            <option value="politician">politician</option>
            <option value="user">user</option>
          </select>
        </div>
        <div className="flex flex-col">
          <label className="text-xs">ステータス</label>
          <select
            className="border px-2 py-1"
            value={status}
            onChange={(e) => {
              setStatus(e.target.value);
              setPage(1);
            }}
          >
            <option value="">すべて</option>
            <option value="active">active</option>
            <option value="suspended">suspended</option>
          </select>
        </div>
        <button className="border px-3 py-1 rounded text-sm">検索</button>
      </form>

      {isLoading && <div className="text-sm">読み込み中...</div>}
      {error && <div className="text-sm text-red-600">取得失敗: {(error as any)?.message}</div>}

      <div className="overflow-x-auto">
        <table className="min-w-[600px] text-sm border">
          <thead>
            <tr className="bg-slate-100">
              <th className="border px-2 py-1 text-left">ID</th>
              <th className="border px-2 py-1 text-left">Email</th>
              <th className="border px-2 py-1 text-left">Role</th>
              <th className="border px-2 py-1 text-left">Status</th>
              <th className="border px-2 py-1 text-left">Created</th>
              <th className="border px-2 py-1"></th>
            </tr>
          </thead>
          <tbody>
            {data?.items?.map((u: AdminUserSummary) => (
              <tr key={u.id}>
                <td className="border px-2 py-1">{u.id.slice(0, 8)}…</td>
                <td className="border px-2 py-1">{u.email}</td>
                <td className="border px-2 py-1">
                  <select
                    className="border px-1 py-0.5 text-xs"
                    value={u.role}
                    onChange={(e) => onChangeField(u.id, { role: e.target.value })}
                  >
                    <option value="admin">admin</option>
                    <option value="politician">politician</option>
                    <option value="user">user</option>
                  </select>
                </td>
                <td className="border px-2 py-1">
                  <select
                    className="border px-1 py-0.5 text-xs"
                    value={u.status}
                    onChange={(e) => onChangeField(u.id, { status: e.target.value })}
                  >
                    <option value="active">active</option>
                    <option value="suspended">suspended</option>
                  </select>
                </td>
                <td className="border px-2 py-1">{new Date(u.createdAt).toLocaleDateString()}</td>
                <td className="border px-2 py-1">
                  <button
                    className="text-xs underline"
                    onClick={() => alert(`詳細表示は後で実装 (userId=${u.id})`)}
                  >
                    詳細
                  </button>
                </td>
              </tr>
            ))}
            {!data?.items?.length && !isLoading && (
              <tr>
                <td colSpan={6} className="border px-2 py-3 text-center text-slate-500">
                  対象ユーザーなし
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>

      {data && data.total > perPage && (
        <div className="flex gap-2 items-center">
          <button
            disabled={page === 1}
            onClick={() => setPage((p) => Math.max(1, p - 1))}
            className="border px-2 py-1 rounded disabled:opacity-50"
          >
            前へ
          </button>
          <span className="text-xs">
            {page} / {Math.ceil(data.total / perPage)} ページ
          </span>
          <button
            disabled={page >= Math.ceil(data.total / perPage)}
            onClick={() => setPage((p) => p + 1)}
            className="border px-2 py-1 rounded disabled:opacity-50"
          >
            次へ
          </button>
        </div>
      )}
    </div>
  );
}
</file>

<file path="frontend/app/admin/page.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import { api } from '@/lib/api';
import Header from '@/components/Header';
import Footer from '@/components/Footer';
import { motion } from 'framer-motion';
import { 
  Users, 
  FileText, 
  DollarSign, 
  Activity, 
  Upload, 
  Plus, 
  Edit, 
  Trash2, 
  BarChart3,
  Download,
  RefreshCw
} from 'lucide-react';
import toast from 'react-hot-toast';

interface Member {
  id: string;
  name: string;
  email: string;
  photoUrl?: string;
  affiliation: string;
  biography?: string;
  position?: string;
  district?: string;
  party?: string;
  website?: string;
  twitterHandle?: string;
  pledges: Pledge[];
  activityLogs: ActivityLog[];
  activityFunds: ActivityFund[];
}

interface Pledge {
  id: string;
  title: string;
  description: string;
  category?: string;
  status: 'pending' | 'in_progress' | 'completed' | 'cancelled';
  voteCount: number;
  supportCount: number;
  opposeCount: number;
}

interface ActivityLog {
  id: string;
  title: string;
  content: string;
  source: 'manual' | 'twitter' | 'rss' | 'official';
  createdAt: string;
}

interface ActivityFund {
  id: string;
  fiscalYear: number;
  category: string;
  amount: number;
  description?: string;
  expenseDate?: string;
}

interface DashboardStats {
  members: { totalMembers: number; activeMembers: number };
  pledges: { totalPledges: number; completedPledges: number; inProgressPledges: number };
  users: { totalUsers: number; activeUsers: number; adminUsers: number };
  activityLogs: { totalLogs: number; publicLogs: number };
  activityFunds: { totalAmount: number; averageAmount: number };
}

export default function AdminPage() {
  const { user, loading } = useAuth();
  const [stats, setStats] = useState<DashboardStats | null>(null);
  const [members, setMembers] = useState<Member[]>([]);
  const [loadingData, setLoadingData] = useState(true);
  const [activeTab, setActiveTab] = useState<'dashboard' | 'members' | 'pledges' | 'activity-funds'>('dashboard');
  const [showMemberForm, setShowMemberForm] = useState(false);
  const [editingMember, setEditingMember] = useState<Member | null>(null);

  useEffect(() => {
    if (!loading && user) {
      fetchDashboardData();
    }
  }, [loading, user]);

  const fetchDashboardData = async () => {
    try {
      const [statsRes, membersRes] = await Promise.all([
        api.get('/admin/dashboard').catch(() => ({ data: null })),
        api.get('/members').catch(() => ({ data: [] }))
      ]);
      
      setStats(statsRes.data);
      setMembers(membersRes.data || []);
    } catch (error) {
      console.error('Error fetching dashboard data:', error);
      toast.error('データの取得に失敗しました');
      setStats(null);
      setMembers([]);
    } finally {
      setLoadingData(false);
    }
  };

  const handleCollectData = async () => {
    try {
      await api.post('/external-feeds/collect-all');
      toast.success('外部データの収集を開始しました');
    } catch (error) {
      console.error('Error collecting data:', error);
      toast.error('データ収集に失敗しました');
    }
  };

  const handleImportActivityFunds = async (memberId: string, file: File) => {
    try {
      const formData = new FormData();
      formData.append('file', file);
      
      await api.post(`/admin/import/activity-funds/${memberId}`, formData, {
        headers: {
          'Content-Type': 'multipart/form-data',
        },
      });
      
      toast.success('政務活動費データをインポートしました');
      fetchDashboardData();
    } catch (error) {
      console.error('Error importing activity funds:', error);
      toast.error('インポートに失敗しました');
    }
  };

  const handleDeleteMember = async (memberId: string) => {
    if (!confirm('この議員を削除しますか？')) return;
    
    try {
      await api.delete(`/members/${memberId}`);
      toast.success('議員を削除しました');
      fetchDashboardData();
    } catch (error) {
      console.error('Error deleting member:', error);
      toast.error('削除に失敗しました');
    }
  };

  if (loading || loadingData) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  if (!user) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <h1 className="text-2xl font-bold text-gray-900 mb-4">ログインが必要です</h1>
          <p className="text-gray-600 mb-4">このページにアクセスするにはログインが必要です。</p>
          <a href="/login" className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
            ログインページへ
          </a>
        </div>
      </div>
    );
  }

  // デモ用: 管理者権限がない場合でもアクセスを許可（開発環境のみ）
  const isDevelopment = process.env.NODE_ENV === 'development';
  if (user.role !== 'admin' && !isDevelopment) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <h1 className="text-2xl font-bold text-gray-900 mb-4">アクセス拒否</h1>
          <p className="text-gray-600">このページにアクセスするには管理者権限が必要です。</p>
          <p className="text-sm text-gray-500 mt-2">現在のユーザー: {user.displayName || user.email}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <Header />
      
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Header */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="mb-8"
        >
          <h1 className="text-3xl font-bold text-gray-900 mb-2">管理画面</h1>
          <p className="text-gray-600">プラットフォームの管理とデータの更新を行います</p>
        </motion.div>

        {/* Tabs */}
        <div className="mb-8">
          <nav className="flex space-x-8">
            {[
              { id: 'dashboard', label: 'ダッシュボード', icon: BarChart3 },
              { id: 'members', label: '議員管理', icon: Users },
              { id: 'pledges', label: '公約管理', icon: FileText },
              { id: 'activity-funds', label: '政務活動費', icon: DollarSign },
            ].map((tab) => {
              const Icon = tab.icon;
              return (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id as any)}
                  className={`flex items-center px-4 py-2 border-b-2 font-medium text-sm ${
                    activeTab === tab.id
                      ? 'border-blue-500 text-blue-600'
                      : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                  }`}
                >
                  <Icon className="w-4 h-4 mr-2" />
                  {tab.label}
                </button>
              );
            })}
          </nav>
        </div>

        {/* Dashboard Tab */}
        {activeTab === 'dashboard' && stats && (
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="space-y-6"
          >
            {/* Stats Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <div className="bg-white p-6 rounded-lg shadow">
                <div className="flex items-center">
                  <Users className="w-8 h-8 text-blue-600" />
                  <div className="ml-4">
                    <p className="text-sm font-medium text-gray-600">登録議員</p>
                    <p className="text-2xl font-bold text-gray-900">{stats.members.activeMembers}</p>
                  </div>
                </div>
              </div>
              
              <div className="bg-white p-6 rounded-lg shadow">
                <div className="flex items-center">
                  <FileText className="w-8 h-8 text-green-600" />
                  <div className="ml-4">
                    <p className="text-sm font-medium text-gray-600">公約数</p>
                    <p className="text-2xl font-bold text-gray-900">{stats.pledges.totalPledges}</p>
                  </div>
                </div>
              </div>
              
              <div className="bg-white p-6 rounded-lg shadow">
                <div className="flex items-center">
                  <Activity className="w-8 h-8 text-purple-600" />
                  <div className="ml-4">
                    <p className="text-sm font-medium text-gray-600">活動ログ</p>
                    <p className="text-2xl font-bold text-gray-900">{stats.activityLogs.totalLogs}</p>
                  </div>
                </div>
              </div>
              
              <div className="bg-white p-6 rounded-lg shadow">
                <div className="flex items-center">
                  <DollarSign className="w-8 h-8 text-orange-600" />
                  <div className="ml-4">
                    <p className="text-sm font-medium text-gray-600">政務活動費総額</p>
                    <p className="text-2xl font-bold text-gray-900">¥{(stats.activityFunds.totalAmount / 1000000).toFixed(1)}M</p>
                  </div>
                </div>
              </div>
            </div>

            {/* Actions */}
            <div className="bg-white p-6 rounded-lg shadow">
              <h2 className="text-lg font-semibold text-gray-900 mb-4">管理操作</h2>
              <div className="flex flex-wrap gap-4">
                <button
                  onClick={handleCollectData}
                  className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                >
                  <RefreshCw className="w-4 h-4 mr-2" />
                  外部データ収集
                </button>
                
                <button
                  onClick={fetchDashboardData}
                  className="flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
                >
                  <RefreshCw className="w-4 h-4 mr-2" />
                  データ更新
                </button>
              </div>
            </div>
          </motion.div>
        )}

        {/* Members Tab */}
        {activeTab === 'members' && (
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="space-y-6"
          >
            <div className="flex justify-between items-center">
              <h2 className="text-xl font-semibold text-gray-900">議員管理</h2>
              <button
                onClick={() => setShowMemberForm(true)}
                className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
              >
                <Plus className="w-4 h-4 mr-2" />
                議員追加
              </button>
            </div>

            <div className="bg-white rounded-lg shadow overflow-hidden">
              <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-gray-200">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        議員名
                      </th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        所属
                      </th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        公約数
                      </th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        活動ログ
                      </th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        操作
                      </th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-gray-200">
                    {members.map((member) => (
                      <tr key={member.id}>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center">
                            {member.photoUrl ? (
                              <img
                                src={member.photoUrl}
                                alt={member.name}
                                className="w-10 h-10 rounded-full object-cover"
                              />
                            ) : (
                              <div className="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">
                                <Users className="w-5 h-5 text-gray-600" />
                              </div>
                            )}
                            <div className="ml-4">
                              <div className="text-sm font-medium text-gray-900">{member.name}</div>
                              <div className="text-sm text-gray-500">{member.position}</div>
                            </div>
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          {member.affiliation}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          {member.pledges.length}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                          {member.activityLogs.length}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                          <div className="flex space-x-2">
                            <button
                              onClick={() => setEditingMember(member)}
                              className="text-blue-600 hover:text-blue-900"
                            >
                              <Edit className="w-4 h-4" />
                            </button>
                            <button
                              onClick={() => handleDeleteMember(member.id)}
                              className="text-red-600 hover:text-red-900"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </motion.div>
        )}

        {/* Activity Funds Tab */}
        {activeTab === 'activity-funds' && (
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="space-y-6"
          >
            <h2 className="text-xl font-semibold text-gray-900">政務活動費管理</h2>
            
            <div className="bg-white rounded-lg shadow p-6">
              <h3 className="text-lg font-medium text-gray-900 mb-4">CSVインポート</h3>
              <div className="space-y-4">
                {members.map((member) => (
                  <div key={member.id} className="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                    <div>
                      <h4 className="font-medium text-gray-900">{member.name}</h4>
                      <p className="text-sm text-gray-600">{member.affiliation}</p>
                    </div>
                    <div className="flex items-center space-x-2">
                      <input
                        type="file"
                        accept=".csv"
                        onChange={(e) => {
                          const file = e.target.files?.[0];
                          if (file) {
                            handleImportActivityFunds(member.id, file);
                          }
                        }}
                        className="hidden"
                        id={`file-${member.id}`}
                      />
                      <label
                        htmlFor={`file-${member.id}`}
                        className="flex items-center px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors cursor-pointer"
                      >
                        <Upload className="w-4 h-4 mr-2" />
                        インポート
                      </label>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </motion.div>
        )}
      </main>

      <Footer />
    </div>
  );
}
</file>

<file path="frontend/app/contact/page.tsx">
'use client';

import { useState } from 'react';
import Header from '@/components/Header';
import Footer from '@/components/Footer';
import { motion } from 'framer-motion';
import { Mail, Phone, MapPin, Send, CheckCircle, AlertCircle } from 'lucide-react';
import toast from 'react-hot-toast';

export default function ContactPage() {
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    subject: '',
    category: '',
    message: ''
  });
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isSubmitted, setIsSubmitted] = useState(false);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);

    try {
      // 実際の実装では、ここでAPIに送信
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      setIsSubmitted(true);
      toast.success('お問い合わせを受け付けました。ありがとうございます。');
    } catch (error) {
      console.error('Error submitting contact form:', error);
      toast.error('送信に失敗しました。もう一度お試しください。');
    } finally {
      setIsSubmitting(false);
    }
  };

  const contactInfo = [
    {
      icon: Mail,
      title: 'メール',
      content: 'support@transparency-platform.jp',
      description: '24時間以内に回答いたします'
    },
    {
      icon: Phone,
      title: '電話',
      content: '03-1234-5678',
      description: '平日 9:00-18:00'
    },
    {
      icon: MapPin,
      title: '所在地',
      content: '東京都渋谷区',
      description: '〒150-0000'
    }
  ];

  const categories = [
    '技術的な問題',
    'アカウント関連',
    'データの不正確性',
    '機能の要望',
    'その他'
  ];

  if (isSubmitted) {
    return (
      <div className="min-h-screen bg-gray-50">
        <Header />
        
        <main className="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="text-center"
          >
            <div className="bg-white rounded-lg shadow-lg p-8">
              <CheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" />
              <h1 className="text-2xl font-bold text-gray-900 mb-4">お問い合わせを受け付けました</h1>
              <p className="text-gray-600 mb-6">
                お問い合わせいただき、ありがとうございます。<br />
                内容を確認の上、24時間以内にご回答いたします。
              </p>
              <div className="flex flex-col sm:flex-row gap-4 justify-center">
                <button
                  onClick={() => {
                    setIsSubmitted(false);
                    setFormData({
                      name: '',
                      email: '',
                      subject: '',
                      category: '',
                      message: ''
                    });
                  }}
                  className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                >
                  新しいお問い合わせ
                </button>
                <a
                  href="/"
                  className="border border-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-50 transition-colors"
                >
                  ホームに戻る
                </a>
              </div>
            </div>
          </motion.div>
        </main>

        <Footer />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <Header />
      
      <main className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Header */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="text-center mb-12"
        >
          <h1 className="text-3xl font-bold text-gray-900 mb-4">お問い合わせ</h1>
          <p className="text-lg text-gray-600">
            ご質問、ご要望、不具合の報告など、お気軽にお問い合わせください
          </p>
        </motion.div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
          {/* Contact Form */}
          <motion.div
            initial={{ opacity: 0, x: -20 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ delay: 0.1 }}
            className="bg-white rounded-lg shadow-lg p-8"
          >
            <h2 className="text-2xl font-bold text-gray-900 mb-6">お問い合わせフォーム</h2>
            
            <form onSubmit={handleSubmit} className="space-y-6">
              <div>
                <label htmlFor="name" className="block text-sm font-medium text-gray-700 mb-2">
                  お名前 <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  value={formData.name}
                  onChange={handleInputChange}
                  required
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="山田 太郎"
                />
              </div>

              <div>
                <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-2">
                  メールアドレス <span className="text-red-500">*</span>
                </label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  value={formData.email}
                  onChange={handleInputChange}
                  required
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="example@email.com"
                />
              </div>

              <div>
                <label htmlFor="category" className="block text-sm font-medium text-gray-700 mb-2">
                  カテゴリ <span className="text-red-500">*</span>
                </label>
                <select
                  id="category"
                  name="category"
                  value={formData.category}
                  onChange={handleInputChange}
                  required
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="">カテゴリを選択してください</option>
                  {categories.map((category) => (
                    <option key={category} value={category}>
                      {category}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label htmlFor="subject" className="block text-sm font-medium text-gray-700 mb-2">
                  件名 <span className="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  id="subject"
                  name="subject"
                  value={formData.subject}
                  onChange={handleInputChange}
                  required
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="お問い合わせの件名"
                />
              </div>

              <div>
                <label htmlFor="message" className="block text-sm font-medium text-gray-700 mb-2">
                  メッセージ <span className="text-red-500">*</span>
                </label>
                <textarea
                  id="message"
                  name="message"
                  value={formData.message}
                  onChange={handleInputChange}
                  required
                  rows={6}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="お問い合わせの詳細をご記入ください"
                />
              </div>

              <button
                type="submit"
                disabled={isSubmitting}
                className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center"
              >
                {isSubmitting ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                    送信中...
                  </>
                ) : (
                  <>
                    <Send className="w-5 h-5 mr-2" />
                    送信する
                  </>
                )}
              </button>
            </form>
          </motion.div>

          {/* Contact Information */}
          <motion.div
            initial={{ opacity: 0, x: 20 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ delay: 0.2 }}
            className="space-y-8"
          >
            {/* Contact Info */}
            <div className="bg-white rounded-lg shadow-lg p-8">
              <h2 className="text-2xl font-bold text-gray-900 mb-6">連絡先情報</h2>
              <div className="space-y-6">
                {contactInfo.map((info, index) => {
                  const Icon = info.icon;
                  return (
                    <div key={index} className="flex items-start">
                      <Icon className="w-6 h-6 text-blue-600 mr-4 mt-1" />
                      <div>
                        <h3 className="font-semibold text-gray-900">{info.title}</h3>
                        <p className="text-gray-700">{info.content}</p>
                        <p className="text-sm text-gray-500">{info.description}</p>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* FAQ Link */}
            <div className="bg-blue-50 rounded-lg p-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-3">よくある質問</h3>
              <p className="text-gray-600 mb-4">
                お問い合わせの前に、よくある質問をご確認ください。
              </p>
              <a
                href="/help"
                className="inline-block bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
              >
                ヘルプセンターを見る
              </a>
            </div>

            {/* Response Time */}
            <div className="bg-green-50 rounded-lg p-6">
              <div className="flex items-center mb-3">
                <CheckCircle className="w-6 h-6 text-green-600 mr-2" />
                <h3 className="text-lg font-semibold text-gray-900">回答時間</h3>
              </div>
              <p className="text-gray-600">
                お問い合わせいただいた内容には、24時間以内に回答いたします。
                緊急の場合は、電話でのお問い合わせをお願いいたします。
              </p>
            </div>
          </motion.div>
        </div>
      </main>

      <Footer />
    </div>
  );
}
</file>

<file path="frontend/app/forgot-password/page.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { useAuth } from '@/contexts/AuthContext';
import Header from '@/components/Header';
import Footer from '@/components/Footer';
import { motion } from 'framer-motion';
import { Mail, ArrowLeft, CheckCircle, AlertCircle } from 'lucide-react';
import toast from 'react-hot-toast';

export default function ForgotPasswordPage() {
  const [email, setEmail] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isEmailSent, setIsEmailSent] = useState(false);
  const [error, setError] = useState('');
  const router = useRouter();
  const { user } = useAuth();

  // 既にログインしている場合はリダイレクト
  if (user) {
    router.push('/');
    return null;
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setIsLoading(true);

    try {
      // Firebase Authenticationでパスワードリセットメールを送信
      const { sendPasswordResetEmail } = await import('firebase/auth');
      const { auth } = await import('@/lib/firebase');
      
      if (!auth) {
        throw new Error('Firebase認証が初期化されていません');
      }

      await sendPasswordResetEmail(auth, email);
      setIsEmailSent(true);
      toast.success('パスワードリセットメールを送信しました');
    } catch (error: any) {
      console.error('Password reset error:', error);
      
      if (error.code === 'auth/user-not-found') {
        setError('このメールアドレスは登録されていません');
      } else if (error.code === 'auth/invalid-email') {
        setError('無効なメールアドレスです');
      } else if (error.code === 'auth/too-many-requests') {
        setError('リクエストが多すぎます。しばらくしてから再試行してください');
      } else {
        setError('パスワードリセットメールの送信に失敗しました。もう一度お試しください。');
      }
    } finally {
      setIsLoading(false);
    }
  };

  if (isEmailSent) {
    return (
      <div className="min-h-screen bg-gray-50">
        <Header />
        
        <main className="max-w-md mx-auto px-4 py-8">
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="bg-white rounded-lg shadow-lg p-8 text-center"
          >
            <CheckCircle className="w-16 h-16 text-green-500 mx-auto mb-4" />
            <h1 className="text-2xl font-bold text-gray-900 mb-4">
              メールを送信しました
            </h1>
            <p className="text-gray-600 mb-6">
              <strong>{email}</strong> にパスワードリセットのリンクを送信しました。
              <br />
              メールボックスを確認して、リンクをクリックしてパスワードをリセットしてください。
            </p>
            
            <div className="space-y-4">
              <div className="bg-blue-50 rounded-lg p-4">
                <h3 className="font-semibold text-blue-900 mb-2">次の手順</h3>
                <ol className="text-sm text-blue-800 text-left space-y-1">
                  <li>1. メールボックスを確認してください</li>
                  <li>2. パスワードリセットのメールを探してください</li>
                  <li>3. メール内のリンクをクリックしてください</li>
                  <li>4. 新しいパスワードを設定してください</li>
                </ol>
              </div>
              
              <div className="bg-yellow-50 rounded-lg p-4">
                <div className="flex items-start">
                  <AlertCircle className="w-5 h-5 text-yellow-600 mr-2 mt-0.5" />
                  <div className="text-sm text-yellow-800">
                    <p className="font-semibold">メールが届かない場合：</p>
                    <p>迷惑メールフォルダも確認してください。数分待っても届かない場合は、再度お試しください。</p>
                  </div>
                </div>
              </div>
            </div>

            <div className="mt-8 space-y-4">
              <button
                onClick={() => {
                  setIsEmailSent(false);
                  setEmail('');
                }}
                className="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
              >
                別のメールアドレスで再試行
              </button>
              
              <Link
                href="/login"
                className="block text-center text-blue-600 hover:text-blue-800 transition-colors"
              >
                ログインページに戻る
              </Link>
            </div>
          </motion.div>
        </main>

        <Footer />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <Header />
      
      <main className="max-w-md mx-auto px-4 py-8">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="bg-white rounded-lg shadow-lg p-8"
        >
          <div className="text-center mb-8">
            <h1 className="text-2xl font-bold text-gray-900 mb-2">パスワードを忘れた場合</h1>
            <p className="text-gray-600">
              登録されているメールアドレスを入力してください。<br />
              パスワードリセットのリンクを送信します。
            </p>
          </div>

          <form onSubmit={handleSubmit} className="space-y-6">
            <div>
              <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-2">
                メールアドレス
              </label>
              <div className="relative">
                <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
                <input
                  type="email"
                  id="email"
                  name="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="example@email.com"
                />
              </div>
            </div>

            {error && (
              <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                <div className="flex items-start">
                  <AlertCircle className="w-5 h-5 text-red-600 mr-2 mt-0.5" />
                  <p className="text-sm text-red-800">{error}</p>
                </div>
              </div>
            )}

            <button
              type="submit"
              disabled={isLoading}
              className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              {isLoading ? (
                <div className="flex items-center justify-center">
                  <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                  送信中...
                </div>
              ) : (
                'パスワードリセットメールを送信'
              )}
            </button>
          </form>

          <div className="mt-6 text-center space-y-4">
            <Link
              href="/login"
              className="inline-flex items-center text-sm text-gray-600 hover:text-gray-900 transition-colors"
            >
              <ArrowLeft className="w-4 h-4 mr-1" />
              ログインページに戻る
            </Link>
            
            <div className="text-sm text-gray-500">
              アカウントをお持ちでない場合は{' '}
              <Link href="/register" className="text-blue-600 hover:text-blue-800 font-medium">
                新規登録
              </Link>
            </div>
          </div>

          <div className="mt-8 p-4 bg-blue-50 rounded-lg">
            <h3 className="text-sm font-medium text-blue-900 mb-2">パスワードリセットについて</h3>
            <ul className="text-sm text-blue-800 space-y-1">
              <li>• パスワードリセットメールは数分以内に届きます</li>
              <li>• メールが届かない場合は迷惑メールフォルダを確認してください</li>
              <li>• リンクは24時間有効です</li>
              <li>• セキュリティのため、リンクは1回のみ使用できます</li>
            </ul>
          </div>
        </motion.div>
      </main>

      <Footer />
    </div>
  );
}
</file>

<file path="frontend/app/globals/globals.css">
html, body {
  margin: 0;
  padding: 0;
}
* { box-sizing: border-box; }
</file>

<file path="frontend/app/help/page.tsx">
'use client';

import Header from '@/components/Header';
import Footer from '@/components/Footer';
import { motion } from 'framer-motion';
import { 
  HelpCircle, 
  Search, 
  Users, 
  MessageSquare, 
  BarChart3, 
  Shield,
  ChevronDown,
  ChevronRight
} from 'lucide-react';
import { useState } from 'react';

export default function HelpPage() {
  const [openSections, setOpenSections] = useState<Set<string>>(new Set(['getting-started']));

  const toggleSection = (sectionId: string) => {
    const newOpenSections = new Set(openSections);
    if (newOpenSections.has(sectionId)) {
      newOpenSections.delete(sectionId);
    } else {
      newOpenSections.add(sectionId);
    }
    setOpenSections(newOpenSections);
  };

  const faqData = [
    {
      id: 'getting-started',
      title: 'はじめに',
      icon: HelpCircle,
      items: [
        {
          question: 'このプラットフォームとは何ですか？',
          answer: '市民参加型 透明性データプラットフォームは、地方議会議員の活動情報、公約、および政務活動費の使途を市民が公平に確認・評価できるプラットフォームです。政治の透明性向上と市民参加の促進を目指しています。'
        },
        {
          question: 'どのような機能がありますか？',
          answer: '議員情報の閲覧、公約の追跡、政務活動費の可視化、投票機能、活動ログの確認、外部データの自動収集などの機能を提供しています。'
        },
        {
          question: '利用料金はかかりますか？',
          answer: 'すべての機能は無料でご利用いただけます。アカウント作成も無料です。'
        }
      ]
    },
    {
      id: 'account',
      title: 'アカウント・ログイン',
      icon: Users,
      items: [
        {
          question: 'アカウントの作成方法を教えてください',
          answer: 'トップページの「新規登録」ボタンをクリックし、必要事項を入力してアカウントを作成してください。メールアドレスとパスワードが必要です。'
        },
        {
          question: 'ログインできない場合はどうすればよいですか？',
          answer: 'メールアドレスとパスワードが正しいか確認してください。パスワードを忘れた場合は、ログインページの「パスワードを忘れた場合」リンクから再設定できます。'
        },
        {
          question: 'Googleアカウントでログインできますか？',
          answer: 'はい、Googleアカウントでのログインも可能です。ログインページの「Googleでログイン」ボタンを使用してください。'
        }
      ]
    },
    {
      id: 'members',
      title: '議員情報',
      icon: Users,
      items: [
        {
          question: '議員の情報はどこで確認できますか？',
          answer: '「議員一覧」ページで全議員の一覧を確認でき、各議員の詳細ページで詳細情報、公約、活動ログ、政務活動費などを確認できます。'
        },
        {
          question: '議員の検索はできますか？',
          answer: '議員一覧ページで名前、所属、区、政党で検索できます。また、フィルター機能で条件を絞り込むことも可能です。'
        },
        {
          question: '議員の情報はどのくらいの頻度で更新されますか？',
          answer: '議員の基本情報は手動で更新されますが、活動ログは外部データ（Twitter、RSS、公式サイト）から自動収集されます。'
        }
      ]
    },
    {
      id: 'pledges',
      title: '公約・投票',
      icon: MessageSquare,
      items: [
        {
          question: '公約に投票するにはどうすればよいですか？',
          answer: 'ログイン後、議員の詳細ページで公約を確認し、「賛成」または「反対」ボタンをクリックして投票できます。1つの公約につき1回まで投票可能です。'
        },
        {
          question: '投票を変更・取り消すことはできますか？',
          answer: 'はい、投票後も「賛成」「反対」ボタンをクリックすることで投票を変更できます。投票を取り消すには、現在の投票と同じボタンを再度クリックしてください。'
        },
        {
          question: '公約の進捗状況はどのように更新されますか？',
          answer: '公約の進捗状況は議員または管理者が手動で更新します。「未着手」「進行中」「完了」「中止」の4つのステータスがあります。'
        }
      ]
    },
    {
      id: 'activity-funds',
      title: '政務活動費',
      icon: BarChart3,
      items: [
        {
          question: '政務活動費の情報はどこで確認できますか？',
          answer: '議員の詳細ページで政務活動費の情報を確認できます。カテゴリ別の円グラフと棒グラフで可視化されています。'
        },
        {
          question: '政務活動費のデータはどのように収集されますか？',
          answer: '政務活動費のデータは管理者がCSVファイルでインポートします。各議員の支出データをカテゴリ別に分類して表示します。'
        },
        {
          question: '政務活動費のデータはどのくらいの頻度で更新されますか？',
          answer: '政務活動費のデータは管理者が定期的に更新します。更新頻度は各自治体の公開スケジュールに依存します。'
        }
      ]
    },
    {
      id: 'privacy',
      title: 'プライバシー・セキュリティ',
      icon: Shield,
      items: [
        {
          question: '個人情報はどのように保護されますか？',
          answer: 'Firebase Authenticationを使用した安全な認証システムを採用し、個人情報は適切に暗号化されて保護されます。'
        },
        {
          question: '投票情報は他のユーザーに公開されますか？',
          answer: '個別の投票内容は公開されません。集計結果（賛成数、反対数、総投票数）のみが表示されます。'
        },
        {
          question: 'データの削除は可能ですか？',
          answer: 'アカウント削除時に個人データも削除されます。詳細についてはプライバシーポリシーをご確認ください。'
        }
      ]
    }
  ];

  return (
    <div className="min-h-screen bg-gray-50">
      <Header />
      
      <main className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Header */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="text-center mb-12"
        >
          <h1 className="text-3xl font-bold text-gray-900 mb-4">ヘルプセンター</h1>
          <p className="text-lg text-gray-600">
            よくある質問と回答をまとめました。お困りの際はこちらをご確認ください。
          </p>
        </motion.div>

        {/* Search */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.1 }}
          className="mb-8"
        >
          <div className="relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
            <input
              type="text"
              placeholder="質問を検索..."
              className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
        </motion.div>

        {/* FAQ Sections */}
        <div className="space-y-6">
          {faqData.map((section, sectionIndex) => {
            const Icon = section.icon;
            const isOpen = openSections.has(section.id);
            
            return (
              <motion.div
                key={section.id}
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: sectionIndex * 0.1 }}
                className="bg-white rounded-lg shadow-lg overflow-hidden"
              >
                <button
                  onClick={() => toggleSection(section.id)}
                  className="w-full px-6 py-4 text-left flex items-center justify-between hover:bg-gray-50 transition-colors"
                >
                  <div className="flex items-center">
                    <Icon className="w-5 h-5 text-blue-600 mr-3" />
                    <h2 className="text-lg font-semibold text-gray-900">{section.title}</h2>
                  </div>
                  {isOpen ? (
                    <ChevronDown className="w-5 h-5 text-gray-400" />
                  ) : (
                    <ChevronRight className="w-5 h-5 text-gray-400" />
                  )}
                </button>
                
                {isOpen && (
                  <div className="px-6 pb-4">
                    <div className="space-y-4">
                      {section.items.map((item, itemIndex) => (
                        <div key={itemIndex} className="border-b border-gray-100 last:border-b-0 pb-4 last:pb-0">
                          <h3 className="font-medium text-gray-900 mb-2">{item.question}</h3>
                          <p className="text-gray-600 text-sm leading-relaxed">{item.answer}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </motion.div>
            );
          })}
        </div>

        {/* Contact Section */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.6 }}
          className="mt-12 bg-blue-50 rounded-lg p-6"
        >
          <h2 className="text-xl font-semibold text-gray-900 mb-4">まだ解決しませんか？</h2>
          <p className="text-gray-600 mb-4">
            上記のFAQで解決しない場合は、お気軽にお問い合わせください。
          </p>
          <div className="flex flex-col sm:flex-row gap-4">
            <a
              href="/contact"
              className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors text-center"
            >
              お問い合わせ
            </a>
            <a
              href="mailto:support@transparency-platform.jp"
              className="border border-blue-600 text-blue-600 px-6 py-2 rounded-lg hover:bg-blue-50 transition-colors text-center"
            >
              メールでサポート
            </a>
          </div>
        </motion.div>
      </main>

      <Footer />
    </div>
  );
}
</file>

<file path="frontend/app/kyc/page.tsx">
'use client';

import { useEffect, useState } from 'react';
import { API_BASE } from '../../lib/api';

export default function KycPage() {
  const [status, setStatus] = useState<'pending'|'verified'|'rejected'|'unknown'>('unknown');
  const [file, setFile] = useState<File | null>(null);
  const [uploading, setUploading] = useState(false);

  useEffect(() => {
    // Fetch KYC status via /auth/me in real impl
    setStatus('pending');
  }, []);

  async function uploadDoc() {
    if (!file) return;
    const form = new FormData();
    form.append('file', file);
    form.append('category', 'kyc');
    setUploading(true);
    const res = await fetch(`${API_BASE}/media/upload`, {
      method: 'POST',
      body: form,
      credentials: 'include',
    });
    setUploading(false);
    if (!res.ok) {
      alert('アップロード失敗');
      return;
    }
    alert('アップロードしました（審査待ち）');
  }

  return (
    <div className="bg-white border rounded p-4 max-w-md mx-auto">
      <h1 className="text-xl font-bold mb-3">KYC ステータス</h1>
      <p className="mb-3">現在のステータス: <b>{status}</b></p>
      <input type="file" onChange={(e)=>setFile(e.target.files?.[0] ?? null)} />
      <button className="rounded bg-blue-600 text-white px-3 py-1 mt-2" onClick={uploadDoc} disabled={uploading}>
        {uploading ? 'アップロード中...' : 'アップロード'}
      </button>
      <div className="mt-3 text-sm text-gray-600">アップロード後、通知に審査メッセージが届く前提です。</div>
    </div>
  );
}
</file>

<file path="frontend/app/legal/privacy/page.md">
# プライバシーポリシー（ドラフト）

このページはドラフト版です。後日正式な文言に更新されます。
</file>

<file path="frontend/app/legal/terms/page.md">
# 利用規約（ドラフト）

このページはドラフト版です。後日正式な文言に更新されます。
（静的コンポーネント化する場合は React で再構成してください）
</file>

<file path="frontend/app/members/[id]/page.tsx">
// frontend/app/(main)/members/[id]/page.tsx

'use client'; // 💡 修正: これをファイルの最初の行にのみ記述します

import React, { useState, useEffect } from 'react';
import { useParams } from 'next/navigation';
import apiClient from '@/lib/api';
import { MapPin, Users, Briefcase, Link as LinkIcon, Twitter, Loader2, BookOpen, Clock, Zap } from 'lucide-react';
import toast from 'react-hot-toast';

// ----------------------------------------------------
// 1. データ型定義 (重複を削除し、一度だけ定義)
// ----------------------------------------------------

/**
 * 公約の情報型
 */
interface Pledge {
  id: string;
  title: string;
  description: string;
  status: 'pending' | 'in_progress' | 'completed' | 'cancelled';
  supportCount: number;
  opposeCount: number;
}

/**
 * 活動記録の情報型
 */
interface ActivityLog {
  id: string;
  title: string;
  content: string;
  createdAt: string;
}

/**
 * 議員の詳細情報型
 */
interface MemberDetail {
  id: string;
  name: string;
  photoUrl?: string;
  affiliation: string;
  district: string;
  party: string;
  position: string;
  biography: string;
  website?: string;
  twitterHandle?: string;
  pledges: Pledge[];
  activityLogs: ActivityLog[];
}


// ----------------------------------------------------
// 2. 議員詳細ページコンポーネント
// ----------------------------------------------------

export default function MemberDetailPage() {
  // Next.jsからURLの[id]の部分を取得します
  const params = useParams();
  const memberId = params.id as string;
  
  const [member, setMember] = useState<MemberDetail | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [activeTab, setActiveTab] = useState<'pledges' | 'activityLogs'>('pledges');

  // 議員データを取得する関数
  useEffect(() => {
    if (!memberId) return;

    const fetchMemberDetail = async () => {
      try {
        setLoading(true);
        setError(null);
        // バックエンドの /members/[id] エンドポイントからデータを取得
        const response = await apiClient.get<MemberDetail>(`/members/${memberId}`);
        setMember(response.data);
      } catch (err) {
        console.error(`議員ID: ${memberId} の詳細データの取得に失敗:`, err);
        setError('議員データの読み込みに失敗しました。IDまたはサーバーを確認してください。');
        toast.error('議員の詳細情報を読み込めませんでした。');
      } finally {
        setLoading(false);
      }
    };

    fetchMemberDetail();
  }, [memberId]);

  // ローディング表示
  if (loading) {
    return (
      <div className="flex justify-center items-center py-20 min-h-screen">
        <Loader2 className="h-8 w-8 animate-spin text-blue-600" />
        <p className="ml-3 text-lg text-gray-600">詳細データを読み込み中...</p>
      </div>
    );
  }

  // エラー表示
  if (error || !member) {
    return (
      <div className="container mx-auto px-4 py-12">
        <div className="text-center p-10 bg-red-50 border border-red-200 rounded-lg">
          <h1 className="text-2xl font-bold text-red-700 mb-2">エラー</h1>
          <p className="text-red-600">{error || '指定された議員が見つかりませんでした。'}</p>
        </div>
      </div>
    );
  }

  // データ表示
  return (
    <div className="container mx-auto px-4 py-8">
      
      {/* 議員の基本情報セクション */}
      <MemberHeader member={member} />

      {/* タブ切り替えセクション */}
      <div className="mt-8">
        <div className="border-b border-gray-200">
          <nav className="-mb-px flex space-x-8" aria-label="Tabs">
            <TabButton 
                isActive={activeTab === 'pledges'} 
                onClick={() => setActiveTab('pledges')} 
                count={member.pledges.length}
                icon={BookOpen}
                label="公約"
            />
            <TabButton 
                isActive={activeTab === 'activityLogs'} 
                onClick={() => setActiveTab('activityLogs')} 
                count={member.activityLogs.length}
                icon={Clock}
                label="活動記録"
            />
          </nav>
        </div>

        {/* タブの内容 */}
        <div className="mt-8">
          {activeTab === 'pledges' && <PledgeList pledges={member.pledges} />}
          {activeTab === 'activityLogs' && <ActivityLogList activityLogs={member.activityLogs} />}
        </div>
      </div>
      
    </div>
  );
}

// ----------------------------------------------------
// 3. ヘルパーコンポーネント
// ----------------------------------------------------

// 議員のヘッダー部分（名前、写真、基本情報）
const MemberHeader: React.FC<{ member: MemberDetail }> = ({ member }) => {
    // ダミーの画像URL
    const dummyPhotoUrl = `https://picsum.photos/seed/${member.id}/150/150`;
    
    return (
        <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <div className="flex flex-col md:flex-row items-center md:items-start space-y-4 md:space-y-0 md:space-x-6">
                
                {/* 写真 */}
                <img
                    src={member.photoUrl || dummyPhotoUrl}
                    alt={`${member.name} 議員の写真`}
                    className="w-32 h-32 rounded-full object-cover border-4 border-blue-50 shadow-md"
                />
                
                {/* 情報 */}
                <div className="flex-grow text-center md:text-left">
                    <h1 className="text-3xl font-extrabold text-gray-900">{member.name}</h1>
                    <p className="text-xl text-blue-600 font-semibold mb-3">{member.position}</p>
                    
                    {/* 基本情報グリッド */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 mt-4 text-gray-600">
                        <InfoBadge icon={MapPin} label="選出区" value={member.district} />
                        <InfoBadge icon={Briefcase} label="所属会派" value={member.affiliation} />
                        <InfoBadge icon={Users} label="所属政党" value={member.party} />
                        {member.website && <InfoBadge icon={LinkIcon} label="Web" value={member.website} isLink />}
                        {member.twitterHandle && <InfoBadge icon={Twitter} label="Twitter" value={`@${member.twitterHandle}`} isLink linkUrl={`https://twitter.com/${member.twitterHandle}`} />}
                    </div>
                </div>
            </div>
            
            {/* 自己紹介 */}
            <div className="mt-6 pt-4 border-t border-gray-100">
                <h3 className="text-lg font-bold text-gray-800 mb-2">自己紹介・経歴</h3>
                <p className="text-gray-700 whitespace-pre-line">{member.biography || '自己紹介文は準備中です。'}</p>
            </div>
        </div>
    );
};

// 情報バッジ（リンク対応）
const InfoBadge: React.FC<{ icon: React.ElementType, label: string, value: string, isLink?: boolean, linkUrl?: string }> = ({ icon: Icon, label, value, isLink = false, linkUrl }) => {
    const content = (
        <span className="flex items-center text-sm">
            <Icon className="w-4 h-4 mr-2 text-blue-500" />
            <span className="font-medium mr-1">{label}:</span>
            <span className={`font-semibold ${isLink ? 'text-blue-600 hover:underline' : 'text-gray-800'}`}>{value}</span>
        </span>
    );

    if (isLink) {
        return (
            <a href={linkUrl || value} target="_blank" rel="noopener noreferrer" className="truncate">
                {content}
            </a>
        );
    }
    return <div className="truncate">{content}</div>;
};

// タブボタン
const TabButton: React.FC<{ isActive: boolean, onClick: () => void, count: number, icon: React.ElementType, label: string }> = ({ isActive, onClick, count, icon: Icon, label }) => (
    <button
        onClick={onClick}
        className={`
            flex items-center px-1 py-3 text-lg font-medium transition-colors
            ${isActive
                ? 'border-b-4 border-blue-600 text-blue-600'
                : 'border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            }
        `}
    >
        <Icon className="w-5 h-5 mr-2" />
        {label}
        <span className={`ml-2 inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold leading-none rounded-full ${isActive ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'}`}>
            {count}
        </span>
    </button>
);


// 公約リスト
const PledgeList: React.FC<{ pledges: Pledge[] }> = ({ pledges }) => {
    if (pledges.length === 0) {
        return (
            <div className="p-10 text-center bg-gray-100 rounded-lg border border-gray-200">
                <Zap className="w-8 h-8 text-gray-400 mx-auto mb-3" />
                <p className="text-gray-600">現在、登録されている公約はありません。</p>
            </div>
        );
    }

    return (
        <div className="space-y-6">
            {pledges.map(pledge => (
                <PledgeCard key={pledge.id} pledge={pledge} />
            ))}
        </div>
    );
};

// 公約カード
const PledgeCard: React.FC<{ pledge: Pledge }> = ({ pledge }) => {
    const statusMap = {
        pending: { label: '未着手', color: 'text-gray-600 bg-gray-100' },
        in_progress: { label: '進行中', color: 'text-blue-600 bg-blue-100' },
        completed: { label: '達成済み', color: 'text-green-600 bg-green-100' },
        cancelled: { label: '中止', color: 'text-red-600 bg-red-100' },
    };
    const currentStatus = statusMap[pledge.status] || statusMap.pending;

    return (
        <div className="bg-white p-6 rounded-lg shadow-md border border-gray-100">
            <div className="flex justify-between items-start mb-3">
                <h4 className="text-xl font-bold text-gray-900">{pledge.title}</h4>
                <span className={`px-3 py-1 text-sm font-semibold rounded-full ${currentStatus.color}`}>
                    {currentStatus.label}
                </span>
            </div>
            <p className="text-gray-700 mb-4">{pledge.description}</p>
            <div className="flex justify-between items-center pt-3 border-t border-gray-100">
                <div className="text-sm text-gray-600">
                    <span className="font-semibold text-green-600">{pledge.supportCount}</span> 賛成 / 
                    <span className="font-semibold text-red-600"> {pledge.opposeCount}</span> 反対
                </div>
                {/* TODO: 投票ボタンや詳細リンクをここに追加 */}
                <span className="text-sm text-blue-600 font-medium hover:underline cursor-pointer">
                    詳細を見る &rarr;
                </span>
            </div>
        </div>
    );
};


// 活動記録リスト
const ActivityLogList: React.FC<{ activityLogs: ActivityLog[] }> = ({ activityLogs }) => {
    if (activityLogs.length === 0) {
        return (
            <div className="p-10 text-center bg-gray-100 rounded-lg border border-gray-200">
                <Zap className="w-8 h-8 text-gray-400 mx-auto mb-3" />
                <p className="text-gray-600">現在、登録されている活動記録はありません。</p>
            </div>
        );
    }

    return (
        <div className="space-y-6">
            {activityLogs.map(log => (
                <ActivityLogCard key={log.id} log={log} />
            ))}
        </div>
    );
};

// 活動記録カード
const ActivityLogCard: React.FC<{ log: ActivityLog }> = ({ log }) => {
    const formattedDate = new Date(log.createdAt).toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
    });

    return (
        <div className="bg-white p-6 rounded-lg shadow-md border border-gray-100">
            <div className="flex justify-between items-start mb-3">
                <h4 className="text-xl font-bold text-gray-900">{log.title}</h4>
                <span className="text-sm text-gray-500">{formattedDate}</span>
            </div>
            <p className="text-gray-700 whitespace-pre-line">{log.content.substring(0, 200)}...</p>
            {/* TODO: コメント機能や詳細へのリンクをここに追加 */}
            <div className="mt-4 pt-3 border-t border-gray-100 text-sm text-blue-600 font-medium hover:underline cursor-pointer">
                すべて読む & コメントする &rarr;
            </div>
        </div>
    );
};
</file>

<file path="frontend/app/posts/[id]/comment-with-media.tsx">
'use client';
import { useState } from 'react';
import { uploadMedia } from '../../lib/api-media';

export function CommentWithMedia({ postId, token }: { postId: string; token: string }) {
  const [text, setText] = useState('');
  const [file, setFile] = useState<File | null>(null);
  const [mediaIds, setMediaIds] = useState<string[]>([]);

  async function onUpload() {
    if (!file) return;
    const { mediaId } = await uploadMedia(file, token, 'comment');
    setMediaIds((arr) => [...arr, mediaId]);
  }

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    const res = await fetch(`${process.env.NEXT_PUBLIC_API_BASE_URL}/posts/${postId}/comments`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ content: text, mediaIds }),
    });
    if (!res.ok) {
      alert('コメント投稿に失敗しました');
      return;
    }
    setText('');
    setMediaIds([]);
    alert('投稿しました');
  }

  return (
    <form onSubmit={onSubmit} className="flex flex-col gap-2">
      <textarea value={text} onChange={(e)=>setText(e.target.value)} placeholder="コメント…" />
      <input type="file" onChange={(e)=>setFile(e.target.files?.[0] ?? null)} />
      <div className="flex gap-2">
        <button type="button" onClick={onUpload} className="px-3 py-1 bg-gray-200 rounded">添付アップロード</button>
        <button type="submit" className="px-3 py-1 bg-blue-600 text-white rounded">送信</button>
      </div>
    </form>
  );
}
</file>

<file path="frontend/app/posts/[id]/page.tsx">
'use client';
import { useEffect, useState } from 'react';
import { API_BASE } from '../../../lib/api';
import { getToken } from '../../../lib/auth';

export default function PostDetailPage({ params }: { params: { id: string } }) {
  const [post, setPost] = useState<any>(null);
  const [comments, setComments] = useState<any[]>([]);
  const [text, setText] = useState('');
  const [file, setFile] = useState<File | null>(null);
  const [mediaIds, setMediaIds] = useState<string[]>([]);
  const token = typeof window !== 'undefined' ? getToken() : null;

  useEffect(() => {
    fetch(`${API_BASE}/posts/${params.id}`).then(r => r.json()).then(setPost);
    fetch(`${API_BASE}/posts/${params.id}/comments`).then(r => r.json()).then(setComments);
  }, [params.id]);

  async function onVote(choice: 'agree' | 'disagree') {
    if (!token) return alert('ログインしてください');
    const res = await fetch(`${API_BASE}/posts/${params.id}/votes`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ choice }),
    });
    if (!res.ok) return alert('投票失敗');
    alert('投票しました');
  }

  async function uploadMedia() {
    if (!token || !file) return;
    const form = new FormData();
    form.append('file', file);
    form.append('category', 'comment');
    const res = await fetch(`${API_BASE}/media/upload`, {
      method: 'POST',
      headers: { Authorization: `Bearer ${token}` },
      body: form,
    });
    if (!res.ok) return alert('アップロード失敗');
    const data = await res.json();
    setMediaIds((prev) => [...prev, data.mediaId]);
    alert('添付しました');
  }

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (!token) return alert('ログインしてください');
    const res = await fetch(`${API_BASE}/posts/${params.id}/comments`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ content: text, mediaIds }),
    });
    if (!res.ok) return alert('コメント失敗');
    setText('');
    setMediaIds([]);
    const updated = await fetch(`${API_BASE}/posts/${params.id}/comments`).then(r => r.json());
    setComments(updated);
  }

  if (!post) return <div>読み込み中…</div>;

  return (
    <div className="flex flex-col gap-4">
      <article className="bg-white border rounded p-4">
        <h1 className="text-2xl font-bold">{post.title}</h1>
        <p className="text-sm text-gray-500">{new Date(post.createdAt).toLocaleString()}</p>
        <p className="mt-3 whitespace-pre-wrap">{post.content}</p>
        <div className="mt-3 flex gap-2">
          <button className="rounded bg-green-600 text-white px-3 py-1" onClick={() => onVote('agree')}>賛成</button>
          <button className="rounded bg-red-600 text-white px-3 py-1" onClick={() => onVote('disagree')}>反対</button>
        </div>
      </article>

      <section className="bg-white border rounded p-4">
        <h2 className="text-xl font-semibold mb-2">コメント</h2>
        <form onSubmit={onSubmit} className="flex flex-col gap-2">
          <textarea className="border rounded px-3 py-2" value={text} onChange={(e)=>setText(e.target.value)} placeholder="@nickname メンションも可（サーバで解析可）" />
          <input type="file" onChange={(e)=>setFile(e.target.files?.[0] ?? null)} />
          <div className="flex gap-2">
            <button type="button" onClick={uploadMedia} className="rounded bg-gray-300 px-3 py-1">添付アップロード</button>
            <button type="submit" className="rounded bg-blue-600 text-white px-3 py-1">送信</button>
          </div>
        </form>
        <ul className="mt-3 flex flex-col gap-2">
          {comments.map((c) => (
            <li key={c.id} className="border rounded px-3 py-2">
              <div className="text-sm text-gray-600">{new Date(c.createdAt).toLocaleString()}</div>
              <div className="whitespace-pre-wrap">{c.content}</div>
            </li>
          ))}
        </ul>
      </section>
    </div>
  );
}
</file>

<file path="frontend/app/privacy/page.tsx">
'use client';

import Header from '@/components/Header';
import Footer from '@/components/Footer';
import { motion } from 'framer-motion';
import { Shield, Eye, Lock, Database, UserCheck, Mail } from 'lucide-react';

export default function PrivacyPage() {
  const sections = [
    {
      icon: Eye,
      title: '情報の収集',
      content: [
        '当プラットフォームでは、以下の情報を収集します：',
        '• アカウント情報（メールアドレス、表示名、居住区）',
        '• 投票情報（公約に対する賛成・反対の投票）',
        '• アクセスログ（IPアドレス、ブラウザ情報、アクセス日時）',
        '• 議員の公開情報（プロフィール、公約、活動ログ、政務活動費）'
      ]
    },
    {
      icon: Database,
      title: '情報の利用目的',
      content: [
        '収集した情報は以下の目的で利用します：',
        '• プラットフォームの提供・運営',
        '• ユーザー認証・アカウント管理',
        '• 投票機能の提供・集計',
        '• サービス改善・新機能開発',
        '• 不正利用の防止・セキュリティ確保',
        '• 法令に基づく対応'
      ]
    },
    {
      icon: Lock,
      title: '情報の保護',
      content: [
        '個人情報の保護のため、以下の措置を講じています：',
        '• Firebase Authenticationによる安全な認証',
        '• HTTPS通信によるデータの暗号化',
        '• アクセス制御による不正アクセスの防止',
        '• 定期的なセキュリティ監査',
        '• データベースの暗号化',
        '• 従業員への情報セキュリティ教育'
      ]
    },
    {
      icon: UserCheck,
      title: '第三者への提供',
      content: [
        '以下の場合を除き、個人情報を第三者に提供することはありません：',
        '• ユーザーの同意がある場合',
        '• 法令に基づく場合',
        '• 人の生命、身体または財産の保護のために必要な場合',
        '• 公衆衛生の向上または児童の健全な育成の推進のために特に必要な場合',
        '• 国の機関もしくは地方公共団体またはその委託を受けた者が法令の定める事務を遂行することに対して協力する必要がある場合'
      ]
    },
    {
      icon: Mail,
      title: 'お問い合わせ',
      content: [
        '個人情報の取扱いに関するお問い合わせは、以下までご連絡ください：',
        'メール: privacy@transparency-platform.jp',
        '受付時間: 平日 9:00-18:00',
        '回答までに数日を要する場合がございます。'
      ]
    }
  ];

  return (
    <div className="min-h-screen bg-gray-50">
      <Header />
      
      <main className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Header */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="text-center mb-12"
        >
          <h1 className="text-3xl font-bold text-gray-900 mb-4">プライバシーポリシー</h1>
          <p className="text-lg text-gray-600">
            最終更新日: 2024年1月1日
          </p>
        </motion.div>

        {/* Introduction */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.1 }}
          className="bg-white rounded-lg shadow-lg p-8 mb-8"
        >
          <div className="flex items-center mb-4">
            <Shield className="w-8 h-8 text-blue-600 mr-3" />
            <h2 className="text-2xl font-bold text-gray-900">はじめに</h2>
          </div>
          <p className="text-gray-700 leading-relaxed">
            市民参加型 透明性データプラットフォーム（以下「当プラットフォーム」）は、
            ユーザーの個人情報の保護を重要な責務と考え、以下のプライバシーポリシーに従って
            個人情報を適切に取り扱います。
          </p>
        </motion.div>

        {/* Sections */}
        <div className="space-y-8">
          {sections.map((section, index) => {
            const Icon = section.icon;
            return (
              <motion.div
                key={section.title}
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: (index + 1) * 0.1 }}
                className="bg-white rounded-lg shadow-lg p-8"
              >
                <div className="flex items-center mb-6">
                  <Icon className="w-8 h-8 text-blue-600 mr-3" />
                  <h2 className="text-2xl font-bold text-gray-900">{section.title}</h2>
                </div>
                <div className="space-y-3">
                  {section.content.map((item, itemIndex) => (
                    <p key={itemIndex} className="text-gray-700 leading-relaxed">
                      {item}
                    </p>
                  ))}
                </div>
              </motion.div>
            );
          })}
        </div>

        {/* Additional Information */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.8 }}
          className="bg-blue-50 rounded-lg p-8 mt-8"
        >
          <h2 className="text-2xl font-bold text-gray-900 mb-4">その他の重要な事項</h2>
          <div className="space-y-4">
            <div>
              <h3 className="text-lg font-semibold text-gray-900 mb-2">Cookieの使用</h3>
              <p className="text-gray-700">
                当プラットフォームでは、サービス向上のためCookieを使用しています。
                Cookieの使用を希望しない場合は、ブラウザの設定で無効にできます。
              </p>
            </div>
            <div>
              <h3 className="text-lg font-semibold text-gray-900 mb-2">プライバシーポリシーの変更</h3>
              <p className="text-gray-700">
                当プラットフォームは、必要に応じて本プライバシーポリシーを変更する場合があります。
                変更があった場合は、当プラットフォーム上でお知らせします。
              </p>
            </div>
            <div>
              <h3 className="text-lg font-semibold text-gray-900 mb-2">適用法令</h3>
              <p className="text-gray-700">
                本プライバシーポリシーは、日本の個人情報保護法およびその他の関連法令に準拠します。
              </p>
            </div>
          </div>
        </motion.div>

        {/* Contact */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.9 }}
          className="text-center mt-8"
        >
          <p className="text-gray-600 mb-4">
            本プライバシーポリシーに関するご質問がございましたら、お気軽にお問い合わせください。
          </p>
          <a
            href="/contact"
            className="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors"
          >
            お問い合わせ
          </a>
        </motion.div>
      </main>

      <Footer />
    </div>
  );
}
</file>

<file path="frontend/app/register/types.ts">
export type AgeGroup = 'teen' | 'twenties' | 'thirties' | 'forties' | 'fifties' | 'sixties_plus';
</file>

<file path="frontend/app/search/page.tsx">
'use client';
import { useSearchParams } from 'next/navigation';
import useSWR from 'swr';

type SearchResult = {
  posts: Array<{ id: string; title?: string; body: string; createdAt: string }>;
  users: Array<{ id: string; name?: string; email: string; role: string; party?: string; addressPref?: string; addressCity?: string }>;
};

async function fetchSearch(params: URLSearchParams): Promise<SearchResult> {
  const res = await fetch(`/search?${params.toString()}`);
  if (!res.ok) throw new Error('検索に失敗しました');
  return res.json();
}

export default function SearchPage() {
  const sp = useSearchParams();
  const params = new URLSearchParams();
  const q = sp.get('q') || '';
  const party = sp.get('party') || '';
  const pref = sp.get('pref') || '';
  const city = sp.get('city') || '';
  if (q) params.set('q', q);
  if (party) params.set('party', party);
  if (pref) params.set('pref', pref);
  if (city) params.set('city', city);

  const { data, error, isLoading } = useSWR<SearchResult>(
    ['/search', q, party, pref, city],
    () => fetchSearch(params),
  );

  return (
    <div className="space-y-6">
      <h1 className="text-lg font-semibold">検索結果</h1>

      <div className="card">
        <h2 className="font-medium mb-2">投稿</h2>
        {isLoading && <div className="text-sm text-slate-500">読み込み中...</div>}
        {error && <div className="text-sm text-red-600">検索に失敗しました</div>}
        <ul className="space-y-2">
          {data?.posts?.map((p) => (
            <li key={p.id} className="text-sm">
              <div className="font-medium">{p.title || p.body.slice(0, 40)}</div>
              <div className="text-xs text-slate-500">{new Date(p.createdAt).toLocaleString()}</div>
            </li>
          ))}
          {data && data.posts?.length === 0 && <div className="text-sm text-slate-500">該当する投稿はありません。</div>}
        </ul>
      </div>

      <div className="card">
        <h2 className="font-medium mb-2">ユーザー</h2>
        <ul className="space-y-2">
          {data?.users?.map((u) => (
            <li key={u.id} className="text-sm">
              <div className="font-medium">{u.name || '(名称未設定)'} {u.party ? ` [${u.party}]` : ''}</div>
              <div className="text-xs text-slate-500">{u.email} / {u.role} / {u.addressPref || ''} {u.addressCity || ''}</div>
            </li>
          ))}
          {data && data.users?.length === 0 && <div className="text-sm text-slate-500">該当するユーザーはありません。</div>}
        </ul>
      </div>
    </div>
  );
}
</file>

<file path="frontend/app/surveys/page.tsx">
'use client';
import { useEffect, useState } from 'react';
import { API_BASE } from '../../lib/api';
import { getToken } from '../../lib/auth';

export default function SurveysPage() {
  const [list, setList] = useState<any[]>([]);
  const token = typeof window !== 'undefined' ? getToken() : null;

  useEffect(() => {
    if (!token) return;
    fetch(`${API_BASE}/surveys/available`, { headers: { Authorization: `Bearer ${token}` } })
      .then(r => r.json()).then(setList);
  }, [token]);

  async function respond(id: string) {
    if (!token) return alert('ログインしてください');
    const res = await fetch(`${API_BASE}/surveys/${id}/responses`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
      body: JSON.stringify({ answers: { q1: 'yes' } }),
    });
    if (!res.ok) return alert('回答失敗');
    alert('回答しました');
  }

  return (
    <div className="flex flex-col gap-3">
      <h1 className="text-xl font-bold">アンケート</h1>
      {list.map((s) => (
        <div key={s.id} className="bg-white border rounded p-3">
          <div className="font-semibold">{s.title}</div>
          <div className="text-sm text-gray-600">{s.description}</div>
          <button className="rounded bg-blue-600 text-white px-3 py-1 mt-2" onClick={()=>respond(s.id)}>回答する</button>
        </div>
      ))}
    </div>
  );
}
</file>

<file path="frontend/app/terms/page.tsx">
'use client';

import Header from '@/components/Header';
import Footer from '@/components/Footer';
import { motion } from 'framer-motion';
import { FileText, AlertTriangle, Shield, Users, Ban, Gavel } from 'lucide-react';

export default function TermsPage() {
  const sections = [
    {
      icon: FileText,
      title: '第1条（適用）',
      content: [
        '本利用規約（以下「本規約」）は、市民参加型 透明性データプラットフォーム（以下「当プラットフォーム」）が提供するサービス（以下「本サービス」）の利用条件を定めるものです。',
        'ユーザーは、本サービスを利用することにより、本規約に同意したものとみなします。'
      ]
    },
    {
      icon: Users,
      title: '第2条（利用登録）',
      content: [
        '本サービスにおいては、登録希望者が本規約に同意の上、当プラットフォームの定める方法によって利用登録を申請し、当プラットフォームがこれを承認することによって、利用登録が完了するものとします。',
        '当プラットフォームは、利用登録の申請者に以下の事由があると判断した場合、利用登録の申請を承認しないことがあり、その理由については一切の開示義務を負わないものとします。',
        '• 利用登録の申請に際して虚偽の事項を届け出た場合',
        '• 本規約に違反したことがある者からの申請である場合',
        '• その他、当プラットフォームが利用登録を相当でないと判断した場合'
      ]
    },
    {
      icon: Shield,
      title: '第3条（ユーザーIDおよびパスワードの管理）',
      content: [
        'ユーザーは、自己の責任において、本サービスのユーザーIDおよびパスワードを適切に管理するものとします。',
        'ユーザーは、いかなる場合にも、ユーザーIDおよびパスワードを第三者に譲渡または貸与し、もしくは第三者と共用することはできません。',
        '当プラットフォームは、ユーザーIDとパスワードの組み合わせが登録情報と一致してログインされた場合には、そのユーザーIDを登録しているユーザー自身による利用とみなします。'
      ]
    },
    {
      icon: AlertTriangle,
      title: '第4条（禁止事項）',
      content: [
        'ユーザーは、本サービスの利用にあたり、以下の行為をしてはなりません。',
        '• 法令または公序良俗に違反する行為',
        '• 犯罪行為に関連する行為',
        '• 本サービスの内容等、本サービスに含まれる著作権、商標権ほか知的財産権を侵害する行為',
        '• 当プラットフォーム、ほかのユーザー、またはその他第三者のサーバーまたはネットワークの機能を破壊したり、妨害したりする行為',
        '• 本サービスによって得られた情報を商業的に利用する行為',
        '• 当プラットフォームのサービスの運営を妨害するおそれのある行為',
        '• 不正アクセスをし、またはこれを試みる行為',
        '• 他のユーザーに関する個人情報等を収集または蓄積する行為',
        '• 不正な目的を持って本サービスを利用する行為',
        '• 本サービスの他のユーザーまたはその他の第三者に不利益、損害、不快感を与える行為',
        '• 他のユーザーに成りすます行為',
        '• 当プラットフォームが許諾しない本サービス上での宣伝、広告、勧誘、または営業行為',
        '• 面識のない異性との出会いを目的とした行為',
        '• 当プラットフォームのサービスに関連して、反社会的勢力に対して直接または間接的に利益を供与する行為',
        '• その他、当プラットフォームが不適切と判断する行為'
      ]
    },
    {
      icon: Ban,
      title: '第5条（本サービスの提供の停止等）',
      content: [
        '当プラットフォームは、以下のいずれかの事由があると判断した場合、ユーザーに事前に通知することなく本サービスの全部または一部の提供を停止または中断することができるものとします。',
        '• 本サービスにかかるコンピュータシステムの保守点検または更新を行う場合',
        '• 地震、落雷、火災、停電または天災などの不可抗力により、本サービスの提供が困難となった場合',
        '• コンピュータまたは通信回線等が事故により停止した場合',
        '• その他、当プラットフォームが本サービスの提供が困難と判断した場合',
        '当プラットフォームは、本サービスの提供の停止または中断により、ユーザーまたは第三者が被ったいかなる不利益または損害についても、一切の責任を負わないものとします。'
      ]
    },
    {
      icon: Gavel,
      title: '第6条（利用制限および登録抹消）',
      content: [
        '当プラットフォームは、ユーザーが以下のいずれかに該当する場合には、事前の通知なく、ユーザーに対して、本サービスの全部もしくは一部の利用を制限し、またはユーザーとしての登録を抹消することができるものとします。',
        '• 本規約のいずれかの条項に違反した場合',
        '• 登録事項に虚偽の事実があることが判明した場合',
        '• 決済手段として当該ユーザーが届け出たクレジットカードが利用停止となった場合',
        '• 料金等の支払債務の不履行があった場合',
        '• 当プラットフォームからの連絡に対し、一定期間返答がない場合',
        '• 本サービスについて、最後の利用から一定期間利用がない場合',
        '• その他、当プラットフォームが本サービスの利用を適当でないと判断した場合',
        '当プラットフォームは、本条に基づき当プラットフォームが行った行為によりユーザーに生じた損害について、一切の責任を負いません。'
      ]
    }
  ];

  return (
    <div className="min-h-screen bg-gray-50">
      <Header />
      
      <main className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Header */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="text-center mb-12"
        >
          <h1 className="text-3xl font-bold text-gray-900 mb-4">利用規約</h1>
          <p className="text-lg text-gray-600">
            最終更新日: 2024年1月1日
          </p>
        </motion.div>

        {/* Introduction */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.1 }}
          className="bg-white rounded-lg shadow-lg p-8 mb-8"
        >
          <div className="flex items-center mb-4">
            <FileText className="w-8 h-8 text-blue-600 mr-3" />
            <h2 className="text-2xl font-bold text-gray-900">はじめに</h2>
          </div>
          <p className="text-gray-700 leading-relaxed">
            この利用規約（以下「本規約」）は、市民参加型 透明性データプラットフォーム（以下「当プラットフォーム」）が提供するサービス（以下「本サービス」）の利用条件を定めるものです。
            本サービスをご利用いただく前に、必ず本規約をお読みください。
          </p>
        </motion.div>

        {/* Sections */}
        <div className="space-y-8">
          {sections.map((section, index) => {
            const Icon = section.icon;
            return (
              <motion.div
                key={section.title}
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: (index + 1) * 0.1 }}
                className="bg-white rounded-lg shadow-lg p-8"
              >
                <div className="flex items-center mb-6">
                  <Icon className="w-8 h-8 text-blue-600 mr-3" />
                  <h2 className="text-2xl font-bold text-gray-900">{section.title}</h2>
                </div>
                <div className="space-y-3">
                  {section.content.map((item, itemIndex) => (
                    <p key={itemIndex} className="text-gray-700 leading-relaxed">
                      {item}
                    </p>
                  ))}
                </div>
              </motion.div>
            );
          })}
        </div>

        {/* Additional Terms */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.8 }}
          className="bg-white rounded-lg shadow-lg p-8 mt-8"
        >
          <h2 className="text-2xl font-bold text-gray-900 mb-6">その他の条項</h2>
          <div className="space-y-6">
            <div>
              <h3 className="text-lg font-semibold text-gray-900 mb-3">第7条（免責事項）</h3>
              <p className="text-gray-700 leading-relaxed">
                当プラットフォームは、本サービスに事実上または法律上の瑕疵（安全性、信頼性、正確性、完全性、有効性、特定の目的への適合性、セキュリティなどに関する欠陥、エラーやバグ、権利侵害などを含みます。）がないことを明示的にも黙示的にも保証しておりません。
              </p>
            </div>
            <div>
              <h3 className="text-lg font-semibold text-gray-900 mb-3">第8条（サービス内容の変更等）</h3>
              <p className="text-gray-700 leading-relaxed">
                当プラットフォームは、ユーザーに通知することなく、本サービスの内容を変更しまたは本サービスの提供を中止することができるものとし、これによってユーザーに生じた損害について一切の責任を負いません。
              </p>
            </div>
            <div>
              <h3 className="text-lg font-semibold text-gray-900 mb-3">第9条（利用規約の変更）</h3>
              <p className="text-gray-700 leading-relaxed">
                当プラットフォームは、必要と判断した場合には、ユーザーに通知することなくいつでも本規約を変更することができるものとします。なお、本規約の変更後、本サービスの利用を開始した場合には、当該ユーザーは変更後の規約に同意したものとみなします。
              </p>
            </div>
            <div>
              <h3 className="text-lg font-semibold text-gray-900 mb-3">第10条（準拠法・裁判管轄）</h3>
              <p className="text-gray-700 leading-relaxed">
                本規約の解釈にあたっては、日本法を準拠法とします。本サービスに関して紛争が生じた場合には、当プラットフォームの本店所在地を管轄する裁判所を専属的合意管轄とします。
              </p>
            </div>
          </div>
        </motion.div>

        {/* Contact */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.9 }}
          className="text-center mt-8"
        >
          <p className="text-gray-600 mb-4">
            本利用規約に関するご質問がございましたら、お気軽にお問い合わせください。
          </p>
          <a
            href="/contact"
            className="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors"
          >
            お問い合わせ
          </a>
        </motion.div>
      </main>

      <Footer />
    </div>
  );
}
</file>

<file path="frontend/app/timeline/page.tsx">
'use client';
import useSWRInfinite from 'swr/infinite';
import { API_BASE } from '../../lib/api';

type Post = {
  id: string;
  title: string;
  content: string;
  type: string;
  authorUserId: string;
  createdAt: string;
};

const PAGE_SIZE = 20;
const getKey = (pageIndex: number, previousPageData: Post[]) => {
  if (previousPageData && previousPageData.length < PAGE_SIZE) return null;
  const cursor = '';
  return `${API_BASE}/posts?limit=${PAGE_SIZE}&cursor=${cursor}`;
};

export default function TimelinePage() {
  const { data, size, setSize, isValidating } = useSWRInfinite<Post[]>(getKey, (url: string) => fetch(url).then(r => r.json()));
  const posts = (data || []).flat();

  return (
    <div className="flex flex-col gap-3">
      {posts.map((p) => (
        <article key={p.id} className="bg-white border rounded p-3">
          <h2 className="font-semibold">{p.title}</h2>
          <p className="text-sm text-gray-500">{new Date(p.createdAt).toLocaleString()}</p>
          <p className="mt-2 whitespace-pre-wrap">{p.content}</p>
        </article>
      ))}
      <button
        className="rounded bg-gray-800 text-white px-3 py-2"
        onClick={() => setSize(size + 1)}
        disabled={isValidating}
      >
        さらに読み込む
      </button>
    </div>
  );
}
</file>

<file path="frontend/app/verify/page.tsx">
'use client';
import { useState } from 'react';
import { verifyEmail, sendPhoneCode, verifyPhone } from '../../lib/api-extended';

export default function VerifyPage() {
  const [emailToken, setEmailToken] = useState('');
  const [emailMsg, setEmailMsg] = useState<string|null>(null);
  const [emailErr, setEmailErr] = useState<string|null>(null);

  const [phoneEmail, setPhoneEmail] = useState('');
  const [phoneCode, setPhoneCode] = useState('');
  const [phoneMsg, setPhoneMsg] = useState<string|null>(null);
  const [phoneErr, setPhoneErr] = useState<string|null>(null);

  async function onEmail(e: React.FormEvent) {
    e.preventDefault();
    setEmailMsg(null); setEmailErr(null);
    try {
      await verifyEmail(emailToken.trim());
      setEmailMsg('メール認証成功');
    } catch (e: any) {
      setEmailErr(e?.response?.data?.message || e.message);
    }
  }

  async function onSendPhone(e: React.FormEvent) {
    e.preventDefault();
    setPhoneMsg(null); setPhoneErr(null);
    try {
      await sendPhoneCode(phoneEmail.trim());
      setPhoneMsg('コード再送信完了。ログに出ています。');
    } catch (e: any) {
      setPhoneErr(e?.response?.data?.message || e.message);
    }
  }

  async function onPhoneVerify(e: React.FormEvent) {
    e.preventDefault();
    setPhoneMsg(null); setPhoneErr(null);
    try {
      await verifyPhone(phoneEmail.trim(), phoneCode.trim());
      setPhoneMsg('電話番号認証成功');
    } catch (e: any) {
      setPhoneErr(e?.response?.data?.message || e.message);
    }
  }

  return (
    <div className="space-y-6">
      <h1 className="text-lg font-semibold">認証</h1>
      <div className="card space-y-2">
        <h2 className="font-medium text-sm">メール認証</h2>
        <form onSubmit={onEmail} className="flex gap-2">
          <input className="border rounded px-2 py-1 text-sm flex-1" placeholder="メールトークン" value={emailToken} onChange={(e) => setEmailToken(e.target.value)} />
          <button className="border rounded px-3 py-1 text-sm">認証</button>
        </form>
        {emailMsg && <div className="text-xs text-green-600">{emailMsg}</div>}
        {emailErr && <div className="text-xs text-red-600">{emailErr}</div>}
        <div className="text-xs text-slate-500">登録時にバックエンドログに出力された token を使用してください。</div>
      </div>

      <div className="card space-y-2">
        <h2 className="font-medium text-sm">電話番号認証</h2>
        <form onSubmit={onSendPhone} className="flex gap-2">
          <input className="border rounded px-2 py-1 text-sm flex-1" placeholder="メールアドレス" value={phoneEmail} onChange={(e) => setPhoneEmail(e.target.value)} />
          <button className="border rounded px-3 py-1 text-sm">コード再送信</button>
        </form>
        <form onSubmit={onPhoneVerify} className="flex gap-2">
          <input className="border rounded px-2 py-1 text-sm flex-1" placeholder="認証コード" value={phoneCode} onChange={(e) => setPhoneCode(e.target.value)} />
          <button className="border rounded px-3 py-1 text-sm">電話認証</button>
        </form>
        {phoneMsg && <div className="text-xs text-green-600">{phoneMsg}</div>}
        {phoneErr && <div className="text-xs text-red-600">{phoneErr}</div>}
        <div className="text-xs text-slate-500">コードはサーバログに出力されます（暫定）。</div>
      </div>
    </div>
  );
}
</file>

<file path="frontend/app/wallet/page.tsx">
'use client';
import { useEffect, useState } from 'react';
import { API_BASE } from '../../lib/api';
import { getToken } from '../../lib/auth';

export default function WalletPage() {
  const [txs, setTxs] = useState<any[]>([]);
  const token = typeof window !== 'undefined' ? getToken() : null;

  useEffect(() => {
    if (!token) return;
    fetch(`${API_BASE}/wallet/transactions`, { headers: { Authorization: `Bearer ${token}` } })
      .then(r => r.json()).then(setTxs);
  }, [token]);

  return (
    <div className="bg-white border rounded p-4">
      <h1 className="text-xl font-bold mb-2">取引履歴</h1>
      <ul className="flex flex-col gap-2">
        {txs.map((t) => (
          <li key={t.id} className="border rounded px-3 py-2 flex justify-between">
            <span>{t.type}</span>
            <span>{t.amount} {t.currency}</span>
            <span className="text-sm text-gray-600">{new Date(t.createdAt).toLocaleString()}</span>
          </li>
        ))}
      </ul>
    </div>
  );
}
</file>

<file path="frontend/app/globals.css">
@tailwind base;
@tailwind components;
@tailwind utilities;

body { @apply text-slate-800 bg-slate-50; }
.card { @apply bg-white border rounded-md p-4 shadow-sm; }
</file>

<file path="frontend/components/auth/AuthGuard.tsx">
// frontend/components/auth/AuthGuard.tsx
'use client';

import React, { useEffect } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import { useRouter } from 'next/navigation';
import { Loader2 } from 'lucide-react'; // ローディングアイコンとして仮置き

interface AuthGuardProps {
  children: React.ReactNode;
}

const AuthGuard: React.FC<AuthGuardProps> = ({ children }) => {
  const { isAuthenticated, loading } = useAuth();
  const router = useRouter();

  useEffect(() => {
    // 認証情報とローディングが完了した後
    if (!loading && !isAuthenticated) {
      // ログインしていない場合、ログインページにリダイレクト
      router.replace('/login');
    }
  }, [isAuthenticated, loading, router]);

  // ローディング中は何も表示しないか、ローディング画面を表示
  if (loading) {
    return (
      <div className="flex justify-center items-center h-screen">
        <Loader2 className="h-10 w-10 animate-spin text-blue-600" />
      </div>
    );
  }

  // 認証済みの場合のみ子コンポーネントを表示
  if (isAuthenticated) {
    return <>{children}</>;
  }

  // リダイレクト処理中（通常、このreturnは短い間にしか実行されない）
  return null;
};

export default AuthGuard;
</file>

<file path="frontend/components/auth/LoginForm.tsx">
// frontend/components/auth/LoginForm.tsx
'use client'; 

import React, { useState } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import { useRouter } from 'next/navigation';
import toast from 'react-hot-toast'; // トースト表示用にインポート

export default function LoginForm() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const { login } = useAuth(); 
  const router = useRouter();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      // 💡 login関数を呼び出し、成功したらリダイレクト
      await login(email, password); 
      router.push('/');
      
    } catch (error) {
      // 💡 AuthContext側でトーストが表示されるが、念のためコンソールにエラー出力
      console.error("Login attempt failed:", error); 
    }
  };

  // 💡 ここからが正しい return ステートメントです
  return (
    <div className="w-full max-w-md bg-white p-8 rounded-lg shadow-xl dark:bg-gray-800">
      <h2 className="text-2xl font-bold text-gray-900 mb-6 dark:text-white">ログイン</h2>
      <form onSubmit={handleSubmit}>
        <div className="mb-4">
          <label className="block text-gray-700 text-sm font-bold mb-2 dark:text-gray-300" htmlFor="email">
            メールアドレス
          </label>
          <input
            className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
            id="email"
            type="email"
            placeholder="メールアドレス"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            required
          />
        </div>
        <div className="mb-6">
          <label className="block text-gray-700 text-sm font-bold mb-2 dark:text-gray-300" htmlFor="password">
            パスワード
          </label>
          <input
            className="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
            id="password"
            type="password"
            placeholder="********"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            required
          />
        </div>
        <div className="flex items-center justify-between">
          <button
            className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-150"
            type="submit"
          >
            ログイン
          </button>
        </div>
      </form>
    </div>
  );
}
</file>

<file path="frontend/components/auth/RegisterForm.tsx">
// frontend/components/auth/RegisterForm.tsx (完全版)
'use client';

import React, { useState } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import { useRouter } from 'next/navigation';
import toast from 'react-hot-toast';

const initialFormData = {
  email: '',
  password: '',
  confirmPassword: '',
  phoneNumber: '', 
  age: '',         
  prefecture: '',  
  city: '',        
};

export default function RegisterForm() {
  const [formData, setFormData] = useState(initialFormData);
  const { register } = useAuth();
  const router = useRouter();

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    setFormData({ ...formData, [e.target.name]: e.target.value });
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (formData.password !== formData.confirmPassword) {
      toast.error('パスワードが一致しません。');
      return;
    }

    try {
      // 💡 AuthContextのregister関数を呼び出し、登録
      await register(formData); 
      
      // 成功したらログインページへ
      router.push('/login');

    } catch (error) {
      const errorMessage = (error as Error).message || '登録に失敗しました。';
      toast.error(errorMessage);
    }
  };

  return (
    <div className="w-full max-w-lg bg-white p-8 rounded-lg shadow-xl dark:bg-gray-800">
      <h2 className="text-2xl font-bold text-gray-900 mb-6 dark:text-white">新規会員登録</h2>
      <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
        
        {/* === 認証情報 === */}
        <div className="md:col-span-2">
          <label className="block text-gray-700 text-sm font-bold mb-2 dark:text-gray-300" htmlFor="email">メールアドレス</label>
          <input className="shadow border rounded w-full py-2 px-3 text-gray-700" id="email" type="email" name="email" value={formData.email} onChange={handleChange} required />
        </div>
        <div className="col-span-1">
          <label className="block text-gray-700 text-sm font-bold mb-2 dark:text-gray-300" htmlFor="password">パスワード</label>
          <input className="shadow border rounded w-full py-2 px-3 text-gray-700" id="password" type="password" name="password" value={formData.password} onChange={handleChange} required />
        </div>
        <div className="col-span-1">
          <label className="block text-gray-700 text-sm font-bold mb-2 dark:text-gray-300" htmlFor="confirmPassword">パスワード（確認）</label>
          <input className="shadow border rounded w-full py-2 px-3 text-gray-700" id="confirmPassword" type="password" name="confirmPassword" value={formData.confirmPassword} onChange={handleChange} required />
        </div>

        {/* === 本人確認情報 === */}
        <div className="col-span-1">
          <label className="block text-gray-700 text-sm font-bold mb-2 dark:text-gray-300" htmlFor="phoneNumber">電話番号</label>
          <input className="shadow border rounded w-full py-2 px-3 text-gray-700" id="phoneNumber" type="tel" name="phoneNumber" value={formData.phoneNumber} onChange={handleChange} required />
        </div>
        <div className="col-span-1">
          <label className="block text-gray-700 text-sm font-bold mb-2 dark:text-gray-300" htmlFor="age">年齢</label>
          <input className="shadow border rounded w-full py-2 px-3 text-gray-700" id="age" type="number" name="age" value={formData.age} onChange={handleChange} min="18" required />
        </div>
        
        {/* === 住所情報 === */}
        <div className="col-span-1">
          <label className="block text-gray-700 text-sm font-bold mb-2 dark:text-gray-300" htmlFor="prefecture">都道府県</label>
          <input className="shadow border rounded w-full py-2 px-3 text-gray-700" id="prefecture" type="text" name="prefecture" value={formData.prefecture} onChange={handleChange} required />
        </div>
        <div className="col-span-1">
          <label className="block text-gray-700 text-sm font-bold mb-2 dark:text-gray-300" htmlFor="city">市区町村</label>
          <input className="shadow border rounded w-full py-2 px-3 text-gray-700" id="city" type="text" name="city" value={formData.city} onChange={handleChange} required />
        </div>

        {/* === 送信ボタン === */}
        <div className="md:col-span-2 mt-6 flex justify-center">
          <button
            className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-150 w-full"
            type="submit"
          >
            本登録を完了する
          </button>
        </div>
      </form>
    </div>
  );
}
</file>

<file path="frontend/components/common/Button.tsx">
// frontend/components/common/Button.tsx

import React from 'react';
import { Loader2 } from 'lucide-react';
import { cn } from '../../lib/utils'; // cn関数をインポート

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'danger';
  size?: 'default' | 'sm' | 'lg';
  loading?: boolean;
  children: React.ReactNode;
}

const Button: React.FC<ButtonProps> = ({ 
  children, 
  variant = 'primary', 
  size = 'default', 
  loading = false, 
  className, 
  disabled, 
  ...props 
}) => {
  const baseStyles = "inline-flex items-center justify-center font-medium rounded-md shadow-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed";

  const variantStyles = {
    primary: "bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500",
    secondary: "bg-gray-200 text-gray-800 hover:bg-gray-300 focus:ring-gray-400",
    danger: "bg-red-600 text-white hover:bg-red-700 focus:ring-red-500",
  }[variant];

  const sizeStyles = {
    default: "px-4 py-2 text-base",
    sm: "px-3 py-1.5 text-sm",
    lg: "px-6 py-3 text-lg",
  }[size];

  return (
    <button
      className={cn(baseStyles, variantStyles, sizeStyles, className)}
      disabled={disabled || loading}
      {...props}
    >
      {loading ? (
        <Loader2 className="mr-2 h-4 w-4 animate-spin" />
      ) : (
        children
      )}
    </button>
  );
};

export default Button;
</file>

<file path="frontend/components/common/Input.tsx">
// frontend/components/common/Input.tsx

import React from 'react';
import { UseFormRegisterReturn } from 'react-hook-form';
import { cn } from '../../lib/utils'; // Tailwind CSSのユーティリティ関数を想定

interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {
  label: string;
  id: string;
  error?: string;
  register: UseFormRegisterReturn;
}

const Input: React.FC<InputProps> = ({ label, id, error, register, className, ...props }) => {
  return (
    <div className="space-y-1">
      <label htmlFor={id} className="block text-sm font-medium text-gray-700">
        {label}
      </label>
      <input
        id={id}
        {...register}
        {...props}
        className={cn(
          // 変更点:
          // 1. 入力文字を濃い色にする 'text-gray-900' を追加
          // 2. ページ側で 'pl-10' が適用できるように、デフォルトの 'px-3' を削除し 'py-2' のみを残す
          "w-full py-2 border rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",
          "text-gray-900", // 👈 入力文字の色を濃くする修正
          error ? "border-red-500" : "border-gray-300",
          className
        )}
      />
      {error && <p className="mt-1 text-sm text-red-600">{error}</p>}
    </div>
  );
};

export default Input;
</file>

<file path="frontend/components/layout/Footer.tsx">
// frontend/components/layouts/Footer.tsx

import React from 'react';
import Link from 'next/link';

const Footer: React.FC = () => {
  const footerLinks = [
    { name: 'プラットフォームについて', href: '/about' },
    { name: '利用規約', href: '/terms' },
    { name: 'プライバシーポリシー', href: '/privacy' },
    { name: 'ヘルプ・FAQ', href: '/help' },
    { name: 'お問い合わせ', href: '/contact' },
  ];

  return (
    <footer className="bg-gray-800 text-white mt-12">
      <div className="container mx-auto px-4 sm:px-6 lg:px-8 pt-8 pb-4">
        {/* リンクセクション */}
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4 border-b border-gray-700 pb-6">
          {footerLinks.map((link) => (
            <Link 
              key={link.name} 
              href={link.href} 
              className="text-sm hover:text-blue-400 transition-colors"
            >
              {link.name}
            </Link>
          ))}
        </div>

        {/* コピーライト */}
        <div className="mt-4 text-center text-gray-400 text-sm">
          &copy; {new Date().getFullYear()} 政治家透明化プラットフォーム. All rights reserved.
        </div>
      </div>
    </footer>
  );
};

export default Footer;
</file>

<file path="frontend/components/layout/Header.tsx">
// frontend/components/layout/Header.tsx
'use client'; 

import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { useAuth } from '@/contexts/AuthContext';
import { LogOut } from 'lucide-react'; 
import toast from 'react-hot-toast'; // 💡 トーストをインポート

export default function Header() {
  const { isAuthenticated, user, logout } = useAuth();
  const router = useRouter(); 

  // ログアウト処理 (状態クリアとリダイレクト、トースト表示をすべて実行)
  const handleLogout = () => {
    // 1. 認証状態をクリア (AuthContext.tsx で実装済み)
    logout(); 
    
    // 2. 成功メッセージを表示
    toast.success('ログアウトしました。'); 
    
    // 3. ログインページへ強制リダイレクト
    router.push('/login'); 
  };
  
  const navItems = [];

  return (
    // サイドバー（幅64）の右にヘッダーを配置するスタイル
    <header className="fixed top-0 left-0 md:left-64 right-0 z-40 bg-white shadow-md p-4 flex justify-between items-center dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
      
      <Link href="/" className="text-xl font-semibold text-blue-700 dark:text-white transition-colors">
        {isAuthenticated ? 'ダッシュボード' : '透明化プラットフォーム'}
      </Link>
      
      <nav className="flex items-center space-x-4">
        {isAuthenticated ? (
          <>
            {/* ユーザー名表示 */}
            <span className="text-gray-700 text-sm dark:text-gray-300 hidden sm:inline truncate max-w-[150px]">
              ようこそ, {user?.name || user?.email}
            </span>
            
            {/* ログアウトボタン */}
            <button
              onClick={handleLogout} 
              className="bg-red-600 hover:bg-red-700 text-white font-bold py-1.5 px-3 rounded text-sm transition duration-150 flex items-center"
            >
              <LogOut className="h-4 w-4 mr-1 hidden sm:inline" />
              ログアウト
            </button>
          </>
        ) : (
          /* 未認証時はログインリンクを表示 */
          <Link 
            href="/login" 
            className="text-white bg-blue-600 hover:bg-blue-700 font-bold py-1.5 px-3 rounded text-sm transition duration-150"
          >
            ログイン/登録
          </Link>
        )}
      </nav>
    </header>
  );
}
</file>

<file path="frontend/components/layout/MainLayout.tsx">
// frontend/components/layout/MainLayout.tsx

import React from 'react';
import Sidebar from './Sidebar'; // Sidebarは同じフォルダ内なので相対パス（./）でOK

interface MainLayoutProps {
    children: React.ReactNode;
}

// ----------------------------------------------------
// 💡 右サイドバーのモック
// ----------------------------------------------------
// 今はシンプルに広告スペースとして定義します
const RightSidebarMock: React.FC = () => (
    <div className="sticky top-0 p-4 space-y-4">
        {/* 収益化 B: 広告 */}
        <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <h3 className="font-bold text-lg mb-2 text-gray-900 dark:text-white">広告・おすすめ</h3>
            <div className="h-32 bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-500 text-sm rounded">
                サイト内広告スペース（収益化 B）
            </div>
        </div>
        
        {/* トレンド（データSaaSのデモも兼ねる） */}
        <div className="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <h3 className="font-bold text-lg mb-2 text-gray-900 dark:text-white">地域のトレンド</h3>
            <ul className="text-sm space-y-2 text-gray-700 dark:text-gray-300">
                <li>#給食費無償化 (2.5K 賛否)</li>
                <li>#駅前再開発 (1.2K 議論)</li>
                <li>#子育て支援策</li>
            </ul>
        </div>
    </div>
);


export default function MainLayout({ children }: MainLayoutProps) {
    return (
        <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
            <div className="flex max-w-7xl mx-auto">
                
                {/* 1. 左サイドバー (ナビゲーション) */}
                <aside className="w-16 lg:w-64 flex-shrink-0">
                    <Sidebar />
                </aside>

                {/* 2. 中央コンテンツ (メインエリア) */}
                <main className="flex-grow border-x border-gray-200 dark:border-gray-700 min-h-screen w-full lg:w-1/2">
                    {children}
                </main>

                {/* 3. 右サイドバー (広告・ウィジェット) */}
                <aside className="hidden lg:block w-80 xl:w-96 flex-shrink-0 sticky top-0 h-screen">
                    <RightSidebarMock />
                </aside>
            </div>
        </div>
    );
}
</file>

<file path="frontend/components/layout/Sidebar.tsx">
// frontend/components/layout/Sidebar.tsx

'use client';
import React from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
// 💡 正しいインポートパス: 相対パス + 拡張子 (.ts) を使用
// Sidebarは /frontend/components/layout にいるので、2つ上の階層 (/frontend/) に上がり、/lib/navData.ts へ
import { NavItem, mainNavItems, utilityNavItems, authNavItems } from '../../lib/navData.ts';
import { User, LogIn, LogOut, Zap } from 'lucide-react';

// 認証ロジックのモック（後で実装）
const useAuth = () => ({ isAuthenticated: true, user: { name: '市民 太郎' } });

// --- NavLink, UserProfileWidget, Sidebar の定義は省略 ---

const NavLink: React.FC<{ item: NavItem }> = ({ item }) => {
    const pathname = usePathname();
    const isActive = pathname === item.href;

    return (
        <Link
            href={item.href}
            className={`
                flex items-center space-x-4 p-3 rounded-full transition-colors duration-200
                hover:bg-gray-100 dark:hover:bg-gray-800
                ${isActive
                    ? 'font-extrabold text-blue-600 dark:text-blue-400'
                    : 'font-medium text-gray-800 dark:text-gray-200'
                }
            `}
        >
            <item.icon className={`h-6 w-6 ${isActive ? 'fill-blue-600 dark:fill-blue-400' : 'text-gray-800 dark:text-gray-200'}`} />
            <span className="text-xl hidden lg:inline">{item.name}</span>
        </Link>
    );
}

const UserProfileWidget: React.FC<{ isAuthenticated: boolean, user: { name: string } | null }> = ({ isAuthenticated, user }) => {
    return (
        <div className="mt-auto pt-4">
            {isAuthenticated ? (
                <div className="flex items-center space-x-3 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 cursor-pointer transition-colors">
                    <div className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-semibold">
                        {user?.name ? user.name[0] : <User className="w-5 h-5" />}
                    </div>
                    <div className="hidden lg:block">
                        <p className="text-sm font-bold text-gray-900 dark:text-white">{user?.name}</p>
                        <p className="text-xs text-gray-500 dark:text-gray-400">@user_mock</p>
                    </div>
                </div>
            ) : (
                <Link
                    href="/login"
                    className="flex items-center space-x-3 p-3 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 cursor-pointer transition-colors"
                >
                    <LogIn className="h-6 w-6 text-gray-500 dark:text-gray-400" />
                    <span className="text-xl font-medium hidden lg:inline text-gray-800 dark:text-gray-200">ログイン</span>
                </Link>
            )}
        </div>
    );
}

export default function Sidebar() {
    const { isAuthenticated, user } = useAuth();

    return (
        <div className="fixed h-full border-r border-gray-200 dark:border-gray-700 w-16 lg:w-64">
            <div className="flex flex-col h-full p-2 lg:p-4">
                {/* ロゴ */}
                <div className="p-3 mb-4">
                    <Link href="/" className="text-2xl font-black text-blue-600 dark:text-blue-400">
                        <Zap className="h-8 w-8" />
                    </Link>
                </div>

                {/* メインナビゲーション */}
                <nav className="flex flex-col space-y-1">
                    {mainNavItems.map(item => (
                        <NavLink key={item.href} item={item} />
                    ))}
                    {isAuthenticated ? (
                        <NavLink key="/profile" item={{ name: 'プロフィール', href: '/profile', icon: User, isAuthRequired: true }} />
                    ) : (
                        authNavItems.map(item => (
                            <NavLink key={item.href} item={item} />
                        ))
                    )}
                </nav>

                {/* ポストボタン */}
                <button
                    className="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-full transition-colors shadow-md"
                >
                    <span className="hidden lg:inline">意見を投稿</span>
                    <span className="lg:hidden">💬</span>
                </button>

                {/* ユーティリティ & プロフィール */}
                <div className="mt-auto">
                    {isAuthenticated && (
                        <nav className="flex flex-col space-y-1 mb-2 border-t border-gray-200 dark:border-gray-700 pt-2">
                             {utilityNavItems.map(item => (
                                <NavLink key={item.href} item={item} />
                            ))}
                        </nav>
                    )}
                    <UserProfileWidget isAuthenticated={isAuthenticated} user={user} />
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend/components/timeline/PostForm.tsx">
// frontend/components/timeline/PostForm.tsx
'use client';

import React, { useState } from 'react';
import { Post } from '@/types/data';
import { createPost } from '@/utils/fakeApi';

interface PostFormProps {
    onPostCreated: (post: Post) => void;
}

export default function PostForm({ onPostCreated }: PostFormProps) {
    const [content, setContent] = useState('');
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [error, setError] = useState<string | null>(null);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!content.trim()) return;

        setIsSubmitting(true);
        setError(null);

        try {
            const newPost = await createPost(content, null);
            onPostCreated(newPost);
            setContent('');
        } catch (err) {
            setError('投稿に失敗しました。時間をおいて再試行してください。');
            console.error(err);
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <div className="bg-white p-4 rounded-xl shadow-md mb-6 dark:bg-gray-800 dark:border dark:border-gray-700">
            <form onSubmit={handleSubmit}>
                <textarea
                    className="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                    rows={3}
                    placeholder="いま、あなたの政治に関する意見を聞かせてください..."
                    value={content}
                    onChange={(e) => setContent(e.target.value)}
                    disabled={isSubmitting}
                />
                {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                <div className="mt-3 flex justify-end">
                    <button
                        type="submit"
                        disabled={isSubmitting || !content.trim()}
                        className={`px-6 py-2 rounded-lg font-semibold transition-colors ${
                            content.trim() && !isSubmitting
                                ? 'bg-blue-600 text-white hover:bg-blue-700'
                                : 'bg-gray-300 text-gray-500 cursor-not-allowed dark:bg-gray-600 dark:text-gray-400'
                        }`}
                    >
                        {isSubmitting ? '投稿中...' : '投稿する'}
                    </button>
                </div>
            </form>
        </div>
    );
}
</file>

<file path="frontend/components/timeline/PostItem.tsx">
// frontend/components/timeline/PostItem.tsx

'use client';

import React, { useState } from 'react'; 
import { Post } from '@/types/data'; 
import { MessageCircle, MoreVertical, Loader2 } from 'lucide-react'; 
import { toggleVote } from '@/utils/fakeApi'; 
import { toast } from 'react-hot-toast';

type VoteType = 'upvote' | 'downvote' | 'none';

interface PostItemProps {
  post: Post;
}

// =======================================================
// ArrowUp/DownのSVGコンポーネント定義 (埋め込み)
// =======================================================
const UpArrowSVG = (props: { className?: string, fill?: string, isVoting?: boolean }) => {
    if (props.isVoting) {
        return <Loader2 size={18} className="animate-spin" />;
    }
    return (
        <svg {...props} xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill={props.fill || 'none'} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}>
            <path d="m5 12 7-7 7 7"/><path d="M12 19V5"/>
        </svg>
    );
};

const DownArrowSVG = (props: { className?: string, fill?: string, isVoting?: boolean }) => {
    if (props.isVoting) {
        return <Loader2 size={18} className="animate-spin" />;
    }
    return (
        <svg {...props} xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill={props.fill || 'none'} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={props.className}>
            <path d="m19 12-7 7-7-7"/><path d="M12 5v14"/>
        </svg>
    );
};
// =======================================================


export default function PostItem({ post: initialPost }: PostItemProps) {
  const [post, setPost] = useState(initialPost);
  const [isVoting, setIsVoting] = useState(false); 

  const defaultAvatar = 'https://via.placeholder.com/40/FFFFFF/808080?text=U'; 

  /**
   * 賛否投票の状態を切り替えるハンドラ
   */
  const handleVoteToggle = async (voteDirection: 'upvote' | 'downvote') => {
    if (isVoting) return; 

    // Optimistic Update: UIを即時更新
    const previousPost = post;
    setIsVoting(true);

    const currentStatus = post.userVoteStatus;
    const isUpvote = voteDirection === 'upvote';
    const isDownvote = voteDirection === 'downvote';

    let newUp = post.upvoteCount;
    let newDown = post.downvoteCount;
    let newStatus: VoteType = 'none';

    if (isUpvote) {
        if (currentStatus === 'upvote') { newUp--; newStatus = 'none'; }
        else if (currentStatus === 'downvote') { newUp++; newDown--; newStatus = 'upvote'; }
        else { newUp++; newStatus = 'upvote'; }
    } else if (isDownvote) {
        if (currentStatus === 'downvote') { newDown--; newStatus = 'none'; }
        else if (currentStatus === 'upvote') { newUp--; newDown++; newStatus = 'downvote'; }
        else { newDown++; newStatus = 'downvote'; }
    }

    setPost(prev => ({
        ...prev,
        upvoteCount: newUp,
        downvoteCount: newDown,
        userVoteStatus: newStatus,
    }));


    try {
        const result = await toggleVote(post.id, voteDirection);
        
        setPost(prev => ({
            ...prev,
            upvoteCount: result.newUpvoteCount,
            downvoteCount: result.newDownvoteCount,
            userVoteStatus: result.newUserVoteStatus,
        }));
    } catch (error) {
        setPost(previousPost);
        toast.error('投票の操作に失敗しました。');
    } finally {
        setIsVoting(false);
    }
  };


  const voteButtonBaseClass = "flex items-center space-x-1 transition-colors disabled:opacity-50";

  return (
    <div className="bg-white p-4 sm:p-6 rounded-lg shadow-md border border-gray-100 dark:bg-gray-800 dark:border-gray-700 transition-shadow hover:shadow-lg">
      
      {/* ユーザー情報とメタデータ */}
      <div className="flex justify-between items-start mb-3">
        {/* ... (中略: ユーザー情報) ... */}
        <div className="flex items-center space-x-3">
          <img 
            src={post.author.avatarUrl || defaultAvatar} 
            alt={post.author.username} 
            className="w-10 h-10 rounded-full object-cover border border-gray-200 dark:border-gray-600"
          />
          <div>
            <div className="font-semibold text-gray-900 dark:text-white">{post.author.username}</div>
            <div className="text-xs text-gray-500 dark:text-gray-400">
              {post.author.prefecture || '地域不明'} ({post.author.ageGroup || '年代不明'}) • {new Date(post.createdAt).toLocaleDateString()}
            </div>
          </div>
        </div>
        <button className="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
          <MoreVertical size={18} />
        </button>
      </div>

      {/* 投稿内容 */}
      <p className="text-gray-800 dark:text-gray-200 mb-4 whitespace-pre-wrap">{post.content}</p>

      {/* 画像 */}
      {post.imageUrl && (
        <div className="mb-4">
          <img 
            src={post.imageUrl} 
            alt="Post image" 
            className="w-full max-h-80 object-cover rounded-lg border border-gray-200 dark:border-gray-700"
          />
        </div>
      )}

      {/* アクションと統計 (賛否投票エリア) */}
      <div className="flex items-center space-x-6 pt-3 pb-2 text-gray-500 dark:text-gray-400">
        
        {/* 💡 賛成ボタン (Upvote) - SVGコンポーネントを使用 */}
        <button 
          onClick={() => handleVoteToggle('upvote')} 
          disabled={isVoting} 
          className={`${voteButtonBaseClass} ${post.userVoteStatus === 'upvote' ? 'text-green-500' : 'hover:text-green-500'}`}
        >
          <UpArrowSVG 
              isVoting={isVoting && post.userVoteStatus !== 'upvote'}
              fill={post.userVoteStatus === 'upvote' ? 'currentColor' : 'none'} 
              className="w-[18px] h-[18px]" 
          />
          <span className="text-sm font-semibold">{post.upvoteCount} 賛成</span>
        </button>

        {/* 💡 反対ボタン (Downvote) - SVGコンポーネントを使用 */}
        <button 
          onClick={() => handleVoteToggle('downvote')} 
          disabled={isVoting} 
          className={`${voteButtonBaseClass} ${post.userVoteStatus === 'downvote' ? 'text-red-500' : 'hover:text-red-500'}`}
        >
           <DownArrowSVG 
              isVoting={isVoting && post.userVoteStatus !== 'downvote'}
              fill={post.userVoteStatus === 'downvote' ? 'currentColor' : 'none'} 
              className="w-[18px] h-[18px]" 
          />
          <span className="text-sm font-semibold">{post.downvoteCount} 反対</span>
        </button>

        {/* コメントボタン */}
        <button className="flex items-center space-x-1 hover:text-blue-500 transition-colors">
          <MessageCircle size={18} />
          <span className="text-sm">{post.commentCount} コメント</span>
        </button>

      </div>
    </div>
  );
}
</file>

<file path="frontend/components/timeline/PostList.tsx">
// frontend/components/timeline/PostList.tsx

'use client'; 

import React, { useState, useEffect } from 'react';
import { Post } from '@/types/data';
import { fetchTimelineData } from '@/utils/fakeApi';
import PostItem from './PostItem';
import PostForm from './PostForm'; // 🚨 正しいパス

export default function PostList() {
    const [posts, setPosts] = useState<Post[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    const handleNewPost = (newPost: Post) => {
        setPosts(prevPosts => [newPost, ...prevPosts]);
    };

    useEffect(() => {
        const loadPosts = async () => {
            try {
                const data = await fetchTimelineData();
                setPosts(data);
            } catch (err) {
                console.error("Failed to fetch timeline data:", err);
                setError("タイムラインデータの取得に失敗しました。");
            } finally {
                setIsLoading(false);
            }
        };
        loadPosts();
    }, []);

    if (isLoading) {
        return null; 
    }

    if (error) {
        return <div className="text-center text-red-500 p-8">{error}</div>;
    }

    if (posts.length === 0) {
        return (
            <div className="text-center text-gray-500 p-8 border rounded-lg bg-white shadow-sm dark:bg-gray-800">
                <p className="font-semibold mb-2">まだ投稿がありません。</p>
                <p className="text-sm">最初の投稿を作成してみましょう。</p>
            </div>
        );
    }

    return (
        <div className="space-y-6">
            <PostForm onPostCreated={handleNewPost} />
            
            {posts.map(post => (
                <PostItem key={post.id} post={post} />
            ))}
        </div>
    );
}
</file>

<file path="frontend/components/ActivityFundsChart.tsx">
// frontend/contexts/AuthContext.tsx
'use client';

import React, { createContext, useContext, useState, useEffect, useCallback } from 'react';
import toast from 'react-hot-toast'; 
// import axios from 'axios'; // 💡 API連携時に使用

// --- 型定義 ---

// ユーザー情報（今後の本人確認情報を反映）
interface User {
    id: number;
    email: string;
    name: string;
    prefecture?: string; 
    city?: string;
    // ... その他必要なフィールド
}

// 会員登録フォームのデータ型
interface RegisterFormData {
    email: string;
    password: string;
    phoneNumber: string;
    age: string;
    prefecture: string;
    city: string;
    // ... その他すべての登録フィールド
}

// Auth Contextが提供する値の型
interface AuthContextType {
    isAuthenticated: boolean;
    loading: boolean;
    user: User | null;
    login: (email: string, password: string) => Promise<void>;
    register: (data: RegisterFormData) => Promise<void>; 
    logout: () => void;
}

// 💡 Auth Contextの初期化
const AuthContext = createContext<AuthContextType | undefined>(undefined);

// --- AuthProvider コンポーネント ---

interface AuthProviderProps {
    children: React.ReactNode;
}

export const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {
    const [isAuthenticated, setIsAuthenticated] = useState(false);
    const [loading, setLoading] = useState(true);
    const [user, setUser] = useState<User | null>(null);

    // ログイン処理
    const login = useCallback(async (email: string, password: string) => {
        setLoading(true);
        try {
            console.log(`Attempting login for: ${email}`);
            
            // 🚨 【API呼び出しの仮ロジック】: 実際はここでバックエンドAPIを呼び出す
            await new Promise(resolve => setTimeout(resolve, 500)); 
            
            // 成功時: トークンを保存し、状態を更新
            localStorage.setItem('authToken', 'fake-jwt-token-' + email); 
            setIsAuthenticated(true);
            setUser({ id: 1, email: email, name: 'テストユーザー' }); 
            
            toast.success('ログインに成功しました！');
            
        } catch (error) {
            console.error('Login failed:', error);
            const errorMessage = (error as Error).message || 'ログインに失敗しました。';
            toast.error(errorMessage);
            throw new Error(errorMessage);
        } finally {
            setLoading(false);
        }
    }, []);

    // 会員登録処理 (本人確認情報を保存)
    const register = useCallback(async (data: RegisterFormData) => {
        setLoading(true);
        try {
            console.log("Registering user with data:", data);
            
            // 🚨 【API呼び出しの仮ロジック】: 実際はここで登録APIを呼び出す
            await new Promise(resolve => setTimeout(resolve, 800)); 

            // 登録成功メッセージ
            toast.success('会員登録に成功しました！ログインしてください。');
            
        } catch (error) {
            console.error('Registration failed:', error);
            const errorMessage = (error as Error).message || '会員登録に失敗しました。';
            toast.error(errorMessage);
            throw new Error(errorMessage);
        } finally {
            setLoading(false);
        }
    }, []);

    // ログアウト処理
    const logout = useCallback(() => {
        localStorage.removeItem('authToken');
        setIsAuthenticated(false);
        setUser(null);
        toast.success('ログアウトしました。');
    }, []);

    // 初期化処理（ページロード時にトークンチェック）
    useEffect(() => {
        const token = localStorage.getItem('authToken');
        if (token) {
            // 💡 本来はここでトークンを検証し、ユーザー情報をフェッチするAPIを呼び出す
            setIsAuthenticated(true);
            setUser({ id: 1, email: 'fake@example.com', name: '既存ユーザー' });
        }
        setLoading(false);
    }, []);

    const contextValue = {
        isAuthenticated,
        loading,
        user,
        login,
        register, // 💡 register関数を提供
        logout,
    };

    return (
        <AuthContext.Provider value={contextValue}>
            {children}
        </AuthContext.Provider>
    );
};

// --- Custom Hook (useAuth) ---

export const useAuth = (): AuthContextType => {
    const context = useContext(AuthContext);
    if (context === undefined) {
        throw new Error('useAuth must be used within an AuthProvider');
    }
    return context;
};
</file>

<file path="frontend/components/AdminReportsClient.tsx">
'use client';

import React, { useEffect, useState } from 'react';
import { fetchAdminReports, adminReportAction, Report } from '../lib/api.reports';

export default function AdminReportsClient() {
  const [reports, setReports] = useState<Report[]>([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string | null>(null);
  const [actionRunning, setActionRunning] = useState<number | null>(null);

  async function load() {
    setErr(null);
    setLoading(true);
    const list = await fetchAdminReports();
    setReports(list.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()));
    setLoading(false);
  }

  useEffect(() => {
    load();
  }, []);

  async function doAction(id: number, action: string) {
    setActionRunning(id);
    const ok = await adminReportAction(id, action);
    setActionRunning(null);
    if (!ok) {
      setErr('操作に失敗しました');
    } else {
      await load();
    }
  }

  return (
    <div className="space-y-4">
      {loading && <p className="text-sm text-gray-500">読み込み中...</p>}
      {err && <p className="text-sm text-red-600">{err}</p>}
      {!loading && reports.length === 0 && (
        <p className="text-sm text-gray-500">通報はまだありません。</p>
      )}
      <ul className="space-y-3">
        {reports.map(r => (
          <li
            key={r.id}
            className="border border-gray-200 rounded-lg p-3 bg-white shadow-sm text-xs space-y-2"
          >
            <div className="flex justify-between items-center">
              <span className="font-mono text-[10px] text-gray-500">REPORT #{r.id}</span>
              <span
                className={
                  'px-2 py-[2px] rounded text-[10px] ' +
                  (r.status === 'open'
                    ? 'bg-red-50 text-red-600 border border-red-200'
                    : 'bg-green-50 text-green-600 border border-green-200')
                }
              >
                {r.status}
              </span>
            </div>
            <div className="text-gray-700">
              対象: {r.targetType} #{r.targetId}
            </div>
            <div className="text-gray-600 break-all">
              理由: {r.reason}
            </div>
            {r.adminAction && (
              <div className="text-[10px] text-gray-500">action: {r.adminAction}</div>
            )}
            <div className="flex gap-2">
              {r.status === 'open' && (
                <>
                  <button
                    disabled={actionRunning === r.id}
                    onClick={() => doAction(r.id, 'hide')}
                    className="px-2 py-1 rounded bg-red-600 text-white disabled:opacity-50"
                  >
                    {actionRunning === r.id ? '処理中...' : '非表示 (hide)'}
                  </button>
                  <button
                    disabled={actionRunning === r.id}
                    onClick={() => doAction(r.id, 'ignore')}
                    className="px-2 py-1 rounded bg-gray-200 text-gray-700 disabled:opacity-50 hover:bg-gray-300"
                  >
                    {actionRunning === r.id ? '処理中...' : '無視 (ignore)'}
                  </button>
                </>
              )}
            </div>
            <div className="text-[9px] text-gray-400">
              送信: {new Date(r.createdAt).toLocaleString()}
            </div>
          </li>
        ))}
      </ul>
      <div className="text-[10px] text-gray-400">
        ※ 操作後は自動で更新されます。ブラウザフォーカス復帰時にも再読み込み推奨。
      </div>
    </div>
  );
}
</file>

<file path="frontend/components/AppShell.tsx">
'use client';

import { LeftSidebar } from './LeftSidebar';
import { RightSidebarFilters } from './RightSidebarFilters';

export function AppShell({ children }: { children: React.ReactNode }) {
  return (
    <div className="mx-auto max-w-6xl px-4 py-4 grid grid-cols-12 gap-4">
      <div className="col-span-12 md:col-span-2">
        <LeftSidebar />
      </div>
      <main className="col-span-12 md:col-span-8" aria-label="メインコンテンツ">
        {children}
      </main>
      <div className="col-span-12 md:col-span-2">
        <RightSidebarFilters />
      </div>
    </div>
  );
}

export { AppShell }
</file>

<file path="frontend/components/AuthActions.tsx">
'use client';
import { useAuth } from '../contexts/AuthContext';

export default function AuthActions() {
  const { isLoggedIn, user, logout } = useAuth();

  if (!isLoggedIn) {
    return (
      <div className="flex gap-3 text-sm">
        <a className="hover:text-brand-600" href="/login">Login</a>
        <a className="hover:text-brand-600" href="/register">Register</a>
      </div>
    );
  }

  return (
    <div className="flex items-center gap-3 text-sm">
      <span className="text-slate-600">{user?.email} / {user?.role}</span>
      <button onClick={logout} className="px-3 py-1 rounded border hover:bg-slate-50">ログアウト</button>
    </div>
  );
}
</file>

<file path="frontend/components/CommentLikeButton.tsx">
'use client';
import { useEffect, useState } from 'react';
import { likeComment, unlikeComment, isCommentLiked, getCommentLikesCount } from '../lib/api-extended';
import { useAuth } from '../contexts/AuthContext';

export default function CommentLikeButton({ commentId }: { commentId: string }) {
  const { isLoggedIn } = useAuth();
  const [liked, setLiked] = useState(false);
  const [count, setCount] = useState<number>(0);

  async function load() {
    const [likedRes, countRes] = await Promise.all([isCommentLiked(commentId), getCommentLikesCount(commentId)]);
    setLiked(likedRes.liked);
    setCount(countRes.count);
  }

  useEffect(() => {
    load().catch(console.error);
  }, [commentId]);

  async function toggle() {
    if (!isLoggedIn) return;
    if (liked) {
      await unlikeComment(commentId);
    } else {
      await likeComment(commentId);
    }
    load();
  }

  return (
    <button
      disabled={!isLoggedIn}
      onClick={toggle}
      className={`text-xs px-2 py-1 border rounded ${liked ? 'bg-blue-50 border-blue-400' : ''}`}
      title={isLoggedIn ? 'コメントをいいね' : 'ログインが必要です'}
    >
      👍 {count}
    </button>
  );
}
</file>

<file path="frontend/components/FeedClient.tsx">
'use client';

import React from 'react';
import { usePosts } from '../lib/hooks/usePosts';
import PostCard from './PostCard';
import PostComposerSWR from './PostComposerSWR';

export default function FeedClient() {
  const { posts, isLoading, error } = usePosts();

  return (
    <div className="space-y-6">
      <PostComposerSWR />
      <h2 className="text-xl font-semibold">議員フィード（自動更新）</h2>

      {isLoading && <p className="text-sm text-gray-500">読み込み中...</p>}
      {error && <p className="text-sm text-red-600">取得エラーが発生しました</p>}
      {!isLoading && posts.length === 0 && (
        <p className="text-sm text-gray-500">投稿がまだありません。</p>
      )}

      <div className="space-y-4">
        {posts.map(p => (
          <PostCard
            key={p.id}
            id={p.id}
            body={p.body}
            media={p.media}
            createdAt={p.createdAt}
          />
        ))}
      </div>

      <p className="text-[10px] text-gray-400">
        ※ 15秒ごとに自動更新 / フォーカス復帰時も再取得します
      </p>
    </div>
  );
}
</file>

<file path="frontend/components/FollowButton.tsx">
'use client';

import { useState, useEffect } from 'react';
import { followUser, unfollowUser, fetchFollowedUserIds } from '../lib/api.follows-snippet';
import { useAuth } from '../contexts/AuthContext';

export default function FollowButton({ userId }: { userId: string }) {
  const { isLoggedIn, ready } = useAuth();
  const [followed, setFollowed] = useState<boolean>(false);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (ready && isLoggedIn) {
      (async () => {
        try {
          const ids = await fetchFollowedUserIds();
          setFollowed(ids.includes(userId));
        } catch {
          // ignore
        }
      })();
    }
  }, [ready, isLoggedIn, userId]);

  async function toggle() {
    if (!isLoggedIn) {
      alert('ログインしてください');
      return;
    }
    setLoading(true);
    try {
      if (followed) {
        await unfollowUser(userId);
        setFollowed(false);
      } else {
        await followUser(userId);
        setFollowed(true);
      }
    } catch (e: any) {
      alert('操作失敗: ' + (e?.response?.data?.message ?? e?.message ?? 'unknown'));
    } finally {
      setLoading(false);
    }
  }

  return (
    <button
      onClick={toggle}
      disabled={loading}
      className={`text-xs px-2 py-1 rounded border ${
        followed ? 'bg-slate-800 text-white' : 'bg-white'
      } disabled:opacity-50`}
    >
      {loading ? '処理中...' : followed ? 'フォロー解除' : 'フォロー'}
    </button>
  );
}
</file>

<file path="frontend/components/FollowingPanel.tsx">
'use client';
import { useEffect, useState } from 'react';
import { fetchMyFollows, unfollowPolitician, FollowRecord } from '../lib/api-follows';
import { useAuth } from '../contexts/AuthContext';

export default function FollowingPanel() {
  const { isLoggedIn, ready } = useAuth();
  const [items, setItems] = useState<FollowRecord[]>([]);
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  async function load() {
    setLoading(true);
    try {
      const data = await fetchMyFollows();
      setItems(data);
      setErr(null);
    } catch (e: any) {
      // 401の場合は未ログイン扱いで静かに表示
      if (e?.response?.status === 401) {
        setItems([]);
        setErr(null);
      } else {
        setErr(e?.response?.data?.message || e.message || '取得に失敗しました');
      }
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    if (ready && isLoggedIn) load();
  }, [ready, isLoggedIn]);

  if (!ready) {
    return <div className="card text-xs text-slate-500">読み込み中...</div>;
  }
  if (!isLoggedIn) {
    return <div className="card text-xs text-slate-500">ログインするとフォローが表示されます。</div>;
  }

  return (
    <div className="card space-y-2">
      <div className="flex items-center justify-between">
        <h3 className="font-medium text-sm">応援している議員</h3>
        <button onClick={load} className="text-xs px-2 py-1 border rounded">更新</button>
      </div>
      {loading && <div className="text-xs text-slate-500">読み込み中...</div>}
      {err && <div className="text-xs text-red-600">{err}</div>}
      {!loading && items.length === 0 && (
        <div className="text-xs text-slate-500">まだフォローがありません。</div>
      )}
      <ul className="space-y-1">
        {items.map(i => (
          <li key={i.followId} className="flex items-center justify-between text-xs">
            <span>{i.name || i.email || i.politicianId}</span>
            <button
              className="px-2 py-1 border rounded"
              onClick={async () => {
                await unfollowPolitician(i.politicianId);
                load();
              }}
            >
              解除
            </button>
          </li>
        ))}
      </ul>
    </div>
  );
}
</file>

<file path="frontend/components/Footer.tsx">
export default function Footer() {
  return (
    <footer className="mt-8 border-t pt-4 text-xs text-slate-500">
      <div className="flex gap-4 flex-wrap">
        <a href="/legal/terms" className="underline">利用規約</a>
        <a href="/legal/privacy" className="underline">プライバシーポリシー</a>
        <a href="/contact" className="underline">お問い合わせ(準備中)</a>
      </div>
      <div className="mt-2">&copy; 2025 サービス名 (仮)</div>
    </footer>
  );
}
</file>

<file path="frontend/components/FundingChart.tsx">
'use client';
import { Bar } from 'react-chartjs-2';
import {
  Chart as ChartJS, CategoryScale, LinearScale, BarElement, Tooltip, Legend,
} from 'chart.js';
ChartJS.register(CategoryScale, LinearScale, BarElement, Tooltip, Legend);

export default function FundingChart({ summary }: { summary: Record<string, number> }) {
  const labels = Object.keys(summary);
  const dataValues = labels.map(l => summary[l]);

  return (
    <div className="w-full">
      <Bar
        data={{
          labels,
          datasets: [{
            label: '金額(円)',
            data: dataValues,
            backgroundColor: 'rgba(99, 102, 241, 0.5)',
          }],
        }}
        options={{
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { ticks: { color: '#334155' } }, x: { ticks: { color: '#334155' } } }
        }}
      />
    </div>
  );
}
</file>

<file path="frontend/components/Hero.tsx">
'use client';

import { motion } from 'framer-motion';
import Link from 'next/link';
import { ArrowRight, Users, TrendingUp, Shield } from 'lucide-react';

export default function Hero() {
  return (
    <section className="bg-gradient-to-br from-blue-600 via-blue-700 to-blue-800 text-white">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-20">
        <div className="text-center">
          <motion.h1
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.8 }}
            className="text-4xl md:text-6xl font-bold mb-6"
          >
            市民参加型
            <br />
            <span className="text-blue-200">透明性データプラットフォーム</span>
          </motion.h1>
          
          <motion.p
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.8, delay: 0.2 }}
            className="text-xl md:text-2xl text-blue-100 mb-8 max-w-3xl mx-auto"
          >
            地方議会議員の活動情報、公約、および政務活動費の使途を
            市民が公平に確認・評価できるプラットフォーム
          </motion.p>

          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.8, delay: 0.4 }}
            className="flex flex-col sm:flex-row gap-4 justify-center mb-12"
          >
            <Link 
              href="/members"
              className="bg-white text-blue-600 px-8 py-3 rounded-lg font-semibold hover:bg-blue-50 transition-colors flex items-center justify-center"
            >
              議員一覧を見る
              <ArrowRight className="ml-2 w-5 h-5" />
            </Link>
            <Link 
              href="/about"
              className="border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-blue-600 transition-colors"
            >
              このサイトについて
            </Link>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.8, delay: 0.6 }}
            className="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-4xl mx-auto"
          >
            <div className="text-center">
              <div className="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <Users className="w-8 h-8" />
              </div>
              <h3 className="text-xl font-semibold mb-2">議員情報の透明性</h3>
              <p className="text-blue-200">
                議員のプロフィール、公約、活動履歴を一元的に確認できます
              </p>
            </div>

            <div className="text-center">
              <div className="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <TrendingUp className="w-8 h-8" />
              </div>
              <h3 className="text-xl font-semibold mb-2">政務活動費の可視化</h3>
              <p className="text-blue-200">
                公金の使途をカテゴリ別に集計し、グラフで分かりやすく表示
              </p>
            </div>

            <div className="text-center">
              <div className="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <Shield className="w-8 h-8" />
              </div>
              <h3 className="text-xl font-semibold mb-2">市民参加の促進</h3>
              <p className="text-blue-200">
                公約や活動に対する賛否評価で、市民の声を反映できます
              </p>
            </div>
          </motion.div>
        </div>
      </div>
    </section>
  );
}
</file>

<file path="frontend/components/LeftSidebar.tsx">
'use client';

import Link from 'next/link';
import { useEffect, useState } from 'react';
import { API_BASE } from '../lib/api';

type PoliticianSummary = {
  id: string;
  user?: { name?: string };
  party?: { name?: string };
};

type FollowersAgg = {
  total: number;
};

export function LeftSidebar() {
  const [navOpen, setNavOpen] = useState(false);
  const [isPolitician, setIsPolitician] = useState(false);
  const [profile, setProfile] = useState<PoliticianSummary | null>(null);
  const [followers, setFollowers] = useState<FollowersAgg | null>(null);

  useEffect(() => {
    // Minimal check (replace with auth/me in real)
    // Fetch politician self profile if available
    (async () => {
      try {
        // Placeholder: assume current user has politician profile at /politicians/me
        const res = await fetch(`${API_BASE}/politicians/me`, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          setProfile(data);
          setIsPolitician(true);
          const aggRes = await fetch(`${API_BASE}/analytics/my/followers/demographics`, { credentials: 'include' });
          if (aggRes.ok) setFollowers(await aggRes.json());
        }
      } catch {
        /* ignore */
      }
    })();
  }, []);

  return (
    <aside className={`bg-white border rounded p-3 ${navOpen ? '' : 'hidden md:block'}`} aria-label="メインナビ">
      <button
        aria-label="ナビを開閉"
        className="md:hidden rounded border px-2 py-1 mb-2"
        onClick={() => setNavOpen((v) => !v)}
      >
        メニュー
      </button>

      {isPolitician && profile && (
        <div className="mb-3">
          <div className="font-semibold">{profile.user?.name ?? '議員'}</div>
          <div className="text-sm text-gray-600">{profile.party?.name ?? '無所属'}</div>
          <div className="text-xs text-gray-500">フォロワー: {followers?.total ?? 0}</div>
        </div>
      )}

      <nav className="flex flex-col gap-2">
        <Link href="/feed" className="rounded px-3 py-2 hover:bg-gray-100">タイムライン</Link>
        <Link href="/notifications" className="rounded px-3 py-2 hover:bg-gray-100">通知</Link>
        <Link href="/profile" className="rounded px-3 py-2 hover:bg-gray-100">プロフィール</Link>
        <Link href="/kyc" className="rounded px-3 py-2 hover:bg-gray-100">KYC</Link>
        <Link href="/login" className="rounded px-3 py-2 hover:bg-gray-100">ログイン</Link>
        <Link href="/register" className="rounded px-3 py-2 hover:bg-gray-100">新規登録</Link>
      </nav>
    </aside>
  );
}

export { LeftSidebar }
</file>

<file path="frontend/components/MembersGrid.tsx">
'use client';

import { motion } from 'framer-motion';
import Link from 'next/link';
import { Users, MapPin, Building, ExternalLink } from 'lucide-react';

interface Member {
  id: string;
  name: string;
  email: string;
  photoUrl?: string;
  affiliation: string;
  biography?: string;
  position?: string;
  district?: string;
  party?: string;
  website?: string;
  twitterHandle?: string;
  pledges: Pledge[];
  activityLogs: ActivityLog[];
  activityFunds: ActivityFund[];
}

interface Pledge {
  id: string;
  title: string;
  description: string;
  category?: string;
  status: 'pending' | 'in_progress' | 'completed' | 'cancelled';
  supportCount: number;
  opposeCount: number;
  voteCount: number;
  createdAt: string;
}

interface ActivityLog {
  id: string;
  title: string;
  content: string;
  source: 'manual' | 'twitter' | 'rss' | 'official';
  sourceUrl?: string;
  createdAt: string;
}

interface ActivityFund {
  id: string;
  fiscalYear: number;
  category: string;
  amount: number;
  description?: string;
  expenseDate?: string;
  recipient?: string;
  purpose?: string;
}

interface MembersGridProps {
  members: Member[];
}

export default function MembersGrid({ members }: MembersGridProps) {
  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed':
        return 'bg-green-100 text-green-800';
      case 'in_progress':
        return 'bg-blue-100 text-blue-800';
      case 'pending':
        return 'bg-yellow-100 text-yellow-800';
      case 'cancelled':
        return 'bg-red-100 text-red-800';
      default:
        return 'bg-gray-100 text-gray-800';
    }
  };

  const getStatusText = (status: string) => {
    switch (status) {
      case 'completed':
        return '完了';
      case 'in_progress':
        return '進行中';
      case 'pending':
        return '未着手';
      case 'cancelled':
        return '中止';
      default:
        return status;
    }
  };

  return (
    <section className="py-16 bg-gray-50">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          whileInView={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.8 }}
          viewport={{ once: true }}
          className="text-center mb-12"
        >
          <h2 className="text-3xl font-bold text-gray-900 mb-4">
            登録議員一覧
          </h2>
          <p className="text-lg text-gray-600">
            各議員のプロフィール、公約、活動履歴をご確認ください
          </p>
        </motion.div>

        {members.length === 0 ? (
          <div className="text-center py-12">
            <Users className="w-16 h-16 text-gray-400 mx-auto mb-4" />
            <p className="text-gray-500 text-lg">登録されている議員はいません</p>
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {members.map((member, index) => (
              <motion.div
                key={member.id}
                initial={{ opacity: 0, y: 20 }}
                whileInView={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.8, delay: index * 0.1 }}
                viewport={{ once: true }}
                className="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow"
              >
                <div className="p-6">
                  <div className="flex items-center mb-4">
                    {member.photoUrl ? (
                      <img
                        src={member.photoUrl}
                        alt={member.name}
                        className="w-16 h-16 rounded-full object-cover"
                      />
                    ) : (
                      <div className="w-16 h-16 bg-gray-300 rounded-full flex items-center justify-center">
                        <Users className="w-8 h-8 text-gray-600" />
                      </div>
                    )}
                    <div className="ml-4">
                      <h3 className="text-xl font-bold text-gray-900">{member.name}</h3>
                      <p className="text-gray-600">{member.position || '議員'}</p>
                    </div>
                  </div>

                  <div className="space-y-2 mb-4">
                    <div className="flex items-center text-sm text-gray-600">
                      <Building className="w-4 h-4 mr-2" />
                      {member.affiliation}
                    </div>
                    {member.district && (
                      <div className="flex items-center text-sm text-gray-600">
                        <MapPin className="w-4 h-4 mr-2" />
                        {member.district}
                      </div>
                    )}
                    {member.party && (
                      <div className="text-sm text-gray-600">
                        所属政党: {member.party}
                      </div>
                    )}
                  </div>

                  {member.biography && (
                    <p className="text-gray-700 text-sm mb-4 line-clamp-3">
                      {member.biography}
                    </p>
                  )}

                  <div className="mb-4">
                    <h4 className="text-sm font-semibold text-gray-900 mb-2">公約状況</h4>
                    <div className="flex flex-wrap gap-1">
                      {member.pledges.slice(0, 3).map((pledge) => (
                        <span
                          key={pledge.id}
                          className={`px-2 py-1 text-xs rounded-full ${getStatusColor(pledge.status)}`}
                        >
                          {getStatusText(pledge.status)}
                        </span>
                      ))}
                      {member.pledges.length > 3 && (
                        <span className="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">
                          +{member.pledges.length - 3}
                        </span>
                      )}
                    </div>
                  </div>

                  <div className="flex items-center justify-between text-sm text-gray-600 mb-4">
                    <span>公約数: {member.pledges.length}</span>
                    <span>活動ログ: {member.activityLogs.length}</span>
                  </div>

                  <div className="flex space-x-2">
                    <Link
                      href={`/members/${member.id}`}
                      className="flex-1 bg-blue-600 text-white text-center py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
                    >
                      詳細を見る
                    </Link>
                    {member.website && (
                      <a
                        href={member.website}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="p-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
                      >
                        <ExternalLink className="w-4 h-4" />
                      </a>
                    )}
                  </div>
                </div>
              </motion.div>
            ))}
          </div>
        )}

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          whileInView={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.8, delay: 0.4 }}
          viewport={{ once: true }}
          className="text-center mt-12"
        >
          <Link
            href="/members"
            className="inline-flex items-center bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors"
          >
            すべての議員を見る
            <ExternalLink className="ml-2 w-4 h-4" />
          </Link>
        </motion.div>
      </div>
    </section>
  );
}
</file>

<file path="frontend/components/PledgeCard.tsx">
'use client';

import { useState } from 'react';
import { motion } from 'framer-motion';
import { Calendar, Tag, ThumbsUp, ThumbsDown, CheckCircle, Clock, XCircle, AlertCircle } from 'lucide-react';
import VoteButton from './VoteButton';

interface Pledge {
  id: string;
  title: string;
  description: string;
  category?: string;
  targetDate?: string;
  status: 'pending' | 'in_progress' | 'completed' | 'cancelled';
  voteCount: number;
  supportCount: number;
  opposeCount: number;
  createdAt: string;
  updatedAt: string;
}

interface PledgeCardProps {
  pledge: Pledge;
  showVoting?: boolean;
}

const statusConfig = {
  pending: {
    icon: Clock,
    label: '未着手',
    color: 'text-gray-600',
    bgColor: 'bg-gray-100',
    borderColor: 'border-gray-200'
  },
  in_progress: {
    icon: AlertCircle,
    label: '進行中',
    color: 'text-yellow-600',
    bgColor: 'bg-yellow-100',
    borderColor: 'border-yellow-200'
  },
  completed: {
    icon: CheckCircle,
    label: '完了',
    color: 'text-green-600',
    bgColor: 'bg-green-100',
    borderColor: 'border-green-200'
  },
  cancelled: {
    icon: XCircle,
    label: '中止',
    color: 'text-red-600',
    bgColor: 'bg-red-100',
    borderColor: 'border-red-200'
  }
};

export default function PledgeCard({ pledge, showVoting = false }: PledgeCardProps) {
  const [isExpanded, setIsExpanded] = useState(false);
  const [voteCounts, setVoteCounts] = useState({
    support: pledge.supportCount,
    oppose: pledge.opposeCount,
    total: pledge.voteCount
  });

  const status = statusConfig[pledge.status];
  const StatusIcon = status.icon;

  const supportPercentage = voteCounts.total > 0 ? (voteCounts.support / voteCounts.total * 100).toFixed(1) : '0';
  const opposePercentage = voteCounts.total > 0 ? (voteCounts.oppose / voteCounts.total * 100).toFixed(1) : '0';

  const handleVoteUpdate = (newCounts: { support: number; oppose: number; total: number }) => {
    setVoteCounts(newCounts);
  };

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className={`bg-white rounded-lg shadow-lg border-l-4 ${status.borderColor} overflow-hidden hover:shadow-xl transition-shadow duration-300`}
    >
      <div className="p-6">
        {/* Header */}
        <div className="flex items-start justify-between mb-4">
          <div className="flex-1">
            <h3 className="text-lg font-semibold text-gray-900 mb-2 line-clamp-2">
              {pledge.title}
            </h3>
            <div className="flex items-center space-x-4 text-sm text-gray-600">
              <div className={`flex items-center px-2 py-1 rounded-full ${status.bgColor} ${status.color}`}>
                <StatusIcon className="w-4 h-4 mr-1" />
                <span className="font-medium">{status.label}</span>
              </div>
              {pledge.category && (
                <div className="flex items-center text-gray-500">
                  <Tag className="w-4 h-4 mr-1" />
                  <span>{pledge.category}</span>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Description */}
        <div className="mb-4">
          <p className={`text-gray-700 leading-relaxed ${!isExpanded ? 'line-clamp-3' : ''}`}>
            {pledge.description}
          </p>
          {pledge.description.length > 150 && (
            <button
              onClick={() => setIsExpanded(!isExpanded)}
              className="text-blue-600 hover:text-blue-800 text-sm font-medium mt-2"
            >
              {isExpanded ? '折りたたむ' : '続きを読む'}
            </button>
          )}
        </div>

        {/* Target Date */}
        {pledge.targetDate && (
          <div className="flex items-center text-sm text-gray-600 mb-4">
            <Calendar className="w-4 h-4 mr-2" />
            <span>目標日: {new Date(pledge.targetDate).toLocaleDateString('ja-JP')}</span>
          </div>
        )}

        {/* Voting Section */}
        {showVoting && (
          <div className="mb-4">
            <VoteButton 
              pledgeId={pledge.id} 
              onVoteUpdate={handleVoteUpdate}
              initialCounts={{
                support: pledge.supportCount,
                oppose: pledge.opposeCount,
                total: pledge.voteCount
              }}
            />
          </div>
        )}

        {/* Vote Results */}
        <div className="bg-gray-50 rounded-lg p-4">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-medium text-gray-700">投票結果</span>
            <span className="text-sm text-gray-600">{voteCounts.total}票</span>
          </div>
          
          <div className="space-y-2">
            {/* Support Bar */}
            <div className="flex items-center">
              <div className="flex items-center w-16 text-sm text-green-700">
                <ThumbsUp className="w-4 h-4 mr-1" />
                <span>賛成</span>
              </div>
              <div className="flex-1 mx-3">
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div 
                    className="bg-green-500 h-2 rounded-full transition-all duration-300"
                    style={{ width: `${supportPercentage}%` }}
                  />
                </div>
              </div>
              <div className="text-sm text-gray-700 w-16 text-right">
                {voteCounts.support}票 ({supportPercentage}%)
              </div>
            </div>

            {/* Oppose Bar */}
            <div className="flex items-center">
              <div className="flex items-center w-16 text-sm text-red-700">
                <ThumbsDown className="w-4 h-4 mr-1" />
                <span>反対</span>
              </div>
              <div className="flex-1 mx-3">
                <div className="w-full bg-gray-200 rounded-full h-2">
                  <div 
                    className="bg-red-500 h-2 rounded-full transition-all duration-300"
                    style={{ width: `${opposePercentage}%` }}
                  />
                </div>
              </div>
              <div className="text-sm text-gray-700 w-16 text-right">
                {voteCounts.oppose}票 ({opposePercentage}%)
              </div>
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="mt-4 pt-4 border-t border-gray-200">
          <div className="flex items-center justify-between text-xs text-gray-500">
            <span>作成日: {new Date(pledge.createdAt).toLocaleDateString('ja-JP')}</span>
            <span>更新日: {new Date(pledge.updatedAt).toLocaleDateString('ja-JP')}</span>
          </div>
        </div>
      </div>
    </motion.div>
  );
}
</file>

<file path="frontend/components/PostCard.tsx">
import React from 'react';
import ReactionButtons from './ReactionButtons';
import CommentsSection from './CommentsSection';

type Media = { images?: string[]; video?: string } | null;
export type PostProps = {
  id: number;
  body: string;
  media?: Media;
  createdAt: string;
};

export default function PostCard({ id, body, media, createdAt }: PostProps) {
  return (
    <article className="tw-card p-4 fade-in">
      <header className="flex items-center justify-between">
        <span className="text-xs font-mono text-gray-500">POST #{id}</span>
        <span className="text-[10px] text-gray-400">{new Date(createdAt).toLocaleString()}</span>
      </header>
      <p className="mt-2 text-sm leading-relaxed whitespace-pre-line">{body}</p>

      {media?.images && media.images.length > 0 && (
        <div className="mt-3 grid grid-cols-2 md:grid-cols-3 gap-2">
          {media.images.map((img, i) => (
            <div
              key={i}
              className="relative h-24 bg-gray-100 border rounded flex items-center justify-center text-[10px] text-gray-600"
            >
              {img}
            </div>
          ))}
        </div>
      )}

      <div className="mt-4">
        <ReactionButtons postId={id} />
      </div>

      <CommentsSection postId={id} />
    </article>
  );
}
</file>

<file path="frontend/components/PostCategoryBadge.tsx">
'use client';

import React from 'react';

export default function PostCategoryBadge({ category }: { category: 'policy' | 'activity' }) {
  const label = category === 'policy' ? '政策' : '活動報告';
  const color = category === 'policy' ? 'bg-blue-600' : 'bg-green-600';
  return (
    <span className={`inline-block text-xs text-white px-2 py-1 rounded ${color}`}>
      {label}
    </span>
  );
}
</file>

<file path="frontend/components/PostComposer.tsx">
'use client';
import { useState } from 'react';
import { createPost } from '../lib/api';
import { useAuth } from '../contexts/AuthContext';

export default function PostComposer({ onCreated }: { onCreated?: () => void }) {
  const [title, setTitle] = useState('');
  const [body, setBody] = useState('');
  const [tags, setTags] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const { isPolitician, isLoggedIn } = useAuth();

  if (!isLoggedIn) {
    return (
      <div className="card">
        <p className="text-sm">投稿作成は <a className="text-brand-600 hover:underline" href="/login">ログイン</a> が必要です。</p>
      </div>
    );
  }

  if (!isPolitician) {
    return (
      <div className="card">
        <p className="text-sm">投稿できるのは政治家アカウントのみです。</p>
      </div>
    );
  }

  async function submit(e: React.FormEvent) {
    e.preventDefault();
    if (!title.trim() || !body.trim()) return;
    setLoading(true);
    setError(null);
    try {
      await createPost({
        title: title.trim(),
        body: body.trim(),
        tags: tags.split(',').map(t => t.trim()).filter(Boolean),
      });
      setTitle('');
      setBody('');
      setTags('');
      onCreated?.();
    } catch (e: any) {
      setError(e?.response?.data?.message || e.message || '投稿に失敗しました');
    } finally {
      setLoading(false);
    }
  }

  return (
    <form onSubmit={submit} className="space-y-3 bg-white border rounded-md p-4 shadow-sm">
      <h3 className="font-semibold text-slate-800 text-sm">新規投稿（政治家のみ）</h3>
      <input className="w-full border rounded px-3 py-2 text-sm" placeholder="タイトル（任意）" value={title} onChange={(e) => setTitle(e.target.value)} />
      <textarea className="w-full border rounded px-3 py-2 text-sm" rows={4} placeholder="本文" value={body} onChange={(e) => setBody(e.target.value)} />
      <input className="w-full border rounded px-3 py-2 text-sm" placeholder="タグ (カンマ区切り/任意)" value={tags} onChange={(e) => setTags(e.target.value)} />
      {error && <p className="text-red-600 text-xs">{error}</p>}
      <button type="submit" disabled={loading} className="px-4 py-2 text-sm font-medium rounded bg-brand-600 text-white hover:bg-brand-700 disabled:opacity-50">
        {loading ? '送信中...' : '投稿'}
      </button>
    </form>
  );
}
</file>

<file path="frontend/components/PostComposerSWR.tsx">
'use client';

import React, { useState } from 'react';
import { usePosts } from '../lib/hooks/usePosts';

export default function PostComposerSWR() {
  const { addPost } = usePosts();
  const [body, setBody] = useState('');
  const [imagesText, setImagesText] = useState('');
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState<string | null>(null);
  const [done, setDone] = useState(false);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setErr(null);
    setDone(false);
    setLoading(true);
    try {
      const images = imagesText.split(',').map(v => v.trim()).filter(Boolean);
      await addPost(body, images);
      setBody('');
      setImagesText('');
      setDone(true);
    } catch (e: any) {
      setErr(e?.message || '投稿失敗');
    } finally {
      setLoading(false);
    }
  }

  return (
    <form onSubmit={handleSubmit} className="tw-card p-4 space-y-3 fade-in">
      <h3 className="text-sm font-semibold">新規投稿（自動反映）</h3>
      <textarea
        value={body}
        onChange={e => setBody(e.target.value)}
        required
        placeholder="投稿本文を入力"
        className="w-full border rounded p-2 text-sm resize-y min-h-[80px]"
      />
      <input
        value={imagesText}
        onChange={e => setImagesText(e.target.value)}
        placeholder="画像名 (例: img1.png,img2.png) 空でも可"
        className="w-full border rounded p-2 text-sm"
      />
      {err && <div className="text-xs text-red-600">{err}</div>}
      {done && <div className="text-xs text-green-600">投稿反映しました</div>}
      <button
        disabled={loading || !body}
        className="px-4 py-2 text-sm rounded bg-blue-600 text-white disabled:opacity-50"
      >
        {loading ? '送信中...' : '投稿する'}
      </button>
    </form>
  );
}
</file>

<file path="frontend/components/PostCreateForm.tsx">
'use client';
import { useState } from 'react';
import { createPost } from '../lib/api';

export default function PostCreateForm() {
  const [title, setTitle] = useState('');
  const [body, setBody] = useState('');
  const [postCategory, setPostCategory] = useState<'policy' | 'activity'>('activity');
  const [visibility, setVisibility] = useState<'public' | 'hidden'>('public');
  const [regionPref, setRegionPref] = useState('');
  const [regionCity, setRegionCity] = useState('');
  const [submitting, setSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError(null);
    try {
      setSubmitting(true);
      await createPost({
        title: title || undefined,
        body,
        postCategory,
        visibility,
        regionPref: regionPref || undefined,
        regionCity: regionCity || undefined,
      });
      alert('投稿しました');
      setTitle('');
      setBody('');
      setPostCategory('activity');
      setVisibility('public');
      setRegionPref('');
      setRegionCity('');
    } catch (e: any) {
      const msg = e?.response?.data?.message || e?.message || '投稿に失敗しました';
      setError(msg);
    } finally {
      setSubmitting(false);
    }
  }

  return (
    <form onSubmit={onSubmit} className="space-y-3 border rounded p-3">
      <div className="flex gap-2">
        <select
          className="border px-2 py-1"
          value={postCategory}
          onChange={(e) => setPostCategory(e.target.value as any)}
        >
          <option value="activity">活動報告</option>
          <option value="policy">政策</option>
        </select>
        <select
          className="border px-2 py-1"
          value={visibility}
          onChange={(e) => setVisibility(e.target.value as any)}
        >
          <option value="public">公開</option>
          <option value="hidden">非公開</option>
        </select>
      </div>

      {error && (
        <div className="text-xs text-red-600 whitespace-pre-line border border-red-300 p-2 rounded">
          {error}
        </div>
      )}

      <input
        className="border px-2 py-1 w-full"
        placeholder="タイトル（任意）"
        value={title}
        onChange={(e) => setTitle(e.target.value)}
      />
      <textarea
        className="border px-2 py-1 w-full"
        placeholder="本文"
        rows={6}
        value={body}
        onChange={(e) => setBody(e.target.value)}
      />
      <div className="flex gap-2">
        <input
          className="border px-2 py-1"
          placeholder="都道府県（任意）"
          value={regionPref}
          onChange={(e) => setRegionPref(e.target.value)}
        />
        <input
          className="border px-2 py-1"
          placeholder="市区町村（任意）"
          value={regionCity}
          onChange={(e) => setRegionCity(e.target.value)}
        />
      </div>
      <button
        className="border px-3 py-2 rounded disabled:opacity-50"
        disabled={submitting}
      >
        {submitting ? '投稿中...' : '投稿'}
      </button>
    </form>
  );
}
</file>

<file path="frontend/components/PostItem.tsx">
import React from 'react';
import { Post } from '../lib/api';

export function PostItem({ post }: { post: Post }) {
  const badgeColor =
    post.postCategory === 'policy' ? 'bg-blue-600' : 'bg-green-600';
  return (
    <div className="border rounded p-3 space-y-2">
      <div className="flex items-center justify-between">
        <span className={`text-xs text-white px-2 py-1 rounded ${badgeColor}`}>
          {post.postCategory === 'policy' ? '政策' : '活動報告'}
        </span>
        {post.visibility === 'hidden' && (
          <span className="text-xs bg-gray-400 text-white px-2 py-1 rounded">非公開</span>
        )}
      </div>
      {post.title && <h3 className="font-semibold">{post.title}</h3>}
      <p className="text-sm whitespace-pre-line">{post.body}</p>
    </div>
  );
}
</file>

<file path="frontend/components/PostsList.tsx">
'use client';
import { usePosts } from '../lib/hooks/usePosts';
import { useState } from 'react';

export default function PostsList() {
  const { posts, loading, error, create, remove } = usePosts();
  const [title, setTitle] = useState('');
  const [body, setBody] = useState('');
  const [sending, setSending] = useState(false);

  async function submit(e: React.FormEvent) {
    e.preventDefault();
    if (!title.trim() || !body.trim()) return;
    setSending(true);
    try {
      await create({ title: title.trim(), body: body.trim() });
      setTitle('');
      setBody('');
    } finally {
      setSending(false);
    }
  }

  return (
    <div style={{ padding: 16 }}>
      <h2>Posts</h2>
      <form onSubmit={submit} style={{ display: 'flex', flexDirection: 'column', gap: 8, maxWidth: 400 }}>
        <input
          placeholder="タイトル"
          value={title}
          onChange={(e) => setTitle(e.target.value)}
          style={{ padding: 8, border: '1px solid #ccc', borderRadius: 4 }}
        />
        <textarea
          placeholder="本文"
          value={body}
          onChange={(e) => setBody(e.target.value)}
          rows={4}
          style={{ padding: 8, border: '1px solid #ccc', borderRadius: 4 }}
        />
        <button
          type="submit"
          disabled={sending}
          style={{ padding: 10, background: '#2563eb', color: '#fff', border: 'none', borderRadius: 4 }}
        >
          {sending ? '送信中...' : '投稿'}
        </button>
      </form>

      {loading && <p>読み込み中...</p>}
      {error && <p style={{ color: 'red' }}>エラー: {String(error)}</p>}

      <ul style={{ listStyle: 'none', padding: 0, marginTop: 20 }}>
        {posts.map((p) => (
          <li key={p.id} style={{ padding: 12, border: '1px solid #e2e8f0', marginBottom: 12 }}>
            <h3 style={{ margin: '0 0 4px' }}>{p.title}</h3>
            <p style={{ margin: 0 }}>{p.body}</p>
            <small style={{ color: '#64748b' }}>{new Date(p.createdAt).toLocaleString()}</small>
            <div style={{ marginTop: 8 }}>
              <button
                onClick={() => remove(p.id)}
                style={{ background: '#dc2626', color: '#fff', border: 'none', padding: '6px 10px', borderRadius: 4 }}
              >
                削除
              </button>
            </div>
          </li>
        ))}
        {posts.length === 0 && !loading && <li style={{ color: '#64748b' }}>まだ投稿がありません</li>}
      </ul>
    </div>
  );
}
</file>

<file path="frontend/components/ReactionButtons.tsx">
'use client';
import React, { useEffect, useState } from 'react';
import { reactionsSummary, myReaction, toggleReaction, ReactionType } from '../lib/api';
import { ThumbsUp, CheckCircle, XCircle } from 'lucide-react';

type Counts = { like: number; agree: number; disagree: number };

interface Props {
  targetId: string;
}

export default function ReactionButtons({ targetId }: Props) {
  const [counts, setCounts] = useState<Counts>({ like: 0, agree: 0, disagree: 0 });
  const [current, setCurrent] = useState<ReactionType | null>(null);
  const [loading, setLoading] = useState(true);
  const [toggling, setToggling] = useState(false);
  const [error, setError] = useState<string | null>(null);

  async function load() {
    if (!targetId) return;
    setLoading(true);
    setError(null);
    try {
      const summary = await reactionsSummary(targetId);
      setCounts(summary);
      const mine = await myReaction(targetId);
      setCurrent(mine.reaction);
    } catch (e: any) {
      setError(e.message);
    } finally {
      setLoading(false);
    }
  }

  async function doToggle(type: ReactionType) {
    if (!targetId || toggling) return;
    setToggling(true);
    try {
      const result = await toggleReaction(targetId, type);
      setCurrent(result.reaction);
      setCounts(result.summary);
    } catch (e: any) {
      setError(e.message);
    } finally {
      setToggling(false);
    }
  }

  useEffect(() => {
    load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [targetId]);

  if (!targetId) return null;

  return (
    <div style={{ display: 'flex', gap: 12, alignItems: 'center', flexWrap: 'wrap' }}>
      {error && <span style={{ color: 'red', fontSize: 12 }}>エラー: {error}</span>}
      {loading && <span style={{ fontSize: 12, color: '#64748b' }}>読み込み中...</span>}
      <ReactionButton
        label="いいね"
        icon={<ThumbsUp size={16} />}
        active={current === 'like'}
        count={counts.like}
        onClick={() => doToggle('like')}
        disabled={toggling}
      />
      <ReactionButton
        label="賛成"
        icon={<CheckCircle size={16} />}
        active={current === 'agree'}
        count={counts.agree}
        onClick={() => doToggle('agree')}
        disabled={toggling}
      />
      <ReactionButton
        label="反対"
        icon={<XCircle size={16} />}
        active={current === 'disagree'}
        count={counts.disagree}
        onClick={() => doToggle('disagree')}
        disabled={toggling}
      />
    </div>
  );
}

function ReactionButton({
  label,
  icon,
  active,
  count,
  onClick,
  disabled,
}: {
  label: string;
  icon: React.ReactNode;
  active: boolean;
  count: number;
  onClick: () => void;
  disabled: boolean;
}) {
  return (
    <button
      onClick={onClick}
      disabled={disabled}
      style={{
        display: 'flex',
        alignItems: 'center',
        gap: 6,
        padding: '6px 10px',
        borderRadius: 6,
        border: active ? '1px solid #2563eb' : '1px solid #cbd5e1',
        background: active ? '#2563eb' : '#fff',
        color: active ? '#fff' : '#0f172a',
        cursor: disabled ? 'not-allowed' : 'pointer',
        fontSize: 13,
        fontWeight: 500,
      }}
    >
      {icon}
      <span>{label}</span>
      <span style={{ fontSize: 12, opacity: 0.8 }}>{count}</span>
    </button>
  );
}
</file>

<file path="frontend/components/RecommendedUsersPanel.tsx">
'use client';

import { useEffect, useState } from 'react';
import { fetchPublicRecommendations, PublicRecommendationUser } from '../lib/api-recommendations';
import FollowButton from './FollowButton';
import { useAuth } from '../contexts/AuthContext';

export default function RecommendedUsersPanel() {
  const [items, setItems] = useState<PublicRecommendationUser[]>([]);
  const [loading, setLoading] = useState(true);
  const { isLoggedIn } = useAuth();

  useEffect(() => {
    let mounted = true;
    (async () => {
      try {
        const data = await fetchPublicRecommendations(8);
        if (mounted) setItems(data);
      } finally {
        if (mounted) setLoading(false);
      }
    })();
    return () => {
      mounted = false;
    };
  }, []);

  return (
    <div className="border rounded p-3 space-y-2 text-sm">
      <div className="font-medium">おすすめユーザー</div>
      {loading && <div className="text-xs text-slate-500">読み込み中...</div>}
      {!loading && items.length === 0 && (
        <div className="text-xs text-slate-500">今は表示できる推薦がありません</div>
      )}
      <ul className="space-y-1">
        {items.map((u) => (
          <li key={u.id} className="flex justify-between items-center">
            <div className="truncate">
              <span>{u.email}</span>
              {u.role && <span className="ml-1 text-xs text-slate-500">({u.role})</span>}
            </div>
            {isLoggedIn && <FollowButton userId={u.id} />}
          </li>
        ))}
      </ul>
    </div>
  );
}
</file>

<file path="frontend/components/ReportModal.tsx">
'use client';

import React, { useState } from 'react';

type Props = {
  targetType: string;
  targetId: number;
  onSubmit(reason: string): Promise<void>;
  onClose(): void;
};

const PRESET_REASONS = [
  { value: 'spam', label: 'スパム / 宣伝' },
  { value: 'abuse', label: '誹謗中傷' },
  { value: 'misinfo', label: '誤情報の可能性' },
  { value: 'other', label: 'その他' }
];

export default function ReportModal({ targetType, targetId, onSubmit, onClose }: Props) {
  const [reason, setReason] = useState('spam');
  const [detail, setDetail] = useState('');
  const [sending, setSending] = useState(false);
  const [err, setErr] = useState<string | null>(null);
  const [done, setDone] = useState(false);

  async function handle(e: React.FormEvent) {
    e.preventDefault();
    setErr(null);
    setDone(false);
    setSending(true);
    try {
      const finalReason = reason === 'other' && detail.trim() ? detail.trim() : reason;
      await onSubmit(finalReason);
      setDone(true);
      setTimeout(() => onClose(), 1000);
    } catch (e: any) {
      setErr(e.message || '通報に失敗しました');
    } finally {
      setSending(false);
    }
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center px-4">
      <div
        className="absolute inset-0 bg-black/40"
        onClick={() => (!sending ? onClose() : null)}
      />
      <form
        onSubmit={handle}
        className="relative z-10 w-full max-w-sm bg-white rounded-xl shadow-lg border border-gray-200 p-5 space-y-4"
      >
        <h3 className="text-sm font-semibold">通報フォーム</h3>
        <p className="text-[11px] text-gray-500">
          対象: {targetType} #{targetId}
        </p>
        <div className="space-y-2">
          <label className="block text-xs font-medium text-gray-700">
            理由の選択
          </label>
          <div className="flex flex-wrap gap-2">
            {PRESET_REASONS.map(r => (
              <button
                key={r.value}
                type="button"
                onClick={() => setReason(r.value)}
                className={
                  'px-2 py-1 rounded border text-[11px] ' +
                  (reason === r.value
                    ? 'bg-blue-600 text-white border-blue-600'
                    : 'border-gray-300 hover:bg-gray-100')
                }
              >
                {r.label}
              </button>
            ))}
          </div>
        </div>
        {reason === 'other' && (
          <textarea
            value={detail}
            onChange={e => setDetail(e.target.value)}
            required
            placeholder="詳細理由を記載してください"
            className="w-full border rounded p-2 text-xs min-h-[80px]"
          />
        )}
        {err && <div className="text-[11px] text-red-600">{err}</div>}
        {done && <div className="text-[11px] text-green-600">通報を送信しました</div>}
        <div className="flex gap-2 justify-end">
          <button
            type="button"
            disabled={sending}
            onClick={onClose}
            className="px-3 py-1 rounded border text-xs hover:bg-gray-100"
          >
            キャンセル
          </button>
          <button
            disabled={sending}
            className="px-3 py-1 rounded bg-red-600 text-white text-xs disabled:opacity-50"
          >
            {sending ? '送信中...' : '通報する'}
          </button>
        </div>
        <p className="text-[10px] text-gray-400">
          ※ 不適切と判断されれば管理者により非表示処理が行われます。
        </p>
      </form>
    </div>
  );
}
</file>

<file path="frontend/components/RightSidebar.tsx">
'use client';
import SearchSidebar from './SearchSidebar';
import RecommendedUsersPanel from './RecommendedUsersPanel';

export default function RightSidebar() {
  return (
    <aside className="space-y-4">
      <SearchSidebar />
      <RecommendedUsersPanel />
    </aside>
  );
}
</file>

<file path="frontend/components/RightSidebarFilters.tsx">
'use client';

import { useRouter, useSearchParams } from 'next/navigation';
import { useState, useEffect } from 'react';

export function RightSidebarFilters() {
  const router = useRouter();
  const params = useSearchParams();

  const [type, setType] = useState<string>(params.get('type') || '');
  const [region, setRegion] = useState<string>(params.get('region') || '');
  const [q, setQ] = useState<string>(params.get('q') || '');

  useEffect(() => {
    setType(params.get('type') || '');
    setRegion(params.get('region') || '');
    setQ(params.get('q') || '');
  }, [params]);

  function apply() {
    const qs = new URLSearchParams();
    if (type) qs.set('type', type);
    if (region) qs.set('region', region);
    if (q) qs.set('q', q);
    router.push(`/feed${qs.toString() ? `?${qs.toString()}` : ''}`);
  }

  return (
    <aside className="bg-white border rounded p-3" aria-label="フィルタ">
      <h2 className="font-semibold mb-2">フィルタ</h2>
      <div className="flex flex-col gap-2">
        <select className="border rounded px-3 py-2" value={type} onChange={(e)=>setType(e.target.value)}>
          <option value="">すべて</option>
          <option value="activity">活動報告</option>
          <option value="pledge">公約</option>
          <option value="question">質問</option>
          <option value="news">ニュース</option>
        </select>
        <input className="border rounded px-3 py-2" placeholder="地域（IDまたは名称）" value={region} onChange={(e)=>setRegion(e.target.value)} />
        <input className="border rounded px-3 py-2" placeholder="キーワード" value={q} onChange={(e)=>setQ(e.target.value)} />
        <button className="rounded bg-gray-800 text-white px-3 py-1" onClick={apply}>適用</button>
      </div>
    </aside>
  );
}

export { RightSidebarFilters }
</file>

<file path="frontend/components/SearchFilterBar.tsx">
'use client';

import { useState } from 'react';

export interface FilterState {
  q?: string;
  category?: 'policy' | 'activity';
  read?: 'all' | 'unread';
}

export default function SearchFilterBar({ onChange }: { onChange: (f: FilterState) => void }) {
  const [q, setQ] = useState('');
  const [category, setCategory] = useState<FilterState['category']>();
  const [read, setRead] = useState<FilterState['read']>('all');

  function apply() {
    onChange({ q: q || undefined, category, read });
  }

  return (
    <div className="flex flex-wrap gap-2 items-center border rounded p-2">
      <input
        className="border px-2 py-1 text-sm"
        placeholder="キーワード"
        value={q}
        onChange={(e) => setQ(e.target.value)}
      />
      <select
        className="border px-2 py-1 text-sm"
        value={category || ''}
        onChange={(e) => setCategory((e.target.value || undefined) as any)}
      >
        <option value="">すべて</option>
        <option value="policy">政策</option>
        <option value="activity">活動</option>
      </select>
      <select className="border px-2 py-1 text-sm" value={read} onChange={(e) => setRead(e.target.value as any)}>
        <option value="all">すべて</option>
        <option value="unread">未読のみ</option>
      </select>
      <button className="border px-3 py-1 text-sm rounded" onClick={apply}>
        検索/適用
      </button>
    </div>
  );
}
</file>

<file path="frontend/components/SearchSidebar.tsx">
'use client';
import { useEffect, useMemo, useState } from 'react';
import { getPrefectureNames, getCitiesByPrefName } from '../lib/geoJP';
import { useRouter, useSearchParams } from 'next/navigation';

const PARTIES = ['自民党', '立憲民主党', '日本維新の会', '公明党', '共産党', '国民民主党', 'れいわ新選組', '社民党', '無所属'];

export default function SearchSidebar() {
  const router = useRouter();
  const sp = useSearchParams();
  const [q, setQ] = useState(sp.get('q') || '');
  const [party, setParty] = useState(sp.get('party') || '');
  const [prefName, setPrefName] = useState(sp.get('pref') || '');
  const [city, setCity] = useState(sp.get('city') || '');

  const [prefNames, setPrefNames] = useState<string[]>([]);
  const [cities, setCities] = useState<string[]>([]);

  useEffect(() => {
    getPrefectureNames().then(setPrefNames).catch(console.error);
  }, []);

  useEffect(() => {
    if (!prefName) { setCities([]); setCity(''); return; }
    getCitiesByPrefName(prefName).then((list) => {
      setCities(list);
      if (!list.includes(city)) setCity('');
    });
  }, [prefName]);

  function submit(e: React.FormEvent) {
    e.preventDefault();
    const params = new URLSearchParams();
    if (q.trim()) params.set('q', q.trim());
    if (party) params.set('party', party);
    if (prefName) params.set('pref', prefName);
    if (city) params.set('city', city);
    router.push(`/search${params.toString() ? `?${params}` : ''}`);
  }

  function reset() {
    setQ(''); setParty(''); setPrefName(''); setCity('');
    router.push('/search');
  }

  return (
    <div className="card space-y-3 sticky top-4">
      <h3 className="font-medium text-sm">検索</h3>
      <form onSubmit={submit} className="space-y-2">
        <input
          className="w-full border rounded px-3 py-2 text-sm"
          placeholder="キーワード（投稿/ユーザー）"
          value={q}
          onChange={(e) => setQ(e.target.value)}
        />
        <select className="w-full border rounded px-3 py-2 text-sm" value={party} onChange={(e) => setParty(e.target.value)}>
          <option value="">政党（任意）</option>
          {PARTIES.map(p => <option key={p} value={p}>{p}</option>)}
        </select>
        <select className="w-full border rounded px-3 py-2 text-sm" value={prefName} onChange={(e) => setPrefName(e.target.value)}>
          <option value="">都道府県（任意）</option>
          {prefNames.map(p => <option key={p} value={p}>{p}</option>)}
        </select>
        <select className="w-full border rounded px-3 py-2 text-sm" value={city} onChange={(e) => setCity(e.target.value)} disabled={!prefName}>
          <option value="">{prefName ? '市区町村（任意）' : '都道府県を先に選択'}</option>
          {cities.map(c => <option key={c} value={c}>{c}</option>)}
        </select>
        <div className="flex gap-2">
          <button className="flex-1 text-sm px-3 py-2 border rounded" type="submit">検索</button>
          <button className="flex-1 text-sm px-3 py-2 border rounded" type="button" onClick={reset}>リセット</button>
        </div>
      </form>
    </div>
  );
}
</file>

<file path="frontend/components/SegmentsPanel.tsx">
'use client';
import { useEffect, useState } from 'react';
import { fetchPostSegments, Segments } from '../lib/api';

export default function SegmentsPanel({ postId, from, to }: { postId: string; from?: string; to?: string }) {
  const [data, setData] = useState<Segments | null>(null);
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  useEffect(() => {
    setLoading(true);
    fetchPostSegments(postId, { from, to })
      .then((d) => setData(d))
      .catch((e) => setErr(e?.response?.data?.message || e.message || '取得に失敗しました'))
      .finally(() => setLoading(false));
  }, [postId, from, to]);

  if (loading) return <div className="text-sm text-slate-600">セグメント読み込み中…</div>;
  if (err) return <div className="text-sm text-red-600">{err}</div>;
  if (!data) return null;

  const renderTable = (obj: Record<string, { support: number; oppose: number; total: number }>) => {
    const entries = Object.entries(obj).sort((a, b) => b[1].total - a[1].total).slice(0, 20);
    return (
      <table className="w-full text-sm border">
        <thead className="bg-slate-50">
          <tr>
            <th className="text-left p-2 border-b">キー</th>
            <th className="text-right p-2 border-b">賛成</th>
            <th className="text-right p-2 border-b">反対</th>
            <th className="text-right p-2 border-b">合計</th>
          </tr>
        </thead>
        <tbody>
          {entries.map(([k, v]) => (
            <tr key={k}>
              <td className="p-2 border-b">{k}</td>
              <td className="p-2 border-b text-right">{v.support}</td>
              <td className="p-2 border-b text-right">{v.oppose}</td>
              <td className="p-2 border-b text-right">{v.total}</td>
            </tr>
          ))}
        </tbody>
      </table>
    );
  };

  return (
    <div className="space-y-4 mt-3">
      <div>
        <h4 className="font-medium mb-1">都道府県別</h4>
        {renderTable(data.byPref)}
      </div>
      <div>
        <h4 className="font-medium mb-1">市区町村別（上位20）</h4>
        {renderTable(data.byCity)}
      </div>
      <div>
        <h4 className="font-medium mb-1">年齢帯別</h4>
        {renderTable(data.byAge)}
      </div>
    </div>
  );
}
</file>

<file path="frontend/components/Sidebar.tsx">
'use client';
import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from '../contexts/AuthContext';
import FollowingPanel from './FollowingPanel';

export default function Sidebar() {
  const { isLoggedIn, isAdmin, isPolitician, logout } = useAuth();
  const [q, setQ] = useState('');
  const router = useRouter();

  return (
    <aside className="space-y-4">
      <nav className="card space-y-2 sticky top-4">
        <div className="text-lg font-semibold">サイト名</div>

        {/* 検索 */}
        <form
          onSubmit={(e) => {
            e.preventDefault();
            const term = q.trim();
            if (!term) return;
            router.push(`/search?q=${encodeURIComponent(term)}`);
          }}
          className="flex gap-2"
        >
          <input
            className="flex-1 border rounded px-3 py-2 text-sm"
            placeholder="検索（投稿/ユーザー）"
            value={q}
            onChange={(e) => setQ(e.target.value)}
          />
          <button className="text-sm px-3 py-2 border rounded">検索</button>
        </form>

        <a className="block px-3 py-2 rounded hover:bg-slate-50" href="/feed">フィード</a>
        {isPolitician && (
          <a className="block px-3 py-2 rounded hover:bg-slate-50" href="/dashboard">ダッシュボード</a>
        )}
        <a className="block px-3 py-2 rounded hover:bg-slate-50" href="/notifications">通知</a>
        <a className="block px-3 py-2 rounded hover:bg-slate-50" href="/profile">プロフィール</a>
        {isAdmin && (
          <a className="block px-3 py-2 rounded hover:bg-slate-50" href="/admin/users">管理</a>
        )}

        {!isLoggedIn && (
          <div className="pt-2 border-t">
            <a className="block px-3 py-2 rounded hover:bg-slate-50" href="/login">ログイン</a>
            <a className="block px-3 py-2 rounded hover:bg-slate-50" href="/register">新規登録</a>
          </div>
        )}

        {isLoggedIn && (
          <button
            className="w-full text-left px-3 py-2 rounded hover:bg-slate-50 border-t"
            onClick={logout}
          >
            ログアウト
          </button>
        )}
      </nav>

      <FollowingPanel />
    </aside>
  );
}
</file>

<file path="frontend/components/Stats.tsx">
'use client';

import { motion } from 'framer-motion';
import { Users, FileText, Activity, DollarSign } from 'lucide-react';

interface StatsProps {
  stats: {
    members: { totalMembers: number; activeMembers: number };
    pledges: { totalPledges: number; completedPledges: number; inProgressPledges: number };
    users: { totalUsers: number; activeUsers: number; adminUsers: number };
    activityLogs: { totalLogs: number; publicLogs: number };
    activityFunds: { totalFunds: number; totalAmount: number; averageAmount: number };
  } | null;
}

export default function Stats({ stats }: StatsProps) {
  if (!stats) {
    return (
      <section className="py-16 bg-white">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
            {[1, 2, 3, 4].map((i) => (
              <div key={i} className="animate-pulse">
                <div className="bg-gray-200 h-20 rounded-lg"></div>
              </div>
            ))}
          </div>
        </div>
      </section>
    );
  }

  const statItems = [
    {
      icon: Users,
      label: '登録議員数',
      value: stats.members.activeMembers,
      color: 'text-blue-600',
      bgColor: 'bg-blue-100',
    },
    {
      icon: FileText,
      label: '公約数',
      value: stats.pledges.totalPledges,
      color: 'text-green-600',
      bgColor: 'bg-green-100',
    },
    {
      icon: Activity,
      label: '活動ログ数',
      value: stats.activityLogs.publicLogs,
      color: 'text-purple-600',
      bgColor: 'bg-purple-100',
    },
    {
      icon: DollarSign,
      label: '政務活動費総額',
      value: `¥${(stats.activityFunds.totalAmount / 1000000).toFixed(1)}M`,
      color: 'text-orange-600',
      bgColor: 'bg-orange-100',
    },
  ];

  return (
    <section className="py-16 bg-white">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          whileInView={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.8 }}
          viewport={{ once: true }}
          className="text-center mb-12"
        >
          <h2 className="text-3xl font-bold text-gray-900 mb-4">
            プラットフォーム統計
          </h2>
          <p className="text-lg text-gray-600">
            現在のプラットフォームの利用状況をご確認ください
          </p>
        </motion.div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
          {statItems.map((item, index) => (
            <motion.div
              key={item.label}
              initial={{ opacity: 0, y: 20 }}
              whileInView={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.8, delay: index * 0.1 }}
              viewport={{ once: true }}
              className="bg-white rounded-xl shadow-lg p-6 border border-gray-100 hover:shadow-xl transition-shadow"
            >
              <div className="flex items-center">
                <div className={`p-3 rounded-lg ${item.bgColor}`}>
                  <item.icon className={`w-6 h-6 ${item.color}`} />
                </div>
                <div className="ml-4">
                  <p className="text-sm font-medium text-gray-600">{item.label}</p>
                  <p className="text-2xl font-bold text-gray-900">{item.value}</p>
                </div>
              </div>
            </motion.div>
          ))}
        </div>

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          whileInView={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.8, delay: 0.4 }}
          viewport={{ once: true }}
          className="mt-12 text-center"
        >
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-4xl mx-auto">
            <div className="bg-gray-50 rounded-lg p-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-2">
                完了済み公約
              </h3>
              <p className="text-3xl font-bold text-green-600">
                {stats.pledges.completedPledges}
              </p>
              <p className="text-sm text-gray-600 mt-1">
                進行中: {stats.pledges.inProgressPledges}
              </p>
            </div>

            <div className="bg-gray-50 rounded-lg p-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-2">
                登録ユーザー数
              </h3>
              <p className="text-3xl font-bold text-blue-600">
                {stats.users.activeUsers}
              </p>
              <p className="text-sm text-gray-600 mt-1">
                管理者: {stats.users.adminUsers}
              </p>
            </div>

            <div className="bg-gray-50 rounded-lg p-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-2">
                平均政務活動費
              </h3>
              <p className="text-3xl font-bold text-orange-600">
                ¥{Math.round(stats.activityFunds.averageAmount).toLocaleString()}
              </p>
              <p className="text-sm text-gray-600 mt-1">
                記録数: {stats.activityFunds.totalFunds}
              </p>
            </div>
          </div>
        </motion.div>
      </div>
    </section>
  );
}
</file>

<file path="frontend/components/SupportOpposeChart.tsx">
'use client';
import { Line } from 'react-chartjs-2';
import { Chart as ChartJS, LineElement, PointElement, CategoryScale, LinearScale, Tooltip, Legend } from 'chart.js';
ChartJS.register(LineElement, PointElement, CategoryScale, LinearScale, Tooltip, Legend);

type Point = { date: string; support: number; oppose: number };

export default function SupportOpposeChart({ points }: { points: Point[] }) {
  const data = {
    labels: points.map(p => p.date),
    datasets: [
      {
        label: '賛成',
        data: points.map(p => p.support),
        borderColor: 'rgb(34,197,94)',
        backgroundColor: 'rgba(34,197,94,0.3)',
        tension: 0.2,
      },
      {
        label: '反対',
        data: points.map(p => p.oppose),
        borderColor: 'rgb(239,68,68)',
        backgroundColor: 'rgba(239,68,68,0.3)',
        tension: 0.2,
      }
    ],
  };
  const options = {
    responsive: true,
    plugins: {
      legend: { position: 'top' as const },
    },
    scales: {
      y: { beginAtZero: true },
    },
  };
  return <Line data={data} options={options} />;
}
</file>

<file path="frontend/components/Timeline.tsx">
'use client';

import { motion } from 'framer-motion';
import { Calendar, ExternalLink, Twitter, Rss, FileText, Globe } from 'lucide-react';
import { format } from 'date-fns';
import { ja } from 'date-fns/locale';
import Link from 'next/link';

interface ActivityLog {
  id: string;
  title: string;
  content: string;
  source: 'manual' | 'twitter' | 'rss' | 'official';
  sourceUrl?: string;
  createdAt: string;
  member?: {
    id: string;
    name: string;
    photoUrl?: string;
  };
}

interface TimelineProps {
  activityLogs: ActivityLog[];
}

export default function Timeline({ activityLogs }: TimelineProps) {
  const getSourceIcon = (source: string) => {
    switch (source) {
      case 'twitter':
        return <Twitter className="w-4 h-4" />;
      case 'rss':
        return <Rss className="w-4 h-4" />;
      case 'official':
        return <Globe className="w-4 h-4" />;
      default:
        return <FileText className="w-4 h-4" />;
    }
  };

  const getSourceColor = (source: string) => {
    switch (source) {
      case 'twitter':
        return 'bg-blue-100 text-blue-600';
      case 'rss':
        return 'bg-orange-100 text-orange-600';
      case 'official':
        return 'bg-green-100 text-green-600';
      default:
        return 'bg-gray-100 text-gray-600';
    }
  };

  const getSourceText = (source: string) => {
    switch (source) {
      case 'twitter':
        return 'Twitter';
      case 'rss':
        return 'RSS';
      case 'official':
        return '公式サイト';
      default:
        return '手動投稿';
    }
  };

  return (
    <section className="py-16 bg-white">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          whileInView={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.8 }}
          viewport={{ once: true }}
          className="text-center mb-12"
        >
          <h2 className="text-3xl font-bold text-gray-900 mb-4">
            最新活動タイムライン
          </h2>
          <p className="text-lg text-gray-600">
            議員の最新の活動情報をリアルタイムで確認できます
          </p>
        </motion.div>

        {activityLogs.length === 0 ? (
          <div className="text-center py-12">
            <Calendar className="w-16 h-16 text-gray-400 mx-auto mb-4" />
            <p className="text-gray-500 text-lg">活動ログはありません</p>
          </div>
        ) : (
          <div className="max-w-4xl mx-auto">
            <div className="space-y-6">
              {activityLogs.map((log, index) => (
                <motion.div
                  key={log.id}
                  initial={{ opacity: 0, x: -20 }}
                  whileInView={{ opacity: 1, x: 0 }}
                  transition={{ duration: 0.8, delay: index * 0.1 }}
                  viewport={{ once: true }}
                  className="bg-white border border-gray-200 rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow"
                >
                  <div className="flex items-start space-x-4">
                    <div className="flex-shrink-0">
                      {log.member?.photoUrl ? (
                        <img
                          src={log.member.photoUrl}
                          alt={log.member.name}
                          className="w-12 h-12 rounded-full object-cover"
                        />
                      ) : (
                        <div className="w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center">
                          <span className="text-gray-600 font-semibold">
                            {log.member?.name?.charAt(0) || '?'}
                          </span>
                        </div>
                      )}
                    </div>

                    <div className="flex-1 min-w-0">
                      <div className="flex items-center space-x-2 mb-2">
                        {log.member ? (
                          <Link href={`/members/${log.member.id}`}>
                            <h3 className="text-lg font-semibold text-gray-900 hover:text-blue-600 transition-colors cursor-pointer">
                              {log.member.name}
                            </h3>
                          </Link>
                        ) : (
                          <h3 className="text-lg font-semibold text-gray-900">
                            不明な議員
                          </h3>
                        )}
                        <span
                          className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getSourceColor(log.source)}`}
                        >
                          {getSourceIcon(log.source)}
                          <span className="ml-1">{getSourceText(log.source)}</span>
                        </span>
                      </div>

                      <h4 className="text-lg font-medium text-gray-900 mb-2">
                        {log.title}
                      </h4>

                      <p className="text-gray-700 mb-4 line-clamp-3">
                        {log.content}
                      </p>

                      <div className="flex items-center justify-between">
                        <div className="flex items-center text-sm text-gray-500">
                          <Calendar className="w-4 h-4 mr-1" />
                          {format(new Date(log.createdAt), 'yyyy年MM月dd日 HH:mm', { locale: ja })}
                        </div>

                        {log.sourceUrl && (
                          <a
                            href={log.sourceUrl}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="inline-flex items-center text-sm text-blue-600 hover:text-blue-800 transition-colors"
                          >
                            <ExternalLink className="w-4 h-4 mr-1" />
                            元の投稿を見る
                          </a>
                        )}
                      </div>
                    </div>
                  </div>
                </motion.div>
              ))}
            </div>

            <motion.div
              initial={{ opacity: 0, y: 20 }}
              whileInView={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.8, delay: 0.4 }}
              viewport={{ once: true }}
              className="text-center mt-12"
            >
              <a
                href="/timeline"
                className="inline-flex items-center bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors"
              >
                すべての活動を見る
                <ExternalLink className="ml-2 w-4 h-4" />
              </a>
            </motion.div>
          </div>
        )}
      </div>
    </section>
  );
}
</file>

<file path="frontend/components/ToastProvider.tsx">
// frontend/components/ToastProvider.tsx

'use client';

import { Toaster } from 'react-hot-toast';

export function ToastProvider() {
  return (
    <Toaster 
      position="top-right" // 画面右上に表示
      reverseOrder={false} 
      toastOptions={{
        success: {
          style: {
            background: '#4CAF50',
            color: '#fff',
          },
        },
        error: {
          style: {
            background: '#F44336',
            color: '#fff',
          },
        },
      }}
    />
  );
}
</file>

<file path="frontend/components/VoteButton.tsx">
'use client';

import { useState } from 'react';
import { useAuth } from '@/contexts/AuthContext';
import { api } from '@/lib/api';
import { ThumbsUp, ThumbsDown, Check } from 'lucide-react';
import toast from 'react-hot-toast';

interface VoteButtonProps {
  pledgeId: string;
  onVoteUpdate: (counts: { support: number; oppose: number; total: number }) => void;
  initialCounts: {
    support: number;
    oppose: number;
    total: number;
  };
}

export default function VoteButton({ pledgeId, onVoteUpdate, initialCounts }: VoteButtonProps) {
  const { user } = useAuth();
  const [currentVote, setCurrentVote] = useState<'support' | 'oppose' | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [hasVoted, setHasVoted] = useState(false);

  const handleVote = async (voteType: 'support' | 'oppose') => {
    if (!user) {
      toast.error('投票するにはログインが必要です');
      return;
    }

    if (isLoading) return;

    setIsLoading(true);

    try {
      let response;
      
      if (currentVote === voteType) {
        // 同じ投票を再度押した場合は投票を取り消し
        response = await api.delete(`/votes/pledge/${pledgeId}`);
        setCurrentVote(null);
        setHasVoted(false);
        toast.success('投票を取り消しました');
      } else if (currentVote) {
        // 既存の投票を変更
        response = await api.patch(`/votes/pledge/${pledgeId}`, { voteType });
        setCurrentVote(voteType);
        toast.success(`投票を${voteType === 'support' ? '賛成' : '反対'}に変更しました`);
      } else {
        // 新しい投票
        response = await api.post('/votes', {
          pledgeId,
          voteType
        });
        setCurrentVote(voteType);
        setHasVoted(true);
        toast.success(`${voteType === 'support' ? '賛成' : '反対'}に投票しました`);
      }

      // 投票結果を更新
      if (response.data) {
        onVoteUpdate({
          support: response.data.supportCount || initialCounts.support,
          oppose: response.data.opposeCount || initialCounts.oppose,
          total: response.data.voteCount || initialCounts.total
        });
      }
    } catch (error: any) {
      console.error('Vote error:', error);
      
      if (error.response?.status === 409) {
        toast.error('この公約には既に投票済みです');
      } else if (error.response?.status === 401) {
        toast.error('ログインが必要です');
      } else {
        toast.error('投票に失敗しました。もう一度お試しください。');
      }
    } finally {
      setIsLoading(false);
    }
  };

  if (!user) {
    return (
      <div className="text-center py-4">
        <p className="text-gray-500 text-sm">投票するにはログインが必要です</p>
      </div>
    );
  }

  return (
    <div className="space-y-3">
      <div className="text-center">
        <p className="text-sm text-gray-600 mb-3">この公約についてどう思いますか？</p>
      </div>
      
      <div className="flex space-x-4">
        {/* Support Button */}
        <button
          onClick={() => handleVote('support')}
          disabled={isLoading}
          className={`flex-1 flex items-center justify-center px-4 py-3 rounded-lg border-2 transition-all duration-200 ${
            currentVote === 'support'
              ? 'border-green-500 bg-green-50 text-green-700'
              : 'border-gray-300 bg-white text-gray-700 hover:border-green-300 hover:bg-green-50'
          } ${isLoading ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
        >
          <ThumbsUp className={`w-5 h-5 mr-2 ${currentVote === 'support' ? 'text-green-600' : 'text-gray-500'}`} />
          <span className="font-medium">賛成</span>
          {currentVote === 'support' && <Check className="w-4 h-4 ml-2 text-green-600" />}
        </button>

        {/* Oppose Button */}
        <button
          onClick={() => handleVote('oppose')}
          disabled={isLoading}
          className={`flex-1 flex items-center justify-center px-4 py-3 rounded-lg border-2 transition-all duration-200 ${
            currentVote === 'oppose'
              ? 'border-red-500 bg-red-50 text-red-700'
              : 'border-gray-300 bg-white text-gray-700 hover:border-red-300 hover:bg-red-50'
          } ${isLoading ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
        >
          <ThumbsDown className={`w-5 h-5 mr-2 ${currentVote === 'oppose' ? 'text-red-600' : 'text-gray-500'}`} />
          <span className="font-medium">反対</span>
          {currentVote === 'oppose' && <Check className="w-4 h-4 ml-2 text-red-600" />}
        </button>
      </div>

      {hasVoted && (
        <div className="text-center">
          <p className="text-sm text-green-600 flex items-center justify-center">
            <Check className="w-4 h-4 mr-1" />
            投票完了
          </p>
        </div>
      )}

      {isLoading && (
        <div className="text-center">
          <div className="inline-flex items-center">
            <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
            <span className="text-sm text-gray-600">処理中...</span>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="frontend/components/VoteButtons.tsx">
'use client';
import { useAuth } from '../contexts/AuthContext';
import { useState } from 'react';
import useSWR from 'swr';
import { fetchVoteStats, getUserVote, castVote, updateVote, VoteType, VoteStats, UserVote } from '../lib/api';

export default function VoteButtons({ postId }: { postId: string }) {
  const { isLoggedIn, isUser } = useAuth();
  const { data: stats, isLoading: statsLoading, mutate: mutateStats } = useSWR<VoteStats>(
    postId ? ['/votes/stats', postId] : null,
    () => fetchVoteStats(postId),
  );
  const { data: myVote, isLoading: voteLoading, mutate: mutateMyVote } = useSWR<UserVote | null>(
    postId ? ['/votes/me', postId] : null,
    () => getUserVote(postId),
  );

  const [pending, setPending] = useState<VoteType | null>(null);

  const disabled = !isLoggedIn || !isUser || !!pending || statsLoading || voteLoading;

  async function onClick(type: VoteType) {
    if (disabled) return;
    setPending(type);
    try {
      if (!myVote) {
        await castVote(postId, type);
      } else if (myVote.type !== type) {
        await updateVote(postId, type);
      } else {
        // 同じボタンを再押下は何もしない（必要なら取消APIを作る）
      }
      await Promise.all([mutateStats(), mutateMyVote()]);
    } catch (e: any) {
      alert(e?.response?.data?.message || e.message || '投票に失敗しました');
    } finally {
      setPending(null);
    }
  }

  return (
    <div className="flex items-center gap-3">
      <div className="flex gap-2">
        <button
          className={`px-3 py-1 text-sm rounded border bg-white hover:bg-slate-50 disabled:opacity-50 ${myVote?.type === 'support' ? 'border-green-600 text-green-700' : ''}`}
          disabled={disabled}
          onClick={() => onClick('support')}
          aria-pressed={myVote?.type === 'support'}
        >
          {pending === 'support' ? '送信中…' : '賛成'}
        </button>
        <button
          className={`px-3 py-1 text-sm rounded border bg-white hover:bg-slate-50 disabled:opacity-50 ${myVote?.type === 'oppose' ? 'border-red-600 text-red-700' : ''}`}
          disabled={disabled}
          onClick={() => onClick('oppose')}
          aria-pressed={myVote?.type === 'oppose'}
        >
          {pending === 'oppose' ? '送信中…' : '反対'}
        </button>
      </div>
      <div className="text-xs text-slate-600">
        {statsLoading ? '集計読み込み中…' : (
          <span>賛成 {stats?.support ?? 0}・反対 {stats?.oppose ?? 0}</span>
        )}
      </div>
      {!isLoggedIn && <span className="text-xs text-slate-500">ログインが必要です</span>}
      {isLoggedIn && !isUser && <span className="text-xs text-slate-500">投票はユーザーのみ</span>}
    </div>
  );
}
</file>

<file path="frontend/contexts/AuthContext.tsx">
'use client';
import { createContext, useContext, useEffect, useState } from 'react';
import { getMe, Me } from '../lib/api';

type Role = 'user' | 'politician' | 'admin';
type User = { id: string; email: string; role: Role };

type AuthContextValue = {
  user: User | null;
  isLoggedIn: boolean;
  isUser: boolean;
  isPolitician: boolean;
  isAdmin: boolean;
  loginWithToken: (token: string) => Promise<void>;
  logout: () => void;
  ready: boolean; // ログイン判定が確定したか
};

const AuthContext = createContext<AuthContextValue | null>(null);

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [ready, setReady] = useState(false);

  async function refresh() {
    const token = typeof window !== 'undefined' ? localStorage.getItem('token') : null;
    if (!token) {
      setUser(null);
      setReady(true);
      return;
    }
    try {
      const me = await getMe();
      setUser(me as Me);
    } catch {
      // トークン不正/期限切れ → 破棄
      localStorage.removeItem('token');
      setUser(null);
    } finally {
      setReady(true);
    }
  }

  useEffect(() => {
    refresh();
  }, []);

  async function loginWithToken(token: string) {
    localStorage.setItem('token', token);
    setReady(false);
    await refresh();
  }

  function logout() {
    localStorage.removeItem('token');
    setUser(null);
  }

  const value: AuthContextValue = {
    user,
    isLoggedIn: !!user,
    isUser: user?.role === 'user',
    isPolitician: user?.role === 'politician',
    isAdmin: user?.role === 'admin',
    loginWithToken,
    logout,
    ready,
  };

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
}

export function useAuth() {
  const ctx = useContext(AuthContext);
  if (!ctx) throw new Error('useAuth must be used within AuthProvider');
  return ctx;
}
</file>

<file path="frontend/lib/hooks/usePosts.ts">
'use client';
/**
 * 投稿一覧取得 + 作成/更新/削除を扱う SWR フック
 */

import useSWR from 'swr';
import { Post, fetchPosts, createPost, updatePost, deletePost } from '../api';

const KEY = 'posts';

export function usePosts() {
  const { data, error, isLoading, mutate } = useSWR<Post[]>(KEY, fetchPosts, {
    revalidateOnFocus: false,
    keepPreviousData: true,
  });

  async function create(input: { title: string; body: string; tags?: string[] }) {
    const newPost = await createPost(input);
    mutate(
      (current) => {
        const list = current || [];
        return [newPost, ...list];
      },
      false,
    );
    mutate(); // 正式再取得
    return newPost;
  }

  async function update(id: string, input: { title?: string; body?: string; tags?: string[] }) {
    const updated = await updatePost(id, input);
    mutate(
      (current) => (current || []).map((p) => (p.id === id ? updated : p)),
      false,
    );
    mutate();
    return updated;
  }

  async function remove(id: string) {
    await deletePost(id);
    mutate(
      (current) => (current || []).filter((p) => p.id !== id),
      false,
    );
    mutate();
  }

  return {
    posts: data || [],
    loading: isLoading,
    error,
    create,
    update,
    remove,
    refresh: () => mutate(),
  };
}
</file>

<file path="frontend/lib/age.ts">
export function calcAgeFromBirthdate(isoDateString: string): number | null {
  // isoDateString: '2001-05-06' など
  try {
    const dob = new Date(isoDateString);
    if (Number.isNaN(dob.getTime())) return null;
    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const m = today.getMonth() - dob.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
      age--;
    }
    return age;
  } catch {
    return null;
  }
}

// 年齢の選択肢（18〜100）
export function ageOptions(min = 18, max = 100): number[] {
  const arr: number[] = [];
  for (let i = min; i <= max; i++) arr.push(i);
  return arr;
}
</file>

<file path="frontend/lib/api-follows.ts">
import api from './api';

export type FollowRecord = {
  followId: string;
  politicianId: string;
  name?: string;
  email?: string;
  createdAt: string;
};

export async function fetchMyFollows(): Promise<FollowRecord[]> {
  const res = await api.get('/follows/my');
  return res.data;
}

export async function followPolitician(politicianId: string) {
  const res = await api.post('/follows', { politicianId });
  return res.data;
}

export async function unfollowPolitician(politicianId: string) {
  const res = await api.delete('/follows', { data: { politicianId } });
  return res.data;
}

export type Recommendation = {
  id: string;
  name?: string;
  email?: string;
  addressPref?: string;
  addressCity?: string;
};

export async function fetchRecommendations(params?: { limit?: number; q?: string }): Promise<Recommendation[]> {
  const q = new URLSearchParams();
  if (params?.limit) q.set('limit', String(params.limit));
  if (params?.q) q.set('q', params.q);
  const res = await api.get(`/follows/recommendations${q.toString() ? `?${q}` : ''}`);
  return res.data;
}
</file>

<file path="frontend/lib/api-media.ts">
export async function uploadMedia(file: File, token: string, category: 'post' | 'comment' | 'kyc' = 'comment') {
  const form = new FormData();
  form.append('file', file);
  form.append('category', category);
  const res = await fetch(`${process.env.NEXT_PUBLIC_API_BASE_URL}/media/upload`, {
    method: 'POST',
    headers: { Authorization: `Bearer ${token}` },
    body: form,
  });
  if (!res.ok) throw new Error(`Upload failed: ${res.status}`);
  return res.json() as Promise<{ mediaId: string; url: string; type: string }>;
}
</file>

<file path="frontend/lib/api-recommendations.ts">
import api, { unwrap } from './api';

export type PublicRecommendationUser = {
  id: string;
  email: string;
  role?: string;
  createdAt?: string;
};

export async function fetchPublicRecommendations(limit = 8): Promise<PublicRecommendationUser[]> {
  try {
    const res = await api.get('/recommendations', { params: { limit } });
    return unwrap<PublicRecommendationUser[]>(res);
  } catch (e: any) {
    // 404 等は空配列で握りつぶし
    if (e?.response?.status === 404) {
      return [];
    }
    throw e;
  }
}
</file>

<file path="frontend/lib/api.analytics-snippet.ts">
import api, { unwrap } from './api';

export interface PostsSummary {
  total: number;
  policy: number;
  activity: number;
}
export interface PostsTimeseriesPoint {
  date: string;
  total: number;
  policy: number;
  activity: number;
}

export async function fetchPostsSummary(): Promise<PostsSummary> {
  const res = await api.get('/analytics/posts/summary');
  return unwrap<PostsSummary>(res);
}

export async function fetchPostsTimeseries(days = 30): Promise<PostsTimeseriesPoint[]> {
  const res = await api.get(`/analytics/posts/timeseries`, { params: { days } });
  return unwrap<PostsTimeseriesPoint[]>(res);
}
</file>

<file path="frontend/lib/api.follows-snippet.ts">
import api, { unwrap } from './api';

export async function followUser(targetUserId: string) {
  const res = await api.post('/follows/follow', { targetUserId });
  return unwrap(res);
}

export async function unfollowUser(targetUserId: string) {
  const res = await api.post('/follows/unfollow', { targetUserId });
  return unwrap(res);
}

export async function fetchFollowedUserIds(): Promise<string[]> {
  const res = await api.get('/follows/followed');
  return unwrap<{ ids: string[] }>(res).ids;
}
</file>

<file path="frontend/lib/api.notifications-admin-snippet.ts">
// ===== 管理: 通知送信 =====
export async function adminSendNotification(input: {
  userId: string;
  type: string;
  title: string;
  text?: string;
  linkUrl?: string;
}) {
  const res = await api.post('/notifications/send', input);
  return unwrap(res);
}

export async function adminBulkSendNotifications(input: {
  userIds: string[];
  type: string;
  title: string;
  text?: string;
  linkUrl?: string;
}) {
  const res = await api.post('/notifications/bulk', input);
  return unwrap(res);
}
</file>

<file path="frontend/lib/api.notifications-snippet.ts">
import api, { unwrap } from './api';

export interface Notification {
  id: string;
  type: string;
  title: string;
  body?: string;
  linkUrl?: string;
  readAt?: string | null;
  createdAt: string;
}

export async function listNotifications(): Promise<Notification[]> {
  const res = await api.get('/notifications');
  return unwrap<Notification[]>(res);
}

export async function markNotificationRead(id: string): Promise<Notification> {
  const res = await api.patch(`/notifications/${id}/read`, {});
  return unwrap<Notification>(res);
}

export async function sendNotification(payload: { userId: string; type: string; title: string; text?: string; linkUrl?: string; email?: string }) {
  const res = await api.post('/notifications/send', payload);
  return unwrap<any>(res);
}

// 互換用: fetchNotifications を使っているページがある可能性に備え、listNotifications のエイリアスを提供します
export async function fetchNotifications(): Promise<Notification[]> {
  return listNotifications();
}
</file>

<file path="frontend/lib/api.posts-edit-snippet.ts">
import api, { unwrap, Post } from './api';

export async function fetchPostById(id: string): Promise<Post> {
  const res = await api.get(`/posts/${id}`);
  return unwrap<Post>(res);
}
</file>

<file path="frontend/lib/api.posts-manage-snippet.ts">
import api, { unwrap } from './api';
import type { Post } from './api';

export async function softDeletePost(id: string): Promise<Post> {
  const res = await api.patch(`/posts/${id}/delete`, {});
  return unwrap<Post>(res);
}

export async function restorePost(id: string): Promise<Post> {
  const res = await api.patch(`/posts/${id}/restore`, {});
  return unwrap<Post>(res);
}
</file>

<file path="frontend/lib/api.reports.ts">
const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001/api';

export type Report = {
  id: number;
  reporterId: number;
  targetType: string;
  targetId: number;
  reason: string;
  status: string;        // open | resolved など
  adminAction: string | null; // hide | ignore 等
  createdAt: string;
};

export async function createReport(targetType: string, targetId: number, reason: string) {
  try {
    const res = await fetch(`${API_BASE}/reports`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ targetType, targetId, reason })
    });
    if (!res.ok) {
      let msg = 'Report failed';
      try {
        const detail = await res.json();
        if (detail?.message) msg = detail.message;
      } catch {}
      throw new Error(msg);
    }
    return res.json() as Promise<Report>;
  } catch (e: any) {
    throw new Error(e.message || 'Report error');
  }
}

// 管理者一覧
export async function fetchAdminReports(): Promise<Report[]> {
  try {
    const res = await fetch(`${API_BASE}/reports/admin`, { cache: 'no-store' });
    if (!res.ok) {
      throw new Error(`Failed to fetch reports: ${res.status}`);
    }
    return res.json();
  } catch (e) {
    console.error(e);
    return [];
  }
}

// 管理者アクション (hide | ignore など)
export async function adminReportAction(id: number, action: string): Promise<boolean> {
  try {
    const res = await fetch(`${API_BASE}/reports/admin/${id}/${action}`, {
      method: 'POST'
    });
    return res.ok;
  } catch (e) {
    console.error(e);
    return false;
  }
}
</file>

<file path="frontend/lib/auth.ts">
export function getToken() {
  // JWT を cookie から取得する想定（必要なら cookie-parse などに変更）
  const m = document.cookie.match(/token=([^;]+)/);
  return m ? decodeURIComponent(m[1]) : null;
}

export function setToken(token: string) {
  document.cookie = `token=${encodeURIComponent(token)}; path=/; max-age=${60 * 60 * 24 * 7}`;
}

export function clearToken() {
  document.cookie = 'token=; path=/; max-age=0';
}
</file>

<file path="frontend/lib/firebase.ts">
import { initializeApp, type FirebaseApp } from 'firebase/app';
import { getAuth, type Auth } from 'firebase/auth';

// Read config from env
const firebaseConfig = {
  apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
  authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
  projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
  storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
  messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
  appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID,
};

function hasValidConfig(): boolean {
  // Check if critical fields are present
  return !!(
    firebaseConfig.apiKey &&
    firebaseConfig.authDomain &&
    firebaseConfig.projectId &&
    firebaseConfig.appId
  );
}

let app: FirebaseApp | null = null;
let auth: Auth | null = null;
let isFirebaseEnabled = false;

try {
  const enableFirebase = process.env.NEXT_PUBLIC_ENABLE_FIREBASE_AUTH === 'true';
  
  if (enableFirebase && hasValidConfig()) {
    // Ensure all config values are strings (not undefined)
    const config = {
      apiKey: firebaseConfig.apiKey as string,
      authDomain: firebaseConfig.authDomain as string,
      projectId: firebaseConfig.projectId as string,
      storageBucket: firebaseConfig.storageBucket || `${firebaseConfig.projectId}.appspot.com`,
      messagingSenderId: firebaseConfig.messagingSenderId as string,
      appId: firebaseConfig.appId as string,
    };
    
    console.log('Initializing Firebase with config:', {
      apiKey: config.apiKey?.substring(0, 10) + '...',
      authDomain: config.authDomain,
      projectId: config.projectId,
      appId: config.appId,
    });
    
    app = initializeApp(config);
    auth = getAuth(app);
    isFirebaseEnabled = true;
    console.log('✅ Firebase initialized successfully');
  } else {
    console.warn('⚠️ Firebase not initialized:', {
      enableFirebase,
      hasValidConfig: hasValidConfig(),
      envVars: {
        apiKey: !!firebaseConfig.apiKey,
        authDomain: !!firebaseConfig.authDomain,
        projectId: !!firebaseConfig.projectId,
        appId: !!firebaseConfig.appId,
      },
    });
  }
} catch (error: any) {
  console.error('❌ Firebase initialization failed:', error);
  console.error('Error details:', {
    code: error.code,
    message: error.message,
  });
  app = null;
  auth = null;
  isFirebaseEnabled = false;
}

export { auth, isFirebaseEnabled };
export default app;
</file>

<file path="frontend/lib/geoJP.ts">
export type Prefecture = { code: string; name: string; cities: string[] };

let cache: Prefecture[] | null = null;

export async function loadPrefCityData(): Promise<Prefecture[]> {
  if (cache) return cache;
  const res = await fetch('/geo/jp-pref-cities.json', { cache: 'force-cache' });
  if (!res.ok) throw new Error('Failed to load prefecture data');
  cache = (await res.json()) as Prefecture[];
  return cache!;
}

export async function getPrefectureNames(): Promise<string[]> {
  const list = await loadPrefCityData();
  return list.map((p) => p.name);
}

export async function getCitiesByPrefName(prefName: string): Promise<string[]> {
  const list = await loadPrefCityData();
  const pref = list.find((p) => p.name === prefName);
  return pref ? pref.cities : [];
}
</file>

<file path="frontend/lib/japanLocation.ts">
// japanLocation.ts - named exports only (ensure exact filename and path)
// Provide prefectures and minimal city lists. Extend as needed.

export type Prefecture = { name: string; code: string };
export type City = { name: string; code: string };

export const PREFECTURES: Prefecture[] = [
  { name: '北海道', code: '01' },
  { name: '青森県', code: '02' },
  { name: '岩手県', code: '03' },
  { name: '宮城県', code: '04' },
  { name: '秋田県', code: '05' },
  { name: '山形県', code: '06' },
  { name: '福島県', code: '07' },
  { name: '茨城県', code: '08' },
  { name: '栃木県', code: '09' },
  { name: '群馬県', code: '10' },
  { name: '埼玉県', code: '11' },
  { name: '千葉県', code: '12' },
  { name: '東京都', code: '13' },
  { name: '神奈川県', code: '14' },
  { name: '新潟県', code: '15' },
  { name: '富山県', code: '16' },
  { name: '石川県', code: '17' },
  { name: '福井県', code: '18' },
  { name: '山梨県', code: '19' },
  { name: '長野県', code: '20' },
  { name: '岐阜県', code: '21' },
  { name: '静岡県', code: '22' },
  { name: '愛知県', code: '23' },
  { name: '三重県', code: '24' },
  { name: '滋賀県', code: '25' },
  { name: '京都府', code: '26' },
  { name: '大阪府', code: '27' },
  { name: '兵庫県', code: '28' },
  { name: '奈良県', code: '29' },
  { name: '和歌山県', code: '30' },
  { name: '鳥取県', code: '31' },
  { name: '島根県', code: '32' },
  { name: '岡山県', code: '33' },
  { name: '広島県', code: '34' },
  { name: '山口県', code: '35' },
  { name: '徳島県', code: '36' },
  { name: '香川県', code: '37' },
  { name: '愛媛県', code: '38' },
  { name: '高知県', code: '39' },
  { name: '福岡県', code: '40' },
  { name: '佐賀県', code: '41' },
  { name: '長崎県', code: '42' },
  { name: '熊本県', code: '43' },
  { name: '大分県', code: '44' },
  { name: '宮崎県', code: '45' },
  { name: '鹿児島県', code: '46' },
  { name: '沖縄県', code: '47' }
];

export const CITIES_BY_PREF: Record<string, string[]> = {
  '北海道': ['札幌市', '函館市', '小樽市', '旭川市', '室蘭市', '釧路市', '帯広市', '北見市', '夕張市', '岩見沢市', '網走市', '留萌市', '苫小牧市', '稚内市', '美唄市', '芦別市', '江別市', '赤平市', '紋別市', '士別市', '名寄市', '三笠市', '根室市', '千歳市', '滝川市', '砂川市', '歌志内市', '深川市', '富良野市', '登別市', '恵庭市', '伊達市', '北広島市', '石狩市', '北斗市', '当別町', '新篠津村', '松前町', '福島町', '知内町', '木古内町', '七飯町', '鹿部町', '森町', '八雲町', '長万部町', '江差町', '上ノ国町', '厚沢部町', '乙部町', '奥尻町', '今金町', 'せたな町', '島牧村', '寿都町', '黒松内町', '蘭越町', 'ニセコ町', '真狩村', '留寿都村', '喜茂別町', '京極町', '倶知安町', '共和町', '岩内町', '泊村', '神恵内村', '積丹町', '古平町', '仁木町', '余市町', '赤井川村', '南幌町', '奈井江町', '上砂川町', '由仁町', '長沼町', '栗山町', '月形町', '浦臼町', '新十津川町', '妹背牛町', '秩父別町', '雨竜町', '北竜町', '沼田町', '鷹栖町', '東神楽町', '当麻町', '比布町', '愛別町', '上川町', '東川町', '美瑛町', '上富良野町', '中富良野町', '南富良野町', '占冠村', '和寒町', '剣淵町', '下川町', '美深町', '音威子府村', '中川町', '幌加内町', '増毛町', '小平町', '苫前町', '羽幌町', '初山別村', '遠別町', '天塩町', '猿払村', '浜頓別町', '中頓別町', '枝幸町', '豊富町', '礼文町', '利尻町', '利尻富士町', '幌延町', '美幌町', '津別町', '斜里町', '清里町', '小清水町', '訓子府町', '置戸町', '佐呂間町', '遠軽町', '湧別町', '滝上町', '興部町', '西興部村', '雄武町', '大空町', '豊浦町', '壮瞥町', '白老町', '厚真町', '洞爺湖町', '安平町', 'むかわ町', '日高町', '平取町', '新冠町', '浦河町', '様似町', 'えりも町', '新ひだか町', '音更町', '士幌町', '上士幌町', '鹿追町', '新得町', '清水町', '芽室町', '中札内村', '更別村', '大樹町', '広尾町', '幕別町', '池田町', '豊頃町', '本別町', '足寄町', '陸別町', '浦幌町', '釧路町', '厚岸町', '浜中町', '標茶町', '弟子屈町', '鶴居村', '白糠町', '別海町', '中標津町', '標津町', '羅臼町', '色丹村', '泊村', '留夜別村', '留別村', '紗那村', '蘂取村'],
  '青森県': ['青森市', '弘前市', '八戸市', '黒石市', '五所川原市', '十和田市', '三沢市', 'むつ市', 'つがる市', '平川市', '平内町', '今別町', '蓬田村', '外ヶ浜町', '鰺ヶ沢町', '深浦町', '西目屋村', '藤崎町', '大鰐町', '田舎館村', '板柳町', '鶴田町', '中泊町', '野辺地町', '七戸町', '六戸町', '横浜町', '東北町', '六ヶ所村', 'おいらせ町', '大間町', '東通村', '風間浦村', '佐井村', '三戸町', '五戸町', '田子町', '南部町', '階上町', '新郷村'],
  '岩手県': ['盛岡市', '宮古市', '大船渡市', '花巻市', '北上市', '久慈市', '遠野市', '一関市', '陸前高田市', '釜石市', '二戸市', '八幡平市', '奥州市', '滝沢市', '雫石町', '葛巻町', '岩手町', '紫波町', '矢巾町', '西和賀町', '金ケ崎町', '平泉町', '住田町', '大槌町', '山田町', '岩泉町', '田野畑村', '普代村', '軽米町', '野田村', '九戸村', '洋野町', '一戸町'],
  '宮城県': ['仙台市', '石巻市', '塩竈市', '気仙沼市', '白石市', '名取市', '角田市', '多賀城市', '岩沼市', '登米市', '栗原市', '東松島市', '大崎市', '富谷市', '蔵王町', '七ヶ宿町', '大河原町', '村田町', '柴田町', '川崎町', '丸森町', '亘理町', '山元町', '松島町', '七ヶ浜町', '利府町', '大和町', '大郷町', '大衡村', '色麻町', '加美町', '涌谷町', '美里町', '女川町', '南三陸町'],
  '秋田県': ['秋田市', '能代市', '横手市', '大館市', '男鹿市', '湯沢市', '鹿角市', '由利本荘市', '潟上市', '大仙市', '北秋田市', 'にかほ市', '仙北市', '小坂町', '上小阿仁村', '藤里町', '三種町', '八峰町', '五城目町', '八郎潟町', '井川町', '大潟村', '美郷町', '羽後町', '東成瀬村'],
  '山形県': ['山形市', '米沢市', '鶴岡市', '酒田市', '新庄市', '寒河江市', '上山市', '村山市', '長井市', '天童市', '東根市', '尾花沢市', '南陽市', '山辺町', '中山町', '河北町', '西川町', '朝日町', '大江町', '大石田町', '金山町', '最上町', '舟形町', '真室川町', '大蔵村', '鮭川村', '戸沢村', '高畠町', '川西町', '小国町', '白鷹町', '飯豊町', '三川町', '庄内町', '遊佐町'],
  '福島県': ['福島市', '会津若松市', '郡山市', 'いわき市', '白河市', '須賀川市', '喜多方市', '相馬市', '二本松市', '田村市', '南相馬市', '伊達市', '本宮市', '桑折町', '国見町', '川俣町', '大玉村', '鏡石町', '天栄村', '下郷町', '檜枝岐村', '只見町', '南会津町', '北塩原村', '西会津町', '磐梯町', '猪苗代町', '会津坂下町', '湯川村', '柳津町', '三島町', '金山町', '昭和村', '会津美里町', '西郷村', '泉崎村', '中島村', '矢吹町', '棚倉町', '矢祭町', '塙町', '鮫川村', '石川町', '玉川村', '平田村', '浅川町', '古殿町', '三春町', '小野町', '広野町', '楢葉町', '富岡町', '川内村', '大熊町', '双葉町', '浪江町', '葛尾村', '新地町', '飯舘村'],
  '茨城県': ['水戸市', '日立市', '土浦市', '古河市', '石岡市', '結城市', '龍ケ崎市', '下妻市', '常総市', '常陸太田市', '高萩市', '北茨城市', '笠間市', '取手市', '牛久市', 'つくば市', 'ひたちなか市', '鹿嶋市', '潮来市', '守谷市', '常陸大宮市', '那珂市', '筑西市', '坂東市', '稲敷市', 'かすみがうら市', '桜川市', '神栖市', '行方市', '鉾田市', 'つくばみらい市', '小美玉市', '茨城町', '大洗町', '城里町', '東海村', '大子町', '美浦村', '阿見町', '河内町', '八千代町', '五霞町', '境町', '利根町'],
  '栃木県': ['宇都宮市', '足利市', '栃木市', '佐野市', '鹿沼市', '日光市', '小山市', '真岡市', '大田原市', '矢板市', '那須塩原市', 'さくら市', '那須烏山市', '下野市', '上三川町', '益子町', '茂木町', '市貝町', '芳賀町', '壬生町', '野木町', '塩谷町', '高根沢町', '那須町', '那珂川町'],
  '群馬県': ['前橋市', '高崎市', '桐生市', '伊勢崎市', '太田市', '沼田市', '館林市', '渋川市', '藤岡市', '富岡市', '安中市', 'みどり市', '榛東村', '吉岡町', '上野村', '神流町', '下仁田町', '南牧村', '甘楽町', '中之条町', '長野原町', '嬬恋村', '草津町', '高山村', '東吾妻町', '片品村', '川場村', '昭和村', 'みなかみ町', '玉村町', '板倉町', '明和町', '千代田町', '大泉町', '邑楽町'],
  '埼玉県': ['さいたま市', '川越市', '熊谷市', '川口市', '行田市', '秩父市', '所沢市', '飯能市', '加須市', '本庄市', '東松山市', '春日部市', '狭山市', '羽生市', '鴻巣市', '深谷市', '上尾市', '草加市', '越谷市', '蕨市', '戸田市', '入間市', '朝霞市', '志木市', '和光市', '新座市', '桶川市', '久喜市', '北本市', '八潮市', '富士見市', '三郷市', '蓮田市', '坂戸市', '幸手市', '鶴ヶ島市', '日高市', '吉川市', 'ふじみ野市', '白岡市', '伊奈町', '三芳町', '毛呂山町', '越生町', '滑川町', '嵐山町', '小川町', '川島町', '吉見町', '鳩山町', 'ときがわ町', '横瀬町', '皆野町', '長瀞町', '小鹿野町', '東秩父村', '美里町', '神川町', '上里町', '寄居町', '宮代町', '杉戸町', '松伏町'],
  '千葉県': ['千葉市', '銚子市', '市川市', '船橋市', '館山市', '木更津市', '松戸市', '野田市', '茂原市', '成田市', '佐倉市', '東金市', '旭市', '習志野市', '柏市', '勝浦市', '市原市', '流山市', '八千代市', '我孫子市', '鴨川市', '鎌ケ谷市', '君津市', '富津市', '浦安市', '四街道市', '袖ケ浦市', '八街市', '印西市', '白井市', '富里市', '南房総市', '匝瑳市', '香取市', '山武市', 'いすみ市', '大網白里市', '酒々井町', '栄町', '神崎町', '多古町', '東庄町', '九十九里町', '芝山町', '横芝光町', '一宮町', '睦沢町', '長生村', '白子町', '長柄町', '長南町', '大多喜町', '御宿町', '鋸南町'],
  '東京都': ['千代田区', '中央区', '港区', '新宿区', '文京区', '台東区', '墨田区', '江東区', '品川区', '目黒区', '大田区', '世田谷区', '渋谷区', '中野区', '杉並区', '豊島区', '北区', '荒川区', '板橋区', '練馬区', '足立区', '葛飾区', '江戸川区', '八王子市', '立川市', '武蔵野市', '三鷹市', '青梅市', '府中市', '昭島市', '調布市', '町田市', '小金井市', '小平市', '日野市', '東村山市', '国分寺市', '国立市', '福生市', '狛江市', '東大和市', '清瀬市', '東久留米市', '武蔵村山市', '多摩市', '稲城市', '羽村市', 'あきる野市', '西東京市', '瑞穂町', '日の出町', '檜原村', '奥多摩町', '大島町', '利島村', '新島村', '神津島村', '三宅村', '御蔵島村', '八丈町', '青ヶ島村', '小笠原村'],
  '神奈川県': ['横浜市', '川崎市', '相模原市', '横須賀市', '平塚市', '鎌倉市', '藤沢市', '小田原市', '茅ヶ崎市', '逗子市', '三浦市', '秦野市', '厚木市', '大和市', '伊勢原市', '海老名市', '座間市', '南足柄市', '綾瀬市', '葉山町', '寒川町', '大磯町', '二宮町', '中井町', '大井町', '松田町', '山北町', '開成町', '箱根町', '真鶴町', '湯河原町', '愛川町', '清川村'],
  '新潟県': ['新潟市', '長岡市', '三条市', '柏崎市', '新発田市', '小千谷市', '加茂市', '十日町市', '見附市', '村上市', '燕市', '糸魚川市', '妙高市', '五泉市', '上越市', '阿賀野市', '佐渡市', '魚沼市', '南魚沼市', '胎内市', '聖籠町', '弥彦村', '田上町', '阿賀町', '出雲崎町', '湯沢町', '津南町', '刈羽村', '関川村', '粟島浦村'],
  '富山県': ['富山市', '高岡市', '魚津市', '氷見市', '滑川市', '黒部市', '砺波市', '小矢部市', '南砺市', '射水市', '舟橋村', '上市町', '立山町', '入善町', '朝日町'],
  '石川県': ['金沢市', '七尾市', '小松市', '輪島市', '珠洲市', '加賀市', '羽咋市', 'かほく市', '白山市', '能美市', '野々市市', '川北町', '津幡町', '内灘町', '志賀町', '宝達志水町', '中能登町', '穴水町', '能登町'],
  '福井県': ['福井市', '敦賀市', '小浜市', '大野市', '勝山市', '鯖江市', 'あわら市', '越前市', '坂井市', '永平寺町', '池田町', '南越前町', '越前町', '美浜町', '高浜町', 'おおい町', '若狭町'],
  '山梨県': ['甲府市', '富士吉田市', '都留市', '山梨市', '大月市', '韮崎市', '南アルプス市', '北杜市', '甲斐市', '笛吹市', '上野原市', '甲州市', '中央市', '市川三郷町', '早川町', '身延町', '南部町', '富士川町', '昭和町', '道志村', '西桂町', '忍野村', '山中湖村', '鳴沢村', '富士河口湖町', '小菅村', '丹波山村'],
  '長野県': ['長野市', '松本市', '上田市', '岡谷市', '飯田市', '諏訪市', '須坂市', '小諸市', '伊那市', '駒ヶ根市', '中野市', '大町市', '飯山市', '茅野市', '塩尻市', '佐久市', '千曲市', '東御市', '安曇野市', '小海町', '川上村', '南牧村', '南相木村', '北相木村', '佐久穂町', '軽井沢町', '御代田町', '立科町', '青木村', '長和町', '下諏訪町', '富士見町', '原村', '辰野町', '箕輪町', '飯島町', '南箕輪村', '中川村', '宮田村', '松川町', '高森町', '阿南町', '阿智村', '平谷村', '根羽村', '下條村', '売木村', '天龍村', '泰阜村', '喬木村', '豊丘村', '大鹿村', '上松町', '南木曽町', '木祖村', '王滝村', '大桑村', '木曽町', '麻績村', '生坂村', '山形村', '朝日村', '筑北村', '池田町', '松川村', '白馬村', '小谷村', '坂城町', '小布施町', '高山村', '山ノ内町', '木島平村', '野沢温泉村', '信濃町', '小川村', '飯綱町', '栄村'],
  '岐阜県': ['岐阜市', '大垣市', '高山市', '多治見市', '関市', '中津川市', '美濃市', '瑞浪市', '羽島市', '恵那市', '美濃加茂市', '土岐市', '各務原市', '可児市', '山県市', '瑞穂市', '飛騨市', '本巣市', '郡上市', '下呂市', '海津市', '岐南町', '笠松町', '養老町', '垂井町', '関ケ原町', '神戸町', '輪之内町', '安八町', '揖斐川町', '大野町', '池田町', '北方町', '坂祝町', '富加町', '川辺町', '七宗町', '八百津町', '白川町', '東白川村', '御嵩町', '白川村'],
  '静岡県': ['静岡市', '浜松市', '沼津市', '熱海市', '三島市', '富士宮市', '伊東市', '島田市', '富士市', '磐田市', '焼津市', '掛川市', '藤枝市', '御殿場市', '袋井市', '下田市', '裾野市', '湖西市', '伊豆市', '御前崎市', '菊川市', '伊豆の国市', '牧之原市', '東伊豆町', '河津町', '南伊豆町', '松崎町', '西伊豆町', '函南町', '清水町', '長泉町', '小山町', '吉田町', '川根本町', '森町'],
  '愛知県': ['名古屋市', '豊橋市', '岡崎市', '一宮市', '瀬戸市', '半田市', '春日井市', '豊川市', '津島市', '碧南市', '刈谷市', '豊田市', '安城市', '西尾市', '蒲郡市', '犬山市', '常滑市', '江南市', '小牧市', '稲沢市', '新城市', '東海市', '大府市', '知多市', '知立市', '尾張旭市', '高浜市', '岩倉市', '豊明市', '日進市', '田原市', '愛西市', '清須市', '北名古屋市', '弥富市', 'みよし市', 'あま市', '長久手市', '東郷町', '豊山町', '大口町', '扶桑町', '大治町', '蟹江町', '飛島村', '阿久比町', '東浦町', '南知多町', '美浜町', '武豊町', '幸田町', '設楽町', '東栄町', '豊根村'],
  '三重県': ['津市', '四日市市', '伊勢市', '松阪市', '桑名市', '鈴鹿市', '名張市', '尾鷲市', '亀山市', '鳥羽市', '熊野市', 'いなべ市', '志摩市', '伊賀市', '木曽岬町', '東員町', '菰野町', '朝日町', '川越町', '多気町', '明和町', '大台町', '玉城町', '度会町', '大紀町', '南伊勢町', '紀北町', '御浜町', '紀宝町'],
  '滋賀県': ['大津市', '彦根市', '長浜市', '近江八幡市', '草津市', '守山市', '栗東市', '甲賀市', '野洲市', '湖南市', '高島市', '東近江市', '米原市', '日野町', '竜王町', '愛荘町', '豊郷町', '甲良町', '多賀町'],
  '京都府': ['京都市', '福知山市', '舞鶴市', '綾部市', '宇治市', '宮津市', '亀岡市', '城陽市', '向日市', '長岡京市', '八幡市', '京田辺市', '京丹後市', '南丹市', '木津川市', '大山崎町', '久御山町', '井手町', '宇治田原町', '笠置町', '和束町', '精華町', '南山城村', '京丹波町', '伊根町', '与謝野町'],
  '大阪府': ['大阪市', '堺市', '岸和田市', '豊中市', '池田市', '吹田市', '泉大津市', '高槻市', '貝塚市', '守口市', '枚方市', '茨木市', '八尾市', '泉佐野市', '富田林市', '寝屋川市', '河内長野市', '松原市', '大東市', '和泉市', '箕面市', '柏原市', '羽曳野市', '門真市', '摂津市', '高石市', '藤井寺市', '東大阪市', '泉南市', '四條畷市', '交野市', '大阪狭山市', '阪南市', '島本町', '豊能町', '能勢町', '忠岡町', '熊取町', '田尻町', '岬町', '太子町', '河南町', '千早赤阪村'],
  '兵庫県': ['神戸市', '姫路市', '尼崎市', '明石市', '西宮市', '洲本市', '芦屋市', '伊丹市', '相生市', '豊岡市', '加古川市', '赤穂市', '西脇市', '宝塚市', '三木市', '高砂市', '川西市', '小野市', '三田市', '加西市', '丹波篠山市', '養父市', '丹波市', '南あわじ市', '朝来市', '淡路市', '宍粟市', '加東市', 'たつの市', '猪名川町', '多可町', '稲美町', '播磨町', '市川町', '福崎町', '神河町', '太子町', '上郡町', '佐用町', '香美町', '新温泉町'],
  '奈良県': ['奈良市', '大和高田市', '大和郡山市', '天理市', '橿原市', '桜井市', '五條市', '御所市', '生駒市', '香芝市', '葛城市', '宇陀市', '山添村', '平群町', '三郷町', '斑鳩町', '安堵町', '川西町', '三宅町', '田原本町', '曽爾村', '御杖村', '高取町', '明日香村', '上牧町', '王寺町', '広陵町', '河合町', '吉野町', '大淀町', '下市町', '黒滝村', '天川村', '野迫川村', '十津川村', '下北山村', '上北山村', '川上村', '東吉野村'],
  '和歌山県': ['和歌山市', '海南市', '橋本市', '有田市', '御坊市', '田辺市', '新宮市', '紀の川市', '岩出市', '紀美野町', 'かつらぎ町', '九度山町', '高野町', '湯浅町', '広川町', '有田川町', '美浜町', '日高町', '由良町', '印南町', 'みなべ町', '日高川町', '白浜町', '上富田町', 'すさみ町', '那智勝浦町', '太地町', '古座川町', '北山村', '串本町'],
  '鳥取県': ['鳥取市', '米子市', '倉吉市', '境港市', '岩美町', '若桜町', '智頭町', '八頭町', '三朝町', '湯梨浜町', '琴浦町', '北栄町', '日吉津村', '大山町', '南部町', '伯耆町', '日南町', '日野町', '江府町'],
  '島根県': ['松江市', '浜田市', '出雲市', '益田市', '大田市', '安来市', '江津市', '雲南市', '奥出雲町', '飯南町', '川本町', '美郷町', '邑南町', '津和野町', '吉賀町', '海士町', '西ノ島町', '知夫村', '隠岐の島町'],
  '岡山県': ['岡山市', '倉敷市', '津山市', '玉野市', '笠岡市', '井原市', '総社市', '高梁市', '新見市', '備前市', '瀬戸内市', '赤磐市', '真庭市', '美作市', '浅口市', '和気町', '早島町', '里庄町', '矢掛町', '新庄村', '鏡野町', '勝央町', '奈義町', '西粟倉村', '久米南町', '美咲町', '吉備中央町'],
  '広島県': ['広島市', '呉市', '竹原市', '三原市', '尾道市', '福山市', '府中市', '三次市', '庄原市', '大竹市', '東広島市', '廿日市市', '安芸高田市', '江田島市', '府中町', '海田町', '熊野町', '坂町', '安芸太田町', '北広島町', '大崎上島町', '世羅町', '神石高原町'],
  '山口県': ['下関市', '宇部市', '山口市', '萩市', '防府市', '下松市', '岩国市', '光市', '長門市', '柳井市', '美祢市', '周南市', '山陽小野田市', '周防大島町', '和木町', '上関町', '田布施町', '平生町', '阿武町'],
  '徳島県': ['徳島市', '鳴門市', '小松島市', '阿南市', '吉野川市', '阿波市', '美馬市', '三好市', '勝浦町', '上勝町', '佐那河内村', '石井町', '神山町', '那賀町', '牟岐町', '美波町', '海陽町', '松茂町', '北島町', '藍住町', '板野町', '上板町', 'つるぎ町', '東みよし町'],
  '香川県': ['高松市', '丸亀市', '坂出市', '善通寺市', '観音寺市', 'さぬき市', '東かがわ市', '三豊市', '土庄町', '小豆島町', '三木町', '直島町', '宇多津町', '綾川町', '琴平町', '多度津町', 'まんのう町'],
  '愛媛県': ['松山市', '今治市', '宇和島市', '八幡浜市', '新居浜市', '西条市', '大洲市', '伊予市', '四国中央市', '西予市', '東温市', '上島町', '久万高原町', '松前町', '砥部町', '内子町', '伊方町', '松野町', '鬼北町', '愛南町'],
  '高知県': ['高知市', '室戸市', '安芸市', '南国市', '土佐市', '須崎市', '宿毛市', '土佐清水市', '四万十市', '香南市', '香美市', '東洋町', '奈半利町', '田野町', '安田町', '北川村', '馬路村', '芸西村', '本山町', '大豊町', '土佐町', '大川村', 'いの町', '仁淀川町', '中土佐町', '佐川町', '越知町', '梼原町', '日高村', '津野町', '四万十町', '大月町', '三原村', '黒潮町'],
  '福岡県': ['北九州市', '福岡市', '大牟田市', '久留米市', '直方市', '飯塚市', '田川市', '柳川市', '八女市', '筑後市', '大川市', '行橋市', '豊前市', '中間市', '小郡市', '筑紫野市', '春日市', '大野城市', '宗像市', '太宰府市', '古賀市', '福津市', 'うきは市', '宮若市', '嘉麻市', '朝倉市', 'みやま市', '糸島市', '那珂川市', '宇美町', '篠栗町', '志免町', '須恵町', '新宮町', '久山町', '粕屋町', '芦屋町', '水巻町', '岡垣町', '遠賀町', '小竹町', '鞍手町', '桂川町', '筑前町', '東峰村', '大刀洗町', '大木町', '広川町', '香春町', '添田町', '糸田町', '川崎町', '大任町', '赤村', '福智町', '苅田町', 'みやこ町', '吉富町', '上毛町', '築上町'],
  '佐賀県': ['佐賀市', '唐津市', '鳥栖市', '多久市', '伊万里市', '武雄市', '鹿島市', '小城市', '嬉野市', '神埼市', '吉野ヶ里町', '基山町', '上峰町', 'みやき町', '玄海町', '有田町', '大町町', '江北町', '白石町', '太良町'],
  '長崎県': ['長崎市', '佐世保市', '島原市', '諫早市', '大村市', '平戸市', '松浦市', '対馬市', '壱岐市', '五島市', '西海市', '雲仙市', '南島原市', '長与町', '時津町', '東彼杵町', '川棚町', '波佐見町', '小値賀町', '佐々町', '新上五島町'],
  '熊本県': ['熊本市', '八代市', '人吉市', '荒尾市', '水俣市', '玉名市', '山鹿市', '菊池市', '宇土市', '上天草市', '宇城市', '阿蘇市', '天草市', '合志市', '美里町', '玉東町', '南関町', '長洲町', '和水町', '大津町', '菊陽町', '南小国町', '小国町', '産山村', '高森町', '西原村', '南阿蘇村', '御船町', '嘉島町', '益城町', '甲佐町', '山都町', '氷川町', '芦北町', '津奈木町', '錦町', '多良木町', '湯前町', '水上村', '相良村', '五木村', '山江村', '球磨村', 'あさぎり町', '苓北町'],
  '大分県': ['大分市', '別府市', '中津市', '日田市', '佐伯市', '臼杵市', '津久見市', '竹田市', '豊後高田市', '杵築市', '宇佐市', '豊後大野市', '由布市', '国東市', '姫島村', '日出町', '九重町', '玖珠町'],
  '宮崎県': ['宮崎市', '都城市', '延岡市', '日南市', '小林市', '日向市', '串間市', '西都市', 'えびの市', '三股町', '高原町', '国富町', '綾町', '高鍋町', '新富町', '西米良村', '木城町', '川南町', '都農町', '門川町', '諸塚村', '椎葉村', '美郷町', '高千穂町', '日之影町', '五ヶ瀬町'],
  '鹿児島県': ['鹿児島市', '鹿屋市', '枕崎市', '阿久根市', '出水市', '指宿市', '西之表市', '垂水市', '薩摩川内市', '日置市', '曽於市', '霧島市', 'いちき串木野市', '南さつま市', '志布志市', '奄美市', '南九州市', '伊佐市', '姶良市', '三島村', '十島村', 'さつま町', '長島町', '湧水町', '大崎町', '東串良町', '錦江町', '南大隅町', '肝付町', '中種子町', '南種子町', '屋久島町', '大和村', '宇検村', '瀬戸内町', '龍郷町', '喜界町', '徳之島町', '天城町', '伊仙町', '和泊町', '知名町', '与論町'],
  '沖縄県': ['那覇市', '宜野湾市', '石垣市', '浦添市', '名護市', '糸満市', '沖縄市', '豊見城市', 'うるま市', '宮古島市', '南城市', '国頭村', '大宜味村', '東村', '今帰仁村', '本部町', '恩納村', '宜野座村', '金武町', '伊江村', '読谷村', '嘉手納町', '北谷町', '北中城村', '中城村', '西原町', '与那原町', '南風原町', '渡嘉敷村', '座間味村', '粟国村', '渡名喜村', '南大東村', '北大東村', '伊平屋村', '伊是名村', '久米島町', '八重瀬町', '多良間村', '竹富町', '与那国町'],
};

export { PREFECTURES, CITIES_BY_PREF }
</file>

<file path="frontend/lib/navData.ts">
// frontend/lib/navData.ts
import { Home, Users, Zap, BookOpen, User, Settings, LogOut } from 'lucide-react';

/**
 * 左サイドバーのナビゲーションアイテムの型定義
 */
export interface NavItem {
    name: string;
    href: string;
    icon: React.ElementType; // Lucide Iconの型
    isAuthRequired: boolean; // 認証が必要なリンクかどうか
}

/**
 * メインナビゲーションリンク
 */
export const mainNavItems: NavItem[] = [
    {
        name: 'ホーム',
        href: '/',
        icon: Home,
        isAuthRequired: false,
    },
    {
        name: 'タイムライン',
        href: '/timeline',
        icon: Zap,
        isAuthRequired: false,
    },
    {
        name: '議員一覧',
        href: '/members',
        icon: Users,
        isAuthRequired: false,
    },
    // {
    //     name: '公約一覧',
    //     href: '/pledges',
    //     icon: BookOpen,
    //     isAuthRequired: false,
    // },
    // {
    //     name: 'プロフィール',
    //     href: '/profile',
    //     icon: User,
    //     isAuthRequired: true,
    // },
];

/**
 * 設定・ログアウトリンク
 */
export const utilityNavItems: NavItem[] = [
    {
        name: '設定',
        href: '/settings',
        icon: Settings,
        isAuthRequired: true,
    },
    {
        name: 'ログアウト',
        href: '/logout',
        icon: LogOut,
        isAuthRequired: true,
    },
];

// ログイン/登録ページへの案内
export const authNavItems: NavItem[] = [
    {
        name: 'ログイン',
        href: '/login',
        icon: User,
        isAuthRequired: false,
    },
];
</file>

<file path="frontend/lib/utils.ts">
// frontend/lib/utils.ts

import { type ClassValue, clsx } from 'clsx';
import { twMerge } from 'tailwind-merge';

/**
 * Tailwind CSSクラスを条件付きで結合し、競合するクラスを自動的に解決するヘルパー関数
 */
export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
</file>

<file path="frontend/nextjs-platform-clean/.next/dev/types/routes.d.ts">
// This file is generated automatically by Next.js
// Do not edit this file manually

type AppRoutes = never
type PageRoutes = never
type LayoutRoutes = never
type RedirectRoutes = never
type RewriteRoutes = never
type Routes = AppRoutes | PageRoutes | LayoutRoutes | RedirectRoutes | RewriteRoutes


interface ParamMap {
}


export type ParamsOf<Route extends Routes> = ParamMap[Route]

interface LayoutSlotMap {
}


export type { AppRoutes, PageRoutes, LayoutRoutes, RedirectRoutes, RewriteRoutes, ParamMap }

declare global {
  /**
   * Props for Next.js App Router page components
   * @example
   * ```tsx
   * export default function Page(props: PageProps<'/blog/[slug]'>) {
   *   const { slug } = await props.params
   *   return <div>Blog post: {slug}</div>
   * }
   * ```
   */
  interface PageProps<AppRoute extends AppRoutes> {
    params: Promise<ParamMap[AppRoute]>
    searchParams: Promise<Record<string, string | string[] | undefined>>
  }

  /**
   * Props for Next.js App Router layout components
   * @example
   * ```tsx
   * export default function Layout(props: LayoutProps<'/dashboard'>) {
   *   return <div>{props.children}</div>
   * }
   * ```
   */
  type LayoutProps<LayoutRoute extends LayoutRoutes> = {
    params: Promise<ParamMap[LayoutRoute]>
    children: React.ReactNode
  } & {
    [K in LayoutSlotMap[LayoutRoute]]: React.ReactNode
  }
}
</file>

<file path="frontend/nextjs-platform-clean/.next/dev/types/validator.ts">
// This file is generated automatically by Next.js
// Do not edit this file manually
// This file validates that all pages and layouts export the correct types
</file>

<file path="frontend/public/geo/jp-pref-cities.json">
[
  { "code": "01", "name": "北海道", "cities": ["札幌市中央区","札幌市北区","札幌市東区","札幌市白石区","札幌市豊平区","札幌市南区","札幌市西区","札幌市厚別区","札幌市手稲区","札幌市清田区","函館市","小樽市","旭川市","室蘭市","釧路市","帯広市","北見市","夕張市","岩見沢市","網走市","留萌市","苫小牧市","稚内市","美唄市","芦別市","江別市","赤平市","紋別市","士別市","名寄市","三笠市","根室市","千歳市","滝川市","砂川市","歌志内市","深川市","富良野市","登別市","恵庭市","伊達市","北広島市","石狩市","北斗市"] },
  { "code": "02", "name": "青森県", "cities": ["青森市","弘前市","八戸市","黒石市","五所川原市","十和田市","三沢市","むつ市","つがる市","平川市"] },
  { "code": "03", "name": "岩手県", "cities": ["盛岡市","宮古市","大船渡市","花巻市","北上市","久慈市","遠野市","一関市","陸前高田市","釜石市","二戸市","八幡平市","奥州市"] },
  { "code": "04", "name": "宮城県", "cities": ["仙台市青葉区","仙台市宮城野区","仙台市若林区","仙台市太白区","仙台市泉区","石巻市","塩竈市","気仙沼市","白石市","名取市","角田市","多賀城市","岩沼市","登米市","栗原市","東松島市","大崎市"] },
  { "code": "05", "name": "秋田県", "cities": ["秋田市","能代市","横手市","大館市","男鹿市","湯沢市","鹿角市","由利本荘市","潟上市","大仙市","北秋田市","にかほ市","仙北市"] },
  { "code": "06", "name": "山形県", "cities": ["山形市","米沢市","鶴岡市","酒田市","新庄市","寒河江市","上山市","村山市","長井市","天童市","東根市","尾花沢市","南陽市"] },
  { "code": "07", "name": "福島県", "cities": ["福島市","郡山市","いわき市","白河市","須賀川市","喜多方市","相馬市","二本松市","田村市","南相馬市","伊達市","本宮市"] },
  { "code": "08", "name": "茨城県", "cities": ["水戸市","日立市","土浦市","古河市","石岡市","結城市","龍ケ崎市","下妻市","常総市","常陸太田市","高萩市","北茨城市","笠間市","取手市","牛久市","つくば市","ひたちなか市","鹿嶋市","潮来市","守谷市","常陸大宮市","那珂市","筑西市","坂東市","稲敷市","かすみがうら市","桜川市","神栖市","行方市","鉾田市","つくばみらい市","小美玉市"] },
  { "code": "09", "name": "栃木県", "cities": ["宇都宮市","足利市","栃木市","佐野市","鹿沼市","日光市","小山市","真岡市","大田原市","矢板市","那須塩原市","さくら市","那須烏山市","下野市"] },
  { "code": "10", "name": "群馬県", "cities": ["前橋市","高崎市","桐生市","伊勢崎市","太田市","沼田市","館林市","渋川市","藤岡市","富岡市","安中市","みどり市"] },
  { "code": "11", "name": "埼玉県", "cities": ["さいたま市西区","さいたま市北区","さいたま市大宮区","さいたま市見沼区","さいたま市中央区","さいたま市桜区","さいたま市浦和区","さいたま市南区","さいたま市緑区","さいたま市岩槻区","川越市","熊谷市","川口市","行田市","秩父市","所沢市","飯能市","加須市","本庄市","東松山市","春日部市","狭山市","羽生市","鴻巣市","深谷市","上尾市","草加市","越谷市","蕨市","戸田市","入間市","朝霞市","志木市","和光市","新座市","桶川市","久喜市","北本市","八潮市","富士見市","三郷市","蓮田市","坂戸市","幸手市","鶴ヶ島市","日高市","吉川市","ふじみ野市"] },
  { "code": "12", "name": "千葉県", "cities": ["千葉市中央区","千葉市花見川区","千葉市稲毛区","千葉市若葉区","千葉市緑区","千葉市美浜区","銚子市","市川市","船橋市","館山市","木更津市","松戸市","野田市","茂原市","成田市","佐倉市","東金市","旭市","習志野市","柏市","勝浦市","市原市","流山市","八千代市","我孫子市","鴨川市","鎌ケ谷市","君津市","富津市","浦安市","四街道市","袖ケ浦市","八街市","印西市","白井市","富里市","南房総市","匝瑳市","香取市","山武市","いすみ市"] },
  { "code": "13", "name": "東京都", "cities": ["千代田区","中央区","港区","新宿区","文京区","台東区","墨田区","江東区","品川区","目黒区","大田区","世田谷区","渋谷区","中野区","杉並区","豊島区","北区","荒川区","板橋区","練馬区","足立区","葛飾区","江戸川区","八王子市","立川市","武蔵野市","三鷹市","青梅市","府中市","昭島市","調布市","町田市","小金井市","小平市","日野市","東村山市","国分寺市","国立市","福生市","狛江市","東大和市","清瀬市","東久留米市","武蔵村山市","多摩市","稲城市","羽村市","あきる野市","西東京市"] },
  { "code": "14", "name": "神奈川県", "cities": ["横浜市鶴見区","横浜市神奈川区","横浜市西区","横浜市中区","横浜市南区","横浜市保土ケ谷区","横浜市磯子区","横浜市金沢区","横浜市港北区","横浜市戸塚区","横浜市港南区","横浜市旭区","横浜市緑区","横浜市瀬谷区","横浜市栄区","横浜市泉区","横浜市青葉区","横浜市都筑区","川崎市川崎区","川崎市幸区","川崎市中原区","川崎市高津区","川崎市多摩区","川崎市宮前区","川崎市麻生区","相模原市緑区","相模原市中央区","相模原市南区","横須賀市","平塚市","鎌倉市","藤沢市","小田原市","茅ヶ崎市","逗子市","三浦市","秦野市","厚木市","大和市","伊勢原市","海老名市","座間市","南足柄市","綾瀬市"] },
  { "code": "15", "name": "新潟県", "cities": ["新潟市北区","新潟市東区","新潟市中央区","新潟市江南区","新潟市秋葉区","新潟市南区","新潟市西区","新潟市西蒲区","長岡市","三条市","柏崎市","新発田市","小千谷市","加茂市","十日町市","見附市","村上市","燕市","五泉市","上越市","阿賀野市","佐渡市","魚沼市","胎内市"] },
  { "code": "16", "name": "富山県", "cities": ["富山市","高岡市","魚津市","氷見市","滑川市","黒部市","砺波市","小矢部市","南砺市","射水市"] },
  { "code": "17", "name": "石川県", "cities": ["金沢市","七尾市","小松市","輪島市","珠洲市","加賀市","羽咋市","かほく市","白山市","野々市市","能美市"] },
  { "code": "18", "name": "福井県", "cities": ["福井市","敦賀市","小浜市","大野市","勝山市","鯖江市","あわら市","越前市","坂井市"] },
  { "code": "19", "name": "山梨県", "cities": ["甲府市","富士吉田市","都留市","山梨市","大月市","韮崎市","南アルプス市","北杜市","甲斐市","笛吹市","上野原市","甲州市","中央市"] },
  { "code": "20", "name": "長野県", "cities": ["長野市","松本市","上田市","岡谷市","飯田市","諏訪市","須坂市","小諸市","伊那市","駒ヶ根市","中野市","大町市","飯山市","茅野市","塩尻市","佐久市","千曲市","東御市","安曇野市"] },
  { "code": "21", "name": "岐阜県", "cities": ["岐阜市","大垣市","高山市","多治見市","関市","中津川市","美濃市","瑞浪市","羽島市","恵那市","美濃加茂市","土岐市","各務原市","可児市","山県市","瑞穂市","飛騨市","本巣市","郡上市","下呂市","海津市"] },
  { "code": "22", "name": "静岡県", "cities": ["静岡市葵区","静岡市駿河区","静岡市清水区","浜松市中央区","浜松市浜名区","沼津市","熱海市","三島市","富士宮市","伊東市","島田市","富士市","磐田市","焼津市","掛川市","藤枝市","御殿場市","袋井市","下田市","裾野市","湖西市","伊豆市","御前崎市","菊川市","伊豆の国市","牧之原市"] },
  { "code": "23", "name": "愛知県", "cities": ["名古屋市千種区","名古屋市東区","名古屋市北区","名古屋市西区","名古屋市中村区","名古屋市中区","名古屋市昭和区","名古屋市瑞穂区","名古屋市熱田区","名古屋市中川区","名古屋市港区","名古屋市南区","名古屋市守山区","名古屋市緑区","名古屋市名東区","名古屋市天白区","豊橋市","岡崎市","一宮市","瀬戸市","半田市","春日井市","豊川市","津島市","碧南市","刈谷市","豊田市","安城市","西尾市","蒲郡市","犬山市","常滑市","江南市","小牧市","稲沢市","新城市","東海市","大府市","知多市","知立市","尾張旭市","高浜市","岩倉市","豊明市","日進市","田原市","愛西市","清須市","北名古屋市","弥富市","みよし市","あま市","長久手市"] },
  { "code": "24", "name": "三重県", "cities": ["津市","四日市市","伊勢市","松阪市","桑名市","鈴鹿市","名張市","尾鷲市","亀山市","鳥羽市","熊野市","いなべ市","志摩市","伊賀市"] },
  { "code": "25", "name": "滋賀県", "cities": ["大津市","彦根市","長浜市","近江八幡市","草津市","守山市","栗東市","甲賀市","野洲市","湖南市","高島市","東近江市","米原市"] },
  { "code": "26", "name": "京都府", "cities": ["京都市北区","京都市上京区","京都市左京区","京都市中京区","京都市東山区","京都市下京区","京都市南区","京都市右京区","京都市伏見区","京都市山科区","京都市西京区","福知山市","舞鶴市","綾部市","宇治市","宮津市","亀岡市","城陽市","向日市","長岡京市","八幡市","京田辺市","京丹後市","南丹市","木津川市"] },
  { "code": "27", "name": "大阪府", "cities": ["大阪市都島区","大阪市福島区","大阪市此花区","大阪市西区","大阪市港区","大阪市大正区","大阪市天王寺区","大阪市浪速区","大阪市西淀川区","大阪市東淀川区","大阪市東成区","大阪市生野区","大阪市旭区","大阪市城東区","大阪市阿倍野区","大阪市住吉区","大阪市東住吉区","大阪市西成区","大阪市淀川区","大阪市鶴見区","大阪市住之江区","大阪市平野区","大阪市北区","大阪市中央区","堺市堺区","堺市中区","堺市東区","堺市西区","堺市南区","堺市北区","堺市美原区","岸和田市","豊中市","池田市","吹田市","泉大津市","高槻市","貝塚市","守口市","枚方市","茨木市","八尾市","泉佐野市","富田林市","寝屋川市","河内長野市","松原市","大東市","和泉市","箕面市","柏原市","羽曳野市","門真市","摂津市","高石市","藤井寺市","東大阪市","泉南市","四條畷市","交野市","大阪狭山市","阪南市"] },
  { "code": "28", "name": "兵庫県", "cities": ["神戸市東灘区","神戸市灘区","神戸市兵庫区","神戸市長田区","神戸市須磨区","神戸市垂水区","神戸市北区","神戸市中央区","神戸市西区","姫路市","尼崎市","明石市","西宮市","洲本市","芦屋市","伊丹市","相生市","豊岡市","加古川市","赤穂市","西脇市","宝塚市","三木市","高砂市","川西市","小野市","三田市","加西市","丹波篠山市","養父市","丹波市","南あわじ市","朝来市","淡路市","宍粟市","たつの市"] },
  { "code": "29", "name": "奈良県", "cities": ["奈良市","大和高田市","大和郡山市","天理市","橿原市","桜井市","五條市","御所市","生駒市","香芝市","葛城市","宇陀市"] },
  { "code": "30", "name": "和歌山県", "cities": ["和歌山市","海南市","橋本市","有田市","御坊市","田辺市","新宮市","紀の川市","岩出市"] },
  { "code": "31", "name": "鳥取県", "cities": ["鳥取市","米子市","倉吉市","境港市"] },
  { "code": "32", "name": "島根県", "cities": ["松江市","浜田市","出雲市","益田市","大田市","安来市","江津市","雲南市"] },
  { "code": "33", "name": "岡山県", "cities": ["岡山市北区","岡山市中区","岡山市東区","岡山市南区","倉敷市","津山市","玉野市","笠岡市","井原市","総社市","高梁市","新見市","備前市","瀬戸内市","赤磐市","真庭市","美作市","浅口市"] },
  { "code": "34", "name": "広島県", "cities": ["広島市中区","広島市東区","広島市南区","広島市西区","広島市安佐南区","広島市安佐北区","広島市佐伯区","広島市安芸区","呉市","竹原市","三原市","尾道市","福山市","府中市","三次市","庄原市","大竹市","東広島市","廿日市市","安芸高田市","江田島市"] },
  { "code": "35", "name": "山口県", "cities": ["下関市","宇部市","山口市","萩市","防府市","下松市","岩国市","光市","長門市","柳井市","美祢市","周南市","山陽小野田市"] },
  { "code": "36", "name": "徳島県", "cities": ["徳島市","鳴門市","小松島市","阿南市","吉野川市","阿波市","美馬市","三好市"] },
  { "code": "37", "name": "香川県", "cities": ["高松市","丸亀市","坂出市","善通寺市","観音寺市","さぬき市","東かがわ市","三豊市"] },
  { "code": "38", "name": "愛媛県", "cities": ["松山市","今治市","宇和島市","八幡浜市","新居浜市","西条市","大洲市","伊予市","四国中央市","西予市","東温市"] },
  { "code": "39", "name": "高知県", "cities": ["高知市","室戸市","安芸市","南国市","土佐市","須崎市","宿毛市","土佐清水市","四万十市"] },
  { "code": "40", "name": "福岡県", "cities": ["北九州市門司区","北九州市若松区","北九州市戸畑区","北九州市小倉北区","北九州市小倉南区","北九州市八幡東区","北九州市八幡西区","福岡市東区","福岡市博多区","福岡市中央区","福岡市南区","福岡市西区","福岡市城南区","福岡市早良区","大牟田市","久留米市","直方市","飯塚市","田川市","柳川市","八女市","筑後市","大川市","行橋市","豊前市","中間市","小郡市","筑紫野市","春日市","大野城市","宗像市","太宰府市","古賀市","福津市","うきは市","宮若市","嘉麻市","朝倉市","みやま市","糸島市"] },
  { "code": "41", "name": "佐賀県", "cities": ["佐賀市","唐津市","鳥栖市","多久市","伊万里市","武雄市","鹿島市","小城市","嬉野市","神埼市"] },
  { "code": "42", "name": "長崎県", "cities": ["長崎市","佐世保市","島原市","諫早市","大村市","平戸市","松浦市","対馬市","壱岐市","五島市"] },
  { "code": "43", "name": "熊本県", "cities": ["熊本市中央区","熊本市東区","熊本市西区","熊本市南区","熊本市北区","八代市","人吉市","荒尾市","水俣市","玉名市","山鹿市","菊池市","宇土市","上天草市","宇城市","阿蘇市","合志市"] },
  { "code": "44", "name": "大分県", "cities": ["大分市","別府市","中津市","日田市","佐伯市","臼杵市","津久見市","竹田市","豊後高田市","杵築市","宇佐市","豊後大野市","由布市"] },
  { "code": "45", "name": "宮崎県", "cities": ["宮崎市","都城市","延岡市","日南市","小林市","日向市","串間市","西都市","えびの市"] },
  { "code": "46", "name": "鹿児島県", "cities": ["鹿児島市","鹿屋市","枕崎市","阿久根市","出水市","指宿市","西之表市","垂水市","薩摩川内市","日置市","曽於市","霧島市","いちき串木野市","南さつま市","志布志市","奄美市","南九州市"] },
  { "code": "47", "name": "沖縄県", "cities": ["那覇市","宜野湾市","石垣市","浦添市","名護市","糸満市","沖縄市","豊見城市","うるま市","宮古島市","南城市"] }
]
</file>

<file path="frontend/public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="frontend/public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="frontend/public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="frontend/public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="frontend/public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="frontend/types/data.ts">
// frontend/types/data.ts

/** ユーザー情報 */
export interface User {
  id: string; // UUID
  email: string; // メールアドレス
  displayName: string | null;
  role: 'admin' | 'user'; // ロール
  firebaseUid: string | null;
  photoUrl: string | null;
  district: string | null; // 地域
  
  // 💡 統合: タイムライン/本人確認に必要な属性
  prefecture: string | null; // ユーザーの居住都道府県
  ageGroup: '10s' | '20s' | '30s' | '40s' | '50s+' | 'Unknown' | null; // 年齢層

  isActive: boolean;
  createdAt: string; // Dateオブジェクトとして扱うことが多いですが、APIから文字列で返ることを想定しstring
  updatedAt: string;
}

/** 議員情報 */
export interface Member {
  id: string; // UUID
  name: string; // 議員名
  twitterHandle: string | null;
  email: string | null;
  affiliation: string | null; // 所属政党
  position: string | null; // 役職
  userId: string | null; // 関連ユーザーID
  blogRssUrl: string | null;
  officialRssUrl: string | null;
  lastTwitterFetch: string | null;
  createdAt: string;
  updatedAt: string;
}

/** 公約情報 */
export interface Pledge {
  id: string; // UUID
  memberId: string; // 議員ID
  title: string; // 公約タイトル
  description: string | null;
  category: string | null; // カテゴリ
  status: 'pending' | 'in_progress' | 'completed' | 'failed'; // ステータス
  createdAt: string;
  updatedAt: string;
}

/** 投票情報 */
export interface Vote {
  id: string; // UUID
  userId: string; // 投票者ID
  pledgeId: string; // 公約ID
  memberId: string; // 議員ID
  voteType: 'agree' | 'disagree'; // 投票タイプ
  createdAt: string;
}

/** 活動ログ情報 */
export interface ActivityLog {
  id: string; // UUID
  memberId: string; // 議員ID
  title: string; // タイトル
  content: string | null; // 内容
  source: 'twitter' | 'rss' | 'manual'; // ソース
  sourceUrl: string | null; // ソースURL
  publishedAt: string;
  createdAt: string;
}

/** 政務活動費情報 */
export interface ActivityFund {
  id: string; // UUID
  memberId: string; // 議員ID
  category: string; // カテゴリ (交通費、事務所費など)
  amount: number; // 金額
  description: string | null;
  date: string; // 支出日
  createdAt: string;
}

/** API応答の共通エラー型 */
export interface ApiError {
  statusCode: number;
  message: string | string[];
  error: string;
}

// -----------------------------------------------------------
// 📌 タイムライン機能用 新しい型定義
// -----------------------------------------------------------

export type AgeGroup = '10s' | '20s' | '30s' | '40s' | '50s+' | 'Unknown';

/**
 * 投稿 (Post) の型定義
 * 投稿内容と投稿者情報を含む
 */
export interface Post {
    id: string;
    content: string; // 投稿本文
    imageUrl: string | null; // 添付画像があればそのURL
    
    // 投稿者情報 (ネスト) - タイムライン表示に必要な情報のみ
    author: {
        id: string;
        username: string;
        avatarUrl: string | null;
        
        // 投稿と関連付けたい本人確認属性情報
        prefecture: string | null; 
        ageGroup: AgeGroup | null;
    };
    
    // インタラクション (いいね、コメント)
    likeCount: number; 
    commentCount: number; 
    isLiked: boolean; // ログインユーザーが「いいね」しているか
    
    // タイムスタンプ
    createdAt: string; 
    updatedAt: string; 
}

/**
 * タイムライン表示用のデータ構造
 * ページネーションを考慮
 */
export interface TimelineData {
    posts: Post[]; // 投稿のリスト
    hasNextPage: boolean; // 次のページがあるか
    nextCursor: string | null; // 次のページ取得のためのカーソル値
    totalCount: number; // 全投稿数
}
</file>

<file path="frontend/utils/fakeApi.ts">
// frontend/utils/fakeApi.ts

import { Post } from '@/types/data';

// ----------------------------------------------------
// 1. サンプルデータに投票数と投票状態を追加
// ----------------------------------------------------

// 💡 投稿データの構造を拡張
const samplePosts: Post[] = [
  {
    id: 'p1',
    author: {
      id: 'u1',
      username: '田中_市議会に期待',
      prefecture: '東京都',
      ageGroup: '30代',
      avatarUrl: 'https://i.pravatar.cc/150?img=1',
    },
    content: '駅前の再開発計画について、もっと住民の声を聞くべきだと思います。特に商業施設の誘致は慎重に！',
    imageUrl: null,
    createdAt: '2025-11-10T10:00:00Z',
    commentCount: 5,
    // 💡 変更点: いいねから賛否投票に変更
    upvoteCount: 15, // 賛成票
    downvoteCount: 3, // 反対票
    // 💡 変更点: ユーザーの投票状態 (upvote, downvote, none)
    userVoteStatus: 'none', 
  },
  {
    id: 'p2',
    author: {
      id: 'u2',
      username: '環境派の市民',
      prefecture: '大阪府',
      ageGroup: '40代',
      avatarUrl: 'https://i.pravatar.cc/150?img=2',
    },
    content: '公園の整備予算を増やす公約に賛成です。子どもたちの遊び場は最優先事項だと思います。',
    imageUrl: 'https://picsum.photos/600/300',
    createdAt: '2025-11-09T15:30:00Z',
    commentCount: 12,
    upvoteCount: 42, 
    downvoteCount: 8, 
    userVoteStatus: 'upvote', 
  },
  // ... (必要に応じて他の投稿を追加)
];

// ----------------------------------------------------
// 2. タイムラインデータの取得
// ----------------------------------------------------

/**
 * タイムラインの投稿データを取得する（フェイクAPI）
 */
export async function fetchTimelineData(): Promise<Post[]> {
  // サーバーサイドでの処理をシミュレートするため、200msの遅延
  await new Promise(resolve => setTimeout(resolve, 200)); 
  return samplePosts;
}

// ----------------------------------------------------
// 3. 投稿の作成
// ----------------------------------------------------

/**
 * 新しい投稿を作成する（フェイクAPI）
 */
export async function createPost(content: string, imageUrl: string | null): Promise<Post> {
  await new Promise(resolve => setTimeout(resolve, 500));
  
  const newPost: Post = {
    id: `p${Date.now()}`,
    author: {
      id: 'u999',
      username: '現在のユーザー',
      prefecture: '未設定',
      ageGroup: '未設定',
      avatarUrl: null,
    },
    content: content,
    imageUrl: imageUrl,
    createdAt: new Date().toISOString(),
    commentCount: 0,
    // 💡 変更点: 初期投票数を設定
    upvoteCount: 0, 
    downvoteCount: 0, 
    userVoteStatus: 'none',
  };
  
  samplePosts.unshift(newPost); // リストの先頭に追加
  return newPost;
}


// ----------------------------------------------------
// 4. 賛否投票の処理 (いいね機能の置き換え)
// ----------------------------------------------------

type VoteType = 'upvote' | 'downvote' | 'none';

/**
 * 投稿の賛否投票を切り替える（フェイクAPI）
 * @param postId 対象の投稿ID
 * @param newStatus ユーザーが押したボタンの種類 ('upvote' または 'downvote')
 * @returns 更新後の投票数とユーザーの新しい投票状態
 */
export async function toggleVote(postId: string, newStatus: 'upvote' | 'downvote'): Promise<{ newUpvoteCount: number; newDownvoteCount: number; newUserVoteStatus: VoteType }> {
  await new Promise(resolve => setTimeout(resolve, 300));

  const post = samplePosts.find(p => p.id === postId);
  if (!post) {
    throw new Error('Post not found');
  }

  let upvoteChange = 0;
  let downvoteChange = 0;
  let finalStatus: VoteType = 'none';

  // 1. 現在の投票状態を確認
  const currentStatus = post.userVoteStatus;
  
  if (newStatus === 'upvote') {
    if (currentStatus === 'upvote') {
      // 既に賛成 -> 投票を取り消し
      upvoteChange = -1;
      finalStatus = 'none';
    } else if (currentStatus === 'downvote') {
      // 反対から賛成へ変更
      upvoteChange = 1;
      downvoteChange = -1;
      finalStatus = 'upvote';
    } else {
      // 未投票 -> 賛成
      upvoteChange = 1;
      finalStatus = 'upvote';
    }
  } else if (newStatus === 'downvote') {
    if (currentStatus === 'downvote') {
      // 既に反対 -> 投票を取り消し
      downvoteChange = -1;
      finalStatus = 'none';
    } else if (currentStatus === 'upvote') {
      // 賛成から反対へ変更
      upvoteChange = -1;
      downvoteChange = 1;
      finalStatus = 'downvote';
    } else {
      // 未投票 -> 反対
      downvoteChange = 1;
      finalStatus = 'downvote';
    }
  }

  // 2. データを更新
  post.upvoteCount += upvoteChange;
  post.downvoteCount += downvoteChange;
  post.userVoteStatus = finalStatus;

  // 3. 結果を返す
  return {
    newUpvoteCount: post.upvoteCount,
    newDownvoteCount: post.downvoteCount,
    newUserVoteStatus: finalStatus,
  };
}

// ----------------------------------------------------
// 5. 新しい投稿型をエクスポート
// ----------------------------------------------------

/**
 * 投稿型に新しいフィールドが追加されたため、Post型も再定義する必要がある
 * 実際には '@/types/data'で定義されているが、ここではローカルで再定義する
 */
export type { Post } from '@/types/data';
</file>

<file path="frontend/.gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="frontend/env.example">
# Firebase Configuration
NEXT_PUBLIC_ENABLE_FIREBASE_AUTH=false
NEXT_PUBLIC_FIREBASE_API_KEY=your_firebase_api_key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your_project.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your_firebase_project_id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your_project.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your_messaging_sender_id
NEXT_PUBLIC_FIREBASE_APP_ID=your_firebase_app_id

# API Configuration
NEXT_PUBLIC_API_URL=http://localhost:3001/api
</file>

<file path="frontend/eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="frontend/jsconfig.json">
// frontend/jsconfig.json (この内容が正しいことを確認)
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./*"] 
    },
    "target": "es2020",
    "module": "esnext",
    "jsx": "preserve",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": false,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true
  },
  "include": ["**/*.js", "**/*.jsx", "**/*.ts", "**/*.tsx"],
  "exclude": ["node_modules"]
}
</file>

<file path="frontend/next.config.js">
/**
 * Next.js 16 (Turbopack) 用の設定ファイル
 * - 複数の lockfile がある環境でワークスペースルート誤認識を防ぐため、turbopack.root を frontend フォルダに明示
 * - 画像・最適化などは必要最低限に留めています。必要に応じて追記してください。
 * - クライアントから参照する公開環境変数（NEXT_PUBLIC_...）は .env.local で管理します
 */

const path = require('path');

/** @type {import('next').NextConfig} */
const nextConfig = {
  // Turbopack のルートを明示（警告を消す）
  turbopack: {
    root: path.resolve(__dirname),
  },

  // React の StrictMode（必要に応じて切り替え可能）
  reactStrictMode: true,

  // 国際化（未使用ならそのままでOK）
  i18n: {
    locales: ['ja'],
    defaultLocale: 'ja',
  },

  // 画像の外部ドメイン許可（SNSなどの OGP 画像を使う場合に必要）
  images: {
    remotePatterns: [
      { protocol: 'https', hostname: 'images.unsplash.com' },
      { protocol: 'https', hostname: 'pbs.twimg.com' },       // X(Twitter) 画像
      { protocol: 'https', hostname: 'abs.twimg.com' },       // X(Twitter) assets
      { protocol: 'https', hostname: 'instagram.com' },
      { protocol: 'https', hostname: 'scontent.cdninstagram.com' },
      { protocol: 'https', hostname: 'facebook.com' },
      { protocol: 'https', hostname: 'lookaside.facebook.com' },
      { protocol: 'https', hostname: 'i.ytimg.com' },         // YouTube thumbnail
      { protocol: 'https', hostname: 'img.youtube.com' },
      { protocol: 'https', hostname: 'ogp.me' },              // OGP 取得系の仮例
    ],
  },

  // リダイレクト・リライト（必要なら API のプロキシをここで定義できます）
  async rewrites() {
    // 現状は .env.local の NEXT_PUBLIC_API_BASE を使うため rewrites は不要
    // もしフロントから相対パスで /api をバックエンドに流したい場合はここに追記してください
    return [];
  },

  // ビルドの最適化設定（開発用途ではデフォルトで十分）
  experimental: {
    // 必要なら App Router の設定などを拡張可能
    // serverActions: true,
  },
};

module.exports = nextConfig;
</file>

<file path="frontend/next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
</file>

<file path="frontend/package.json">
{
  "name": "mvp",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@hookform/resolvers": "^3.9.0",
    "@tailwindcss/forms": "^0.5.10",
    "axios": "^1.7.2",
    "chart.js": "^4.5.1",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "firebase": "^10.13.0",
    "framer-motion": "^11.11.17",
    "jwt-decode": "^4.0.0",
    "lucide-react": "^0.460.0",
    "next": "^16.0.0",
    "react": "^19.2.0",
    "react-chartjs-2": "^5.3.1",
    "react-dom": "^19.2.0",
    "react-hook-form": "^7.53.0",
    "react-hot-toast": "^2.6.0",
    "recharts": "^2.12.7",
    "swr": "^2.3.6",
    "tailwind-merge": "^2.5.4",
    "zod": "^3.23.8"
  },
  "devDependencies": {
    "@faker-js/faker": "^10.1.0",
    "@types/chart.js": "^2.9.41",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.22",
    "eslint": "^9",
    "eslint-config-next": "16.0.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.18",
    "ts-node": "^10.9.2",
    "typescript": "^5"
  }
}
</file>

<file path="frontend/postcss.config.js">
// postcss.config.js
module.exports = {
  plugins: {
    // 💡 v3の標準プラグイン形式
    tailwindcss: {},
    autoprefixer: {},
  },
};
</file>

<file path="frontend/postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="frontend/README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="frontend/tailwind.config.js">
// frontend/tailwind.config.js

/** @type {import('tailwindcss').Config} */
module.exports = {
  // 💡 ダークモードの切り替え方法を指定 (Next.jsのclassName方式)
  darkMode: 'class', 
  content: [
    './app/**/*.{js,ts,jsx,tsx,mdx}',
    './pages/**/*.{js,ts,jsx,tsx,mdx}',
    './components/**/*.{js,ts,jsx,tsx,mdx}',
    './utils/**/*.{js,ts,jsx,tsx,mdx}',

    // 外部コンポーネントのスキャン設定を維持
    './node_modules/lucide-react/**/*.{js,ts,jsx,tsx}', 
  ],
  theme: {
    extend: {
      colors: {
        // 必要に応じてカスタムカラーを追加
        primary: '#3B82F6', // Blue-500
      },
    },
  },
  plugins: [
    // フォーム要素のスタイリングをリセット
    require('@tailwindcss/forms'),
  ],
};
</file>

<file path="frontend/testData.js">
// frontend/testData.js

// 🚨 注意: このパスは、fakeApi.tsがどこにあるかに依存します。
// utilsフォルダがfrontend直下にあると仮定しています。
import { fetchTimelineData } from './utils/fakeApi.ts';

async function runTest() {
    console.log("--- ダミーデータ生成テスト開始 ---");
    try {
        const data = await fetchTimelineData(5); // 5件のデータを取得
        console.log("取得成功。投稿数:", data.posts.length);
        
        // 最初の投稿の中身を少し確認
        if (data.posts.length > 0) {
            console.log("\n最初の投稿の著者情報:");
            console.log("  ユーザー名:", data.posts[0].author.username);
            console.log("  都道府県:", data.posts[0].author.prefecture);
            console.log("  本文の一部:", data.posts[0].content.substring(0, 50) + "...");
        }

    } catch (e) {
        console.error("データ取得中にエラーが発生しました:", e);
    }
    console.log("--- テスト終了 ---");
}

runTest();
</file>

<file path="test/app.e2e-spac.ts">
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication } from '@nestjs/common';
import * as request from 'supertest';
import { AppModule } from '../src/app.module';

describe('App (e2e)', () => {
  let app: INestApplication;

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    app.setGlobalPrefix('api');
    await app.init();
  });

  afterAll(async () => {
    await app.close();
  });

  it('GET /api/posts should respond (200 or 404)', async () => {
    const res = await request(app.getHttpServer()).get('/api/posts');
    expect([200, 404]).toContain(res.status);
  });
});
</file>

<file path=".env.example">
NODE_ENV=production
PORT=3001
DB_FILE=dev.sqlite
JWT_SECRET=CHANGEME_TO_A_LONG_RANDOM_SECRET
</file>

<file path="docker-compose.yml">
version: '3.8'
services:
  mysql:
    image: mysql:8.0
    container_name: transparency_platform_mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: "MLLGNUjqLfra/ZpvCuBSt4miXmqX2d+25DDr2ieRAjY="
      MYSQL_DATABASE: transparency_platform
      MYSQL_USER: transparency_user
      MYSQL_PASSWORD: "MLLGNUjqLfra/ZpvCuBSt4miXmqX2d+25DDr2ieRAjY="
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
volumes:
  mysql_data:
    driver: local
</file>

<file path="FIREBASE_SETUP.md">
# Firebase Setup Guide

## The Error: `auth/configuration-not-found`

This error means **Firebase Authentication is not enabled** in your Firebase Console.

## Step 1: Enable Email/Password Authentication

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select your project: **seijika-com**
3. Click **Authentication** in the left sidebar
4. Click **Get Started** (if you haven't set up Authentication yet)
5. Go to the **Sign-in method** tab
6. Click on **Email/Password**
7. **Enable** the first toggle (Email/Password)
8. Click **Save**

## Step 2: Verify Your Environment Variables

Make sure your `frontend/.env.local` file contains:

```env
NEXT_PUBLIC_ENABLE_FIREBASE_AUTH=true
NEXT_PUBLIC_FIREBASE_API_KEY=AIzaSyDohRRkWVo2hUK4xzsLKUhAz_SJHbmA37M
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=seijika-com.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=seijika-com
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=seijika-com.firebasestorage.app
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=349199737379
NEXT_PUBLIC_FIREBASE_APP_ID=1:349199737379:web:0146142a03bc1741fec796
NEXT_PUBLIC_API_URL=http://localhost:3001/api
```

## Step 3: Restart Your Development Server

After updating `.env.local`:

1. **Stop** the frontend server (Ctrl+C)
2. **Delete** the `.next` folder: `rm -rf frontend/.next` (Linux/Mac) or `rmdir /s frontend\.next` (Windows)
3. **Restart**: `cd frontend && npm run dev`

## Step 4: Verify in Browser Console

Open your browser's developer console (F12) and check:
- You should see: `✅ Firebase initialized successfully`
- If you see warnings, check what variables are missing

## Still Having Issues?

1. **Check API Key Restrictions**: In Google Cloud Console, make sure your API key is not restricted or is allowed for your domain
2. **Verify Project ID**: Make sure `seijika-com` is the correct project ID
3. **Check Auth Domain**: The authDomain must match exactly: `seijika-com.firebaseapp.com`

## Common Issues

- **"API key not valid"**: Your API key might be restricted. Check Google Cloud Console → APIs & Services → Credentials
- **"Network request failed"**: Check your internet connection and firewall settings
- **"Project not found"**: Verify the project ID matches your Firebase project
</file>

<file path="generateData.js">
// Node.jsのバージョンやプロジェクト設定によっては、requireを使用します。
// const { faker } = require('@faker-js/faker'); 

import { faker } from '@faker-js/faker';

// ランダムなユーザーデータを生成する関数
function createRandomUser() {
  return {
    userId: faker.string.uuid(),
    username: faker.internet.userName(),
    email: faker.internet.email(),
    avatar: faker.image.avatar(),
    password: faker.internet.password(),
    birthdate: faker.date.birthdate(),
    registeredAt: faker.date.past(),
  };
}

// createRandomUser関数を5回実行し、結果を配列に格納
const users = faker.helpers.multiple(createRandomUser, {
  count: 5,
});

// 生成されたデータをコンソールに出力
console.log(users);
</file>

<file path="README.md">
# 市民参加型 透明性データプラットフォーム

地方議会議員の活動情報、公約、および政務活動費の使途を市民が公平に確認・評価できるデータ駆動型WebプラットフォームのMVP（最小実行可能製品）です。

## 🎯 プロジェクトの目的

- **政治的透明性の向上**: 議員の活動情報と公金の使途を可視化
- **市民参加の促進**: 公約や活動に対する賛否評価機能
- **情報の一元化**: 複数のソースからの情報を自動収集・統合
- **データ駆動型の政治**: 客観的なデータに基づく政治評価

## 🚀 主要機能

### A. 登録メンバー（議員）チャンネル機能
- **プロフィール表示**: 議員の氏名、写真、所属、経歴、公約一覧
- **活動資金の可視化**: 政務活動費の支出データをカテゴリ別に集計し、Chart.js/Rechartsで可視化
- **賛否評価機能**: ログインユーザーが各活動や公約に「賛成」または「反対」の評価を表明

### B. メインタイムライン・情報自動収集機能
- **活動ログのフィード**: 全登録メンバーの最新活動ログを時系列で表示
- **外部フィード連携**: X (旧Twitter) API、議員の公式ブログ・ウェブサイトのRSS、地方自治体議会公式サイトのRSSから自動収集
- **堅牢な自動収集システム**: 再送・リトライ機構を備えた障害対応

### C. バックエンド・データ管理
- **RESTful API**: NestJSによる堅牢なAPI基盤
- **DB設計**: 正規化と拡張性を意識したMySQLスキーマ設計
- **運営者向け管理画面**: 議員情報のCRUD操作、活動資金データのCSVインポート機能

## 🛠 技術スタック

### バックエンド
- **フレームワーク**: NestJS
- **データベース**: MySQL with TypeORM
- **認証**: Firebase Authentication
- **外部API**: Twitter API v2, RSS Parser
- **セキュリティ**: Helmet, CORS, Rate Limiting
- **ドキュメント**: Swagger/OpenAPI

### フロントエンド
- **フレームワーク**: Next.js 16 (App Router)
- **UI**: React 19, Tailwind CSS
- **状態管理**: React Context API
- **チャート**: Chart.js, Recharts
- **アニメーション**: Framer Motion
- **認証**: Firebase Auth

### インフラ・DevOps
- **コンテナ**: Docker (推奨)
- **環境管理**: Environment Variables
- **CI/CD**: GitHub Actions (設定例)

## 📁 プロジェクト構造

```
mvp/
├── backend/                 # NestJS バックエンド
│   ├── src/
│   │   ├── entities/        # データベースエンティティ
│   │   ├── modules/         # 機能モジュール
│   │   │   ├── auth/        # 認証
│   │   │   ├── members/     # 議員管理
│   │   │   ├── pledges/     # 公約管理
│   │   │   ├── votes/       # 投票システム
│   │   │   ├── activity-logs/ # 活動ログ
│   │   │   ├── activity-funds/ # 政務活動費
│   │   │   ├── external-feeds/ # 外部フィード収集
│   │   │   └── admin/       # 管理画面
│   │   ├── config/          # 設定ファイル
│   │   └── main.ts          # アプリケーションエントリーポイント
│   ├── package.json
│   └── env.example
├── frontend/                # Next.js フロントエンド
│   ├── app/                 # App Router
│   ├── components/          # React コンポーネント
│   ├── contexts/            # React Context
│   ├── lib/                 # ユーティリティ
│   ├── package.json
│   └── env.example
└── README.md
```

## 🚀 セットアップ手順

### 前提条件
- Node.js 18+ 
- MySQL 8.0+
- Firebase プロジェクト
- Twitter API アカウント（オプション）

### 1. リポジトリのクローン
```bash
git clone <repository-url>
cd mvp
```

### 2. バックエンドのセットアップ
```bash
cd backend
npm install

# 環境変数の設定
cp env.example .env
# .env ファイルを編集して必要な値を設定

# データベースの作成
mysql -u root -p
CREATE DATABASE transparency_platform;

# アプリケーションの起動
npm run start:dev
```

### 3. フロントエンドのセットアップ
```bash
cd frontend
npm install

# 環境変数の設定
cp env.example .env.local
# .env.local ファイルを編集して必要な値を設定

# アプリケーションの起動
npm run dev
```

### 4. アクセス
- フロントエンド: http://localhost:3000
- バックエンドAPI: http://localhost:3001
- API ドキュメント: http://localhost:3001/api/docs

## 🔧 環境変数の設定

### バックエンド (.env)
```env
# Database Configuration
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=your_password
DB_DATABASE=transparency_platform

# JWT Configuration
JWT_SECRET=your_jwt_secret_key_here
JWT_EXPIRES_IN=24h

# Firebase Configuration
FIREBASE_PROJECT_ID=your_firebase_project_id
FIREBASE_PRIVATE_KEY_ID=your_firebase_private_key_id
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n..."
FIREBASE_CLIENT_EMAIL=your_firebase_client_email
FIREBASE_CLIENT_ID=your_firebase_client_id

# Twitter API Configuration (Optional)
TWITTER_API_KEY=your_twitter_api_key
TWITTER_API_SECRET=your_twitter_api_secret
TWITTER_ACCESS_TOKEN=your_twitter_access_token
TWITTER_ACCESS_SECRET=your_twitter_access_secret

# Application Configuration
NODE_ENV=development
PORT=3001
FRONTEND_URL=http://localhost:3000
```

### フロントエンド (.env.local)
```env
# Firebase Configuration
NEXT_PUBLIC_FIREBASE_API_KEY=your_firebase_api_key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your_project.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your_firebase_project_id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your_project.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your_messaging_sender_id
NEXT_PUBLIC_FIREBASE_APP_ID=your_firebase_app_id

# API Configuration
NEXT_PUBLIC_API_URL=http://localhost:3001/api
```

## 📊 データベーススキーマ

### 主要テーブル
- **members**: 議員情報
- **pledges**: 公約情報
- **activity_logs**: 活動ログ
- **activity_funds**: 政務活動費
- **users**: ユーザー情報
- **votes**: 投票データ

### リレーション
- 議員 → 公約 (1:N)
- 議員 → 活動ログ (1:N)
- 議員 → 政務活動費 (1:N)
- ユーザー → 投票 (1:N)
- 公約 → 投票 (1:N)

## 🔐 セキュリティ機能

- **認証**: Firebase Authentication
- **認可**: JWT トークンベース
- **入力検証**: class-validator
- **SQL インジェクション対策**: TypeORM
- **レート制限**: Throttler
- **CORS**: 適切な設定
- **セキュリティヘッダー**: Helmet

## 📈 外部データ収集

### 対応ソース
- **Twitter API v2**: 議員のツイート収集
- **RSS フィード**: ブログ・公式サイトの更新
- **手動投稿**: 管理画面からの投稿

### 収集スケジュール
- 30分間隔での自動収集
- エラー時の再試行機能
- 重複データの防止

## 🎨 UI/UX 特徴

- **レスポンシブデザイン**: モバイル・タブレット・デスクトップ対応
- **モダンなUI**: Tailwind CSS + Framer Motion
- **アクセシビリティ**: WCAG 2.1 準拠
- **ダークモード**: 対応予定
- **多言語対応**: 日本語（将来英語対応予定）

## 🧪 テスト

```bash
# バックエンドテスト
cd backend
npm run test
npm run test:e2e

# フロントエンドテスト
cd frontend
npm run test
```

## 🚀 デプロイ

### Docker を使用したデプロイ
```bash
# バックエンド
cd backend
docker build -t transparency-backend .
docker run -p 3001:3001 transparency-backend

# フロントエンド
cd frontend
docker build -t transparency-frontend .
docker run -p 3000:3000 transparency-frontend
```

### 本番環境での推奨設定
- **データベース**: MySQL 8.0+ (本番用)
- **Webサーバー**: Nginx (リバースプロキシ)
- **SSL**: Let's Encrypt
- **監視**: ログ監視、パフォーマンス監視
- **バックアップ**: 定期的なデータベースバックアップ

## 🤝 コントリビューション

1. このリポジトリをフォーク
2. フィーチャーブランチを作成 (`git checkout -b feature/amazing-feature`)
3. 変更をコミット (`git commit -m 'Add some amazing feature'`)
4. ブランチにプッシュ (`git push origin feature/amazing-feature`)
5. プルリクエストを作成

## 📝 ライセンス

このプロジェクトは MIT ライセンスの下で公開されています。詳細は [LICENSE](LICENSE) ファイルを参照してください。

## 📞 サポート

- **Issues**: GitHub Issues でバグ報告や機能要求
- **Discussions**: GitHub Discussions で質問や議論
- **Email**: info@transparency-platform.jp

## 🗺 ロードマップ

### Phase 1 (MVP) - 完了
- [x] 基本的な議員管理機能
- [x] 公約・投票システム
- [x] 活動ログ・政務活動費管理
- [x] 外部データ収集
- [x] 管理画面

### Phase 2 (拡張)
- [ ] コメント機能
- [ ] 地域別フィルター
- [ ] データエクスポート機能
- [ ] モバイルアプリ
- [ ] 多言語対応

### Phase 3 (高度な機能)
- [ ] AI による活動分析
- [ ] 予測分析
- [ ] リアルタイム通知
- [ ] 高度な可視化

---

**市民参加型 透明性データプラットフォーム** - 政治の透明性向上と市民参加の促進を目指して
</file>

<file path="setup-env.js">
const fs = require('fs');
const path = require('path');

// Create backend .env file
const backendEnv = `# Database Configuration
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=your_password
DB_DATABASE=transparency_platform

# JWT Configuration
JWT_SECRET=your_jwt_secret_key_here_${Math.random().toString(36).substring(2, 15)}
JWT_EXPIRES_IN=24h

# Firebase Configuration
FIREBASE_PROJECT_ID=your_firebase_project_id
FIREBASE_PRIVATE_KEY_ID=your_firebase_private_key_id
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\\nyour_firebase_private_key\\n-----END PRIVATE KEY-----\\n"
FIREBASE_CLIENT_EMAIL=your_firebase_client_email
FIREBASE_CLIENT_ID=your_firebase_client_id

# Twitter API Configuration (Optional)
TWITTER_API_KEY=your_twitter_api_key
TWITTER_API_SECRET=your_twitter_api_secret
TWITTER_ACCESS_TOKEN=your_twitter_access_token
TWITTER_ACCESS_SECRET=your_twitter_access_secret

# Application Configuration
NODE_ENV=development
PORT=3001
FRONTEND_URL=http://localhost:3000
SKIP_DATABASE=true
`;

// Create frontend .env.local file
const frontendEnv = `# Firebase Configuration (Demo values - replace with real ones)
NEXT_PUBLIC_FIREBASE_API_KEY=demo-api-key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=demo-project.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=demo-project
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=demo-project.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=123456789
NEXT_PUBLIC_FIREBASE_APP_ID=1:123456789:web:abcdef

# API Configuration
NEXT_PUBLIC_API_URL=http://localhost:3001/api
`;

try {
  // Write backend .env
  fs.writeFileSync(path.join(__dirname, 'backend', '.env'), backendEnv);
  console.log('✅ Created backend/.env file');
  
  // Write frontend .env.local
  fs.writeFileSync(path.join(__dirname, 'frontend', '.env.local'), frontendEnv);
  console.log('✅ Created frontend/.env.local file');
  
  console.log('\n📝 Next steps:');
  console.log('1. Update the environment variables with your actual values');
  console.log('2. Set up your Firebase project and add the credentials');
  console.log('3. Configure your MySQL database');
  console.log('4. Run: cd backend && npm install && npm run start:dev');
  console.log('5. Run: cd frontend && npm install && npm run dev');
  
} catch (error) {
  console.error('Error creating environment files:', error);
}
</file>

<file path="SETUP.md">
# 🚀 セットアップガイド

## 前提条件

- Node.js 18+ 
- MySQL 8.0+
- Git

## クイックスタート

### 1. 依存関係のインストール

```bash
# バックエンド
cd backend
npm install --legacy-peer-deps

# フロントエンド
cd ../frontend
npm install
```

### 2. 環境変数の設定

環境変数ファイルは既に作成されています：

- `backend/.env` - バックエンド設定
- `frontend/.env.local` - フロントエンド設定

**重要**: 実際の値に更新してください：

#### バックエンド (.env)
```env
# データベース設定
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=root
DB_PASSWORD=your_actual_password
DB_DATABASE=transparency_platform

# JWT設定
JWT_SECRET=your_actual_jwt_secret

# Firebase設定（本番環境用）
FIREBASE_PROJECT_ID=your_firebase_project_id
FIREBASE_PRIVATE_KEY_ID=your_firebase_private_key_id
FIREBASE_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
FIREBASE_CLIENT_EMAIL=your_firebase_client_email
FIREBASE_CLIENT_ID=your_firebase_client_id
```

#### フロントエンド (.env.local)
```env
# Firebase設定（本番環境用）
NEXT_PUBLIC_FIREBASE_API_KEY=your_actual_firebase_api_key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your_project.firebaseapp.com
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your_firebase_project_id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your_project.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your_messaging_sender_id
NEXT_PUBLIC_FIREBASE_APP_ID=your_firebase_app_id
```

### 3. データベースのセットアップ

```sql
-- MySQLに接続してデータベースを作成
CREATE DATABASE transparency_platform;
```

### 4. アプリケーションの起動

#### 方法1: 自動起動スクリプト（推奨）

**Windows:**
```bash
start-dev.bat
```

**Linux/Mac:**
```bash
chmod +x start-dev.sh
./start-dev.sh
```

#### 方法2: 手動起動

**ターミナル1 - バックエンド:**
```bash
cd backend
npm run start:dev
```

**ターミナル2 - フロントエンド:**
```bash
cd frontend
npm run dev
```

### 5. アクセス

- **フロントエンド**: http://localhost:3000
- **バックエンドAPI**: http://localhost:3001
- **API ドキュメント**: http://localhost:3001/api/docs

## 🔧 トラブルシューティング

### よくある問題

#### 1. Firebase認証エラー
```
Firebase: Error (auth/invalid-api-key)
```

**解決方法:**
- `frontend/.env.local` のFirebase設定を確認
- デモ値の場合は、実際のFirebaseプロジェクトの設定に更新

#### 2. データベース接続エラー
```
Error: connect ECONNREFUSED 127.0.0.1:3306
```

**解決方法:**
- MySQLが起動していることを確認
- `backend/.env` のデータベース設定を確認
- データベース `transparency_platform` が作成されていることを確認

#### 3. 依存関係の競合
```
npm error ERESOLVE unable to resolve dependency tree
```

**解決方法:**
```bash
cd backend
npm install --legacy-peer-deps
```

#### 4. ポートが既に使用中
```
Error: listen EADDRINUSE: address already in use :::3001
```

**解決方法:**
- 他のプロセスがポートを使用していないか確認
- 環境変数でポートを変更: `PORT=3002`

## 🎯 開発モードでの使用

現在の設定では、Firebase認証がデモモードで動作します：

1. **ログイン機能**: エラーメッセージが表示されますが、アプリケーションは動作します
2. **データ表示**: サンプルデータが表示されます
3. **API**: バックエンドAPIは完全に動作します

## 🔐 本番環境への移行

### 1. Firebase プロジェクトの設定

1. [Firebase Console](https://console.firebase.google.com/) でプロジェクトを作成
2. Authentication を有効化
3. サービスアカウントキーを生成
4. 環境変数に実際の値を設定

### 2. データベースの設定

1. 本番用MySQLサーバーをセットアップ
2. データベースとユーザーを作成
3. 環境変数を本番用に更新

### 3. セキュリティ設定

1. JWT秘密鍵を強力な値に変更
2. CORS設定を本番ドメインに制限
3. レート制限を適切に設定

## 📚 追加リソース

- [NestJS ドキュメント](https://docs.nestjs.com/)
- [Next.js ドキュメント](https://nextjs.org/docs)
- [Firebase ドキュメント](https://firebase.google.com/docs)
- [TypeORM ドキュメント](https://typeorm.io/)

## 🆘 サポート

問題が解決しない場合は：

1. GitHub Issues でバグ報告
2. ログファイルを確認
3. 環境変数の設定を再確認
4. 依存関係のバージョンを確認

---

**Happy Coding! 🎉**
</file>

<file path="start-dev.bat">
@echo off
echo Starting Transparency Platform Development Environment...
echo.

echo Starting Backend Server...
start "Backend Server" cmd /k "cd backend && npm run start:dev"

timeout /t 3 /nobreak > nul

echo Starting Frontend Server...
start "Frontend Server" cmd /k "cd frontend && npm run dev"

echo.
echo Both servers are starting...
echo Backend: http://localhost:3001
echo Frontend: http://localhost:3000
echo API Docs: http://localhost:3001/api/docs
echo.
echo Press any key to exit...
pause > nul
</file>

<file path="start-dev.sh">
#!/bin/bash

echo "Starting Transparency Platform Development Environment..."
echo

echo "Starting Backend Server..."
cd backend && npm run start:dev &
BACKEND_PID=$!

sleep 3

echo "Starting Frontend Server..."
cd ../frontend && npm run dev &
FRONTEND_PID=$!

echo
echo "Both servers are starting..."
echo "Backend: http://localhost:3001"
echo "Frontend: http://localhost:3000"
echo "API Docs: http://localhost:3001/api/docs"
echo
echo "Press Ctrl+C to stop both servers"

# Function to cleanup background processes
cleanup() {
    echo "Stopping servers..."
    kill $BACKEND_PID 2>/dev/null
    kill $FRONTEND_PID 2>/dev/null
    exit
}

# Set trap to cleanup on script exit
trap cleanup SIGINT SIGTERM

# Wait for background processes
wait
</file>

<file path="admin-frontend/app/comments/page.tsx">
'use client';
import React, { useEffect, useState } from 'react';

type Comment = {
  id: string;
  postTitle: string;
  content: string;
  author: string;
};

export default function CommentsPage() {
  const [comments, setComments] = useState<Comment[]>([]); // 初期値「配列」
  const [msg, setMsg] = useState('');

  useEffect(()=>{
    fetch('http://localhost:4000/api/admin/comments', { credentials: 'include' })
      .then(res=>res.json())
      .then(data=>setComments(Array.isArray(data) ? data : [])); // ←配列保証
  }, []);

  return (
    <div>
      <div className="text-green-600">{msg}</div>
      <div className="space-y-6">
        {comments.map(c=>(
          <div key={c.id} className="border rounded p-3">
            <div className="mb-1 font-bold">{c.postTitle}</div>
            <div className="mb-1">{c.content} <span className="text-xs text-gray-500">by {c.author}</span></div>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="admin-frontend/app/page.tsx">
import Image from "next/image";

export default function Home() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-zinc-50 font-sans dark:bg-black">
      <main className="flex min-h-screen w-full max-w-3xl flex-col items-center justify-between py-32 px-16 bg-white dark:bg-black sm:items-start">
        <Image
          className="dark:invert"
          src="/next.svg"
          alt="Next.js logo"
          width={100}
          height={20}
          priority
        />
        <div className="flex flex-col items-center gap-6 text-center sm:items-start sm:text-left">
          <h1 className="max-w-xs text-3xl font-semibold leading-10 tracking-tight text-black dark:text-white">
            To get started, edit the page.tsx file.
          </h1>
          <p className="max-w-md text-lg leading-8 text-black dark:text-white">
            Looking for a starting point or more instructions? Head over to{" "}
            <a
              href="https://vercel.com/templates?framework=next.js&utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
              className="font-medium text-zinc-950 dark:text-white underline"
            >
              Templates
            </a>{" "}
            or the{" "}
            <a
              href="https://nextjs.org/learn?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
              className="font-medium text-zinc-950 dark:text-white underline"
            >
              Learning
            </a>{" "}
            center.
          </p>
        </div>
        <div className="flex flex-col gap-4 text-base font-medium sm:flex-row">
          <a
            className="flex h-12 w-full items-center justify-center gap-2 rounded-full bg-foreground px-5 text-background transition-colors hover:bg-[#383838] dark:hover:bg-[#ccc] md:w-[158px]"
            href="https://vercel.com/new?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
            target="_blank"
            rel="noopener noreferrer"
          >
            <Image
              className="dark:invert"
              src="/vercel.svg"
              alt="Vercel logomark"
              width={16}
              height={16}
            />
            Deploy Now
          </a>
          <a
            className="flex h-12 w-full items-center justify-center rounded-full border border-solid border-black/[.08] px-5 transition-colors hover:border-transparent hover:bg-black/[.04] dark:border-white/[.145] dark:hover:bg-[#1a1a1a] md:w-[158px]"
            href="https://nextjs.org/docs?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
            target="_blank"
            rel="noopener noreferrer"
          >
            Documentation
          </a>
        </div>
      </main>
    </div>
  );
}
</file>

<file path="backend/src/auth/dto/login.dto.ts">
export class LoginDto {
  id!: string;
  password!: string;
}
</file>

<file path="backend/src/auth/dto/register-user.dto.ts">
export type AgeGroup = 'teen' | 'twenties' | 'thirties' | 'forties' | 'fifties' | 'sixties_plus';

export class RegisterUserDto {
  name!: string;
  nickname!: string;
  ageGroup!: AgeGroup;
  phone!: string;
  email!: string;
  password!: string;
  regionId?: string;
}
</file>

<file path="backend/src/auth/auth.controller.ts">
import { Body, Controller, Post, Req, UseGuards } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';
import { AuthService } from './auth.service';

@Controller('auth')
export class AuthController {
  constructor(private readonly auth: AuthService) {}

  @Post('login')
  async login(@Body() body: { id: string; password: string }) {
    return this.auth.login(body.id, body.password);
  }

  @UseGuards(AuthGuard('jwt'))
  @Post('me')
  async me(@Req() req: any) {
    const user = req.user;
    return { user };
  }
}
</file>

<file path="backend/src/auth/dev-login.controller.ts">
import { Controller, Post } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { Public } from '../common/decorators/public.decorator';

@Controller('dev/login')
export class DevLoginController {
  constructor(private readonly jwt: JwtService) {}

  @Public()
  @Post('admin')
  async admin() {
    // 開発用: 管理者権限のトークンを即発行
    const payload = {
      sub: 'admin-dev-id',
      role: 'admin',
      email: 'dev-admin@example.com',
    };
    const accessToken = await this.jwt.signAsync(payload);
    return { accessToken };
  }
}
</file>

<file path="backend/src/auth/jwt.strategy.ts">
import { Injectable } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor() {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      secretOrKey: process.env.JWT_SECRET || 'dev_secret',
      ignoreExpiration: false,
    });
  }

  async validate(payload: any) {
    return payload;
  }
}
</file>

<file path="backend/src/common/decorators/roles.decorator.ts">
// backend/src/common/decorators/roles.decorator.ts (全体コード)

import { SetMetadata } from '@nestjs/common';
// 役割の Enum をインポートします
import { UserRole } from '../../modules/users/user.entity';

// ロールデコレータをエクスポート
export const Roles = (...roles: UserRole[]) => SetMetadata('roles', roles);
</file>

<file path="backend/src/common/filters/http-exception.filter.ts">
import {
  ArgumentsHost,
  Catch,
  ExceptionFilter,
  HttpException,
  HttpStatus,
} from '@nestjs/common';
import { Request, Response } from 'express';

@Catch()
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: any, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const res = ctx.getResponse<Response>();
    const req = ctx.getRequest<Request>();

    const isHttp = exception instanceof HttpException;
    const status = isHttp
      ? (exception as HttpException).getStatus()
      : HttpStatus.INTERNAL_SERVER_ERROR;

    const responseBody = isHttp
      ? (exception as HttpException).getResponse()
      : undefined;

    // Nest の HttpException の message は string/obj の可能性がある
    const message = ((): string => {
      if (!isHttp) return 'Internal server error';
      if (typeof responseBody === 'string') return responseBody;
      if (responseBody && typeof responseBody === 'object') {
        // class-validator のメッセージ配列などに対応
        if (Array.isArray((responseBody as any).message)) {
          return (responseBody as any).message.join('; ');
        }
        return (responseBody as any).message || (responseBody as any).error || 'Error';
      }
      return 'Error';
    })();

    // 共通エラーフォーマット
    const payload = {
      success: false,
      error: {
        statusCode: status,
        message,
        path: req.originalUrl || req.url,
        timestamp: new Date().toISOString(),
        // 必要に応じてアプリ固有のエラーコードを付与可能
        // code: (responseBody as any)?.code,
        // details: (responseBody as any)?.details,
      },
    };

    res.status(status).json(payload);
  }
}
</file>

<file path="backend/src/common/guards/jwt-auth.guard.ts">
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {}
</file>

<file path="backend/src/common/guards/roles.guard.ts">
// backend/src/common/guards/roles.guard.ts (全体コード)

import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { UserRole } from '../../modules/users/user.entity';

@Injectable()
export class RolesGuard implements CanActivate {
  // Reflector を使用して、デコレータで設定されたメタデータ（必要なロール）を読み取ります
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    // 1. メソッドやクラスに設定された 'roles' メタデータを取得
    const requiredRoles = this.reflector.getAllAndOverride<UserRole[]>('roles', [
      context.getHandler(), // メソッド（例: createPost）
      context.getClass(),   // クラス（例: PostsController）
    ]);
    
    // 2. ロール設定がない場合は、アクセスを許可
    if (!requiredRoles) {
      return true;
    }

    // 3. リクエストから認証済みユーザー情報を取得
    const request = context.switchToHttp().getRequest();
    // ⚠️ 前提: JWT Guard などで認証後、ユーザー情報が req.user に付与されている必要があります。
    const user = request.user; 

    // 4. ユーザー情報がない、またはロールがない場合はアクセスを拒否
    if (!user || !user.role) {
      return false;
    }

    // 5. ユーザーのロールが必要なロールリストに含まれているかチェック
    // 政治家('politician')または管理者('admin')のどちらかであれば true を返す
    return requiredRoles.some((role) => user.role === role);
  }
}
</file>

<file path="backend/src/common/interceptors/response.interceptor.ts">
import { CallHandler, ExecutionContext, Injectable, NestInterceptor } from '@nestjs/common';
import { Observable } from 'rxjs';
import { map } from 'rxjs/operators';

@Injectable()
export class ResponseInterceptor implements NestInterceptor {
  intercept(_context: ExecutionContext, next: CallHandler): Observable<any> {
    return next.handle().pipe(map((data) => ({ ok: true, data })));
  }
}
</file>

<file path="backend/src/config/database.config.ts">
import { ConfigService } from '@nestjs/config';
import { TypeOrmModuleOptions } from '@nestjs/typeorm';

export function getDatabaseConfig(configService: ConfigService): TypeOrmModuleOptions {
  return {
    type: 'mysql',
    host: configService.get<string>('DB_HOST', 'localhost'),
    port: Number(configService.get<number>('DB_PORT', 3306)),
    username: configService.get<string>('DB_USERNAME', 'root'),
    password: configService.get<string>('DB_PASSWORD', 'password'),
    database: configService.get<string>('DB_DATABASE', 'transparency_platform'),
    entities: [
      __dirname + '/../modules/**/*.entity.{ts,js}',
      __dirname + '/../entities/**/*.entity.{ts,js}'
    ],
    synchronize: true,
    charset: 'utf8mb4',
    logging: false
  };
}
</file>

<file path="backend/src/config/firebase.config.ts">
import * as admin from 'firebase-admin';

export function initializeFirebase(_token?: string) {
  if (admin.apps.length === 0) {
    admin.initializeApp({
      credential: admin.credential.applicationDefault(),
    });
  }
  return admin;
}
</file>

<file path="backend/src/entities/audit-log.entity.ts">
import { Column, CreateDateColumn, Entity, Index, PrimaryGeneratedColumn } from 'typeorm';

@Entity('audit_logs')
export class AuditLog {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  @Index()
  @Column({ type: 'uuid', nullable: true })
  actorUserId!: string | null;

  @Index()
  @Column({ type: 'varchar', length: 64, nullable: true })
  targetType!: string | null;

  @Index()
  @Column({ type: 'varchar', length: 64, nullable: true })
  targetId!: string | null;

  @Index()
  @Column({ type: 'varchar', length: 64 })
  action!: string;

  @Column({ type: 'varchar', length: 512, nullable: true })
  message!: string | null;

  @Column({ type: 'jsonb', nullable: true })
  meta!: Record<string, any> | null;

  @CreateDateColumn({ type: 'timestamp with time zone' })
  createdAt!: Date;
}
</file>

<file path="backend/src/entities/comment-like.entity.ts">
import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, Index } from 'typeorm';

@Entity('comment_likes')
@Index(['commentId', 'userId'], { unique: true })
export class CommentLike {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  @Index()
  @Column({ type: 'uuid' })
  commentId!: string;

  @Index()
  @Column({ type: 'uuid' })
  userId!: string;

  // Postgres対応: datetime ではなく timestamp with time zone を使用
  @CreateDateColumn({ type: 'timestamp with time zone' })
  createdAt!: Date;
}
</file>

<file path="backend/src/entities/comment-reaction.entity.ts">
import { Column, CreateDateColumn, Entity, Index, ManyToOne, PrimaryGeneratedColumn, Unique } from 'typeorm';
import { Comment } from './comment.entity';

@Entity('comment_reactions')
@Unique('UQ_comment_user_type', ['commentId', 'userId', 'type'])
export class CommentReaction {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Index()
  @Column()
  commentId: string;

  @ManyToOne(() => Comment, (c) => c.reactions, { onDelete: 'CASCADE' })
  comment: Comment;

  @Index()
  @Column()
  userId: string;

  @Column({ length: 32 })
  type: string;

  @CreateDateColumn()
  createdAt: Date;
}
</file>

<file path="backend/src/entities/follow.entity.ts">
import { Column, CreateDateColumn, Entity, Index, ManyToOne, PrimaryGeneratedColumn, Unique } from 'typeorm';
import { User } from './user.entity';

@Entity('follows')
@Unique('UQ_follow_pair', ['followerUserId', 'targetUserId'])
export class Follow {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Index()
  @Column()
  followerUserId: string;

  @ManyToOne(() => User, { onDelete: 'CASCADE' })
  follower: User;

  @Index()
  @Column()
  targetUserId: string;

  @ManyToOne(() => User, { onDelete: 'CASCADE' })
  target: User;

  @CreateDateColumn()
  createdAt: Date;
}
</file>

<file path="backend/src/entities/funding-record.entity.ts">
import { Column, CreateDateColumn, Entity, Index, ManyToOne, PrimaryGeneratedColumn, UpdateDateColumn } from 'typeorm';
import { Politician } from 'src/entities/politician.entity';
import { Member } from 'src/entities/member.entity';

@Entity('funding_records')
export class FundingRecord {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  @Index()
  @Column({ type: 'uuid' })
  politicianId!: string;

  @ManyToOne(() => Politician, (p) => p.id, { onDelete: 'CASCADE' })
  politician!: Politician;

  @Index()
  @Column({ type: 'uuid', nullable: true })
  memberId!: string | null;

  @ManyToOne(() => Member, (m) => m.id, { onDelete: 'SET NULL', nullable: true })
  member!: Member | null;

  // 金額
  @Column({ type: 'int' })
  amount!: number;

  // 区分（寄付、支出など）
  @Column({ type: 'varchar', length: 64 })
  category!: string;

  // 会計年度（必要なら）
  @Index()
  @Column({ type: 'int', nullable: true })
  fiscalYear!: number | null;

  // 日付（費用発生日など）
  @Index()
  @Column({ type: 'date', nullable: true })
  expenseDate!: Date | null;

  // 備考
  @Column({ type: 'varchar', length: 256, nullable: true })
  note!: string | null;

  // 作成日時（PostgreSQL対応: datetimeではなくtimestamp with time zone）
  @CreateDateColumn({ type: 'timestamp with time zone' })
  createdAt!: Date;

  // 更新日時
  @UpdateDateColumn({ type: 'timestamp with time zone' })
  updatedAt!: Date;
}
</file>

<file path="backend/src/entities/media.entity.ts">
import {
  Column,
  CreateDateColumn,
  Entity,
  Index,
  ManyToOne,
  PrimaryGeneratedColumn,
  UpdateDateColumn,
} from 'typeorm';
import { User } from 'src/entities/user.entity';

@Entity('media')
export class Media {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  // 所有者（アップロードしたユーザー）
  @Index()
  @Column({ type: 'uuid', nullable: true })
  ownerUserId!: string | null;

  @ManyToOne(() => User, (user) => user.id, { onDelete: 'SET NULL', nullable: true })
  owner!: User | null;

  // カテゴリ（例: avatar, post, document など）
  @Index()
  @Column({ type: 'varchar', length: 64, nullable: true })
  category!: string | null;

  // メディアタイプ（例: image, video, document）
  @Index()
  @Column({ type: 'varchar', length: 64 })
  type!: string;

  // ストレージ上の保存パス
  @Index()
  @Column({ type: 'varchar', length: 256 })
  path!: string;

  // アップロード元のファイル名
  @Column({ type: 'varchar', length: 256, nullable: true })
  originalName!: string | null;

  // バイトサイズ
  @Column({ type: 'int', nullable: true })
  sizeBytes!: number | null;

  // MIMEタイプ
  @Column({ type: 'varchar', length: 128, nullable: true })
  mimeType!: string | null;

  // 任意メタデータ
  @Column({ type: 'jsonb', nullable: true })
  meta!: Record<string, any> | null;

  @CreateDateColumn({ type: 'timestamp with time zone' })
  createdAt!: Date;

  @UpdateDateColumn({ type: 'timestamp with time zone' })
  updatedAt!: Date;
}
</file>

<file path="backend/src/entities/ng-word.entity.ts">
import { Column, CreateDateColumn, Entity, Index, PrimaryGeneratedColumn, UpdateDateColumn } from 'typeorm';

@Entity('ng_words')
export class NgWord {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  @Index()
  @Column({ type: 'varchar', length: 128 })
  word!: string;

  @Column({ type: 'varchar', length: 64, nullable: true })
  category!: string | null;

  @Column({ type: 'boolean', default: true })
  active!: boolean;

  // Postgres対応: datetime -> timestamp with time zone
  @CreateDateColumn({ type: 'timestamp with time zone' })
  createdAt!: Date;

  @UpdateDateColumn({ type: 'timestamp with time zone' })
  updatedAt!: Date;
}
</file>

<file path="backend/src/entities/notification.entity.ts">
import { Column, CreateDateColumn, Entity, Index, ManyToOne, PrimaryGeneratedColumn } from 'typeorm';
import { User } from './user.entity';
import { NotificationType } from '../enums/notification-type.enum';

@Entity('notifications')
export class Notification {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Index()
  @Column()
  userId: string;

  @ManyToOne(() => User, { onDelete: 'CASCADE' })
  user: User;

  @Column({ type: 'enum', enum: NotificationType })
  type: NotificationType;

  @Column({ length: 256 })
  title: string;

  @Column({ type: 'text' })
  body: string;

  @Column({ type: 'timestamptz', nullable: true })
  readAt: Date | null;

  @CreateDateColumn()
  createdAt: Date;
}
</file>

<file path="backend/src/entities/policy.entity.ts">
import { Column, CreateDateColumn, Entity, Index, PrimaryGeneratedColumn, UpdateDateColumn } from 'typeorm';

@Entity('policies')
export class Policy {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  @Index()
  @Column({ type: 'uuid' })
  politicianId!: string;

  @Column({ type: 'varchar', length: 256 })
  title!: string;

  @Column({ type: 'text' })
  content!: string;

  @Column({ type: 'varchar', length: 64, nullable: true })
  category!: string | null;

  @Column({ type: 'varchar', length: 32, default: 'draft' })
  status!: string;

  // 修正: Postgresでは 'datetime' 非対応。'timestamp with time zone' を使用
  @Index()
  @Column({ type: 'timestamp with time zone', nullable: true })
  publishedAt!: Date | null;

  @CreateDateColumn({ type: 'timestamp with time zone' })
  createdAt!: Date;

  @UpdateDateColumn({ type: 'timestamp with time zone' })
  updatedAt!: Date;
}
</file>

<file path="backend/src/entities/politician-profile.entity.ts">
import { Column, CreateDateColumn, Entity, Index, PrimaryGeneratedColumn, UpdateDateColumn } from 'typeorm';

@Entity('politician_profiles')
export class PoliticianProfile {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  @Index()
  @Column({ type: 'uuid' })
  politicianId!: string;

  // プロフィールの各種文字列項目は varchar で明示
  @Column({ type: 'varchar', length: 256, nullable: true })
  occupation!: string | null;

  @Column({ type: 'varchar', length: 256, nullable: true })
  homepageUrl!: string | null;

  // 修正点: Object 型ではなく varchar に変更
  @Column({ type: 'varchar', length: 512, nullable: true })
  fundingReportUrl!: string | null;

  @Column({ type: 'varchar', length: 256, nullable: true })
  officeAddress!: string | null;

  @Column({ type: 'varchar', length: 64, nullable: true })
  phoneNumber!: string | null;

  @Column({ type: 'varchar', length: 256, nullable: true })
  email!: string | null;

  // 自由記述フィールドは text か jsonb を使用
  @Column({ type: 'text', nullable: true })
  biography!: string | null;

  @Column({ type: 'jsonb', nullable: true })
  extra!: Record<string, any> | null;

  @CreateDateColumn({ type: 'timestamp with time zone' })
  createdAt!: Date;

  @UpdateDateColumn({ type: 'timestamp with time zone' })
  updatedAt!: Date;
}
</file>

<file path="backend/src/entities/post.entity.ts">
import {
  Column,
  CreateDateColumn,
  Entity,
  Index,
  ManyToOne,
  OneToMany,
  PrimaryGeneratedColumn,
  UpdateDateColumn,
} from 'typeorm';
import { User } from 'src/entities/user.entity';
import { Vote } from 'src/entities/vote.entity';

@Entity('posts')
export class Post {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  @Index()
  @Column({ type: 'uuid', nullable: true })
  authorUserId!: string | null;

  @ManyToOne(() => User, (user) => user.posts)
  author!: User;

  @OneToMany(() => Vote, (vote) => vote.post)
  votes!: Vote[];

  @Column({ type: 'varchar', length: 256 })
  title!: string;

  @Column({ type: 'text' })
  content!: string;

  @Column({ type: 'varchar', length: 32 })
  type!: string;

  @Column({ type: 'varchar', length: 64, nullable: true })
  regionId!: string | null;

  @Column({ type: 'jsonb', nullable: true })
  mediaIds!: string[] | null;

  @CreateDateColumn()
  createdAt!: Date;

  @UpdateDateColumn()
  updatedAt!: Date;
}
</file>

<file path="backend/src/entities/report.entity.ts">
import { Column, CreateDateColumn, Entity, Index, PrimaryGeneratedColumn, UpdateDateColumn } from 'typeorm';

export type ReportStatus = 'pending' | 'reviewed' | 'actioned' | 'rejected' | 'open' | 'reviewing' | 'resolved' | 'dismissed';
export type ReportTargetType = 'user' | 'post' | 'comment';

@Entity('reports')
export class Report {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  @Index()
  @Column({ type: 'uuid' })
  reporterId!: string;

  @Index()
  @Column({ type: 'varchar', length: 32 })
  targetType!: ReportTargetType;

  @Index()
  @Column({ type: 'uuid' })
  targetId!: string;

  @Column({ type: 'varchar', length: 64 })
  type!: string;

  @Column({ type: 'jsonb', nullable: true })
  data!: Record<string, any> | null;

  @Index()
  @Column({ type: 'varchar', length: 32, default: 'pending' })
  status!: ReportStatus;

  @Column({ type: 'varchar', length: 512, nullable: true })
  adminNote!: string | null;

  @CreateDateColumn({ type: 'timestamp with time zone' })
  createdAt!: Date;

  @UpdateDateColumn({ type: 'timestamp with time zone' })
  updatedAt!: Date;
}
</file>

<file path="backend/src/entities/scheduled-post.entity.ts">
import {
  Column,
  CreateDateColumn,
  Entity,
  Index,
  ManyToOne,
  PrimaryGeneratedColumn,
  UpdateDateColumn,
} from 'typeorm';
import { Post } from 'src/entities/post.entity';
import { User } from 'src/entities/user.entity';

@Entity('scheduled_posts')
export class ScheduledPost {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  // 投稿元の下書きや関連postIdがある場合（任意）
  @Index()
  @Column({ type: 'uuid', nullable: true })
  postId!: string | null;

  @ManyToOne(() => Post, (post) => post.id, { onDelete: 'CASCADE', nullable: true })
  post!: Post | null;

  // 作成ユーザー（service は authorId を使用している）
  @Index()
  @Column({ type: 'uuid' })
  authorId!: string;

  // 既存の authorUserId を使用する実装がある場合の互換用（任意）
  @Index()
  @Column({ type: 'uuid', nullable: true })
  authorUserId!: string | null;

  @ManyToOne(() => User, (user) => user.id, { onDelete: 'CASCADE' })
  author!: User;

  // 投稿日時（PostgreSQLでは datetime ではなく timestamp 系を使用）
  @Index()
  @Column({ type: 'timestamp with time zone' })
  scheduledAt!: Date;

  // 投稿内容関連
  @Column({ type: 'varchar', length: 256 })
  title!: string;

  @Column({ type: 'text' })
  body!: string;

  @Column({ type: 'jsonb', nullable: true })
  tags!: string[] | null;

  // 投稿後の状態管理
  @Column({ type: 'varchar', length: 32, default: 'pending' })
  status!: string;

  @Index()
  @Column({ type: 'uuid', nullable: true })
  postedPostId!: string | null;

  @Column({ type: 'varchar', length: 512, nullable: true })
  failureReason!: string | null;

  @CreateDateColumn({ type: 'timestamp with time zone' })
  createdAt!: Date;

  @UpdateDateColumn({ type: 'timestamp with time zone' })
  updatedAt!: Date;
}
</file>

<file path="backend/src/enums/activity-log-type.enum.ts">
export enum ActivityLogType {
  TWITTER = 'twitter',
  SYSTEM = 'system',
  USER = 'user',
  MANUAL = 'manual',
}
</file>

<file path="backend/src/guards/roles.decorator.ts">
import { SetMetadata } from '@nestjs/common';
import type { UserRole } from '../enums/user-role.enum';

export const Roles = (...roles: UserRole[]) => SetMetadata('roles', roles);
</file>

<file path="backend/src/guards/roles.guard.ts">
import { CanActivate, ExecutionContext, Injectable, ForbiddenException } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import type { UserRole } from '../enums/user-role.enum';

@Injectable()
export class RolesGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(ctx: ExecutionContext): boolean {
    const requiredRoles = this.reflector.get<UserRole[]>('roles', ctx.getHandler()) || [];
    if (requiredRoles.length === 0) return true;

    const req = ctx.switchToHttp().getRequest();
    const user = req.user;
    if (!user || !requiredRoles.includes(user.role)) {
      throw new ForbiddenException('Insufficient role');
    }
    return true;
  }
}
</file>

<file path="backend/src/lib/swagger-fallback.ts">
export function swaggerFallback(_t: unknown) {
  return (_req: unknown, _res: unknown, next: Function) => {
    next();
  };
}
</file>

<file path="backend/src/middleware/rate-limit.middleware.ts">
import { Injectable, NestMiddleware } from '@nestjs/common';

@Injectable()
export class RateLimitMiddleware implements NestMiddleware {
  use(_req: any, _res: any, next: Function) {
    // simplistic passthrough; replace with actual rate limit if needed
    next();
  }
}
</file>

<file path="backend/src/modules/activity-funds/dto/update-activity-fund.dto.ts">
// NOTE: PartialType を使わず手書きで optional にする
export class UpdateActivityFundDto {
  // 例: CreateActivityFundDto に title: string; amount: number; description?: string; があると仮定
  title?: string;
  amount?: number;
  description?: string;
  // 他に CreateActivityFundDto で定義しているフィールドがあればすべて ? を付けて追加
}
</file>

<file path="backend/src/modules/activity-funds/activity-funds.controller.ts">
import { Controller, Get, Post, UploadedFile, UseInterceptors } from '@nestjs/common';
import { FileInterceptor } from '@nestjs/platform-express';

@Controller('activity-funds')
export class ActivityFundsController {
  @Get()
  list() {
    const dummyData: any[] = [];
    return { ok: true, data: dummyData };
  }

  @Post('upload')
  @UseInterceptors(FileInterceptor('file'))
  upload(@UploadedFile() _file: Express.Multer.File) {
    return { ok: true };
  }
}
</file>

<file path="backend/src/modules/activity-funds/activity-funds.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ActivityFund } from '../../entities/activity-fund.entity';
import { ActivityFundsService } from './activity-funds.service';
import { ActivityFundsController } from './activity-funds.controller';

@Module({
  imports: [TypeOrmModule.forFeature([ActivityFund])],
  providers: [ActivityFundsService],
  controllers: [ActivityFundsController],
  exports: [ActivityFundsService],
})
export class ActivityFundsModule {}
</file>

<file path="backend/src/modules/activity-logs/activity-log.entity.ts">
import {
  Entity,
  PrimaryGeneratedColumn,
  Column,
  ManyToOne,
  CreateDateColumn,
  Index,
} from 'typeorm';
import { Member } from '../../entities/member.entity';

@Entity('activity_logs')
export class ActivityLog {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ type: 'varchar' })
  type: string; // e.g. 'post_created' | 'vote_cast' | 'external_feed_import'

  @Column({ type: 'text', nullable: true })
  detail?: string;

  @Column({ type: 'varchar', nullable: true })
  source?: string; // 'twitter', 'manual', etc.

  @Index()
  @Column({ type: 'varchar', nullable: true })
  externalId?: string; // external feed id (tweet id 等)

  @Column({ type: 'datetime', nullable: true })
  publishedAt?: Date; // 外部コンテンツ発生時刻

  @ManyToOne(() => Member, (m) => m.activityLogs, { onDelete: 'CASCADE' })
  member: Member;

  @CreateDateColumn({ type: 'datetime' })
  createdAt: Date;
}
</file>

<file path="backend/src/modules/activity-logs/activity-log.service.ts">
import { Injectable } from '@nestjs/common';

@Injectable()
export class ActivityLogService {
  async log(_actorUserId: string | null, action: string, data: Record<string, any>) {
    // 未使用引数警告回避のため _actorUserId とする
    // TODO: 実ログ保存処理
    return { ok: true, action, data };
  }
}
</file>

<file path="backend/src/modules/admin/admin.bulk-posts.controller.ts">
import { Controller, Post, Body } from '@nestjs/common';
import * as bcrypt from 'bcryptjs';

@Controller('admin/bulk-posts')
export class AdminBulkPostsController {
  @Post('create')
  async create(@Body() body: any) {
    // 開発用のダミー処理（実際の一括作成は、対象エンティティのサービスで行ってください）
    const hash = body?.password ? await bcrypt.hash(String(body.password), 10) : undefined;
    return { ok: true, hashed: Boolean(hash) };
  }
}
</file>

<file path="backend/src/modules/admin/admin.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from '../../entities/user.entity';
import { Post } from '../posts/post.entity';
import { AdminController } from './admin.controller';
import { AdminPostsController } from './admin.posts.controller';
import { AdminPoliticiansController } from './admin.politicians.controller';
import { AdminBulkPostsController } from './admin.bulk-posts.controller';

@Module({
  imports: [TypeOrmModule.forFeature([User, Post])],
  controllers: [AdminController, AdminPostsController, AdminPoliticiansController, AdminBulkPostsController],
})
export class AdminModule {}
</file>

<file path="backend/src/modules/admin/admin.politicians.controller.ts">
import { Controller, Post, Body } from '@nestjs/common';
import * as bcrypt from 'bcryptjs';

@Controller('admin/politicians')
export class AdminPoliticiansController {
  @Post('create')
  async create(@Body() body: any) {
    const hash = body?.password ? await bcrypt.hash(String(body.password), 10) : undefined;
    return { ok: true, hashed: Boolean(hash) };
  }
}
</file>

<file path="backend/src/modules/admin/admin.posts.controller.ts">
import { Body, Controller, Post as HttpPost } from '@nestjs/common';
import * as bcrypt from 'bcryptjs';

@Controller('admin/posts')
export class AdminPostsController {
  @HttpPost('create')
  async create(@Body() body: any) {
    const hash = body?.password ? await bcrypt.hash(String(body.password), 10) : undefined;
    return { ok: true, hashed: Boolean(hash) };
  }
}
</file>

<file path="backend/src/modules/admin-search/admin-search.controller.ts">
import { Controller, Get, Query } from '@nestjs/common';
import { Repository } from 'typeorm';
import { InjectRepository } from '@nestjs/typeorm';
import { User } from 'src/entities/user.entity';

@Controller('admin/search')
export class AdminSearchController {
  constructor(@InjectRepository(User) private readonly usersRepo: Repository<User>) {}

  @Get('users')
  async searchUsers(@Query('q') q: string) {
    // 簡易検索（ILike 不使用）
    return this.usersRepo
      .createQueryBuilder('u')
      .where('u.email LIKE :q OR u.nickname LIKE :q', { q: `%${q}%` })
      .orderBy('u.createdAt', 'DESC')
      .take(50)
      .getMany();
  }
}
</file>

<file path="backend/src/modules/analytics/analytics.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { AnalyticsService } from './analytics.service';
import { AnalyticsController } from './analytics.controller';
import { User } from '../../entities/user.entity';
import { Post } from '../../entities/post.entity';
import { Comment } from '../../entities/comment.entity';
import { Vote } from '../../entities/vote.entity';
import { Follow } from '../../entities/follow.entity';

@Module({
  imports: [TypeOrmModule.forFeature([User, Post, Comment, Vote, Follow])],
  controllers: [AnalyticsController],
  providers: [AnalyticsService],
  exports: [AnalyticsService],
})
export class AnalyticsModule {}
</file>

<file path="backend/src/modules/analytics/analytics.service.ts">
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { User } from 'src/entities/user.entity';
import { Post } from 'src/entities/post.entity';
import { Comment } from 'src/entities/comment.entity';
import { Vote } from 'src/entities/vote.entity';
import { Follow } from 'src/entities/follow.entity';
import { UserRoleEnum } from 'src/enums/user-role.enum';
import { VoteChoice } from 'src/enums/vote-choice.enum';

@Injectable()
export class AnalyticsService {
  constructor(
    @InjectRepository(User) private readonly users: Repository<User>,
    @InjectRepository(Post) private readonly posts: Repository<Post>,
    @InjectRepository(Comment) private readonly comments: Repository<Comment>,
    @InjectRepository(Vote) private readonly votes: Repository<Vote>,
    @InjectRepository(Follow) private readonly follows: Repository<Follow>,
  ) {}

  private async assertPolitician(userId: string) {
    const user = await this.users.findOne({ where: { id: userId } });
    if (!user) throw new NotFoundException('User not found');
    if (user.role !== UserRoleEnum.POLITICIAN && user.role !== UserRoleEnum.ADMIN) {
      throw new NotFoundException('Not a politician');
    }
    return user;
  }

  async myPostsSummary(userId: string) {
    await this.assertPolitician(userId);
    const posts = await this.posts.find({ where: { authorUserId: userId } });
    const result = [];

    for (const p of posts) {
      const votes = await this.votes.find({ where: { postId: p.id } });
      const commentsCount = await this.comments.count({ where: { postId: p.id } });

      const agree = votes.filter((v) => v.choice === VoteChoice.AGREE).length;
      const disagree = votes.filter((v) => v.choice === VoteChoice.DISAGREE).length;

      result.push({
        postId: p.id,
        title: p.title,
        type: p.type,
        createdAt: p.createdAt,
        votes: { agree, disagree, total: votes.length },
        comments: commentsCount,
      });
    }

    result.sort((a, b) => +new Date(b.createdAt) - +new Date(a.createdAt));
    return result;
  }

  async followersDemographics(userId: string) {
    await this.assertPolitician(userId);
    const rows = await this.follows
      .createQueryBuilder('f')
      .leftJoinAndSelect('f.follower', 'user')
      .leftJoinAndSelect('user.region', 'region')
      .leftJoinAndSelect('user.supportedParty', 'party')
      .where('f.targetUserId = :uid', { uid: userId })
      .getMany();

    const agg = {
      total: rows.length,
      ageGroup: {} as Record<string, number>,
      region: {} as Record<string, number>,
      party: {} as Record<string, number>,
    };

    for (const r of rows) {
      const age = (r as any).follower?.ageGroup ?? 'unknown';
      const regionName = (r as any).follower?.region?.name ?? 'unknown';
      const partyName = (r as any).follower?.supportedParty?.name ?? 'unknown';
      agg.ageGroup[age] = (agg.ageGroup[age] || 0) + 1;
      agg.region[regionName] = (agg.region[regionName] || 0) + 1;
      agg.party[partyName] = (agg.party[partyName] || 0) + 1;
    }
    return agg;
  }

  async exportMyPostsCsv(userId: string): Promise<string> {
    const rows = await this.myPostsSummary(userId);
    const header = ['postId', 'title', 'type', 'createdAt', 'votesAgree', 'votesDisagree', 'votesTotal', 'comments'];
    const lines = [header.join(',')];

    for (const r of rows) {
      lines.push(
        [
          r.postId,
          escapeCsv(r.title),
          r.type,
          new Date(r.createdAt).toISOString(),
          r.votes.agree,
          r.votes.disagree,
          r.votes.total,
          r.comments,
        ].join(','),
      );
    }
    return lines.join('\n');

    function escapeCsv(val: any) {
      const s = String(val ?? '');
      return /[",\n]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
    }
  }
}
</file>

<file path="backend/src/modules/auth/strategies/firebase.strategy.ts">
import { Injectable, Inject } from '@nestjs/common';

@Injectable()
export class FirebaseStrategy {
  constructor(@Inject('FIREBASE_ADMIN') private readonly _firebaseAdmin: any) {}

  async validateToken(_token: string): Promise<boolean> {
    // 参照して未使用エラーを解消
    void this._firebaseAdmin;
    return true;
  }
}
</file>

<file path="backend/src/modules/auth/strategies/jwt.strategy.ts">
import { Injectable } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';

const JWT_SECRET = process.env.JWT_SECRET || 'dev-secret';
const isProd = process.env.NODE_ENV === 'production';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor() {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      secretOrKey: JWT_SECRET,
      ignoreExpiration: false,
    });
    if (!isProd) {
      // 開発時のみ詳細ログ
      console.log('[JwtStrategy] initialized');
    }
  }

  async validate(payload: { sub: string; role: string; email?: string }) {
    if (!isProd) {
      console.log('[JwtStrategy] validate payload:', payload);
    }
    return { sub: payload.sub, role: payload.role, email: payload.email };
  }
}
</file>

<file path="backend/src/modules/auth/jwt.strategy.ts">
import { Injectable } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';
import { ConfigService } from '@nestjs/config';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor(config: ConfigService) {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      secretOrKey: config.get<string>('JWT_SECRET') || 'dev-secret',
    });
  }

  async validate(payload: { sub: string; role: string }) {
    return { sub: payload.sub, role: payload.role };
  }
}
</file>

<file path="backend/src/modules/comments/dto/create-reply.dto.ts">
import { IsString, IsOptional } from 'class-validator';
import { CreateCommentDto } from './create-comment.dto';

/**
 * CreateReplyDto: inherits CreateCommentDto, defines body (no override keyword)
 */
export class CreateReplyDto extends CreateCommentDto {
  @IsString()
  body: string;

  @IsOptional()
  mediaId?: string;
}
</file>

<file path="backend/src/modules/comments/comment.entity.ts">
import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, Index } from 'typeorm';

@Entity('comments')
@Index(['postId'])
export class Comment {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  postId: string;

  @Column({ nullable: true })
  authorId?: string;

  @Column({ type: 'text' })
  content: string;

  @Column({ type: 'boolean', default: false })
  hidden: boolean;

  @CreateDateColumn({ type: 'datetime' })
  createdAt: Date;
}
</file>

<file path="backend/src/modules/external-feeds/external-feeds.module.ts">
import { Module } from '@nestjs/common';
import { ExternalFeedsService } from './external-feeds.service';
import { ActivityLogsModule } from '../activity-logs/activity-logs.module';
import { ExternalFeedsController } from './external-feeds.controller';

@Module({
  imports: [ActivityLogsModule],
  providers: [ExternalFeedsService],
  controllers: [ExternalFeedsController],
  exports: [ExternalFeedsService],
})
export class ExternalFeedsModule {}
</file>

<file path="backend/src/modules/external-feeds/external-feeds.service.ts">
import { Injectable } from '@nestjs/common';
import { ActivityLogsService } from '../activity-logs/activity-logs.service';

export type ExternalTweet = {
  id: string;
  text: string;
  created_at: string;
};

@Injectable()
export class ExternalFeedsService {
  constructor(private readonly activityLogsService: ActivityLogsService) {}

  /**
   * 外部ツイート配列を ActivityLog に格納
   * @param memberId ログ対象の Member ID
   * @param tweets 外部から取得したツイート配列
   */
  async importTweets(memberId: string, tweets: ExternalTweet[]) {
    for (const tweet of tweets) {
      // 既存登録チェック
      const exists = await this.activityLogsService.findByExternalId(tweet.id);
      if (exists) continue;

      await this.activityLogsService.create({
        memberId,
        type: 'external_feed_import',
        detail: tweet.text,
        source: 'twitter',
        externalId: tweet.id,
        publishedAt: new Date(tweet.created_at),
      });
    }
    return { imported: tweets.length };
  }
}
</file>

<file path="backend/src/modules/follows/follow.entity.ts">
import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, Index } from 'typeorm';

@Entity('follows')
@Index(['followerId', 'politicianId'], { unique: true })
export class Follow {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  followerId: string;

  @Column()
  politicianId: string;

  @CreateDateColumn({ type: 'datetime' })
  createdAt: Date;
}
</file>

<file path="backend/src/modules/funding/funding.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Between, Repository } from 'typeorm';
import { Funding } from 'src/entities/funding.entity';

function toDate(d?: string | Date): Date | undefined {
  if (!d) return undefined;
  if (d instanceof Date) return d;
  const parsed = new Date(d);
  return isNaN(parsed.getTime()) ? undefined : parsed;
}

@Injectable()
export class FundingService {
  constructor(@InjectRepository(Funding) private readonly fundingRepo: Repository<Funding>) {}

  async list(id?: string, from?: string | Date, to?: string | Date) {
    const where: any = {};
    if (id) where.politicianId = id;
    const fromDate = toDate(from);
    const toDateVal = toDate(to);
    if (fromDate && toDateVal) where.createdAt = Between(fromDate, toDateVal);
    return this.fundingRepo.find({ where, order: { createdAt: 'DESC' } });
  }

  async summary(id: string, from?: string | Date, to?: string | Date) {
    const items = await this.list(id, from, to);
    const total = items.reduce((sum, f) => sum + (f.amount || 0), 0);
    return { total, count: items.length };
  }

  async create(politicianId: string, actor: string | { id: string }, body: { amount: number; note?: string }) {
    const actorUserId = typeof actor === 'string' ? actor : actor.id;
    const f = this.fundingRepo.create({
      politicianId,
      actorUserId,
      amount: body.amount,
      note: body.note ?? null,
    } as any);
    return this.fundingRepo.save(f);
  }
}
</file>

<file path="backend/src/modules/members/dto/create-member.dto.ts">
export class CreateMemberDto {
  // 以前 @ApiProperty() 付きなら削除
  name: string;
  email: string;
  // 必要なフィールドをそのまま残す
}
</file>

<file path="backend/src/modules/members/dto/update-member.dto.ts">
// 以前 PartialType(CreateMemberDto) を使っていたなら簡易版:
export class UpdateMemberDto {
  name?: string;
  email?: string;
}
</file>

<file path="backend/src/modules/members/members.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Member } from 'src/entities/member.entity';
import { User } from 'src/entities/user.entity';
import { MembersService } from './members.service';
import { MembersController } from './members.controller';

@Module({
  imports: [TypeOrmModule.forFeature([Member, User])],
  controllers: [MembersController],
  providers: [MembersService],
  exports: [MembersService],
})
export class MembersModule {}
</file>

<file path="backend/src/modules/moderation/ng-words.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { NgWord } from '../../entities/ng-word.entity';
import { Repository } from 'typeorm';

@Injectable()
export class NgWordsService {
  constructor(
    @InjectRepository(NgWord)
    private readonly repo: Repository<NgWord>,
  ) {}

  // 一覧
  async list(): Promise<string[]> {
    const rows = await this.repo.find();
    return rows.map((r) => r.word.toLowerCase());
  }

  // 追加（重複は無視する）
  async add(word: string) {
    const w = word.trim().toLowerCase();
    if (!w) return;
    const existing = await this.repo.findOne({ where: { word: w } });
    if (existing) return existing;
    const row = this.repo.create({ word: w });
    return this.repo.save(row);
  }

  // 削除（ID指定）
  async remove(id: string) {
    const row = await this.repo.findOne({ where: { id } });
    if (!row) return { ok: true };
    await this.repo.remove(row);
    return { ok: true };
  }

  // 含有判定
  async containsNg(input: string): Promise<{ found: string[] }> {
    const words = await this.list();
    const lower = input.toLowerCase();
    const found = words.filter((w) => lower.includes(w));
    return { found };
  }
}
</file>

<file path="backend/src/modules/notifications/notifications.controller.ts">
import { Controller, Get, Param, Patch, Req, UseGuards } from '@nestjs/common';
import { NotificationsService } from './notifications.service';
import { AuthGuard } from '@nestjs/passport';

@Controller('notifications')
@UseGuards(AuthGuard('jwt'))
export class NotificationsController {
  constructor(private readonly notifications: NotificationsService) {}

  @Get()
  async listUnread(@Req() req: any) {
    const userId = req.user?.sub ?? req.user?.id;
    return this.notifications.listUnread(userId);
  }

  @Patch(':id/read')
  async markRead(@Param('id') id: string, @Req() req: any) {
    const userId = req.user?.sub ?? req.user?.id;
    return this.notifications.markRead(id, userId);
  }
}
</file>

<file path="backend/src/modules/notifications/notifications.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Notification } from '../../entities/notification.entity';
import { NotificationsService } from './notifications.service';
import { NotificationsController } from './notifications.controller';

@Module({
  imports: [TypeOrmModule.forFeature([Notification])],
  controllers: [NotificationsController],
  providers: [NotificationsService],
  exports: [NotificationsService],
})
export class NotificationsModule {}
</file>

<file path="backend/src/modules/policies/policies.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Policy } from 'src/entities/policy.entity';

@Injectable()
export class PoliciesService {
  constructor(@InjectRepository(Policy) private readonly policyRepo: Repository<Policy>) {}

  async list(politicianId?: string) {
    const where = politicianId ? { politicianId } : {};
    return this.policyRepo.find({ where, order: { createdAt: 'DESC' } });
  }

  async create(
    politicianId: string,
    body: { title: string; content?: string; description?: string; category?: string; status?: string },
  ) {
    const content = body.content ?? body.description ?? '';
    const p = this.policyRepo.create({
      politicianId,
      title: body.title,
      content,
      category: body.category ?? null,
      status: body.status ?? 'draft',
    } as any);
    return this.policyRepo.save(p);
  }

  async update(id: string, _actor: string | { id: string }, patch: Partial<Policy>) {
    await this.policyRepo.update({ id }, patch);
    return this.policyRepo.findOne({ where: { id } });
  }
}
</file>

<file path="backend/src/modules/politicians/politician-profile.controller.ts">
import { Controller, Get, Param } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Post } from '../posts/post.entity';

@Controller('politicians/profile')
export class PoliticianProfileController {
  constructor(
    @InjectRepository(Post)
    private readonly postRepo: Repository<Post>,
  ) {}

  // 指定の政治家（ユーザー）IDの直近投稿を10件
  @Get(':id/posts')
  async recentPosts(@Param('id') id: string) {
    const posts = await this.postRepo.find({
      where: { author: { id }, hidden: false },
      order: { createdAt: 'DESC' },
      take: 10,
    });
    return posts;
  }
}
</file>

<file path="backend/src/modules/posts/dto/update-post.dto.ts">
import { IsString, IsOptional, IsIn } from 'class-validator';

export class UpdatePostDto {
  @IsOptional()
  @IsString()
  body?: string;

  @IsOptional()
  @IsString()
  title?: string;

  @IsOptional()
  @IsIn(['policy', 'activity'])
  postCategory?: 'policy' | 'activity';

  @IsOptional()
  @IsIn(['public', 'hidden'])
  visibility?: 'public' | 'hidden';

  @IsOptional()
  @IsString()
  regionPref?: string;

  @IsOptional()
  @IsString()
  regionCity?: string;
}
</file>

<file path="backend/src/modules/reactions/reactions.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Reaction } from '../../entities/reaction.entity';
import { ReactionsService } from './reactions.service';
import { ReactionsController } from './reactions.controller';

@Module({
  imports: [TypeOrmModule.forFeature([Reaction])],
  providers: [ReactionsService],
  controllers: [ReactionsController],
  exports: [ReactionsService],
})
export class ReactionsModule {}
</file>

<file path="backend/src/modules/reactions/reactions.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Reaction } from '../../entities/reaction.entity';
import { ReactionType } from '../../enums/reaction-type.enum';

@Injectable()
export class ReactionsService {
  constructor(
    @InjectRepository(Reaction)
    private readonly repo: Repository<Reaction>,
  ) {}

  async getSummary(targetId: string) {
    const like = await this.repo.count({ where: { targetId, type: ReactionType.LIKE } });
    const agree = await this.repo.count({ where: { targetId, type: ReactionType.AGREE } });
    const disagree = await this.repo.count({ where: { targetId, type: ReactionType.DISAGREE } });
    return { like, agree, disagree };
  }

  async getMyReaction(targetId: string, userId: string) {
    const found = await this.repo.findOne({ where: { targetId, userId } });
    return { reaction: found ? found.type : null };
  }

  async toggle(targetId: string, userId: string, type: ReactionType) {
    const existing = await this.repo.findOne({ where: { targetId, userId } });
    if (existing) {
      if (existing.type === type) {
        // 同じリアクション → 削除
        await this.repo.remove(existing);
        return { reaction: null };
      } else {
        // 違うリアクション → 更新
        existing.type = type;
        await this.repo.save(existing);
        return { reaction: existing.type };
      }
    } else {
      const created = this.repo.create({ targetId, userId, type });
      await this.repo.save(created);
      return { reaction: created.type };
    }
  }
}
</file>

<file path="backend/src/modules/recommendations/recommendations.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Post } from 'src/entities/post.entity';

@Injectable()
export class RecommendationsService {
  constructor(@InjectRepository(Post) private readonly posts: Repository<Post>) {}

  async list() {
    // 例: 最近の投稿からダミー推薦
    return this.posts.find({ order: { createdAt: 'DESC' }, take: 10 });
  }
}
</file>

<file path="backend/src/modules/reports/dto/create-report.dto.ts">
import { IsString, IsIn } from 'class-validator';

export class CreateReportDto {
  @IsString()
  targetId: string;

  @IsString()
  @IsIn(['comment', 'post', 'other'])
  targetType: 'comment' | 'post' | 'other';

  @IsString()
  reason: string;
}
</file>

<file path="backend/src/modules/reports/admin-reports.controller.ts">
import { Controller, Get, Query, Param, Patch, Body } from '@nestjs/common';
import { ReportsService } from './reports.service';

@Controller('admin/reports')
export class AdminReportsController {
  constructor(private readonly svc: ReportsService) {}

  @Get()
  async list(@Query('status') status?: string, @Query('targetType') targetType?: string, @Query('limit') limit?: number) {
    return this.svc.list({ status, targetType, limit });
  }

  @Patch(':id/status')
  async updateStatus(@Param('id') id: string, @Body() body: { status: string; adminNote?: string }) {
    // サービス側で ReportStatus 正規化済み
    return this.svc.updateStatus(id, body.status as any, body.adminNote);
  }

  @Patch(':id/action')
  async action(@Param('id') id: string, @Body() body: { adminNote?: string; action: 'ban-user' | 'hide-post' | 'hide-comment' }) {
    const report = await this.svc.updateStatus(id, 'reviewing' as any, body.adminNote);
    return this.svc.actionOnTarget(report as any, body.action);
  }
}
</file>

<file path="backend/src/modules/reports/report.entity.ts">
import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn } from 'typeorm';

@Entity('reports')
export class Report {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  targetId: string;              // 通報対象 (comment/post 等の ID)

  @Column({ type: 'varchar' })
  targetType: 'comment' | 'post' | 'other';

  @Column({ type: 'text' })
  reason: string;

  @Column({ type: 'varchar', default: 'pending' })
  status: 'pending' | 'accepted' | 'rejected';

  @Column({ nullable: true })
  moderatorId?: string;

  @CreateDateColumn({ type: 'datetime' })
  createdAt: Date;
}
</file>

<file path="backend/src/modules/reports/reports.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Report } from '../../entities/report.entity';
import { ReportsService } from './reports.service';
import { ReportsController } from './reports.controller';
import { AdminReportsController } from './admin-reports.controller';
import { User } from '../../entities/user.entity';
import { Post } from '../posts/post.entity';
import { Comment } from '../comments/comment.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Report, User, Post, Comment])],
  providers: [ReportsService],
  controllers: [ReportsController, AdminReportsController],
  exports: [ReportsService],
})
export class ReportsModule {}
</file>

<file path="backend/src/modules/scheduled-posts/scheduled-posts.controller.ts">
import { Body, Controller, Get, Param, Post, Delete, Request } from '@nestjs/common';
import { ScheduledPostsService } from './scheduled-posts.service';

@Controller('scheduled-posts')
export class ScheduledPostsController {
  constructor(private readonly svc: ScheduledPostsService) {}

  @Post()
  async schedule(@Request() req: any, @Body() body: { scheduledAt: string | Date; title: string; body: string; tags?: string[] }) {
    const authorId = req?.user?.sub ?? req?.user?.id;
    return this.svc.schedule(authorId, body);
  }

  @Get()
  async list() {
    return this.svc.list();
  }

  @Delete(':id')
  async cancel(@Param('id') id: string, @Request() req: any) {
    const authorId = req?.user?.sub ?? req?.user?.id;
    return this.svc.cancel(id, authorId);
  }
}
</file>

<file path="backend/src/modules/scheduled-posts/scheduled-posts.service.ts">
import { Injectable, Logger, NotFoundException, ForbiddenException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { LessThanOrEqual, Repository } from 'typeorm';
import { ScheduledPost } from 'src/entities/scheduled-post.entity';
import { Post } from 'src/entities/post.entity';
import { NgWordsService } from 'src/modules/moderation/ng-words.service';

function toDate(d: string | Date): Date {
  if (d instanceof Date) return d;
  const parsed = new Date(d);
  if (isNaN(parsed.getTime())) throw new Error('invalid date');
  return parsed;
}

@Injectable()
export class ScheduledPostsService {
  private readonly logger = new Logger(ScheduledPostsService.name);

  constructor(
    @InjectRepository(ScheduledPost) private readonly repo: Repository<ScheduledPost>,
    @InjectRepository(Post) private readonly posts: Repository<Post>,
    private readonly ngWords: NgWordsService,
  ) {}

  async schedule(authorId: string, body: { scheduledAt: string | Date; title: string; body: string; tags?: string[] }) {
    const sp = this.repo.create({
      authorId,
      scheduledAt: toDate(body.scheduledAt),
      title: body.title,
      body: body.body,
      tags: body.tags ?? null,
      status: 'pending',
      postedPostId: null,
      failureReason: null,
    } as any);
    return this.repo.save(sp);
  }

  async list() {
    return this.repo.find({
      order: { scheduledAt: 'ASC' },
      take: 200,
    });
  }

  async cancel(id: string, authorId: string) {
    const sp = await this.repo.findOne({ where: { id } });
    if (!sp) throw new NotFoundException('scheduled post not found');
    if (sp.authorId !== authorId) throw new ForbiddenException('not owner');
    if (sp.status !== 'pending') throw new ForbiddenException('can cancel only pending');
    sp.status = 'canceled';
    await this.repo.save(sp);
    return { ok: true };
  }

  async runDuePosts(now = new Date()) {
    const due = await this.repo.find({
      where: { scheduledAt: LessThanOrEqual(now), status: 'pending' } as any,
      order: { scheduledAt: 'ASC' },
      take: 100,
    });

    for (const sp of due) {
      try {
        const ng = await this.ngWords.containsNg(sp.body);
        if (ng) {
          sp.status = 'rejected';
          sp.failureReason = 'Contains NG words';
          await this.repo.save(sp);
          continue;
        }

        const postEntity = this.posts.create({
          authorUserId: sp.authorId,
          type: 'normal',
          title: sp.title,
          content: sp.body,
          mediaIds: null,
          regionId: null,
        } as any);
        const saved = await this.posts.save(postEntity);

        sp.postedPostId = (saved as any).id;
        sp.status = 'posted';
        sp.failureReason = null;
        await this.repo.save(sp);
      } catch (e: any) {
        sp.status = 'error';
        sp.failureReason = e?.message ?? 'unknown error';
        await this.repo.save(sp);
        this.logger.error(`Failed to post scheduled ${sp.id}: ${sp.failureReason}`);
      }
    }

    return { ok: true, processed: due.length };
  }
}
</file>

<file path="backend/src/modules/search/follows.controller.ts">
// Ensure correct import path to FollowsService
import { Controller, Get, Param } from '@nestjs/common';
import { FollowsService } from '../follows/follows.service';

@Controller('search/follows')
export class SearchFollowsController {
  constructor(private readonly follows: FollowsService) {}

  @Get(':userId/list')
  async list(@Param('userId') userId: string) {
    return this.follows.listFollowedIds(userId);
  }
}
</file>

<file path="backend/src/modules/search/search.controller.ts">
import { Controller, Get, Query } from '@nestjs/common';
import { SearchService } from './search.service';
import { PostType } from '../../enums/post-type.enum';

@Controller('search')
export class SearchController {
  constructor(private readonly search: SearchService) {}

  @Get('politicians')
  async searchPoliticians(
    @Query('region') region?: string,
    @Query('party') party?: string,
    @Query('q') q?: string,
  ) {
    return this.search.searchPoliticians({ region, party, q });
  }

  @Get('posts')
  async searchPosts(@Query('q') q?: string, @Query('type') type?: PostType) {
    return this.search.searchPosts({ q, type });
  }
}
</file>

<file path="backend/src/modules/search/search.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { SearchController } from './search.controller';
import { SearchService } from './search.service';
import { PoliticianProfile } from '../../entities/politician-profile.entity';
import { Post } from '../../entities/post.entity';
import { User } from '../../entities/user.entity';
import { Party } from '../../entities/party.entity';

@Module({
  imports: [TypeOrmModule.forFeature([PoliticianProfile, Post, User, Party])],
  controllers: [SearchController],
  providers: [SearchService],
  exports: [SearchService],
})
export class SearchModule {}
</file>

<file path="backend/src/modules/search/search.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository, SelectQueryBuilder } from 'typeorm';
import { Post } from 'src/entities/post.entity';
import { Politician } from 'src/entities/politician.entity';

@Injectable()
export class SearchService {
  constructor(
    @InjectRepository(Post) private readonly posts: Repository<Post>,
    @InjectRepository(Politician) private readonly politicians: Repository<Politician>,
  ) {}

  async searchPoliticians(params: { region?: string; party?: string; q?: string }) {
    let qb: SelectQueryBuilder<Politician> = this.politicians.createQueryBuilder('p');
    if (params.region) qb = qb.andWhere('p.regionId = :region', { region: params.region });
    if (params.party) qb = qb.andWhere('p.partyId = :party', { party: params.party });
    if (params.q) qb = qb.andWhere('p.name LIKE :q OR p.nickname LIKE :q', { q: `%${params.q}%` });
    return qb.orderBy('p.createdAt', 'DESC').getMany();
  }

  async searchPosts(params: { q?: string; type?: string }) {
    let qb = this.posts.createQueryBuilder('p');
    if (params.type) qb = qb.andWhere('p.type = :type', { type: params.type });
    if (params.q) qb = qb.andWhere('p.title LIKE :q OR p.content LIKE :q', { q: `%${params.q}%` });
    return qb.orderBy('p.createdAt', 'DESC').getMany();
  }
}
</file>

<file path="backend/src/modules/surveys/surveys.controller.ts">
import { Controller, Get, Param, Post, Body } from '@nestjs/common';
import { SurveysService } from './surveys.service';

@Controller('surveys')
export class SurveysController {
  constructor(private readonly surveys: SurveysService) {}

  @Get('available/:userId')
  async available(@Param('userId') userId: string) {
    return this.surveys.availableForUser(userId);
  }

  @Post(':surveyId/submit/:userId')
  async submit(
    @Param('surveyId') surveyId: string,
    @Param('userId') userId: string,
    @Body() dto: { answers: Record<string, any> },
  ) {
    return this.surveys.submitResponse(surveyId, userId, dto);
  }
}
</file>

<file path="backend/src/modules/votes/vote.entity.ts">
import { Entity, PrimaryGeneratedColumn, Column, CreateDateColumn, ManyToOne, JoinColumn } from 'typeorm';
import { Post } from '../posts/post.entity';

@Entity('votes')
export class Vote {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column()
  postId: string;

  @ManyToOne(() => Post, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'postId' })
  post: Post;

  @Column()
  userId: string;

  @Column({ type: 'varchar' })
  type: 'support' | 'oppose';

  @CreateDateColumn({ type: 'datetime' })
  createdAt: Date;
}
</file>

<file path="backend/src/news-ingest/news-ingest.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { NewsIngestService } from './news-ingest.service';
import { Post } from 'src/entities/post.entity';
import { User } from 'src/entities/user.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Post, User])],
  providers: [NewsIngestService],
  exports: [NewsIngestService],
})
export class NewsIngestModule {}
</file>

<file path="backend/src/news-ingest/news-ingest.service.ts">
import { Injectable, Logger } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Cron, CronExpression } from '@nestjs/schedule';
import { Repository } from 'typeorm';
import { Post } from 'src/entities/post.entity';
import { User } from 'src/entities/user.entity';
import { PostType } from 'src/enums/post-type.enum';
import { createHash } from 'crypto';

@Injectable()
export class NewsIngestService {
  private readonly logger = new Logger(NewsIngestService.name);

  constructor(
    @InjectRepository(Post) private readonly posts: Repository<Post>,
    @InjectRepository(User) private readonly users: Repository<User>,
  ) {}

  // EVERY_15_MINUTES -> EVERY_5_MINUTES に修正
  @Cron(CronExpression.EVERY_5_MINUTES)
  async pollRss() {
    await this.pullAndCreate();
  }

  private hash(link: string) {
    return createHash('sha256').update(link).digest('hex');
  }

  private async fetchItems(): Promise<Array<{ title: string; link: string }>> {
    const feeds = (process.env.RSS_FEEDS || '')
      .split(',')
      .map((s) => s.trim())
      .filter(Boolean);

    const items: Array<{ title: string; link: string }> = [];
    for (const url of feeds) {
      try {
        const res = await fetch(url);
        if (!res.ok) continue;
        const xml = await res.text();
        const itemRegex = /<item[\s\S]*?<\/item>/g;
        const titleRegex = /<title>([\s\S]*?)<\/title>/;
        const linkRegex = /<link>([\s\S]*?)<\/link>/;
        const matches = xml.match(itemRegex) || [];
        for (const m of matches) {
          const title = (m.match(titleRegex)?.[1] || '').trim();
          const link = (m.match(linkRegex)?.[1] || '').trim();
          if (title && link) items.push({ title, link });
        }
      } catch {
        // ignore feed error
      }
    }
    return items;
  }

  private async systemUserId(): Promise<string> {
    const sys = await this.users.findOne({ where: { email: 'system@news.local' } });
    return sys?.id || '00000000-0000-0000-0000-000000000000';
  }

  async pullAndCreate() {
    const items = await this.fetchItems();
    if (!items.length) return;

    const existing = await this.posts
      .createQueryBuilder('p')
      .where('p.type = :type', { type: PostType.NEWS })
      .select(['p.id', 'p.content'])
      .getMany();

    const hashes = new Set<string>();
    for (const p of existing) {
      const match = p.content?.match(/link_hash:([a-f0-9]{64})/);
      if (match?.[1]) hashes.add(match[1]);
    }

    let created = 0;
    for (const item of items) {
      const h = this.hash(item.link);
      if (hashes.has(h)) continue;
      const content = `RSSニュース\nリンク: ${item.link}\nlink_hash:${h}`;
      const post = this.posts.create({
        authorUserId: await this.systemUserId(),
        type: PostType.NEWS,
        title: item.title,
        content,
        mediaIds: null,
        regionId: null,
      } as any);
      await this.posts.save(post);
      hashes.add(h);
      created++;
    }

    if (created > 0) {
      this.logger.log(`News ingested: created ${created} posts`);
    }
  }
}
</file>

<file path="backend/nest-cli.json">
{
  "$schema": "https://json.schemastore.org/nest-cli",
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "deleteOutDir": true
  }
}
</file>

<file path="backend/tsconfig.build.json">
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "sourceMap": false
  },
  "include": ["src/**/*.ts"],
  "exclude": ["node_modules", "dist", "**/*.spec.ts", "__tests__/**"]
}
</file>

<file path="frontend/app/dashboard/page.tsx">
'use client';
import { useEffect, useState } from 'react';
import { API_BASE } from '../../lib/api';
import { getToken } from '../../lib/auth';

export default function DashboardPage() {
  const [postsSummary, setPostsSummary] = useState<any[]>([]);
  const token = typeof window !== 'undefined' ? getToken() : null;

  useEffect(() => {
    if (!token) return;
    fetch(`${API_BASE}/analytics/my/posts`, { headers: { Authorization: `Bearer ${token}` } })
      .then(r => r.json()).then(setPostsSummary);
  }, [token]);

  function downloadCsv() {
    if (!token) return;
    const a = document.createElement('a');
    a.href = `${API_BASE}/analytics/my/export.csv`;
    a.download = 'my-posts-summary.csv';
    a.click();
  }

  return (
    <div className="flex flex-col gap-3">
      <h1 className="text-xl font-bold">ダッシュボード</h1>
      <button className="rounded bg-gray-800 text-white px-3 py-1 w-fit" onClick={downloadCsv}>CSVダウンロード</button>
      <div className="grid gap-3">
        {postsSummary.map((p) => (
          <div key={p.postId} className="bg-white border rounded p-3">
            <div className="font-semibold">{p.title}</div>
            <div className="text-sm text-gray-600">{p.type} / {new Date(p.createdAt).toLocaleString()}</div>
            <div className="mt-1">賛成: {p.votes.agree} / 反対: {p.votes.disagree} / コメント: {p.comments}</div>
          </div>
        ))}
      </div>
    </div>
  );
}
</file>

<file path="frontend/app/feed/page.tsx">
'use client';

import { useEffect, useMemo, useState } from 'react';
import {
  fetchFeed,
  votePost,
  Post,
} from '../../lib/api';
import CommentsSection from '../../components/CommentsSection';
import ReportButton from '../../components/ReportButton';
import { useSearchParams } from 'next/navigation';

type FeedFilters = {
  type?: 'activity' | 'pledge' | 'question' | 'news';
  region?: string;
  q?: string;
  page?: number;
  limit?: number;
};

export default function FeedPage() {
  const params = useSearchParams();
  const [posts, setPosts] = useState<Post[]>([]);
  const [loading, setLoading] = useState<boolean>(false);
  const [error, setError] = useState<string | null>(null);

  const filters: FeedFilters = useMemo(() => ({
    type: (params.get('type') || undefined) as FeedFilters['type'],
    region: params.get('region') || undefined,
    q: params.get('q') || undefined,
    limit: 20,
  }), [params]);

  async function loadFeed(filters: FeedFilters) {
    setLoading(true);
    setError(null);
    try {
      const data = await fetchFeed(filters);
      setPosts(data);
    } catch (e: any) {
      setError(e?.message || 'Failed to load feed');
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    loadFeed(filters);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [filters.type, filters.region, filters.q, filters.page, filters.limit]);

  async function onVote(postId: string, choice: 'agree' | 'disagree') {
    try {
      await votePost(postId, choice);
      loadFeed(filters);
      alert('投票しました');
    } catch (e: any) {
      alert(e?.message || '投票に失敗しました');
    }
  }

  return (
    <div className="flex flex-col gap-3">
      {loading && <div className="bg-white border rounded p-4">読み込み中…</div>}
      {error && <div className="bg-red-50 border border-red-300 text-red-700 rounded p-4">{error}</div>}

      {!loading && !error && posts.map((p) => (
        <article key={p.id} className="bg-white border rounded p-4">
          <div className="flex items-start justify-between gap-3">
            <div>
              <div className="text-xs text-gray-500">{new Date(p.createdAt).toLocaleString()}</div>
              <h2 className="text-lg font-semibold">{p.title}</h2>
              <div className="text-xs text-gray-500">{p.type}</div>
            </div>
            <ReportButton targetId={p.id} targetType="post" />
          </div>

          <p className="mt-3 whitespace-pre-wrap">{p.content}</p>

          <div className="mt-3 flex items-center gap-2">
            <button className="rounded bg-green-600 text-white px-3 py-1" onClick={() => onVote(p.id, 'agree')}>
              賛成 {p.agreeCount ?? 0}
            </button>
            <button className="rounded bg-red-600 text-white px-3 py-1" onClick={() => onVote(p.id, 'disagree')}>
              反対 {p.disagreeCount ?? 0}
            </button>
            <span className="text-sm text-gray-600">コメント {p.commentCount ?? 0}</span>
          </div>

          <div className="mt-4">
            <CommentsSection postId={p.id} />
          </div>
        </article>
      ))}
    </div>
  );
}
</file>

<file path="frontend/app/notifications/page.tsx">
'use client';
import { useEffect, useState } from 'react';
import { API_BASE } from '../../lib/api';
import { getToken } from '../../lib/auth';

export default function NotificationsPage() {
  const [list, setList] = useState<any[]>([]);
  const token = typeof window !== 'undefined' ? getToken() : null;

  useEffect(() => {
    if (!token) return;
    fetch(`${API_BASE}/notifications`, { headers: { Authorization: `Bearer ${token}` } })
      .then(r => r.json()).then(setList);
  }, [token]);

  async function markRead(id: string) {
    if (!token) return;
    await fetch(`${API_BASE}/notifications/${id}/read`, { method: 'PATCH', headers: { Authorization: `Bearer ${token}` } });
    setList((prev) => prev.filter((n) => n.id !== id));
  }

  return (
    <div className="bg-white border rounded p-4">
      <h1 className="text-xl font-bold mb-2">未読通知</h1>
      <ul className="flex flex-col gap-2">
        {list.map((n) => (
          <li key={n.id} className="border rounded px-3 py-2">
            <div className="font-semibold">{n.title}</div>
            <div className="text-sm text-gray-600">{n.type}</div>
            <p className="mt-1">{n.body}</p>
            <button className="rounded bg-gray-800 text-white px-3 py-1 mt-2" onClick={()=>markRead(n.id)}>既読にする</button>
          </li>
        ))}
      </ul>
    </div>
  );
}
</file>

<file path="frontend/app/politicians/[id]/page.tsx">
'use client';
import { useEffect, useState } from 'react';
import { API_BASE } from '../../../lib/api';

export default function PoliticianPage({ params }: { params: { id: string } }) {
  const [profile, setProfile] = useState<any>(null);

  useEffect(() => {
    fetch(`${API_BASE}/politicians/${params.id}`).then(r => r.json()).then(setProfile);
  }, [params.id]);

  if (!profile) return <div>読み込み中…</div>;

  return (
    <div className="bg-white border rounded p-4">
      <h1 className="text-xl font-bold">{profile.user?.name}</h1>
      <p className="text-sm text-gray-500">{profile.party?.name ?? '無所属'}</p>
      <p className="mt-2 whitespace-pre-wrap">{profile.bio ?? 'プロフィール未設定'}</p>
      <h2 className="text-lg font-semibold mt-4">公約</h2>
      <ul className="list-disc pl-5">
        {(profile.pledges ?? []).map((p: any, i: number) => <li key={i}>{p.title}</li>)}
      </ul>
    </div>
  );
}
</file>

<file path="frontend/app/page.tsx">
export default function Home() {
  return (
    <div className="bg-white border rounded p-4">
      <h1 className="text-xl font-bold">ようこそ</h1>
      <p className="text-gray-700">タイムラインへは上部ナビの「タイムライン」から移動してください。</p>
    </div>
  );
}
</file>

<file path="frontend/components/Header.tsx">
import Link from 'next/link';
import { useEffect, useState } from 'react';

export default function Header() {
  const [user, setUser] = useState<any>(null);

  useEffect(() => {
    // 既存の API で /auth/me がある場合はそれを使って現在ユーザーを取得
    // ない場合は、トークン存在チェックだけでもOK
    const token = typeof window !== 'undefined' ? localStorage.getItem('token') : null;
    if (token) {
      // 簡易: トークンがあればログイン扱い。厳密には /auth/me を呼ぶ
      setUser({ id: 1, name: 'You' });
    } else {
      setUser(null);
    }
  }, []);

  return (
    <header className="flex items-center justify-between p-3 border-b">
      <Link href="/">MVP</Link>
      <nav className="flex gap-3">
        {user ? (
          <>
            <Link href="/me">マイページ</Link>
            <button onClick={() => { localStorage.removeItem('token'); location.href = '/'; }}>
              ログアウト
            </button>
          </>
        ) : (
          <>
            <Link href="/login" className="btn btn-primary">ログイン</Link>
            <Link href="/register" className="btn btn-secondary">新規登録</Link>
          </>
        )}
      </nav>
    </header>
  );
}
</file>

<file path="frontend/components/ReportButton.tsx">
'use client';

import { useState } from 'react';
import { createReport } from '../lib/api-extended';

type Props = {
  targetId: string;
  targetType: 'post' | 'comment' | 'user';
};

export default function ReportButton({ targetId, targetType }: Props) {
  const [reason, setReason] = useState<string>('');
  const [loading, setLoading] = useState<boolean>(false);

  async function onSubmit() {
    setLoading(true);
    try {
      await createReport(targetId, targetType, reason);
      alert('通報を送信しました。ありがとうございます。');
      setReason('');
    } catch (e: any) {
      alert(e?.message || '通報送信に失敗しました');
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="flex items-center gap-2" aria-label="通報ボタン">
      <input
        className="border rounded px-2 py-1"
        placeholder="理由（任意）"
        value={reason}
        onChange={(e) => setReason(e.target.value)}
        aria-label="通報理由"
      />
      <button
        className="rounded bg-orange-600 text-white px-3 py-1"
        onClick={onSubmit}
        disabled={loading}
        aria-disabled={loading}
        aria-label="通報する"
        title="不適切な内容を通報します"
      >
        {loading ? '送信中...' : '通報'}
      </button>
    </div>
  );
}
</file>

<file path="backend/src/auth/auth.module.ts">
import { Module } from '@nestjs/common';
import { JwtModule } from '@nestjs/jwt';
import { PassportModule } from '@nestjs/passport';
import { TypeOrmModule } from '@nestjs/typeorm';
import { AuthService } from 'src/auth/auth.service';
import { AuthController } from 'src/auth/auth.controller';
import { JwtStrategy } from 'src/auth/jwt.strategy';
import { User } from 'src/entities/user.entity';

@Module({
  imports: [
    PassportModule.register({ defaultStrategy: 'jwt' }),
    JwtModule.register({
      secret: process.env.JWT_SECRET || 'dev_secret',
      signOptions: { expiresIn: '15m' },
    }),
    TypeOrmModule.forFeature([User]),
  ],
  controllers: [AuthController],
  providers: [AuthService, JwtStrategy],
  exports: [AuthService],
})
export class AuthModule {}
</file>

<file path="backend/src/auth/dev-seed.controller.ts">
import { Body, Controller, Post } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import * as bcrypt from 'bcryptjs';
import { User } from 'src/entities/user.entity';

@Controller('auth/dev-seed')
export class DevSeedController {
  constructor(@InjectRepository(User) private readonly userRepo: Repository<User>) {}

  @Post('user')
  async seedUser(
    @Body()
    body: {
      email: string;
      password: string;
      name?: string;
      nickname?: string | null;
      phoneNumber?: string | null;
      ageGroup?: string | null;
    },
  ) {
    const exists = await this.userRepo.findOne({ where: { email: body.email } });
    if (exists) {
      return { ok: true, id: exists.id };
    }

    const user = this.userRepo.create({
      email: body.email,
      passwordHash: await bcrypt.hash(body.password, 10),
      name: body.name || null,
      nickname: body.nickname ?? null,
      phoneNumber: body.phoneNumber ?? null,
      ageGroup: body.ageGroup ?? null,
      role: 'citizen',
      status: 'active',
      emailVerified: false,
      phoneVerified: false,
    } as any);

    // 単体保存の戻り値（型注釈を外し安全に id を取得）
    const saved = await this.userRepo.save(user);
    const id = Array.isArray(saved) ? (saved[0] as any).id : (saved as any).id;
    return { ok: true, id };
  }
}
</file>

<file path="backend/src/auth/dev.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { DevSeedController } from 'src/auth/dev-seed.controller';
import { User } from 'src/entities/user.entity';

@Module({
  imports: [TypeOrmModule.forFeature([User])],
  controllers: [DevSeedController],
})
export class DevModule {}
</file>

<file path="backend/src/entities/activity-fund.entity.ts">
import { Column, CreateDateColumn, Entity, Index, ManyToOne, PrimaryGeneratedColumn, UpdateDateColumn } from 'typeorm';
import { Member } from 'src/entities/member.entity';

@Entity('activity_funds')
export class ActivityFund {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  @Index()
  @Column({ type: 'uuid' })
  memberId!: string;

  @ManyToOne(() => Member, (member) => member.activityFunds, { onDelete: 'CASCADE' })
  member!: Member;

  @Column({ type: 'int' })
  amount!: number;

  @Column({ type: 'varchar', length: 256, nullable: true })
  note!: string | null;

  // 追加: 会計年度（サービスが order に使用）
  @Index()
  @Column({ type: 'int', nullable: true })
  fiscalYear!: number | null;

  // 追加: 支出日（サービスが order に使用）
  @Index()
  @Column({ type: 'date', nullable: true })
  expenseDate!: Date | null;

  @CreateDateColumn()
  createdAt!: Date;

  @UpdateDateColumn()
  updatedAt!: Date;
}
</file>

<file path="backend/src/entities/activity-log.entity.ts">
import { Column, CreateDateColumn, Entity, Index, ManyToOne, PrimaryGeneratedColumn, UpdateDateColumn } from 'typeorm';
import { Member } from 'src/entities/member.entity';

@Entity('activity_logs')
export class ActivityLog {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  @Index()
  @Column({ type: 'uuid' })
  memberId!: string;

  @ManyToOne(() => Member, (m) => m.activityLogs, { onDelete: 'CASCADE' })
  member!: Member;

  @Column({ type: 'varchar', length: 64 })
  action!: string;

  @Column({ type: 'jsonb', nullable: true })
  data!: Record<string, any> | null;

  @CreateDateColumn()
  createdAt!: Date;

  @UpdateDateColumn()
  updatedAt!: Date;
}
</file>

<file path="backend/src/entities/member.entity.ts">
import {
  Column,
  CreateDateColumn,
  Entity,
  Index,
  ManyToOne,
  OneToMany,
  PrimaryGeneratedColumn,
  UpdateDateColumn,
} from 'typeorm';
import { User } from 'src/entities/user.entity';
import { ActivityFund } from 'src/entities/activity-fund.entity';
import { ActivityLog } from 'src/entities/activity-log.entity';

@Entity('members')
export class Member {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  // UsersService/MembersService が参照する基本プロフィール
  @Index()
  @Column({ type: 'varchar', length: 128 })
  name!: string;

  @Index()
  @Column({ type: 'varchar', length: 256, nullable: true })
  email!: string | null;

  @Index()
  @Column({ type: 'varchar', length: 64, nullable: true })
  twitterHandle!: string | null;

  @Column({ type: 'timestamp', nullable: true })
  lastTwitterFetch!: Date | null;

  // 所属や権限など必要に応じて
  @Index()
  @Column({ type: 'varchar', length: 64, nullable: true })
  role!: string | null;

  @Index()
  @Column({ type: 'varchar', length: 64, nullable: true })
  groupId!: string | null;

  // ユーザーとの関連
  @ManyToOne(() => User, (user) => user.members, { onDelete: 'CASCADE' })
  user!: User;

  @Index()
  @Column({ type: 'uuid' })
  userId!: string;

  // 活動資金（ActivityFund）との関連
  @OneToMany(() => ActivityFund, (fund) => fund.member)
  activityFunds!: ActivityFund[];

  // 活動ログ（ActivityLog）との関連
  @OneToMany(() => ActivityLog, (log) => log.member)
  activityLogs!: ActivityLog[];

  @CreateDateColumn()
  createdAt!: Date;

  @UpdateDateColumn()
  updatedAt!: Date;
}
</file>

<file path="backend/src/enums/kyc-status.enum.ts">
export type KycStatus = 'pending' | 'verified' | 'rejected';

export const KYC_STATUSES = ['pending', 'verified', 'rejected'] as const;

export function isKycStatus(val: any): val is KycStatus {
  return (KYC_STATUSES as readonly string[]).includes(val);
}
</file>

<file path="backend/src/modules/activity-funds/dto/create-activity-fund.dto.ts">
import { ApiProperty } from '@nestjs/swagger';

export class CreateActivityFundDto {
  @ApiProperty()
  amount!: number;

  @ApiProperty()
  description!: string;

  @ApiProperty({ required: false })
  fileId?: string;
}
</file>

<file path="backend/src/modules/activity-logs/dto/create-activity-log.dto.ts">
import { ActivityLogType } from '../../../enums/activity-log-type.enum';

export class CreateActivityLogDto {
  action?: string;
  actorId?: string;
  memberId?: string;
  externalId?: string;
  source?: ActivityLogType;
  url?: string;
  content?: string;
  title?: string;
  publishedAt?: Date;
  metadata?: string;
}
</file>

<file path="backend/src/modules/activity-logs/dto/update-activity-log.dto.ts">
import { ActivityLogType } from '../../../enums/activity-log-type.enum';

export class UpdateActivityLogDto {
  action?: string;
  actorId?: string;
  memberId?: string;
  externalId?: string;
  source?: ActivityLogType;
  url?: string;
  content?: string;
  title?: string;
  publishedAt?: Date;
  metadata?: string;
}
</file>

<file path="backend/src/modules/activity-logs/activity-logs.controller.ts">
import { Controller, Get, Post, Body, Param, Delete } from '@nestjs/common';
import { ActivityLogsService, CreateActivityLogDto } from './activity-logs.service';

@Controller('activity-logs')
export class ActivityLogsController {
  constructor(private readonly service: ActivityLogsService) {}

  @Get()
  findAll() {
    return this.service.findAll();
  }

  @Get(':id')
  findOne(@Param('id') id: string) {
    return this.service.findOne(id);
  }

  @Post()
  create(@Body() dto: CreateActivityLogDto) {
    return this.service.create(dto);
  }

  @Delete(':id')
  remove(@Param('id') id: string) {
    return this.service.remove(id);
  }
}
</file>

<file path="backend/src/modules/activity-logs/activity-logs.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { ActivityLog } from '../../entities/activity-log.entity';
import { ActivityLogService } from './activity-log.service';

@Module({
  imports: [TypeOrmModule.forFeature([ActivityLog])],
  providers: [ActivityLogService],
  exports: [ActivityLogService], // 他モジュールから利用できるように export
})
export class ActivityLogsModule {}
</file>

<file path="backend/src/modules/activity-logs/activity-logs.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { ActivityLog } from './activity-log.entity';

export type CreateActivityLogDto = {
  memberId: string;
  type: string;
  detail?: string;
  source?: string;
  externalId?: string;
  publishedAt?: Date;
};

@Injectable()
export class ActivityLogsService {
  constructor(
    @InjectRepository(ActivityLog)
    private readonly repo: Repository<ActivityLog>,
  ) {}

  async create(dto: CreateActivityLogDto) {
    const entity = this.repo.create({
      type: dto.type,
      detail: dto.detail,
      source: dto.source,
      externalId: dto.externalId,
      publishedAt: dto.publishedAt,
      member: { id: dto.memberId } as any,
    } as Partial<ActivityLog>);
    return this.repo.save(entity);
  }

  async findAll() {
    return this.repo.find({
      relations: ['member'],
      order: { publishedAt: 'DESC', createdAt: 'DESC' },
      take: 200,
    });
  }

  async findOne(id: string) {
    return this.repo.findOne({
      where: { id },
      relations: ['member'],
    });
  }

  async findByExternalId(externalId: string) {
    if (!externalId) return null;
    return this.repo.findOne({ where: { externalId } });
  }

  async remove(id: string) {
    await this.repo.delete(id);
    return { deleted: true };
  }
}
</file>

<file path="backend/src/modules/analytics/analytics.controller.ts">
import { Controller, Get, Req, UseGuards, Res } from '@nestjs/common';
import { AnalyticsService } from './analytics.service';
import { AuthGuard } from '@nestjs/passport';
import { Response } from 'express';

@Controller('analytics/my')
@UseGuards(AuthGuard('jwt'))
export class AnalyticsController {
  constructor(private readonly analytics: AnalyticsService) {}

  @Get('posts')
  async myPosts(@Req() req: any) {
    const userId = req.user?.sub ?? req.user?.id;
    return this.analytics.myPostsSummary(userId);
  }

  @Get('followers/demographics')
  async myFollowers(@Req() req: any) {
    const userId = req.user?.sub ?? req.user?.id;
    return this.analytics.followersDemographics(userId);
  }

  @Get('export.csv')
  async exportCsv(@Req() req: any, @Res() res: Response) {
    const userId = req.user?.sub ?? req.user?.id;
    const csv = await this.analytics.exportMyPostsCsv(userId);
    res.setHeader('Content-Type', 'text/csv; charset=utf-8');
    res.setHeader('Content-Disposition', 'attachment; filename="my-posts-summary.csv"');
    res.send(csv);
  }
}
</file>

<file path="backend/src/modules/auth/dto/login.dto.ts">
export class LoginDto {
  email: string;
  password: string;
}
</file>

<file path="backend/src/modules/auth/guards/jwt-auth.guard.ts">
import { Injectable, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { AuthGuard } from '@nestjs/passport';
import { IS_PUBLIC_KEY } from '../../../common/decorators/public.decorator';

@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {
  constructor(private readonly reflector: Reflector) {
    super();
  }

  canActivate(context: ExecutionContext) {
    // Public デコレータが付いたルートはスキップ
    const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
      context.getHandler(),
      context.getClass(),
    ]);
    if (isPublic) return true;
    return super.canActivate(context);
  }
}
</file>

<file path="backend/src/modules/external-feeds/external-feeds.controller.ts">
import { Controller, Post, Body } from '@nestjs/common';
import { ExternalFeedsService, ExternalTweet } from './external-feeds.service';

@Controller('external-feeds')
export class ExternalFeedsController {
  constructor(private readonly feeds: ExternalFeedsService) {}

  @Post('import/tweets')
  importTweets(
    @Body() body: { memberId: string; tweets: ExternalTweet[] },
  ) {
    return this.feeds.importTweets(body.memberId, body.tweets || []);
  }
}
</file>

<file path="backend/src/modules/follows/follows.controller.ts">
import { Controller, Post, Body, Req, UnauthorizedException, Get } from '@nestjs/common';
import { FollowsService } from './follows.service';

@Controller('follows')
export class FollowsController {
  constructor(private readonly svc: FollowsService) {}

  @Post('follow')
  async follow(@Body() body: { targetUserId: string }, @Req() req: any) {
    const userId = req.user?.sub;
    if (!userId) throw new UnauthorizedException();
    return this.svc.follow(userId, body.targetUserId);
  }

  @Post('unfollow')
  async unfollow(@Body() body: { targetUserId: string }, @Req() req: any) {
    const userId = req.user?.sub;
    if (!userId) throw new UnauthorizedException();
    return this.svc.unfollow(userId, body.targetUserId);
  }

  @Get('followed')
  async followed(@Req() req: any) {
    const userId = req.user?.sub;
    if (!userId) throw new UnauthorizedException();
    const ids = await this.svc.listFollowedIds(userId);
    return { ids };
  }
}
</file>

<file path="backend/src/modules/media/media.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Media } from 'src/entities/media.entity';
import { MediaService } from './media.service';
import { MediaController } from './media.controller';

@Module({
  imports: [TypeOrmModule.forFeature([Media])],
  providers: [MediaService],
  controllers: [MediaController],
  exports: [MediaService],
})
export class MediaModule {}
</file>

<file path="backend/src/modules/members/members.controller.ts">
import { Controller, Get, Query } from '@nestjs/common';

@Controller('members')
export class MembersController {
  @Get()
  async list(@Query('q') q?: string) {
    // Swagger ダミーは削除、必要なら @nestjs/swagger を導入して利用
    return { ok: true, q: q ?? '' };
  }
}
</file>

<file path="backend/src/modules/members/members.service.ts">
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { FindOptionsWhere, Repository } from 'typeorm';
import { Member } from 'src/entities/member.entity';

@Injectable()
export class MembersService {
  constructor(@InjectRepository(Member) private readonly repo: Repository<Member>) {}

  async create(dto: {
    userId: string;
    name: string;
    email?: string | null;
    twitterHandle?: string | null;
  }) {
    const m = this.repo.create({
      userId: dto.userId,
      name: dto.name,
      email: dto.email ?? null,
      twitterHandle: dto.twitterHandle ?? null,
      lastTwitterFetch: null,
      role: null,
      groupId: null,
    } as any);
    return this.repo.save(m);
  }

  async update(id: string, dto: { name?: string; email?: string | null; twitterHandle?: string | null }) {
    const member = await this.repo.findOne({ where: { id } as FindOptionsWhere<Member> });
    if (!member) throw new NotFoundException('Member not found');

    if (dto.name) member.name = dto.name;
    if (dto.email !== undefined) member.email = dto.email;
    if (dto.twitterHandle !== undefined) member.twitterHandle = dto.twitterHandle;

    // Twitter情報更新のタイムスタンプを更新する例
    member.lastTwitterFetch = new Date();

    return this.repo.save(member);
  }
}
</file>

<file path="backend/src/modules/moderation/ng-words.controller.ts">
import { Controller, Get } from '@nestjs/common';
import { Roles } from '../../guards/roles.decorator';
import type { UserRole } from '../../enums/user-role.enum';

@Controller('moderation/ng-words')
export class NgWordsController {
  @Roles('admin' as UserRole)
  @Get()
  list() {
    return { words: ['badword1', 'badword2'] };
  }
}
</file>

<file path="backend/src/modules/news-ingest/news-ingest.service.ts">
import { Injectable, Logger } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Cron, CronExpression } from '@nestjs/schedule';
import { Repository } from 'typeorm';
import { Post } from 'src/entities/post.entity';
import { User } from 'src/entities/user.entity';
import { PostType } from 'src/enums/post-type.enum';
import { createHash } from 'crypto';

@Injectable()
export class NewsIngestService {
  private readonly logger = new Logger(NewsIngestService.name);

  constructor(
    @InjectRepository(Post) private readonly posts: Repository<Post>,
    @InjectRepository(User) private readonly users: Repository<User>,
  ) {}

  // EVERY_15_MINUTES から EVERY_5_MINUTES に修正
  @Cron(CronExpression.EVERY_5_MINUTES)
  async pollRss() {
    await this.pullAndCreate();
  }

  private hash(link: string) {
    return createHash('sha256').update(link).digest('hex');
  }

  private async fetchItems(): Promise<Array<{ title: string; link: string }>> {
    const feeds = (process.env.RSS_FEEDS || '')
      .split(',')
      .map((s) => s.trim())
      .filter(Boolean);

    const items: Array<{ title: string; link: string }> = [];
    for (const url of feeds) {
      try {
        const res = await fetch(url);
        if (!res.ok) continue;
        const xml = await res.text();
        const itemRegex = /<item[\s\S]*?<\/item>/g;
        const titleRegex = /<title>([\s\S]*?)<\/title>/;
        const linkRegex = /<link>([\s\S]*?)<\/link>/;
        const matches = xml.match(itemRegex) || [];
        for (const m of matches) {
          const title = (m.match(titleRegex)?.[1] || '').trim();
          const link = (m.match(linkRegex)?.[1] || '').trim();
          if (title && link) items.push({ title, link });
        }
      } catch {
        // ignore feed error
      }
    }
    return items;
  }

  private async systemUserId(): Promise<string> {
    const sys = await this.users.findOne({ where: { email: 'system@news.local' } });
    return sys?.id || '00000000-0000-0000-0000-000000000000';
  }

  async pullAndCreate() {
    const items = await this.fetchItems();
    if (!items.length) return;

    const existing = await this.posts
      .createQueryBuilder('p')
      .where('p.type = :type', { type: PostType.NEWS })
      .select(['p.id', 'p.content'])
      .getMany();

    const hashes = new Set<string>();
    for (const p of existing) {
      const match = p.content?.match(/link_hash:([a-f0-9]{64})/);
      if (match?.[1]) hashes.add(match[1]);
    }

    let created = 0;
    for (const item of items) {
      const h = this.hash(item.link);
      if (hashes.has(h)) continue;
      const content = `RSSニュース\nリンク: ${item.link}\nlink_hash:${h}`;
      const post = this.posts.create({
        authorUserId: await this.systemUserId(),
        type: PostType.NEWS,
        title: item.title,
        content,
        mediaIds: null,
        regionId: null,
      } as any);
      await this.posts.save(post);
      hashes.add(h);
      created++;
    }

    if (created > 0) {
      this.logger.log(`News ingested: created ${created} posts`);
    }
  }
}
</file>

<file path="backend/src/modules/notifications/notifications.service.ts">
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { FindOptionsWhere, IsNull, Repository } from 'typeorm';
import { Notification } from 'src/entities/notification.entity';

@Injectable()
export class NotificationsService {
  constructor(@InjectRepository(Notification) private readonly notifications: Repository<Notification>) {}

  async listForUser(userId: string) {
    return this.notifications.find({
      where: { userId, readAt: IsNull() } as FindOptionsWhere<Notification>,
      order: { createdAt: 'DESC' },
    });
  }

  async listUnread(userId: string) {
    return this.notifications.find({
      where: { userId, readAt: IsNull() } as FindOptionsWhere<Notification>,
      order: { createdAt: 'DESC' },
    });
  }

  async markRead(id: string, userId: string) {
    const notif = await this.notifications.findOne({
      where: { id, userId } as FindOptionsWhere<Notification>,
    });
    if (!notif) throw new NotFoundException('Notification not found');
    notif.readAt = new Date();
    await this.notifications.save(notif);
    return { ok: true };
  }
}
</file>

<file path="backend/src/modules/politicians/politicians.controller.ts">
import { Controller, Get, Param, Patch, Body } from '@nestjs/common';
import { PoliticiansService } from './politicians.service';

@Controller('politicians')
export class PoliticiansController {
  constructor(private readonly service: PoliticiansService) {}

  @Get(':id/profile')
  async getProfile(@Param('id') id: string) {
    return this.service.getProfile(id);
  }

  @Patch(':id/profile')
  async updateProfile(
    @Param('id') id: string,
    @Body() dto: Partial<{ name: string; nickname: string; regionId: string; partyId: string }>,
  ) {
    // editorUserId は省略（サービス側で _prefix 未使用扱い）
    return this.service.updateProfile(id, 'system', dto);
  }

  @Get('search')
  async search(
    @Body() params: { region?: string; party?: string; q?: string },
  ) {
    return this.service.search(params);
  }

  @Get(':id/funding-summary')
  async fundingSummary(@Param('id') id: string) {
    return this.service.fundingSummary(id);
  }
}
</file>

<file path="backend/src/modules/politicians/politicians.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Politician } from 'src/entities/politician.entity';
import { PoliticiansService } from './politicians.service';
import { PoliticiansController } from './politicians.controller';

@Module({
  imports: [TypeOrmModule.forFeature([Politician])],
  controllers: [PoliticiansController],
  providers: [PoliticiansService],
  exports: [PoliticiansService],
})
export class PoliticiansModule {}
</file>

<file path="backend/src/modules/politicians/politicians.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository, SelectQueryBuilder } from 'typeorm';
import { Politician } from 'src/entities/politician.entity';

@Injectable()
export class PoliticiansService {
  constructor(@InjectRepository(Politician) private readonly repo: Repository<Politician>) {}

  async getProfile(id: string) {
    return this.repo.findOne({ where: { id } });
  }

  async updateProfile(id: string, _editorUserId: string, dto: Partial<Politician>) {
    await this.repo.update({ id }, dto);
    return this.getProfile(id);
  }

  async search(params: { region?: string; party?: string; q?: string }) {
    let qb: SelectQueryBuilder<Politician> = this.repo.createQueryBuilder('p');
    if (params.region) qb = qb.andWhere('p.regionId = :region', { region: params.region });
    if (params.party) qb = qb.andWhere('p.partyId = :party', { party: params.party });
    if (params.q) qb = qb.andWhere('p.name LIKE :q OR p.nickname LIKE :q', { q: `%${params.q}%` });
    return qb.orderBy('p.createdAt', 'DESC').getMany();
  }

  async fundingSummary(id: string) {
    return { politicianId: id, total: 0, count: 0 };
  }
}
</file>

<file path="backend/src/modules/posts/post.entity.ts">
import {
  Entity,
  PrimaryGeneratedColumn,
  Column,
  ManyToOne,
  CreateDateColumn,
  UpdateDateColumn,
  Index,
  JoinColumn,
  RelationId,
} from 'typeorm';
import { User } from '../../entities/user.entity';

@Entity('posts')
export class Post {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @ManyToOne(() => User, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'authorId' })
  author: User;

  @RelationId((post: Post) => post.author)
  authorId: string;

  @Column({ type: 'text' })
  body: string;

  @Column({ type: 'varchar', nullable: true })
  title?: string;

  @Column({ type: 'simple-enum', enum: ['policy', 'activity'], default: 'activity' })
  @Index()
  postCategory: 'policy' | 'activity';

  @Column({ type: 'boolean', default: false })
  hidden: boolean;

  @Column({ type: 'varchar', nullable: true })
  regionPref?: string;

  @Column({ type: 'varchar', nullable: true })
  regionCity?: string;

  @Column({ type: 'datetime', nullable: true })
  scheduledAt?: Date;

  // 論理削除
  @Column({ type: 'datetime', nullable: true })
  deletedAt?: Date | null;

  @CreateDateColumn({ type: 'datetime' })
  createdAt: Date;

  @UpdateDateColumn({ type: 'datetime' })
  updatedAt: Date;
}
</file>

<file path="backend/src/modules/reactions/reactions.controller.ts">
import { Controller, Get, Query, Post, Body, Request } from '@nestjs/common';

@Controller('reactions')
export class ReactionsController {
  @Get('my')
  async my(@Query('targetId') targetId: string, @Request() req: any) {
    return { ok: true, targetId, userId: req?.user?.id ?? null };
  }

  @Post()
  async create(@Body() body: { targetId: string; type: string }, @Request() req: any) {
    return { ok: true, body, userId: req?.user?.id ?? null };
  }
}
</file>

<file path="backend/src/modules/recommendations/recommendations.controller.ts">
import { Controller, Get, Query } from '@nestjs/common';

@Controller('recommendations')
export class RecommendationsController {
  @Get()
  async list(@Query('limit') limit = '5') {
    const n = Math.min(parseInt(limit, 10) || 5, 20);
    const users = Array.from({ length: n }).map((_, i) => ({
      id: i + 1,
      name: `おすすめユーザー${i + 1}`,
      email: `user${i + 1}@example.com`,
      reason: '共通のトピック/地域/フォロー関係からの暫定レコメンド',
    }));
    return { users };
  }
}
</file>

<file path="backend/src/modules/recommendations/recommendations.module.ts">
import { Module } from '@nestjs/common';
import { RecommendationsController } from './recommendations.controller';

@Module({
  controllers: [RecommendationsController],
})
export class RecommendationsModule {}
</file>

<file path="backend/src/modules/reports/reports.controller.ts">
import { Body, Controller, Post, Request } from '@nestjs/common';
import { ReportsService } from './reports.service';

@Controller('reports')
export class ReportsController {
  constructor(private readonly svc: ReportsService) {}

  @Post()
  async create(
    @Request() req: any,
    @Body()
    body: {
      targetType: 'user' | 'post' | 'comment';
      targetId: string;
      type: string;
      reasonCategory?: string;
      reasonText?: string;
      details?: Record<string, any>;
    },
  ) {
    const reporterId = req?.user?.sub ?? req?.user?.id;
    return this.svc.create({
      reporterId,
      targetType: body.targetType,
      targetId: body.targetId,
      type: body.type,
      reasonCategory: body.reasonCategory,
      reasonText: body.reasonText,
      details: body.details,
    });
  }
}
</file>

<file path="backend/src/modules/reports/reports.service.ts">
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { FindOptionsWhere, Repository } from 'typeorm';
import { Report, ReportStatus } from 'src/entities/report.entity';
import { User } from 'src/entities/user.entity';
import { Post } from 'src/entities/post.entity';
import { Comment } from 'src/entities/comment.entity';

type ReportTargetType = 'user' | 'post' | 'comment';

// ヘルパー: 文字列を許容セットへ安全に変換
function normalizeStatus(input?: string): ReportStatus | undefined {
  if (!input) return undefined;
  const allowed: ReportStatus[] = [
    'pending',
    'reviewed',
    'actioned',
    'rejected',
    'open',
    'reviewing',
    'resolved',
    'dismissed',
  ];
  const s = input.toLowerCase();
  return (allowed as string[]).includes(s) ? (s as ReportStatus) : undefined;
}
function normalizeTargetType(input?: string): ReportTargetType | undefined {
  if (!input) return undefined;
  const allowed: ReportTargetType[] = ['user', 'post', 'comment'];
  const t = input.toLowerCase();
  return (allowed as string[]).includes(t) ? (t as ReportTargetType) : undefined;
}

@Injectable()
export class ReportsService {
  constructor(
    @InjectRepository(Report) private readonly repo: Repository<Report>,
    @InjectRepository(User) private readonly userRepo: Repository<User>,
    @InjectRepository(Post) private readonly postRepo: Repository<Post>,
    @InjectRepository(Comment) private readonly commentRepo: Repository<Comment>,
  ) {}

  async create(data: {
    reporterId: string;
    targetType: ReportTargetType;
    targetId: string;
    type: string;
    details?: Record<string, any>;
    reasonCategory?: string;
    reasonText?: string;
  }) {
    const composedDetails: Record<string, any> | null =
      data.details || data.reasonCategory || data.reasonText
        ? {
            ...(data.details ?? {}),
            ...(data.reasonCategory ? { reasonCategory: data.reasonCategory } : {}),
            ...(data.reasonText ? { reasonText: data.reasonText } : {}),
          }
        : null;

    const r = this.repo.create({
      reporterId: data.reporterId,
      targetType: data.targetType,
      targetId: data.targetId,
      type: data.type,
      data: composedDetails,
      status: 'pending',
      adminNote: null,
    } as any);
    return this.repo.save(r);
  }

  async updateStatus(id: string, status: ReportStatus, adminNote?: string) {
    const r = await this.repo.findOne({ where: { id } as FindOptionsWhere<Report> });
    if (!r) throw new NotFoundException('report not found');
    r.status = status;
    if (adminNote) r.adminNote = adminNote;
    return this.repo.save(r);
  }

  // 文字列パラメータを受けて内部で正規化する
  async list(params: { status?: string; targetType?: string; limit?: number }) {
    const where: any = {};
    const ns = normalizeStatus(params.status);
    const nt = normalizeTargetType(params.targetType);
    if (ns) where.status = ns;
    if (nt) where.targetType = nt;
    const take = params.limit && Number.isFinite(params.limit) ? Math.max(1, Math.min(params.limit, 200)) : 100;
    return this.repo.find({ where, order: { createdAt: 'DESC' }, take });
  }

  async action(id: string, action: 'ban-user' | 'hide-post' | 'hide-comment') {
    const report = await this.repo.findOne({ where: { id } as FindOptionsWhere<Report> });
    if (!report) throw new NotFoundException('report not found');
    return this.actionOnTarget(report, action);
  }

  async actionOnTarget(report: Report, action: 'ban-user' | 'hide-post' | 'hide-comment') {
    if (action === 'ban-user' && report.targetType === 'user') {
      const u = await this.userRepo.findOne({ where: { id: report.targetId } as FindOptionsWhere<User> });
      if (u && 'status' in u) {
        (u as any).status = 'banned';
        await this.userRepo.save(u);
      }
    }

    if (action === 'hide-post' && report.targetType === 'post') {
      const p = await this.postRepo.findOne({ where: { id: report.targetId } as FindOptionsWhere<Post> });
      if (p && 'status' in p) {
        (p as any).status = 'hidden';
        await this.postRepo.save(p);
      }
    }

    if (action === 'hide-comment' && report.targetType === 'comment') {
      const c = await this.commentRepo.findOne({ where: { id: report.targetId } as FindOptionsWhere<Comment> });
      if (c && 'status' in c) {
        (c as any).status = 'hidden';
        await this.commentRepo.save(c);
      }
    }

    report.status = 'actioned';
    return this.repo.save(report);
  }
}
</file>

<file path="backend/src/modules/surveys/surveys.service.ts">
import { Injectable } from '@nestjs/common';

@Injectable()
export class SurveysService {
  async availableForUser(userId: string) {
    // 実装が未定の場合の暫定レスポンス
    return { ok: true, userId, surveys: [] };
  }

  async submitResponse(surveyId: string, userId: string, dto: { answers: Record<string, any> }) {
    // 実装が未定の場合の暫定レスポンス
    return { ok: true, surveyId, userId, answers: dto.answers };
  }
}
</file>

<file path="backend/src/modules/users/users.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from '../../entities/user.entity';
import { Region } from '../../entities/region.entity';
import { Party } from '../../entities/party.entity';
import { UsersService } from './users.service';

@Module({
  imports: [TypeOrmModule.forFeature([User, Region, Party])],
  providers: [UsersService],
  exports: [UsersService],
})
export class UsersModule {}
</file>

<file path="backend/src/scripts/seed.ts">
import { DataSource } from 'typeorm';
import * as bcrypt from 'bcryptjs';
import { User } from 'src/entities/user.entity';

export async function runSeed(ds: DataSource) {
  const userRepo = ds.getRepository(User);

  let citizen1 = userRepo.create({
    email: 'citizen1@example.com',
    passwordHash: await bcrypt.hash('password123', 10),
    name: '佐藤一郎',
    nickname: 'citizen1',
    displayName: '市民1',
    role: 'citizen',
    phoneNumber: '09011112222',
    ageGroup: '30s',
    status: 'active',
  } as any);
  citizen1 = (await userRepo.save(citizen1))!;

  let citizen2 = userRepo.create({
    email: 'citizen2@example.com',
    passwordHash: await bcrypt.hash('password123', 10),
    name: '鈴木次郎',
    nickname: 'citizen2',
    displayName: '市民2',
    role: 'citizen',
    phoneNumber: '09033334444',
    ageGroup: '20s',
    status: 'active',
  } as any);
  citizen2 = (await userRepo.save(citizen2))!;

  let politician = userRepo.create({
    email: 'politician@example.com',
    passwordHash: await bcrypt.hash('password123', 10),
    name: '田中太郎',
    nickname: 'politan',
    displayName: '政治家',
    role: 'politician',
    phoneNumber: '09055556666',
    ageGroup: '40s',
    status: 'active',
  } as any);
  politician = (await userRepo.save(politician))!;

  let systemUser = userRepo.create({
    email: 'system@news.local',
    passwordHash: await bcrypt.hash('password123', 10),
    name: 'システム',
    nickname: 'system',
    displayName: 'システム',
    role: 'admin',
    phoneNumber: null,
    ageGroup: null,
    status: 'active',
  } as any);
  systemUser = (await userRepo.save(systemUser))!;
}
</file>

<file path="frontend/app/profile/page.tsx">
import React from 'react';

// 認証/ユーザー取得のサンプル関数（実装に合わせて差し替えてください）
async function getCurrentUser(): Promise<{
  id: string;
  name?: string | null;
  nickname?: string | null;
  region?: { id: string; name?: string | null } | null;
  supportedParty?: { id: string; name?: string | null } | null;
} | null> {
  // 例: NextAuth or 自前のセッションからユーザーID取得 → API/DBからユーザー情報取得
  // const session = await auth();
  // if (!session?.user?.id) return null;
  // const res = await fetch(`${process.env.API_BASE_URL}/users/${session.user.id}`, { cache: 'no-store' });
  // if (!res.ok) return null;
  // return await res.json();

  // ダミー実装（必ずnull以外を返すわけではないので本番は上記に差し替え）
  return null;
}

export default async function ProfilePage() {
  const user = await getCurrentUser();

  if (!user) {
    // 未ログイン or 取得失敗時の安全なUI
    return (
      <div className="bg-white border rounded p-4">
        <h1 className="text-xl font-bold">プロフィール</h1>
        <p className="text-red-600">ユーザー情報が取得できませんでした。ログインしてください。</p>
        <div className="mt-2">
          <a href="/login" className="text-blue-600 underline">
            ログインページへ
          </a>
        </div>
      </div>
    );
  }

  const name = user.name ?? '-';
  const nickname = user.nickname ?? '-';
  const regionName = user.region?.name ?? '-';
  const partyName = user.supportedParty?.name ?? '-';

  return (
    <div className="bg-white border rounded p-4">
      <h1 className="text-xl font-bold">プロフィール</h1>
      <p>名前: {name}</p>
      <p>ニックネーム: {nickname}</p>
      <p>地域: {regionName}</p>
      <p>支持政党: {partyName}</p>
    </div>
  );
}
</file>

<file path="frontend/app/layout.tsx">
'use client';

import './globals.css';
import Link from 'next/link';
import { AppShell } from '../components/AppShell';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="ja" data-theme="light">
      <body className="min-h-screen bg-gray-50 text-gray-900">
        <header className="sticky top-0 z-50 bg-white border-b">
          <div className="mx-auto max-w-6xl px-4 py-2 flex items-center gap-4">
            <Link href="/" className="font-bold">Political SNS</Link>
            <div className="ml-auto flex items-center gap-3">
              <Link href="/login">ログイン</Link>
              <Link href="/register" className="rounded bg-blue-600 text-white px-3 py-1">新規登録</Link>
            </div>
          </div>
        </header>
        <AppShell>{children}</AppShell>
      </body>
    </html>
  );
}

// Next.js layout: default export is required by framework; no extra named export needed
</file>

<file path="frontend/components/CommentsSection.tsx">
'use client';

import { useState } from 'react';
import { useComments } from '../lib/hooks/useComments';

type Props = { postId: string };

export default function CommentsSection({ postId }: Props) {
  const { comments, isLoading, error, addComment } = useComments(postId);
  const [text, setText] = useState<string>('');
  const [submitting, setSubmitting] = useState<boolean>(false);

  function extractMentions(input: string): string[] {
    const matches = input.match(/@([\w_]+)/g) || [];
    return matches.map((m) => m.slice(1));
  }

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    setSubmitting(true);
    try {
      const mentions = extractMentions(text);
      await addComment({ text, mentions });
      setText('');
    } catch (e: any) {
      alert(e?.message || 'コメント送信に失敗しました');
    } finally {
      setSubmitting(false);
    }
  }

  return (
    <div className="flex flex-col gap-2">
      <form onSubmit={onSubmit} className="flex gap-2">
        <input
          className="border rounded px-2 py-1 flex-1"
          placeholder="コメントを入力（@nickname でメンション）"
          value={text}
          onChange={(e) => setText(e.target.value)}
          aria-label="コメント入力"
        />
        <button
          className="rounded bg-blue-600 text-white px-3 py-1"
          type="submit"
          disabled={submitting}
          aria-disabled={submitting}
        >
          {submitting ? '送信中...' : '送信'}
        </button>
      </form>

      {isLoading && <div className="text-sm text-gray-600">読み込み中…</div>}
      {error && <div className="text-sm text-red-700">コメント取得に失敗しました</div>}

      <ul className="flex flex-col gap-2">
        {comments.map((c) => (
          <li key={c.id} className="border rounded px-2 py-1">
            <div className="text-xs text-gray-500">{new Date(c.createdAt).toLocaleString()}</div>
            <div className="whitespace-pre-wrap">{c.content}</div>
          </li>
        ))}
      </ul>
    </div>
  );
}
</file>

<file path="frontend/lib/hooks/useComments.ts">
'use client';

import useSWR from 'swr';
import { fetchComments, createComment, Comment } from '../api';

export function useComments(postId: string) {
  const key = `/posts/${postId}/comments`;
  const { data, error, isLoading, mutate } = useSWR<Comment[]>(key, () => fetchComments(postId));

  async function addComment(payload: { text: string; mediaIds?: string[]; mentions?: string[] }) {
    await createComment(postId, payload);
    await mutate();
  }

  return {
    comments: data || [],
    error,
    isLoading,
    addComment,
    mutate,
  };
}

export { useComments }
</file>

<file path="frontend/lib/api-extended.ts">
import { apiFetchWithAuth, unwrap } from './api';

export async function createReport(
  targetId: string,
  targetType: 'post' | 'comment' | 'user',
  reason?: string,
) {
  const res = await apiFetchWithAuth('/reports', {
    method: 'POST',
    body: JSON.stringify({ targetId, targetType, reason: reason ?? '' }),
  });
  return unwrap(res);
}

export async function verifyEmail(token: string) {
  const res = await apiFetchWithAuth('/auth/verify-email', {
    method: 'POST',
    body: JSON.stringify({ token }),
  });
  return unwrap(res);
}

export async function verifyPhone(code: string) {
  const res = await apiFetchWithAuth('/auth/verify-phone', {
    method: 'POST',
    body: JSON.stringify({ code }),
  });
  return unwrap(res);
}

export { createReport, verifyEmail, verifyPhone }
</file>

<file path="frontend/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "ESNext",
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "baseUrl": ".",
    "paths": {
      "@/": [
        ""
      ]
    },
    "plugins": [
      {
        "name": "next"
      }
    ],
    "types": [
      "node"
    ]
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="backend/src/auth/auth.service.ts">
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import * as bcrypt from 'bcryptjs';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { User } from 'src/entities/user.entity';

type JwtPayload = {
  sub: string;
  email?: string;
  role?: string;
  nickname?: string | null;
};

@Injectable()
export class AuthService {
  constructor(
    private readonly jwt: JwtService,
    @InjectRepository(User) private readonly users: Repository<User>,
  ) {}

  async validateUser(id: string, password: string): Promise<User> {
    const user =
      (await this.users.findOne({ where: { email: id } })) ??
      (await this.users.findOne({ where: { phoneNumber: id } })); // phone -> phoneNumber に修正
    if (!user) throw new UnauthorizedException('User not found');
    const ok = await bcrypt.compare(password, user.passwordHash);
    if (!ok) throw new UnauthorizedException('Invalid credentials');
    return user;
  }

  async login(id: string, password: string) {
    const user = await this.validateUser(id, password);
    const payload: JwtPayload = { sub: user.id, email: user.email, role: user.role, nickname: user.nickname };

    const accessToken = await this.jwt.signAsync(payload, { expiresIn: 900 });
    const refreshToken = await this.jwt.signAsync(payload, { expiresIn: '7d' });

    return {
      user: {
        id: user.id,
        email: user.email,
        role: user.role,
        nickname: user.nickname,
        addressPref: user.addressPref,
        addressCity: user.addressCity,
      },
      accessToken,
      refreshToken,
    };
  }
}
</file>

<file path="backend/src/entities/vote.entity.ts">
import { Column, Entity, Index, ManyToOne, PrimaryGeneratedColumn } from 'typeorm';
import { User } from 'src/entities/user.entity';
import { Post } from 'src/entities/post.entity';

export enum VoteChoice {
  AGREE = 'agree',
  DISAGREE = 'disagree',
}

@Entity('votes')
export class Vote {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  @Index()
  @Column({ type: 'uuid' })
  postId!: string;

  @Index()
  @Column({ type: 'uuid' })
  voterUserId!: string;

  @Column({ type: 'enum', enum: VoteChoice })
  choice!: VoteChoice;

  @ManyToOne(() => User, (user) => user.votes)
  user!: User;

  @ManyToOne(() => Post, (post) => post.votes)
  post!: Post;
}
</file>

<file path="backend/src/modules/admin/admin.controller.ts">
import { Controller, Get } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { User } from 'src/entities/user.entity';
import { Post } from 'src/entities/post.entity';
import { Vote } from 'src/entities/vote.entity';

@Controller('api/admin')
export class AdminController {
  constructor(
    @InjectRepository(User) private readonly users: Repository<User>,
    @InjectRepository(Post) private readonly posts: Repository<Post>,
    @InjectRepository(Vote) private readonly voteRepo: Repository<Vote>,
  ) {}

  @Get('users')
  async listUsers() {
    return this.users.find();
  }

  @Get('posts/analytics')
  async getPostsAnalytics() {
    // 全投稿＋投稿者情報取得
    const allPosts = await this.posts.find({ relations: ['author'] });

    // 全投票を一気に取得
    const allVotes = await this.voteRepo.find();

    return allPosts.map((p) => {
      // 投稿に紐づく投票を抽出
      const votesForThisPost = allVotes.filter((v: any) => v.postId === p.id);
      // support/oppose集計（anyにより型エラー回避）
      const likeCount = votesForThisPost.filter((v: any) => v.type === 'support').length;
      const disagreeCount = votesForThisPost.filter((v: any) => v.type === 'oppose').length;
      const commentCount = 0; // コメント機能追加時はここを拡張
      return {
        id: p.id,
        title: p.title,
        likes: likeCount,
        comments: commentCount,
        disagrees: disagreeCount,
        authorId: p.authorUserId ?? (p.author?.id ?? null),
      };
    });
  }

  @Get('comments')
  async getAllComments() {
    // コメントAPIは必要あれば拡張
    return [];
  }
}
</file>

<file path="backend/src/modules/auth/auth.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from 'src/entities/user.entity';
import { Politician } from 'src/entities/politician.entity';
import { AuthController } from './auth.controller';
import { AuthService } from './auth.service';

@Module({
  imports: [TypeOrmModule.forFeature([User, Politician])],
  controllers: [AuthController],
  providers: [AuthService],
})
export class AuthModule {}
</file>

<file path="backend/src/modules/auth/auth.service.ts">
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { User } from 'src/entities/user.entity';
import { Politician } from 'src/entities/politician.entity';
import * as bcrypt from 'bcrypt';
import * as jwt from 'jsonwebtoken';

@Injectable()
export class AuthService {
  constructor(
    @InjectRepository(User) private readonly users: Repository<User>,
    @InjectRepository(Politician) private readonly politicians: Repository<Politician>,
  ) {}

  async adminSignup(email: string, password: string) {
    const existing = await this.users.findOne({ where: { email } });
    if (existing) throw new UnauthorizedException('email already registered');
    const passwordHash = await bcrypt.hash(password, 10);
    const u = this.users.create({ email, passwordHash, role: 'admin', status: 'active' } as any);
    await this.users.save(u);
    return { ok: true };
  }

  async politicianSignup(input: { email: string; password: string; name: string; regionId?: string | null; partyId?: string | null }) {
    const existing = await this.users.findOne({ where: { email: input.email } });
    if (existing) throw new UnauthorizedException('email already registered');
    const passwordHash = await bcrypt.hash(input.password, 10);
    const u = this.users.create({ email: input.email, passwordHash, role: 'politician', status: 'active' } as any);
    await this.users.save(u);
    const p = this.politicians.create({
      name: input.name,
      regionId: input.regionId ?? null,
      partyId: input.partyId ?? null,
    } as any);
    await this.politicians.save(p);
    return { ok: true };
  }

  async login(email: string, password: string, expectedRole: 'admin' | 'politician') {
    const u = await this.users.findOne({ where: { email } });
    if (!u) throw new UnauthorizedException('invalid credentials');
    const ok = await bcrypt.compare(password, u.passwordHash);
    if (!ok) throw new UnauthorizedException('invalid credentials');
    if (u.role !== expectedRole) throw new UnauthorizedException('invalid role');
    const token = jwt.sign({ sub: u.id, role: u.role }, process.env.JWT_SECRET ?? 'dev-secret', { expiresIn: '7d' });
    return { token };
  }
}
</file>

<file path="backend/src/modules/comments/dto/create-comment.dto.ts">
import { IsArray, IsOptional, IsString } from 'class-validator';

export class CreateCommentDto {
  @IsString()
  content: string;

  @IsOptional()
  @IsArray()
  mediaIds?: string[];

  // フロントで @nickname を解析して渡すか、サーバー側で解析するかは実装次第
  @IsOptional()
  @IsArray()
  mentions?: string[]; // nickname の配列（サーバー側でユーザーIDに解決）
}
</file>

<file path="backend/src/modules/comments/comments.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { CommentsController } from './comments.controller';
import { CommentsService } from './comments.service';
import { Comment } from '../../entities/comment.entity';
import { Post } from '../../entities/post.entity';
import { User } from '../../entities/user.entity';
import { UsersModule } from '../users/users.module';
import { NotificationsModule } from '../notifications/notifications.module';
import { PostsModule } from '../posts/posts.module';

@Module({
  imports: [
    TypeOrmModule.forFeature([Comment, Post, User]),
    UsersModule,
    NotificationsModule,
    PostsModule,
  ],
  controllers: [CommentsController],
  providers: [CommentsService],
  exports: [CommentsService],
})
export class CommentsModule {}
</file>

<file path="backend/src/modules/follows/follows.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Follow } from '../../entities/follow.entity';
import { User } from '../../entities/user.entity';
import { FollowsService } from './follows.service';
import { FollowsController } from './follows.controller';

@Module({
  imports: [TypeOrmModule.forFeature([Follow, User])],
  controllers: [FollowsController],
  providers: [FollowsService],
  exports: [FollowsService],
})
export class FollowsModule {}
</file>

<file path="backend/src/modules/media/media.controller.ts">
import { Body, Controller, Delete, Get, Param, Post, Query, Request } from '@nestjs/common';
import { MediaService } from './media.service';

@Controller('media')
export class MediaController {
  constructor(private readonly svc: MediaService) {}

  @Post()
  async create(
    @Request() req: any,
    @Body()
    body: {
      category?: string | null;
      type: string;
      path: string;
      originalName?: string | null;
      sizeBytes?: number | null;
      mimeType?: string | null;
      meta?: Record<string, any> | null;
    },
  ) {
    const ownerUserId = req?.user?.sub ?? req?.user?.id ?? null;
    return this.svc.create({
      ownerUserId,
      category: body.category ?? null,
      type: body.type,
      path: body.path,
      originalName: body.originalName ?? null,
      sizeBytes: body.sizeBytes ?? null,
      mimeType: body.mimeType ?? null,
      meta: body.meta ?? null,
    });
  }

  @Get()
  async list(@Request() req: any, @Query('limit') limit?: number) {
    const ownerUserId = req?.user?.sub ?? req?.user?.id;
    return this.svc.listByOwner(ownerUserId, limit ?? 100);
  }

  @Get(':id')
  async get(@Param('id') id: string) {
    return this.svc.get(id);
  }

  @Post(':id/meta')
  async updateMeta(@Param('id') id: string, @Body() body: { meta: Record<string, any> }) {
    return this.svc.updateMeta(id, body.meta);
  }

  @Delete(':id')
  async delete(@Param('id') id: string) {
    return this.svc.delete(id);
  }
}
</file>

<file path="backend/src/modules/media/media.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Media } from 'src/entities/media.entity';

export type CreateMediaParams = {
  ownerUserId?: string | null;
  category?: string | null;
  type: string;
  path: string;
  originalName?: string | null;
  sizeBytes?: number | null;
  mimeType?: string | null;
  meta?: Record<string, any> | null;
};

@Injectable()
export class MediaService {
  constructor(@InjectRepository(Media) private readonly repo: Repository<Media>) {}

  async create(params: CreateMediaParams) {
    const record = this.repo.create({
      ownerUserId: params.ownerUserId ?? null,
      category: params.category ?? null,
      type: params.type,
      path: params.path,
      originalName: params.originalName ?? null,
      sizeBytes: params.sizeBytes ?? null,
      mimeType: params.mimeType ?? null,
      meta: params.meta ?? null,
    } as any);
    return this.repo.save(record);
  }

  async listByOwner(ownerUserId: string, limit = 100) {
    return this.repo.find({
      where: { ownerUserId },
      order: { createdAt: 'DESC' },
      take: Math.max(1, Math.min(limit, 200)),
    });
  }

  async get(id: string) {
    return this.repo.findOne({ where: { id } });
  }

  async updateMeta(id: string, meta: Record<string, any>) {
    const m = await this.repo.findOne({ where: { id } });
    if (!m) return null;
    m.meta = meta;
    return this.repo.save(m);
  }

  async delete(id: string) {
    await this.repo.delete({ id });
    return { ok: true };
  }
}
</file>

<file path="backend/src/modules/news-ingest/news-ingest.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { NewsIngestService } from './news-ingest.service';
import { Post } from 'src/entities/post.entity';
import { User } from 'src/entities/user.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Post, User])],
  providers: [NewsIngestService],
  exports: [NewsIngestService],
})
export class NewsIngestModule {}
</file>

<file path="backend/src/modules/posts/dto/create-post.dto.ts">
import { IsArray, IsEnum, IsOptional, IsString, MaxLength } from 'class-validator';
import { PostType } from '../../../enums/post-type.enum';

export class CreatePostDto {
  @IsEnum(PostType)
  type: PostType;

  @IsString()
  @MaxLength(256)
  title: string;

  @IsString()
  content: string;

  @IsOptional()
  @IsArray()
  mediaIds?: string[];

  @IsOptional()
  @IsString()
  regionId?: string;
}
</file>

<file path="backend/src/modules/posts/posts.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { PostsController } from './posts.controller';
import { PostsService } from './posts.service';
import { Post } from '../../entities/post.entity';
import { User } from '../../entities/user.entity';
import { Region } from '../../entities/region.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Post, User, Region])],
  controllers: [PostsController],
  providers: [PostsService],
  exports: [PostsService],
})
export class PostsModule {}
</file>

<file path="backend/src/modules/users/dto/create-user.dto.ts">
import { IsEmail, IsString, MinLength, IsOptional } from 'class-validator';

export class CreateUserDto {
  @IsString() name: string;
  @IsString() nickname: string;
  @IsString() phone: string;
  @IsEmail() email: string;
  @IsString() @MinLength(8) password: string;
  @IsOptional() regionId?: string;
}
</file>

<file path="backend/src/modules/users/dto/update-user.dto.ts">
import { IsOptional, IsString } from 'class-validator';

export class UpdateUserDto {
  @IsOptional() @IsString() name?: string;
  @IsOptional() @IsString() nickname?: string;
  @IsOptional() @IsString() phone?: string;
  @IsOptional() @IsString() addressPref?: string;
  @IsOptional() @IsString() addressCity?: string;
}
</file>

<file path="backend/src/modules/users/users.controller.ts">
import { Body, Controller, Get, Param, Post } from '@nestjs/common';
import { UsersService } from './users.service';
import { RegisterUserDto } from 'src/auth/dto/register-user.dto';

@Controller('users')
export class UsersController {
  constructor(private readonly users: UsersService) {}

  @Get()
  async list() {
    return this.users.findAll();
  }

  @Get(':id')
  async findById(@Param('id') id: string) {
    return this.users.findById(id);
  }

  @Post()
  async createUser(@Body() dto: RegisterUserDto) {
    return this.users.createUser(dto);
  }
}
</file>

<file path="backend/src/modules/votes/dto/create-vote.dto.ts">
import { IsEnum } from 'class-validator';
import { VoteChoice } from '../../../enums/vote-choice.enum';

export class CreateVoteDto {
  @IsEnum(VoteChoice)
  choice: VoteChoice;
}
</file>

<file path="backend/src/modules/votes/votes.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { VotesController } from './votes.controller';
import { VotesService } from './votes.service';
import { Vote } from '../../entities/vote.entity';
import { Post } from '../../entities/post.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Vote, Post])],
  controllers: [VotesController],
  providers: [VotesService],
  exports: [VotesService],
})
export class VotesModule {}
</file>

<file path="backend/src/modules/votes/votes.service.ts">
import { ConflictException, Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Vote } from '../../entities/vote.entity';
import { Post } from '../../entities/post.entity';
import { CreateVoteDto } from './dto/create-vote.dto';

@Injectable()
export class VotesService {
  constructor(
    @InjectRepository(Vote) private readonly votes: Repository<Vote>,
    @InjectRepository(Post) private readonly posts: Repository<Post>,
  ) {}

  async cast(postId: string, voterUserId: string, dto: CreateVoteDto) {
    const post = await this.posts.findOne({ where: { id: postId } });
    if (!post) throw new NotFoundException('Post not found');

    // 1ユーザー1回（Unique制約で担保し、サービス層で409返す）
    const existing = await this.votes.findOne({ where: { postId, voterUserId } });
    if (existing) throw new ConflictException('Already voted');

    const vote = this.votes.create({ postId, voterUserId, choice: dto.choice });
    return this.votes.save(vote);
  }

  async summary(postId: string) {
    const rows = await this.votes.find({ where: { postId } });
    const summary = rows.reduce(
      (acc, v) => {
        acc[v.choice] = (acc[v.choice] || 0) + 1;
        return acc;
      },
      {} as Record<string, number>,
    );
    return { postId, summary, total: rows.length };
  }
}
</file>

<file path="frontend/app/login/page.tsx">
'use client';

import { useState } from 'react';
import { API_BASE } from '../../lib/api';
import Link from 'next/link';

export default function LoginPage() {
  const [id, setId] = useState('');
  const [password, setPassword] = useState('');
  const [kycWarning, setKycWarning] = useState<string | null>(null);

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    const res = await fetch(`${API_BASE}/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ id, password }),
    });
    if (!res.ok) {
      alert('ログイン失敗');
      return;
    }
    alert('ログインしました');
    // After login, simple KYC check (replace with robust auth/me)
    try {
      const meRes = await fetch(`${API_BASE}/auth/me`, { credentials: 'include' });
      if (meRes.ok) {
        const me = await meRes.json();
        const status = me?.user?.kycStatus;
        if (status !== 'verified') {
          setKycWarning('KYC 未検証です。アンケート報酬を受け取れません。');
        }
      }
    } catch { /* ignore */ }
    location.href = '/feed';
  }

  return (
    <div className="bg-white border rounded p-4 max-w-md mx-auto">
      <h1 className="text-xl font-bold mb-3">ログイン</h1>
      {kycWarning && (
        <div className="bg-yellow-50 border border-yellow-300 text-yellow-800 rounded p-2 mb-3">
          {kycWarning}
        </div>
      )}
      <form onSubmit={onSubmit} className="flex flex-col gap-2">
        <input className="border rounded px-3 py-2" placeholder="メールまたは電話" value={id} onChange={(e)=>setId(e.target.value)} />
        <input className="border rounded px-3 py-2" type="password" placeholder="パスワード" value={password} onChange={(e)=>setPassword(e.target.value)} />
        <button className="rounded bg-blue-600 text-white px-3 py-2">ログイン</button>
      </form>
      <div className="mt-3 flex items-center gap-2">
        <Link href="/kyc" className="rounded bg-gray-800 text-white px-3 py-2">マイナンバーか免許証をアップロードする</Link>
        <Link href="/register" className="text-blue-700">新規登録へ</Link>
      </div>
    </div>
  );
}
</file>

<file path="frontend/lib/api.ts">
// Re-generated complete API client (named exports only; explicit export list)

export const API_BASE = process.env.NEXT_PUBLIC_API_BASE_URL || 'http://localhost:3001';

export async function apiFetchWithAuth(path: string, init: RequestInit = {}) {
  const headers = new Headers(init.headers || {});
  if (init.body && !headers.has('Content-Type')) {
    headers.set('Content-Type', 'application/json');
  }
  const res = await fetch(`${API_BASE}${path}`, {
    ...init,
    headers,
    credentials: 'include',
  });
  return res;
}

export async function unwrap<T = any>(res: Response): Promise<T> {
  let data: any = null;
  try {
    data = await res.json();
  } catch (_) {}
  if (res.ok) return data as T;
  const status = res.status;
  const message =
    data?.error?.message ||
    data?.message ||
    `HTTP ${status}`;
  const errors = data?.errors || data?.error || null;

  const err = new Error(message) as any;
  err.status = status;
  err.errors = errors;
  throw err;
}

export type Post = {
  id: string;
  authorUserId: string;
  type: 'activity' | 'pledge' | 'question' | 'news';
  title: string;
  content: string;
  createdAt: string;
  mediaIds?: string[];
  regionId?: string;
  agreeCount?: number;
  disagreeCount?: number;
  commentCount?: number;
};

export type Comment = {
  id: string;
  postId: string;
  authorUserId: string;
  content: string;
  createdAt: string;
  mediaIds?: string[];
  mentions?: string[];
};

export async function fetchFeed(params?: {
  type?: 'activity' | 'pledge' | 'question' | 'news';
  region?: string;
  q?: string;
  page?: number;
  limit?: number;
}): Promise<Post[]> {
  const query = new URLSearchParams();
  if (params?.type) query.set('type', params.type);
  if (params?.region) query.set('region', params.region);
  if (params?.q) query.set('q', params.q);
  if (params?.page != null) query.set('page', String(params.page));
  if (params?.limit != null) query.set('limit', String(params.limit));

  const res = await apiFetchWithAuth(`/posts${query.toString() ? `?${query.toString()}` : ''}`, {
    method: 'GET',
  });
  return unwrap<Post[]>(res);
}

export async function fetchComments(postId: string): Promise<Comment[]> {
  const res = await apiFetchWithAuth(`/posts/${postId}/comments`, { method: 'GET' });
  return unwrap<Comment[]>(res);
}

export async function createComment(
  postId: string,
  body: { text: string; mediaIds?: string[]; mentions?: string[] },
): Promise<Comment> {
  const payload = {
    content: body.text,
    mediaIds: body.mediaIds ?? [],
    mentions: body.mentions ?? [],
  };
  const res = await apiFetchWithAuth(`/posts/${postId}/comments`, {
    method: 'POST',
    body: JSON.stringify(payload),
  });
  return unwrap<Comment>(res);
}

export async function votePost(postId: string, choice: 'agree' | 'disagree') {
  const res = await apiFetchWithAuth(`/posts/${postId}/votes`, {
    method: 'POST',
    body: JSON.stringify({ choice }),
  });
  return unwrap(res);
}

export async function fetchPolitician(id: string) {
  const res = await apiFetchWithAuth(`/politicians/${id}`, { method: 'GET' });
  return unwrap(res);
}

export async function fetchFundingSummary(id: string) {
  const res = await apiFetchWithAuth(`/politicians/${id}/funding/summary`, { method: 'GET' });
  return unwrap(res);
}

export async function follow(targetUserId: string) {
  const res = await apiFetchWithAuth(`/follows/${targetUserId}`, { method: 'POST' });
  return unwrap(res);
}

export async function unfollow(targetUserId: string) {
  const res = await apiFetchWithAuth(`/follows/${targetUserId}`, { method: 'DELETE' });
  return unwrap(res);
}

export async function fetchSurveysAvailable() {
  const res = await apiFetchWithAuth(`/surveys/available`, { method: 'GET' });
  return unwrap(res);
}

export async function answerSurvey(id: string, answers: any) {
  const res = await apiFetchWithAuth(`/surveys/${id}/responses`, {
    method: 'POST',
    body: JSON.stringify({ answers }),
  });
  return unwrap(res);
}

export async function fetchWalletTransactions() {
  const res = await apiFetchWithAuth(`/wallet/transactions`, { method: 'GET' });
  return unwrap(res);
}

export async function fetchNotifications() {
  const res = await apiFetchWithAuth(`/notifications`, { method: 'GET' });
  return unwrap(res);
}

export async function markNotificationRead(id: string) {
  const res = await apiFetchWithAuth(`/notifications/${id}/read`, { method: 'PATCH' });
  return unwrap(res);
}

export async function fetchDashboardPosts() {
  const res = await apiFetchWithAuth(`/analytics/my/posts`, { method: 'GET' });
  return unwrap(res);
}

export async function fetchDashboardFollowers() {
  const res = await apiFetchWithAuth(`/analytics/my/followers/demographics`, { method: 'GET' });
  return unwrap(res);
}

export function downloadDashboardCsv(): string {
  return `${API_BASE}/analytics/my/export.csv`;
}

export {
  API_BASE,
  apiFetchWithAuth,
  unwrap,
  fetchFeed,
  fetchComments,
  createComment,
  votePost,
  fetchPolitician,
  fetchFundingSummary,
  follow,
  unfollow,
  fetchSurveysAvailable,
  answerSurvey,
  fetchWalletTransactions,
  fetchNotifications,
  markNotificationRead,
  fetchDashboardPosts,
  fetchDashboardFollowers,
  downloadDashboardCsv,
  Post,
  Comment,
}
</file>

<file path=".gitignore">
# Node / monorepo common
node_modules/
dist/
.tmp/
.coverage/
coverage/
logs/
*.log

# Package manager debug logs
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*

# Editors / OS
.DS_Store
Thumbs.db
.idea/

# Editors
.vscode/

# Env & secrets
.env
.env.*
!.env.example
backend/.env
backend/.env.*

# Databases
*.sqlite
*.db

# Frontend (Next.js)
frontend/.next/
frontend/.turbo/
frontend/out/
</file>

<file path="backend/src/entities/comment.entity.ts">
import { Column, CreateDateColumn, Entity, Index, ManyToOne, OneToMany, PrimaryGeneratedColumn } from 'typeorm';
import { Post } from './post.entity';
import { User } from './user.entity';
import { CommentReaction } from './comment-reaction.entity';

@Entity('comments')
export class Comment {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  @Index()
  @Column({ type: 'uuid' })
  postId!: string;

  @ManyToOne(() => Post, { onDelete: 'CASCADE' })
  post!: Post;

  @Index()
  @Column({ type: 'uuid' })
  authorUserId!: string;

  @ManyToOne(() => User, { onDelete: 'CASCADE' })
  author!: User;

  @Column({ type: 'text' })
  content!: string;

  @Column({ type: 'jsonb', nullable: true })
  mediaIds!: string[] | null;

  @Column({ type: 'jsonb', nullable: true })
  mentions!: string[] | null;

  @CreateDateColumn({ type: 'timestamp with time zone' })
  createdAt!: Date;

  @OneToMany(() => CommentReaction, (r) => r.comment)
  reactions!: CommentReaction[];
}
</file>

<file path="backend/src/enums/user-role.enum.ts">
export enum UserRoleEnum {
  CITIZEN = 'citizen',
  POLITICIAN = 'politician',
  ADMIN = 'admin',
}

export const USER_ROLES = [UserRoleEnum.CITIZEN, UserRoleEnum.POLITICIAN, UserRoleEnum.ADMIN] as const;

// 型エイリアス（配列から導出）
export type UserRole = (typeof USER_ROLES)[number];
</file>

<file path="backend/src/modules/auth/auth.controller.ts">
import { Body, Controller, Post, UnauthorizedException } from '@nestjs/common';
import { AuthService } from './auth.service';

@Controller('api/auth')
export class AuthController {
  constructor(private readonly auth: AuthService) {}

  @Post('admin/signup')
  adminSignup(@Body() body: { email: string; password: string }) {
    // @keygo.jp 以外は弾く
    if (!body.email.endsWith('@keygo.jp')) {
      throw new UnauthorizedException('管理者アカウントは @keygo.jp ドメインのみ登録できます');
    }
    return this.auth.adminSignup(body.email, body.password);
  }

  @Post('admin/login')
  adminLogin(@Body() body: { email: string; password: string }) {
    return this.auth.login(body.email, body.password, 'admin');
  }

  @Post('politician/signup')
  politicianSignup(@Body() body: { email: string; password: string; name: string; regionId?: string | null; partyId?: string | null }) {
    return this.auth.politicianSignup(body);
  }

  @Post('politician/login')
  politicianLogin(@Body() body: { email: string; password: string }) {
    return this.auth.login(body.email, body.password, 'politician');
  }
}
</file>

<file path="backend/src/modules/comments/comments.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { FindOptionsWhere, Repository } from 'typeorm';
import { Comment } from 'src/entities/comment.entity';
import { CreateCommentDto } from './dto/create-comment.dto';

@Injectable()
export class CommentsService {
  constructor(@InjectRepository(Comment) private readonly commentsRepo: Repository<Comment>) {}

  // listByPost -> list
  async list(postId: string, _cursor?: string, limit = 20) {
    return this.commentsRepo.find({
      where: { postId } as FindOptionsWhere<Comment>,
      order: { createdAt: 'ASC' },
      take: limit,
      relations: ['reactions', 'mentions', 'parent', 'children'],
    });
  }

  // createComment -> create
  async create(postId: string, authorId: string, dto: CreateCommentDto) {
    const c = this.commentsRepo.create({
      postId,
      authorUserId: authorId,
      content: dto.content,
      parentId: null,
    } as any);
    return this.commentsRepo.save(c);
  }
}
</file>

<file path="backend/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "CommonJS",
    "lib": ["ES2022"],
    "declaration": false,
    "sourceMap": true,
    "outDir": "./dist",
    "rootDir": "./src",
    "removeComments": true,
    "strict": true,
    "strictPropertyInitialization": false,
    "noImplicitAny": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "esModuleInterop": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "moduleResolution": "node",
    "resolveJsonModule": true,
    "skipLibCheck": true,
    "types": ["node"],
    "baseUrl": ".",
    "paths": {
      "src/": ["src/"],
      "src/*": ["src/*"]
    }
  },
  "include": ["src/**/*.ts"],
  "exclude": ["node_modules", "dist"]
}
</file>

<file path="frontend/app/register/page.tsx">
'use client';

import { useEffect, useMemo, useState } from 'react';
import { API_BASE } from '../../lib/api';
import { PREFECTURES, CITIES_BY_PREF } from '../../lib/japanLocation';

export default function RegisterPage() {
  const [name, setName] = useState('');
  const [nickname, setNickname] = useState('');
  const [ageGroup, setAgeGroup] = useState('twenties');

  // 名称ベースの選択（prefName / cityName）
  const [prefName, setPrefName] = useState('');
  const [cityName, setCityName] = useState('');

  const [phone, setPhone] = useState('');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');

  // KYC 任意アップロード
  const [licenseFile, setLicenseFile] = useState<File | null>(null);
  const [myNumberFile, setMyNumberFile] = useState<File | null>(null);
  const [uploading, setUploading] = useState(false);
  const [licenseMediaId, setLicenseMediaId] = useState<string | null>(null);
  const [myNumberMediaId, setMyNumberMediaId] = useState<string | null>(null);

  useEffect(() => {
    // 都道府県が変わったら市区町村選択をリセット
    setCityName('');
  }, [prefName]);

  const cities = useMemo(() => {
    if (!prefName) return [];
    return CITIES_BY_PREF[prefName] || [];
  }, [prefName]);

  async function uploadKyc(file: File): Promise<string | null> {
    const form = new FormData();
    form.append('file', file);
    form.append('category', 'kyc');
    try {
      setUploading(true);
      const res = await fetch(`${API_BASE}/media/upload`, {
        method: 'POST',
        body: form,
        credentials: 'include',
      });
      setUploading(false);
      if (!res.ok) {
        alert('アップロードに失敗しました');
        return null;
      }
      const data = await res.json();
      return data.mediaId as string;
    } catch (e: any) {
      setUploading(false);
      alert(e?.message || 'アップロードに失敗しました');
      return null;
    }
  }

  async function onSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (!name || !nickname || !phone || !email || !password) {
      alert('必須項目を入力してください');
      return;
    }

    // 任意アップロード
    if (licenseFile) {
      const id = await uploadKyc(licenseFile);
      if (id) setLicenseMediaId(id);
    }
    if (myNumberFile) {
      const id = await uploadKyc(myNumberFile);
      if (id) setMyNumberMediaId(id);
    }

    // regionId は cityName → prefName の優先で名称ベースを送信
    const regionId = cityName || prefName || '';

    const payload = {
      name,
      nickname, // ニックネーム（表示させる名前）
      ageGroup,
      regionId,
      phone,
      email,
      password,
      kycDocuments: {
        licenseMediaId,
        myNumberMediaId,
      },
    };

    const res = await fetch(`${API_BASE}/auth/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(payload),
    });

    if (!res.ok) {
      const text = await res.text().catch(() => '');
      alert(`登録失敗: ${text}`);
      return;
    }

    alert('登録成功。ログインしてください');
    location.href = '/login';
  }

  return (
    <div className="bg-white border rounded p-4 max-w-2xl mx-auto">
      <h1 className="text-xl font-bold mb-3">新規登録</h1>
      <form onSubmit={onSubmit} className="grid grid-cols-2 gap-3">
        <label className="col-span-2">
          <span className="block text-sm text-gray-600">名前</span>
          <input className="border rounded px-3 py-2 w-full" value={name} onChange={(e)=>setName(e.target.value)} required />
        </label>

        <label className="col-span-2">
          <span className="block text-sm text-gray-600">ニックネーム（表示させる名前）</span>
          <input className="border rounded px-3 py-2 w-full" value={nickname} onChange={(e)=>setNickname(e.target.value)} required />
        </label>

        <label>
          <span className="block text-sm text-gray-600">年代</span>
          <select className="border rounded px-3 py-2 w-full" value={ageGroup} onChange={(e)=>setAgeGroup(e.target.value)}>
            <option value="teen">10代</option>
            <option value="twenties">20代</option>
            <option value="thirties">30代</option>
            <option value="forties">40代</option>
            <option value="fifties">50代</option>
            <option value="sixties_plus">60代以上</option>
          </select>
        </label>

        <div className="grid grid-cols-2 gap-3 col-span-2">
          <label>
            <span className="block text-sm text-gray-600">都道府県（名称）</span>
            <select className="border rounded px-3 py-2 w-full" value={prefName} onChange={(e)=>setPrefName(e.target.value)}>
              <option value="">選択してください</option>
              {PREFECTURES.map((p) => <option key={p.code} value={p.name}>{p.name}</option>)}
            </select>
          </label>
          <label>
            <span className="block text-sm text-gray-600">市区町村（名称）</span>
            <select className="border rounded px-3 py-2 w-full" value={cityName} onChange={(e)=>setCityName(e.target.value)} disabled={!prefName}>
              <option value="">選択してください</option>
              {cities.map((c) => <option key={c} value={c}>{c}</option>)}
            </select>
          </label>
        </div>

        <label>
          <span className="block text-sm text-gray-600">電話</span>
          <input className="border rounded px-3 py-2 w-full" value={phone} onChange={(e)=>setPhone(e.target.value)} required />
        </label>

        <label>
          <span className="block text-sm text-gray-600">メール</span>
          <input className="border rounded px-3 py-2 w-full" value={email} onChange={(e)=>setEmail(e.target.value)} required />
        </label>

        <label className="col-span-2">
          <span className="block text-sm text-gray-600">パスワード</span>
          <input className="border rounded px-3 py-2 w-full" type="password" value={password} onChange={(e)=>setPassword(e.target.value)} required />
        </label>

        <div className="col-span-2">
          <span className="block text-sm text-gray-600 mb-1">KYC（任意）</span>
          <div className="flex flex-col md:flex-row gap-2">
            <label className="flex-1">
              <span className="block text-sm">免許証の画像（任意）</span>
              <input type="file" accept="image/*" onChange={(e)=>setLicenseFile(e.target.files?.[0] || null)} />
            </label>
            <label className="flex-1">
              <span className="block text-sm">マイナンバーの画像（任意）</span>
              <input type="file" accept="image/*" onChange={(e)=>setMyNumberFile(e.target.files?.[0] || null)} />
            </label>
          </div>
          {uploading && <div className="text-sm text-gray-600 mt-1">アップロード中…</div>}
        </div>

        <button className="rounded bg-blue-600 text-white px-3 py-2 col-span-2">登録</button>
      </form>
    </div>
  );
}
</file>

<file path="backend/src/modules/follows/follows.service.ts">
import { ConflictException, Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Follow } from '../../entities/follow.entity';

@Injectable()
export class FollowsService {
  constructor(@InjectRepository(Follow) private readonly follows: Repository<Follow>) {}

  async follow(userId: string, targetUserId: string) {
    if (userId === targetUserId) throw new ConflictException('Cannot follow yourself');
    const existing = await this.follows.findOne({ where: { followerUserId: userId, targetUserId } });
    if (existing) throw new ConflictException('Already following');
    const record = this.follows.create({ followerUserId: userId, targetUserId });
    return this.follows.save(record);
  }

  async unfollow(userId: string, targetUserId: string) {
    const existing = await this.follows.findOne({ where: { followerUserId: userId, targetUserId } });
    if (!existing) return { ok: true };
    await this.follows.delete(existing.id);
    return { ok: true };
  }

  async listFollowedIds(userId: string): Promise<string[]> {
    const rows = await this.follows.find({ where: { followerUserId: userId } });
    return rows.map((r) => r.targetUserId);
  }
}
</file>

<file path="backend/src/modules/posts/posts.controller.ts">
import { Body, Controller, Get, Param, Post as PostMethod, Query, Req, UseGuards } from '@nestjs/common';
import { PostsService } from './posts.service';
import { AuthGuard } from '@nestjs/passport';

@Controller('posts')
export class PostsController {
  constructor(private readonly posts: PostsService) {}

  @UseGuards(AuthGuard('jwt'))
  @PostMethod()
  async create(@Body() dto: any, @Req() req: any) {
    const userId = req.user?.sub ?? req.user?.id;
    return this.posts.create(userId, dto);
  }

  @Get()
  async list(@Query() query: { type?: string; region?: string; q?: string; page?: number; limit?: number }) {
    return this.posts.list(query);
  }

  @Get(':id')
  async getOne(@Param('id') id: string) {
    return this.posts.findById(id);
  }
}
</file>

<file path="backend/src/modules/comments/comments.controller.ts">
import { Body, Controller, Get, Param, Post, Query, Req, UseGuards } from '@nestjs/common';
import { CommentsService } from './comments.service';
import { CreateCommentDto } from './dto/create-comment.dto';
import { AuthGuard } from '@nestjs/passport';
// import { Throttle } from '@nestjs/throttler'; // 一時的に非使用（デコレーター引数エラー回避）

@Controller('posts/:postId/comments')
// @UseGuards(ThrottlerGuard) // 必要であれば APP_GUARD で全体適用する方針に合わせてコメントアウト可
export class CommentsController {
  constructor(private readonly comments: CommentsService) {}

  @Get()
  async list(
    @Param('postId') postId: string,
    @Query('cursor') cursor?: string,
    @Query('limit') limit?: string,
  ) {
    return this.comments.list(postId, cursor, parseInt(limit || '20', 10));
  }

  @UseGuards(AuthGuard('jwt'))
  // @Throttle(10, 60) // ライブラリのバージョンによる引数不整合を回避するため一時的に無効化
  @Post()
  async create(@Param('postId') postId: string, @Body() dto: CreateCommentDto, @Req() req: any) {
    const userId = req.user?.sub ?? req.user?.id;
    return this.comments.create(postId, userId, dto);
  }
}
</file>

<file path="backend/src/modules/posts/posts.service.ts">
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository, SelectQueryBuilder } from 'typeorm';
import { Post } from 'src/entities/post.entity';

@Injectable()
export class PostsService {
  constructor(@InjectRepository(Post) private readonly repo: Repository<Post>) {}

  async create(userId: string, dto: { title: string; content: string; type: string }) {
    const post = this.repo.create({
      title: dto.title,
      content: dto.content,
      type: dto.type,
      authorUserId: userId, // リレーションオブジェクトではなく外部キー
    } as any);
    return this.repo.save(post);
  }

  async list(query: {
    type?: string;
    authorUserId?: string;
    search?: string;
    limit?: number;
    beforeId?: string;
  }) {
    let qb: SelectQueryBuilder<Post> = this.repo.createQueryBuilder('p');

    if (query.type) {
      qb = qb.andWhere('p.type = :type', { type: query.type });
    }
    if (query.authorUserId) {
      qb = qb.andWhere('p.authorUserId = :authorUserId', { authorUserId: query.authorUserId });
    }
    if (query.search) {
      qb = qb.andWhere('(p.title LIKE :search OR p.content LIKE :search)', {
        search: `%${query.search}%`,
      });
    }
    if (query.beforeId) {
      qb = qb.andWhere('p.id < :beforeId', { beforeId: query.beforeId });
    }

    qb = qb.orderBy('p.createdAt', 'DESC');

    if (query.limit && Number.isFinite(query.limit)) {
      qb = qb.take(Math.max(1, Math.min(query.limit, 100)));
    } else {
      qb = qb.take(20);
    }

    return qb.getMany();
  }

  async findById(id: string) {
    return this.repo.findOne({ where: { id } });
  }
}
</file>

<file path="backend/src/modules/votes/votes.controller.ts">
import { Body, Controller, Get, Param, Post, Req, UseGuards } from '@nestjs/common';
import { VotesService } from './votes.service';
import { CreateVoteDto } from './dto/create-vote.dto';
import { AuthGuard } from '@nestjs/passport';
// import { Throttle } from '@nestjs/throttler'; // 一時的に非使用（デコレーター引数エラー回避）

@Controller('posts/:postId/votes')
// @UseGuards(ThrottlerGuard) // 必要であれば APP_GUARD で全体適用する方針に合わせてコメントアウト可
export class VotesController {
  constructor(private readonly votes: VotesService) {}

  @UseGuards(AuthGuard('jwt'))
  // @Throttle(5, 60) // ライブラリのバージョンによる引数不整合を回避するため一時的に無効化
  @Post()
  async cast(@Param('postId') postId: string, @Body() dto: CreateVoteDto, @Req() req: any) {
    const userId = req.user?.sub ?? req.user?.id;
    return this.votes.cast(postId, userId, dto);
  }

  @Get('summary')
  async summary(@Param('postId') postId: string) {
    return this.votes.summary(postId);
  }
}
</file>

<file path="backend/src/entities/user.entity.ts">
import {
  Column,
  CreateDateColumn,
  Entity,
  Index,
  OneToMany,
  PrimaryGeneratedColumn,
  UpdateDateColumn,
} from 'typeorm';
import { Member } from 'src/entities/member.entity';
import { Post } from 'src/entities/post.entity';
import { Vote } from 'src/entities/vote.entity';

export type UserStatus = 'pending' | 'approved' | 'rejected';  // 追加

@Entity('users')
export class User {
  @PrimaryGeneratedColumn('uuid')
  id!: string;

  @Index({ unique: true })
  @Column({ type: 'varchar', length: 256, unique: true })
  email!: string;

  @Column({ type: 'varchar', length: 128, nullable: true })
  name!: string | null;

  @Index({ unique: true })
  @Column({ type: 'varchar', length: 128, unique: true, nullable: true })
  nickname!: string | null;

  @Column({ type: 'varchar', length: 32, nullable: true })
  phoneNumber!: string | null;

  @Column({ type: 'varchar', length: 32, nullable: true })
  ageGroup!: string | null;

  @Column({ type: 'varchar', length: 256 })
  passwordHash!: string;

  @Column({ type: 'boolean', default: false })
  emailVerified!: boolean;

  @Column({ type: 'varchar', length: 256, select: false, nullable: true })
  emailVerifyToken!: string | null;

  @Column({ type: 'boolean', default: false })
  phoneVerified!: boolean;

  @Column({ type: 'varchar', length: 64, select: false, nullable: true })
  phoneVerifyCode!: string | null;

  @Column({ type: 'varchar', length: 32, default: 'pending' })
  status!: UserStatus;  // ← 型を必ずUserStatus型に

  @Column({ type: 'varchar', length: 32, default: 'citizen' })
  role!: 'admin' | 'politician' | 'citizen';

  @Column({ type: 'varchar', length: 64, nullable: true })
  addressPref!: string | null;

  @Column({ type: 'varchar', length: 128, nullable: true })
  addressCity!: string | null;

  @OneToMany(() => Member, (member) => member.user)
  members!: Member[];

  @OneToMany(() => Post, (post) => post.author)
  posts!: Post[];

  @OneToMany(() => Vote, (vote) => vote.user)
  votes!: Vote[];

  @CreateDateColumn({ type: 'timestamp with time zone' })
  createdAt!: Date;

  @UpdateDateColumn({ type: 'timestamp with time zone' })
  updatedAt!: Date;
}
</file>

<file path="backend/package.json">
{
  "name": "backend",
  "version": "1.0.0",
  "private": true,
  "description": "NestJS backend server",
  "scripts": {
    "start": "node dist/main.js",
    "start:dev": "nest start --watch",
    "build": "nest build",
    "lint": "eslint .",
    "format": "prettier --write ."
  },
  "dependencies": {
    "@nestjs/cache-manager": "^3.0.1",
    "@nestjs/common": "^10.3.0",
    "@nestjs/config": "^3.2.2",
    "@nestjs/core": "^10.3.0",
    "@nestjs/jwt": "^10.2.0",
    "@nestjs/passport": "^10.0.3",
    "@nestjs/platform-express": "^10.3.0",
    "@nestjs/schedule": "^3.0.4",
    "@nestjs/swagger": "^7.3.1",
    "@nestjs/throttler": "^5.2.0",
    "@nestjs/typeorm": "^10.0.2",
    "bcrypt": "^6.0.0",
    "bcryptjs": "^2.4.3",
    "cache-manager": "^7.2.7",
    "class-transformer": "^0.5.1",
    "class-validator": "^0.14.1",
    "firebase-admin": "^12.7.0",
    "nodemailer": "^7.0.11",
    "passport": "^0.7.0",
    "passport-jwt": "^4.0.1",
    "pg": "^8.16.3",
    "reflect-metadata": "^0.1.14",
    "rxjs": "^7.8.1",
    "typeorm": "^0.3.28",
    "uuid": "^13.0.0"
  },
  "devDependencies": {
    "@nestjs/cli": "^10.3.2",
    "@types/bcrypt": "^6.0.0",
    "@types/bcryptjs": "^2.4.6",
    "@types/cache-manager": "^4.0.6",
    "@types/express": "^4.17.25",
    "@types/jsonwebtoken": "^9.0.6",
    "@types/multer": "^1.4.13",
    "@types/node": "^20.11.30",
    "@types/nodemailer": "^7.0.4",
    "@types/passport": "^1.0.17",
    "@types/passport-jwt": "^3.0.13",
    "@types/uuid": "^10.0.0",
    "eslint": "^9.14.0",
    "prettier": "^3.2.5",
    "ts-node": "^10.9.2",
    "typescript": "^5.6.3"
  }
}
</file>

<file path="backend/src/modules/users/users.service.ts">
import { Injectable, NotFoundException } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { FindOptionsWhere, Repository } from 'typeorm';
import * as bcrypt from 'bcryptjs';
import { User, UserStatus } from 'src/entities/user.entity';
import { Member } from 'src/entities/member.entity'; // Memberエンティティをimport

@Injectable()
export class UsersService {
  constructor(
    @InjectRepository(User) private readonly users: Repository<User>,
    @InjectRepository(Member) private readonly members: Repository<Member>, // Memberリポジトリを注入
  ) {}

  async findById(id: string): Promise<User> {
    const u = await this.users.findOne({ where: { id } as FindOptionsWhere<User> });
    if (!u) throw new NotFoundException('User not found');
    return u;
  }

  async findAll(): Promise<User[]> {
    return this.users.find();
  }

  // createUser：usersとmembersに両方登録
  async createUser(body: {
    email: string;
    password: string;
    name?: string;
    nickname?: string | null;
    phoneNumber?: string | null;
    ageGroup?: string | null;
    role?: 'admin' | 'politician' | 'citizen';
    status?: UserStatus;
  }): Promise<User> {
    const passwordHash = await bcrypt.hash(body.password, 10);

    // 1. usersに登録
    const u = this.users.create({
      email: body.email,
      passwordHash,
      name: body.name ?? null,
      nickname: body.nickname ?? null,
      phoneNumber: body.phoneNumber ?? null,
      ageGroup: body.ageGroup ?? null,
      role: body.role ?? 'citizen',
      status: body.role === 'politician' ? 'pending' : (body.status ?? 'pending'),
      emailVerified: false,
      phoneVerified: false,
    });
    const user = await this.users.save(u);

    // 2. membersにも登録（userId: users.id）
    const m = this.members.create({
      name: body.name ?? '',
      email: body.email,
      role: body.role ?? 'citizen',
      user: user,
      userId: user.id,
    });
    await this.members.save(m);

    return user;
  }
}
</file>

<file path="backend/src/app.module.ts">
import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
// 他の imports...

@Module({
  imports: [
    TypeOrmModule.forRoot({
      type: 'postgres',
      host: process.env.DB_HOST || 'localhost',
      port: parseInt(process.env.DB_PORT || '5432', 10),
      username: process.env.DB_USER || 'postgres',
      password: process.env.DB_PASS || 'postgres',
      database: process.env.DB_NAME || 'app',
      // ここが重要。Member が含まれるようにする
      entities: [__dirname + '/entities/**/*.js', __dirname + '/modules/**/entities/**/*.js'],
      // or ts-node 実行時:
      // entities: ['src/entities/**/*.ts', 'src/modules/**/entities/**/*.ts'],
      synchronize: true,
    }),
    // 他 modules...
  ],
})
export class AppModule {}
</file>

<file path="backend/src/main.ts">
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // ======== ここを追記！ ========
  app.enableCors({
    origin: [
      'http://localhost:3000', // Next.jsフロントのURL（必要に応じて3001も加える）
      'http://localhost:3001'
    ],
    credentials: true,
  });
  // ============================

  await app.listen(4000); // 例: 4000
}
bootstrap();
</file>

</files>
